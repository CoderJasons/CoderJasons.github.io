<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yujiusheng.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="ä¸ªäººæŠ€æœ¯åšå®¢">
<meta property="og:type" content="website">
<meta property="og:title" content="Jasonçš„åšå®¢">
<meta property="og:url" content="http://yujiusheng.com/page/4/index.html">
<meta property="og:site_name" content="Jasonçš„åšå®¢">
<meta property="og:description" content="ä¸ªäººæŠ€æœ¯åšå®¢">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Jason">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yujiusheng.com/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Jasonçš„åšå®¢</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Jasonçš„åšå®¢</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yujiusheng.com/2021/05/19/iOS%E6%8E%A2%E7%B4%A2-Block/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="ä¸ªäººæŠ€æœ¯åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jasonçš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/19/iOS%E6%8E%A2%E7%B4%A2-Block/" class="post-title-link" itemprop="url">iOSæ¢ç´¢ - Block</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-05-19 11:06:45" itemprop="dateCreated datePublished" datetime="2021-05-19T11:06:45+08:00">2021-05-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-07-11 00:31:12" itemprop="dateModified" datetime="2021-07-11T00:31:12+08:00">2021-07-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>åœ¨Objective-Cä¸­ï¼Œblockæ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„ä¸œè¥¿ï¼Œè¯´ç™½äº†å°±æ˜¯ä¸ªåŒ¿åå‡½æ•°ï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šå…³äºblockå¦‚ä½•ä½¿ç”¨çš„æ–‡ç« ï¼Œè®²çš„éƒ½éå¸¸ç²¾å½©ï¼Œè¿™é‡Œä¸»è¦æ¢è®¨ä¸‹blockçš„å®ç°åŸç†ã€‚</p>
<h3 id="å…ˆçœ‹ä¸€ä¸ªä¾‹å­"><a href="#å…ˆçœ‹ä¸€ä¸ªä¾‹å­" class="headerlink" title="å…ˆçœ‹ä¸€ä¸ªä¾‹å­"></a>å…ˆçœ‹ä¸€ä¸ªä¾‹å­</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">void blockFunc1() &#123;</span><br><span class="line">    int num &#x3D; 100;</span><br><span class="line">    void (^block)(void) &#x3D; ^() &#123;</span><br><span class="line">        NSLog(@&quot;num &#x3D; %d\n&quot;, num);</span><br><span class="line">    &#125;;</span><br><span class="line">    num &#x3D; 200;</span><br><span class="line">    block();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void blockFunc2() &#123;</span><br><span class="line">    __block int num &#x3D; 100;</span><br><span class="line">    void (^block)(void) &#x3D; ^() &#123;</span><br><span class="line">        NSLog(@&quot;num &#x3D; %d\n&quot;, num);</span><br><span class="line">    &#125;;</span><br><span class="line">    num &#x3D; 200;</span><br><span class="line">    block();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int num &#x3D; 100;</span><br><span class="line">void blockFunc3() &#123;</span><br><span class="line">    void (^block)(void) &#x3D; ^() &#123;</span><br><span class="line">        NSLog(@&quot;num &#x3D; %d\n&quot;, num);</span><br><span class="line">    &#125;;</span><br><span class="line">    num &#x3D; 200;</span><br><span class="line">    block();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void blockFunc4()</span><br><span class="line">&#123;</span><br><span class="line">    static int num &#x3D; 100;</span><br><span class="line">    void (^block)(void) &#x3D; ^&#123;</span><br><span class="line">        NSLog(@&quot;num &#x3D; %d&quot;, num);</span><br><span class="line">    &#125;;</span><br><span class="line">    num &#x3D; 200;</span><br><span class="line">    block();</span><br><span class="line">&#125;</span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        ^&#123; printf(&quot;Hello, World!\n&quot;); &#125; ();</span><br><span class="line">        blockFunc1();</span><br><span class="line">        blockFunc2();</span><br><span class="line">        blockFunc3();</span><br><span class="line">        blockFunc4();</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰“å°ç»“æœï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Hello, World!</span><br><span class="line"><span class="number">2021</span><span class="number">-05</span><span class="number">-19</span> <span class="number">11</span>:<span class="number">25</span>:<span class="number">19.532572</span>+<span class="number">0800</span> OCDemo[<span class="number">60496</span>:<span class="number">2272335</span>] num = <span class="number">100</span></span><br><span class="line"><span class="number">2021</span><span class="number">-05</span><span class="number">-19</span> <span class="number">11</span>:<span class="number">25</span>:<span class="number">19.534041</span>+<span class="number">0800</span> OCDemo[<span class="number">60496</span>:<span class="number">2272335</span>] num = <span class="number">200</span></span><br><span class="line"><span class="number">2021</span><span class="number">-05</span><span class="number">-19</span> <span class="number">11</span>:<span class="number">25</span>:<span class="number">19.534166</span>+<span class="number">0800</span> OCDemo[<span class="number">60496</span>:<span class="number">2272335</span>] num = <span class="number">200</span></span><br><span class="line"><span class="number">2021</span><span class="number">-05</span><span class="number">-19</span> <span class="number">11</span>:<span class="number">25</span>:<span class="number">19.534292</span>+<span class="number">0800</span> OCDemo[<span class="number">60496</span>:<span class="number">2272335</span>] num = <span class="number">200</span></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å…ˆç®€å•è§£é‡Šä¸€ä¸‹ï¼š</p>
<p>1ã€â€Hello, World!â€åº”è¯¥å¾ˆç®€å•ï¼Œæ‰§è¡Œblockç›´æ¥æ‰“å°ã€‚</p>
<p>2ã€<code>blockFunc1</code>é‡Œé¢,<code>num</code>æ˜¯ä»¥å€¼ä¼ é€’çš„æ–¹å¼è¢«blockè·å–ï¼Œæ‰€ä»¥å°½ç®¡åé¢æ›´æ”¹äº†<code>num</code>çš„å€¼ï¼Œä½†æ˜¯åœ¨blocké‡Œé¢è¿˜æ˜¯ä¿æŒä¿æŒåŸæ¥çš„å€¼ã€‚</p>
<p>3ã€<code>blockFunc2</code>é‡Œé¢ï¼Œnumç”±<code>__block</code>ä¿®é¥°ï¼Œ<code>num</code>åœ¨blockå˜æˆäº†å¤–éƒ¨çš„ä¸€ä¸ªå¼•ç”¨ï¼ˆåé¢ä¼šé€šè¿‡æºç è§£é‡Šï¼‰ï¼Œæ‰€ä»¥åœ¨blockå¤–éƒ¨æ”¹å˜<code>num</code>çš„å€¼æ—¶ï¼Œblocké‡Œé¢çš„<code>num</code>ä¹Ÿéšç€æ”¹å˜ã€‚</p>
<p>4ã€<code>blockFunc3</code>é‡Œé¢ï¼Œblockå¼•ç”¨çš„æ˜¯ä¸€ä¸ªå…¨å±€çš„numï¼Œæ‰€ä»¥ï¼Œnumæ”¹å˜çš„æ—¶å€™ä¹Ÿä¼šæ”¹å˜blockå†…éƒ¨numçš„å€¼ã€‚</p>
<p>5ã€<code>blockFunc3</code>é‡Œé¢ï¼Œblockå¼•ç”¨çš„æ˜¯ä¸€ä¸ªstaticçš„numï¼Œæ‰€ä»¥ï¼Œnumæ”¹å˜ä¹Ÿä¼šæ”¹å˜blockå†…éƒ¨çš„numçš„å€¼ã€‚</p>
<h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p>ä¹Ÿè®¸å¤§å®¶çœ‹åˆ°ä¸Šé¢çš„è§£é‡Šè¿˜æ˜¯ä¸çŸ¥é“ä¸ºå•¥ä¼šè¿™æ ·ï¼Œæ‰€ä»¥æ¥ä¸‹ï¼Œæˆ‘é€šè¿‡æºç æ¥åˆ†æä¸‹å…¶ä¸­çš„ç¼˜ç”±ï¼Œæˆ‘ä»¬å…ˆæŠŠè¿™æ®µå…ˆè½¬æ¢æˆc++æ–‡ä»¶ï¼Œcdåˆ°main.mæ‰€åœ¨çš„ç›®å½•ï¼Œå¹¶æ‰§è¡Œè¿™æ¡å‘½ä»¤<code>clang -rewrite-objc main.m</code>ï¼Œ</p>
<p>å¦‚æœä¸Šé¢çš„å‘½ä»¤æŠ¥é”™<code>&#39;UIKit/UIKit.h&#39; file not found</code>,å¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤</p>
<p><code>clang -x objective-c -rewrite-objc -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk main.m</code></p>
<p>é€šè¿‡è¿™æ¡å‘½ä»¤å¯ä»¥æŠŠmain.mæ–‡ä»¶è½¬æ¢æˆcppæ–‡ä»¶ï¼Œé‡Œé¢å¯ä»¥çœ‹åˆ°blockçš„ç»“æ„ã€‚æˆ‘ä»¬æ‰“å¼€è¿™ä»½æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶æ¯”è¾ƒé•¿ï¼Œç›´æ¥æ‹‰åˆ°æœ€åã€‚å¯ä»¥çœ‹åˆ°åœ¨æ–‡ä»¶çš„æœ€åæ˜¯mainå‡½æ•°çš„å…¥å£ï¼Œä»£ç å¦‚ä¸‹:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* @autoreleasepool */</span> &#123; __AtAutoreleasePool __autoreleasepool; </span><br><span class="line">        ((<span class="keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA)) ();</span><br><span class="line">        blockFunc1();</span><br><span class="line">        blockFunc2();</span><br><span class="line"></span><br><span class="line">        blockFunc3();</span><br><span class="line">        blockFunc4();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆçœ‹ç¬¬ä¸€è¡Œä»£ç ï¼Œæ„é€ äº†ä¸€ä¸ª<strong>main_block_impl_0å¯¹è±¡ï¼Œ</strong>main_block_impl_0æ˜¯ä¸€ä¸ªç»“æ„ä½“ã€‚ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> &#123;</span></span><br><span class="line">  <span class="keyword">void</span> *isa;</span><br><span class="line">  <span class="keyword">int</span> Flags;</span><br><span class="line">  <span class="keyword">int</span> Reserved;</span><br><span class="line">  <span class="keyword">void</span> *FuncPtr;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">main_block_impl_0</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> <span class="title">impl</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span>* <span class="title">Desc</span>;</span></span><br><span class="line">  __main_block_impl_0(<span class="keyword">void</span> *fp, struct __main_block_desc_0 *desc, <span class="keyword">int</span> flags=<span class="number">0</span>) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä»ä»£ç å¯çŸ¥ï¼Œæœ€åblockä¼šè½¬åŒ–æˆä¸€ä¸ª__block_implå¯¹è±¡ï¼Œè€Œblockæ‰§è¡Œçš„ä»£ç ä¼šè½¬åŒ–æˆä¸€ä¸ªé™æ€å‡½æ•°ï¼Œ__block_implé‡Œé¢çš„FuncPträ¼šæŒ‡å‘è¿™ä¸ªé™æ€å‡½æ•°ã€‚åœ¨è¿™é‡Œ<code>printf(&quot;Hello, World!\n&quot;);</code>è¿™ä¸ªblockè½¬æ¢åçš„é™æ€å‡½æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">"Hello, World!\n"</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥æ•´ä¸ªè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š<br>1ã€å…ˆæ„é€ ä¸€ä¸ª<code>__main_block_impl_0</code>å¯¹è±¡ï¼Œæ„é€ çš„æ—¶å€™æŠŠ<code>__main_block_func_0</code>ä¼ è¿›å»ï¼Œå½“ç„¶è¿˜æœ‰åˆ«çš„å‚æ•°ï¼Œè¿™é‡Œå…ˆä¸è€ƒè™‘ã€‚</p>
<p>2ã€åœ¨<code>__main_block_impl_0</code>çš„æ„é€ æ–¹æ³•ä¸­ï¼Œå†æŠŠ<code>__main_block_func_0</code>èµ‹ç»™<code>__block_impl</code>çš„FuncPtrã€‚</p>
<p>3ã€è°ƒç”¨FuncPtrã€‚</p>
<p>æ‰€ä»¥ï¼Œä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œblockå®é™…ä¸Šæ˜¯è½¬åŒ–ä¸ºäº†ä¸€ä¸ª<code>__block_impl</code>å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æœ‰isaæŒ‡é’ˆï¼Œç”¨æ¥è¡¨ç¤ºblockçš„ç±»å‹ï¼Œä¸Šé¢çš„blockçš„isaæŒ‡å‘&amp;_NSConcreteStackBlockã€‚åŒæ—¶blockå¯¹è±¡è¿˜æœ‰ä¸€ä¸ªFuncPtræŒ‡é’ˆï¼Œç”¨æ¥æŒ‡å‘blockæ‰§è¡Œçš„æ–¹æ³•ï¼ˆè½¬æ¢åçš„é™æ€å‡½æ•°ï¼‰ã€‚</p>
<p>å†æ¥çœ‹çœ‹blockFunc1ç›¸å…³çš„å†…å®¹</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">blockFunc1_block_impl_0</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> <span class="title">impl</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">blockFunc1_block_desc_0</span>* <span class="title">Desc</span>;</span></span><br><span class="line">  <span class="keyword">int</span> num;</span><br><span class="line">  __blockFunc1_block_impl_0(<span class="keyword">void</span> *fp, struct __blockFunc1_block_desc_0 *desc, <span class="keyword">int</span> _num, <span class="keyword">int</span> flags=<span class="number">0</span>) : num(_num) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __blockFunc1_block_func_0(struct __blockFunc1_block_impl_0 *__cself) &#123;</span><br><span class="line">  <span class="keyword">int</span> num = __cself-&gt;num; <span class="comment">// bound by copy</span></span><br><span class="line"></span><br><span class="line">        NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders__s_l_p47fxn36j8d2_n75spyb7c0000gn_T_main_324f63_mi_0, num);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> __<span class="title">blockFunc1_block_desc_0</span> &#123;</span></span><br><span class="line">  <span class="keyword">size_t</span> reserved;</span><br><span class="line">  <span class="keyword">size_t</span> Block_size;</span><br><span class="line">&#125; __blockFunc1_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(struct __blockFunc1_block_impl_0)&#125;;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">blockFunc1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> num = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">void</span> (*block)(<span class="keyword">void</span>) = ((<span class="keyword">void</span> (*)())&amp;__blockFunc1_block_impl_0((<span class="keyword">void</span> *)__blockFunc1_block_func_0, &amp;__blockFunc1_block_desc_0_DATA, num));</span><br><span class="line">    num = <span class="number">200</span>;</span><br><span class="line">    ((<span class="keyword">void</span> (*)(__block_impl *))((__block_impl *)block)-&gt;FuncPtr)((__block_impl *)block);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢ï¼Œæ„é€ blockçš„æ—¶å€™æŠŠnumä¼ äº†è¿›å»ï¼Œè€Œä¸”æ˜¯æ™®é€šå€¼ä¼ é€’ï¼Œè¿™æ ·çš„è¯å…¶å®æ˜¯æ‹·è´äº†ä¸€ä»½numã€‚ç„¶ååœ¨æ‰§è¡Œblockæ–¹æ³•çš„æ—¶å€™ï¼Œä½¿ç”¨çš„æ˜¯æ‹·è´çš„é‚£ä»½numï¼Œä»<code>int num = __cself-&gt;num; // bound by copy</code>å¯ä»¥çœ‹å‡ºã€‚è¿™ä¸ªblockä¹Ÿæ˜¯_NSConcreteStackBlockç±»å‹çš„ã€‚</p>
<p>å†æ¥çœ‹çœ‹__blockä¿®é¥°è¿‡çš„numåœ¨blocké‡Œé¢æ˜¯æ€ä¹ˆä¼ é€’çš„ï¼Œæˆ‘ä»¬çœ‹çœ‹blockFunc2ç›¸å…³çš„ä»£ç ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">Block_byref_num_0</span> &#123;</span></span><br><span class="line"> <span class="keyword">void</span> *__isa;</span><br><span class="line">__Block_byref_num_0 *__forwarding;</span><br><span class="line"> <span class="keyword">int</span> __flags;</span><br><span class="line"> <span class="keyword">int</span> __size;</span><br><span class="line"> <span class="keyword">int</span> num;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">blockFunc2_block_impl_0</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> <span class="title">impl</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">blockFunc2_block_desc_0</span>* <span class="title">Desc</span>;</span></span><br><span class="line">  __Block_byref_num_0 *num; <span class="comment">// by ref</span></span><br><span class="line">  __blockFunc2_block_impl_0(<span class="keyword">void</span> *fp, struct __blockFunc2_block_desc_0 *desc, __Block_byref_num_0 *_num, <span class="keyword">int</span> flags=<span class="number">0</span>) : num(_num-&gt;__forwarding) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __blockFunc2_block_func_0(struct __blockFunc2_block_impl_0 *__cself) &#123;</span><br><span class="line">  __Block_byref_num_0 *num = __cself-&gt;num; <span class="comment">// bound by ref</span></span><br><span class="line"></span><br><span class="line">        NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders__s_l_p47fxn36j8d2_n75spyb7c0000gn_T_main_324f63_mi_1, (num-&gt;__forwarding-&gt;num));</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __blockFunc2_block_copy_0(struct __blockFunc2_block_impl_0*dst, struct __blockFunc2_block_impl_0*src) &#123;_Block_object_assign((<span class="keyword">void</span>*)&amp;dst-&gt;num, (<span class="keyword">void</span>*)src-&gt;num, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __blockFunc2_block_dispose_0(struct __blockFunc2_block_impl_0*src) &#123;_Block_object_dispose((<span class="keyword">void</span>*)src-&gt;num, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> __<span class="title">blockFunc2_block_desc_0</span> &#123;</span></span><br><span class="line">  <span class="keyword">size_t</span> reserved;</span><br><span class="line">  <span class="keyword">size_t</span> Block_size;</span><br><span class="line">  <span class="keyword">void</span> (*copy)(struct __blockFunc2_block_impl_0*, struct __blockFunc2_block_impl_0*);</span><br><span class="line">  <span class="keyword">void</span> (*dispose)(struct __blockFunc2_block_impl_0*);</span><br><span class="line">&#125; __blockFunc2_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(struct __blockFunc2_block_impl_0), __blockFunc2_block_copy_0, __blockFunc2_block_dispose_0&#125;;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">blockFunc2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    __attribute__((__blocks__(byref))) __Block_byref_num_0 num = &#123;(<span class="keyword">void</span>*)<span class="number">0</span>,(__Block_byref_num_0 *)&amp;num, <span class="number">0</span>, <span class="keyword">sizeof</span>(__Block_byref_num_0), <span class="number">100</span>&#125;;</span><br><span class="line">    <span class="keyword">void</span> (*block)(<span class="keyword">void</span>) = ((<span class="keyword">void</span> (*)())&amp;__blockFunc2_block_impl_0((<span class="keyword">void</span> *)__blockFunc2_block_func_0, &amp;__blockFunc2_block_desc_0_DATA, (__Block_byref_num_0 *)&amp;num, <span class="number">570425344</span>));</span><br><span class="line">    (num.__forwarding-&gt;num) = <span class="number">200</span>;</span><br><span class="line">    ((<span class="keyword">void</span> (*)(__block_impl *))((__block_impl *)block)-&gt;FuncPtr)((__block_impl *)block);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ__blockä¿®é¥°çš„numåœ¨å†…éƒ¨è¢«åŒ…è£…æˆä¸€ä¸ª__Block_byref_num_0çš„å¯¹è±¡ï¼Œå‡è®¾å«aï¼ŒåŸæ¥numçš„å€¼100å­˜å‚¨åœ¨å¯¹è±¡açš„numå­—æ®µä¸­ï¼ŒåŒæ—¶è¿™ä¸ªå¯¹è±¡aæœ‰ä¸€ä¸ª<strong>forwardingå­—æ®µï¼ŒæŒ‡å‘aæœ¬èº«ã€‚å½“æ”¹å˜numçš„å€¼çš„æ—¶å€™ï¼ˆæºä»£ç æ˜¯<code>num = 200;</code>ï¼‰ï¼Œè¿™æ®µä»£ç å˜ä¸º`(num.</strong>forwarding-&gt;num) = 200;<code>ï¼Œä¹Ÿå°±æ˜¯è¯´æŠŠå¯¹è±¡aé‡Œé¢çš„numå­—æ®µçš„å€¼å˜ä¸ºäº†200ã€‚åŒæ—¶ï¼Œåœ¨blockçš„æ‰§è¡Œå‡½æ•°__blockFunc2_block_func_0ä¸­ï¼Œæ‰“å°å‡ºæ¥çš„å–å€¼æ˜¯ä»</code><strong>Block_byref_num_0 *num = __cself-&gt;num;`å–å‡ºï¼Œä¹Ÿå°±æ˜¯å–å¾—æ˜¯æ”¹å˜åçš„å€¼ï¼Œæ‰€ä»¥æ‰“å°ç»“æœæ˜¯200ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆç”¨</strong>blockä¿®é¥°çš„å˜é‡å¯ä»¥åœ¨blockå†…éƒ¨è¢«ä¿®æ”¹ã€‚</p>
<p>é‚£å½“numä¸ºå…¨å±€å˜é‡çš„æ—¶å€™ï¼Œblockåˆæ˜¯æ€æ ·çš„å‘¢ï¼Ÿè¯·çœ‹ä»£ç ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> num = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">blockFunc3_block_impl_0</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> <span class="title">impl</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">blockFunc3_block_desc_0</span>* <span class="title">Desc</span>;</span></span><br><span class="line">  __blockFunc3_block_impl_0(<span class="keyword">void</span> *fp, struct __blockFunc3_block_desc_0 *desc, <span class="keyword">int</span> flags=<span class="number">0</span>) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __blockFunc3_block_func_0(struct __blockFunc3_block_impl_0 *__cself) &#123;</span><br><span class="line"></span><br><span class="line">        NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders__s_l_p47fxn36j8d2_n75spyb7c0000gn_T_main_324f63_mi_2, num);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> __<span class="title">blockFunc3_block_desc_0</span> &#123;</span></span><br><span class="line">  <span class="keyword">size_t</span> reserved;</span><br><span class="line">  <span class="keyword">size_t</span> Block_size;</span><br><span class="line">&#125; __blockFunc3_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(struct __blockFunc3_block_impl_0)&#125;;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">blockFunc3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">void</span> (*block)(<span class="keyword">void</span>) = ((<span class="keyword">void</span> (*)())&amp;__blockFunc3_block_impl_0((<span class="keyword">void</span> *)__blockFunc3_block_func_0, &amp;__blockFunc3_block_desc_0_DATA));</span><br><span class="line">    num = <span class="number">200</span>;</span><br><span class="line">    ((<span class="keyword">void</span> (*)(__block_impl *))((__block_impl *)block)-&gt;FuncPtr)((__block_impl *)block);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ä»£ç é‡Œå¯ä»¥çœ‹å‡ºï¼Œè¿™ç§æƒ…å†µå¾ˆç®€å•ï¼Œblockå¯¹è±¡æ ¹æœ¬æ²¡æœ‰numå­—æ®µï¼Œä¹Ÿå°±æ˜¯æ‰“å°çš„æ—¶å€™ç›´æ¥å–å¾—å…¨å±€çš„numã€‚</p>
<p>æœ€åä¸€ç§æƒ…å†µä¹Ÿå¾ˆç®€å•ï¼Œå½“numæ—¶staticçš„æ—¶å€™ï¼Œæ„é€ blockå¯¹è±¡çš„æ—¶å€™ç›´æ¥ç”¨å¼•ç”¨ä¼ å€¼çš„æ–¹å¼æŠŠnumæ”¾åˆ°blockå¯¹è±¡ä¸­ã€‚æ‰€ä»¥ï¼Œå½“å¤–éƒ¨æ”¹å˜numçš„å€¼çš„æ—¶å€™ï¼Œä¹Ÿèƒ½åæ˜ åˆ°blockå†…éƒ¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">blockFunc4_block_impl_0</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> <span class="title">impl</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">blockFunc4_block_desc_0</span>* <span class="title">Desc</span>;</span></span><br><span class="line">  <span class="keyword">int</span> *num;</span><br><span class="line">  __blockFunc4_block_impl_0(<span class="keyword">void</span> *fp, struct __blockFunc4_block_desc_0 *desc, <span class="keyword">int</span> *_num, <span class="keyword">int</span> flags=<span class="number">0</span>) : num(_num) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __blockFunc4_block_func_0(struct __blockFunc4_block_impl_0 *__cself) &#123;</span><br><span class="line">  <span class="keyword">int</span> *num = __cself-&gt;num; <span class="comment">// bound by copy</span></span><br><span class="line"></span><br><span class="line">        NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders__s_l_p47fxn36j8d2_n75spyb7c0000gn_T_main_324f63_mi_3, (*num));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> __<span class="title">blockFunc4_block_desc_0</span> &#123;</span></span><br><span class="line">  <span class="keyword">size_t</span> reserved;</span><br><span class="line">  <span class="keyword">size_t</span> Block_size;</span><br><span class="line">&#125; __blockFunc4_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(struct __blockFunc4_block_impl_0)&#125;;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">blockFunc4</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> num = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">void</span> (*block)(<span class="keyword">void</span>) = ((<span class="keyword">void</span> (*)())&amp;__blockFunc4_block_impl_0((<span class="keyword">void</span> *)__blockFunc4_block_func_0, &amp;__blockFunc4_block_desc_0_DATA, &amp;num));</span><br><span class="line">    num = <span class="number">200</span>;</span><br><span class="line">    ((<span class="keyword">void</span> (*)(__block_impl *))((__block_impl *)block)-&gt;FuncPtr)((__block_impl *)block);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>è¿™ç¯‡æ–‡ç« ä¸»è¦ä»æºç çš„è§’åº¦è®²è¿°äº†blockçš„å®ç°æœºåˆ¶ï¼Œå¹¶é’ˆå¯¹å››ç§æƒ…å†µåˆ†æäº†blockæ˜¯å¦‚ä½•å¼•ç”¨å¤–éƒ¨å˜é‡çš„ï¼Œåˆ†åˆ«æ˜¯:<br>1ã€å½“å¼•ç”¨å±€éƒ¨å˜é‡çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰__blockä¿®é¥°ï¼Œé‚£ä¹ˆåœ¨blockå†…éƒ¨è·å–çš„æ˜¯å¤–éƒ¨å˜é‡çš„ä¸€ä»½æ‹·è´ï¼Œæ”¹å˜å¤–éƒ¨å˜é‡ä¸å½±å“blockå†…éƒ¨çš„é‚£ä»½æ‹·è´ã€‚</p>
<p>2ã€å½“å¼•ç”¨å±€éƒ¨å˜é‡çš„æ—¶å€™ï¼ŒåŒæ—¶å±€éƒ¨å˜é‡ç”¨__blockä¿®é¥°ï¼Œé‚£ä¹ˆåœ¨blockå†…éƒ¨ä½¿ç”¨çš„å®é™…ä¸Šæ˜¯å¤–éƒ¨å˜é‡çš„ä¸€ä¸ªå¼•ç”¨ï¼Œæ‰€ä»¥æ”¹å˜å¤–éƒ¨å˜é‡ä¼šå½±å“blockå†…éƒ¨å˜é‡çš„å€¼ã€‚</p>
<p>3ã€å½“å¼•ç”¨å…¨å±€å˜é‡çš„æ—¶å€™ï¼Œblockå¹¶ä¸æŒæœ‰è¿™ä¸ªå˜é‡ã€‚</p>
<p>4ã€å½“å¼•ç”¨staticå˜é‡çš„æ—¶å€™ï¼Œblockä¼šä»¥å¼•ç”¨çš„æ–¹å¼æŒæœ‰è¿™ä¸ªå˜é‡ã€‚å½“åœ¨å¤–éƒ¨ä¿®æ”¹è¿™ä¸ªå˜é‡çš„æ—¶å€™ï¼Œä¼šå½±å“blockå†…éƒ¨æŒæœ‰çš„è¿™ä¸ªå˜é‡çš„å€¼ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yujiusheng.com/2021/05/18/iOS-Runloop/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="ä¸ªäººæŠ€æœ¯åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jasonçš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/18/iOS-Runloop/" class="post-title-link" itemprop="url">iOS  - Runloop</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-05-18 15:33:42" itemprop="dateCreated datePublished" datetime="2021-05-18T15:33:42+08:00">2021-05-18</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yujiusheng.com/2021/05/18/iOS-%E7%BA%BF%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="ä¸ªäººæŠ€æœ¯åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jasonçš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/18/iOS-%E7%BA%BF%E7%A8%8B/" class="post-title-link" itemprop="url">iOS  - çº¿ç¨‹</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-05-18 14:36:21" itemprop="dateCreated datePublished" datetime="2021-05-18T14:36:21+08:00">2021-05-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-08-01 21:30:21" itemprop="dateModified" datetime="2021-08-01T21:30:21+08:00">2021-08-01</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>å¤šçº¿ç¨‹æ˜¯æˆ‘ä»¬å¼€å‘å’Œé¢è¯•ä¸­éƒ½ä¼šé‡åˆ°çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µï¼Œç›¸æ¯”äºå…¶ä»–ç¼–ç¨‹è¯­è¨€å’Œå¹³å°ï¼ŒiOS çš„å¤šçº¿ç¨‹ä½¿ç”¨èµ·æ¥è¦æ¯”è¾ƒå‹å¥½å’Œæ˜“ç”¨ä¸€äº›ã€‚ä½†æ˜¯å¯¹äºå¤šçº¿ç¨‹çš„åŸºæœ¬æ¦‚å¿µï¼Œæˆ‘ä»¬è¿˜æ˜¯éœ€è¦é‡è§†èµ·æ¥ï¼Œè¿™å¯¹äºæˆ‘ä»¬æ¢ç´¢ <code>pthread</code>ã€<code>NSThread</code>ã€<code>GCD</code> ä»¥åŠ <code>RunLoop</code> éƒ½å¤§æœ‰è£¨ç›Šã€‚</p>
<h3 id="å‰å¯¼çŸ¥è¯†"><a href="#å‰å¯¼çŸ¥è¯†" class="headerlink" title="å‰å¯¼çŸ¥è¯†"></a>å‰å¯¼çŸ¥è¯†</h3><ul>
<li>POSIX</li>
</ul>
<blockquote>
<p>POSIX Threads, usually referred to as pthreads, is an execution model that exists independently from a language, as well as a parallel execution model. It allows a program to control multiple different flows of work that overlap in time. Each flow of work is referred to as a thread, and creation and control over these flows is achieved by making calls to the POSIX Threads API.</p>
</blockquote>
<blockquote>
<p>â€“ POSIX Threads, Wikipedia</p>
</blockquote>
<blockquote>
<p>è¯‘ï¼š</p>
</blockquote>
<blockquote>
<p>POSIXï¼ˆPortable Operating System Interface of UNIXï¼Œå¯ç§»æ¤æ“ä½œç³»ç»Ÿæ¥å£ï¼‰çº¿ç¨‹ï¼Œå³ pthreadsï¼Œæ˜¯ä¸€ç§<strong>ä¸ä¾èµ–äºè¯­è¨€çš„æ‰§è¡Œæ¨¡å‹</strong>ï¼Œä¹Ÿç§°ä½œå¹¶è¡Œï¼ˆParallelï¼‰æ‰§è¡Œæ¨¡å‹ã€‚å…¶å…è®¸ä¸€ä¸ªç¨‹åºæ§åˆ¶å¤šä¸ªæ—¶é—´é‡å çš„ä¸åŒå·¥ä½œæµã€‚æ¯ä¸ªå·¥ä½œæµå³ä¸ºä¸€ä¸ªçº¿ç¨‹ï¼Œé€šè¿‡è°ƒç”¨ POSIX çº¿ç¨‹ API åˆ›å»ºå¹¶æ§åˆ¶è¿™äº›æµã€‚</p>
</blockquote>
<blockquote>
<p>â€“ POSIX çº¿ç¨‹ï¼Œç»´åŸºç™¾ç§‘</p>
</blockquote>
<ul>
<li>detached å’Œ joinable</li>
</ul>
<blockquote>
<p>æ— è®ºåœ¨windowsä¸­è¿˜æ˜¯Posixä¸­ï¼Œä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹çš„é»˜è®¤å…³ç³»æ˜¯ï¼šæ— è®ºå­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ä¸å¦ï¼Œä¸€æ—¦ä¸»çº¿ç¨‹æ‰§è¡Œå®Œæ¯•é€€å‡ºï¼Œæ‰€æœ‰å­çº¿ç¨‹æ‰§è¡Œéƒ½ä¼šç»ˆæ­¢ã€‚è¿™æ—¶æ•´ä¸ªè¿›ç¨‹ç»“æŸæˆ–åƒµæ­»ï¼Œéƒ¨åˆ†çº¿ç¨‹ä¿æŒä¸€ç§ç»ˆæ­¢æ‰§è¡Œä½†è¿˜æœªé”€æ¯çš„çŠ¶æ€ï¼Œè€Œè¿›ç¨‹å¿…é¡»åœ¨å…¶æ‰€æœ‰çº¿ç¨‹é”€æ¯åé”€æ¯ï¼Œè¿™æ—¶è¿›ç¨‹å¤„äºåƒµæ­»çŠ¶æ€ã€‚çº¿ç¨‹å‡½æ•°æ‰§è¡Œå®Œæ¯•é€€å‡ºï¼Œæˆ–ä»¥å…¶ä»–éå¸¸æ–¹å¼ç»ˆæ­¢ï¼Œçº¿ç¨‹è¿›å…¥ç»ˆæ­¢æ€ï¼Œä½†æ˜¯ä¸ºçº¿ç¨‹åˆ†é…çš„ç³»ç»Ÿèµ„æºä¸ä¸€å®šé‡Šæ”¾ï¼Œå¯èƒ½åœ¨ç³»ç»Ÿé‡å¯ä¹‹å‰ï¼Œä¸€ç›´éƒ½ä¸èƒ½é‡Šæ”¾ï¼Œç»ˆæ­¢æ€çš„çº¿ç¨‹ï¼Œä»æ—§ä½œä¸ºä¸€ä¸ªçº¿ç¨‹å®ä½“å­˜åœ¨äºæ“ä½œç³»ç»Ÿä¸­ï¼Œä»€ä¹ˆæ—¶å€™é”€æ¯ï¼Œå–å†³äºçº¿ç¨‹å±æ€§ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹é€šå¸¸å®šä¹‰ä»¥ä¸‹ä¸¤ç§å…³ç³»ï¼š</p>
</blockquote>
<blockquote>
<p>1ã€<strong>å¯ä¼šåˆï¼ˆjoinable</strong>ï¼‰ï¼šè¿™ç§å…³ç³»ä¸‹ï¼Œä¸»çº¿ç¨‹éœ€è¦æ˜ç¡®æ‰§è¡Œç­‰å¾…æ“ä½œï¼Œåœ¨å­çº¿ç¨‹ç»“æŸåï¼Œä¸»çº¿ç¨‹çš„ç­‰å¾…æ“ä½œæ‰§è¡Œå®Œæ¯•ï¼Œå­çº¿ç¨‹å’Œä¸»çº¿ç¨‹ä¼šåˆï¼Œè¿™æ—¶ä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œç­‰å¾…æ“ä½œä¹‹åçš„ä¸‹ä¸€æ­¥æ“ä½œã€‚ä¸»çº¿ç¨‹å¿…é¡»ä¼šåˆå¯ä¼šåˆçš„å­çº¿ç¨‹ã€‚åœ¨ä¸»çº¿ç¨‹çš„çº¿ç¨‹å‡½æ•°å†…éƒ¨è°ƒç”¨å­çº¿ç¨‹å¯¹è±¡çš„waitå‡½æ•°å®ç°ï¼Œå³ä½¿å­çº¿ç¨‹èƒ½å¤Ÿåœ¨ä¸»çº¿ç¨‹ä¹‹å‰æ‰§è¡Œå®Œæ¯•ï¼Œè¿›å…¥ç»ˆæ­¢æ€ï¼Œä¹Ÿå¿…é¡»æ‰§è¡Œä¼šåˆæ“ä½œï¼Œå¦åˆ™ï¼Œç³»ç»Ÿæ°¸è¿œä¸ä¼šä¸»åŠ¨é”€æ¯çº¿ç¨‹ï¼Œåˆ†é…ç»™è¯¥çº¿ç¨‹çš„ç³»ç»Ÿèµ„æºä¹Ÿæ°¸è¿œä¸ä¼šé‡Šæ”¾ã€‚</p>
</blockquote>
<blockquote>
<p>2ã€<strong>ç›¸åˆ†ç¦»ï¼ˆdetachedï¼‰</strong>ï¼šè¡¨ç¤ºå­çº¿ç¨‹æ— éœ€å’Œä¸»çº¿ç¨‹ä¼šåˆï¼Œä¹Ÿå°±æ˜¯ç›¸åˆ†ç¦»çš„ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå­çº¿ç¨‹ä¸€æ—¦è¿›å…¥ç»ˆæ­¢çŠ¶æ€ï¼Œè¿™ç§æ–¹å¼å¸¸ç”¨åœ¨çº¿ç¨‹æ•°è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œæœ‰æ—¶è®©ä¸»çº¿ç¨‹é€ä¸ªç­‰å¾…å­çº¿ç¨‹ç»“æŸï¼Œæˆ–è€…è®©ä¸»çº¿ç¨‹å®‰æ’æ¯ä¸ªå­çº¿ç¨‹ç»“æŸçš„ç­‰å¾…é¡ºåºï¼Œæ˜¯å¾ˆå›°éš¾æˆ–ä¸å¯èƒ½çš„ï¼Œæ‰€ä»¥åœ¨å¹¶å‘å­çº¿ç¨‹è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œè¿™ç§æ–¹å¼ä¹Ÿä¼šç»å¸¸ä½¿ç”¨ã€‚</p>
</blockquote>
<blockquote>
<p>åœ¨ä»»ä½•ä¸€ä¸ªæ—¶é—´ç‚¹ä¸Šï¼Œçº¿ç¨‹æ˜¯å¯ç»“åˆï¼ˆjoinableï¼‰æˆ–è€…æ˜¯å¯åˆ†ç¦»çš„ï¼ˆdetachedï¼‰ï¼Œä¸€ä¸ªå¯ç»“åˆçš„çº¿ç¨‹èƒ½å¤Ÿè¢«å…¶ä»–çº¿ç¨‹å›æ”¶èµ„æºå’Œæ€æ­»ï¼Œåœ¨è¢«å…¶ä»–çº¿ç¨‹å›æ”¶ä¹‹å‰ï¼Œå®ƒçš„å­˜å‚¨å™¨èµ„æºå¦‚æ ˆï¼Œæ˜¯ä¸é‡Šæ”¾çš„ï¼Œç›¸åï¼Œä¸€ä¸ªåˆ†ç¦»çš„çº¿ç¨‹æ˜¯ä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹å›æ”¶æˆ–æ€æ­»çš„ï¼Œå®ƒçš„å­˜å‚¨å™¨èµ„æºåœ¨å®ƒç»ˆæ­¢æ—¶ç”±ç³»ç»Ÿè‡ªåŠ¨é‡Šæ”¾ã€‚</p>
</blockquote>
<blockquote>
<p>çº¿ç¨‹çš„åˆ†ç¦»çŠ¶æ€å†³å®šä¸€ä¸ªçº¿ç¨‹ä»¥ä»€ä¹ˆæ ·çš„æ–¹å¼æ¥ç»ˆæ­¢è‡ªå·±ï¼Œåœ¨é»˜è®¤çš„æƒ…å†µä¸‹ï¼Œçº¿ç¨‹æ˜¯éåˆ†ç¦»çŠ¶æ€çš„ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼ŒåŸæœ‰çš„çº¿ç¨‹ç­‰å¾…åˆ›å»ºçš„çº¿ç¨‹ç»“æŸï¼Œåªæœ‰å½“pthread_joinå‡½æ•°è¿”å›æ—¶ï¼Œåˆ›å»ºçš„çº¿ç¨‹æ‰ç®—ç»ˆæ­¢ï¼Œé‡Šæ”¾è‡ªå·±å ç”¨çš„ç³»ç»Ÿèµ„æºï¼Œè€Œåˆ†ç¦»çº¿ç¨‹æ²¡æœ‰è¢«å…¶ä»–çš„çº¿ç¨‹æ‰€ç­‰å¾…ï¼Œè‡ªå·±è¿è¡Œç»“æŸäº†ï¼Œçº¿ç¨‹ä¹Ÿå°±ç»ˆæ­¢äº†ï¼Œé©¬ä¸Šé‡Šæ”¾ç³»ç»Ÿèµ„æºã€‚</p>
</blockquote>
<p>joinable å’Œ detaced å…¶å®æ˜¯ä¸»çº¿ç¨‹ä¸å­çº¿ç¨‹ä¹‹é—´çš„ä¸€ç§å…³ç³»ã€‚app é€€å‡ºåï¼Œdetached çº¿ç¨‹ç›´æ¥è¿›å…¥ç»ˆæ­¢æ€ï¼Œå…¶æ ˆç©ºé—´èµ„æºè¢«ç³»ç»Ÿå›æ”¶ï¼Œä½†æ˜¯ joinable çº¿ç¨‹èµ„æºä¸ä¼šè¢«å›æ”¶ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ app é€€å‡ºçš„æ—¶å€™ä½¿ç”¨ joinable çº¿ç¨‹ä¹Ÿå°±æ˜¯ pthread æ¥åšä¸€äº›ä¿å­˜èµ„æºåˆ°ç£ç›˜çš„æ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œå®Œæ¯•è¦é€€å‡ºä¹‹å‰ï¼Œä¼šå»å¤„ç†joinableçš„çº¿ç¨‹ã€‚</p>
<h3 id="çº¿ç¨‹åˆæ¢"><a href="#çº¿ç¨‹åˆæ¢" class="headerlink" title="çº¿ç¨‹åˆæ¢"></a>çº¿ç¨‹åˆæ¢</h3><h4 id="çº¿ç¨‹å®šä¹‰"><a href="#çº¿ç¨‹å®šä¹‰" class="headerlink" title="çº¿ç¨‹å®šä¹‰"></a>çº¿ç¨‹å®šä¹‰</h4><p>è¦å…ˆäº†è§£ä»€ä¹ˆæ˜¯çº¿ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ä»€ä¹ˆæ˜¯è¿›ç¨‹ã€‚å¯¹äº iOS æ¥è¯´ï¼Œæ¯ä¸€ä¸ª <code>app</code> å…¶å®å°±æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿™ä¸€ç‚¹å’Œ <code>Android</code> æœ‰å¾ˆå¤§çš„åŒºåˆ«ã€‚é™¤äº†å•è¿›ç¨‹ä¹‹å¤–ï¼Œåœ¨æœªè¶Šç‹±ä¹‹å‰ï¼Œæ¯ä¸ª <code>app</code> åªèƒ½è®¿é—®æ¯ä¸ª <code>app</code> è‡ªèº«çš„æ²™ç›’ç¯å¢ƒï¼Œä¸èƒ½è®¿é—®ä¹‹å¤–çš„å†…å®¹ã€‚å¾—ç›Šäºè¿™æ ·çš„è®¾è®¡ï¼Œ<code>iOS</code> æˆä¸ºäº†ä¸–ç•Œä¸Šæœ€å®‰å…¨çš„æ“ä½œç³»ç»Ÿï¼ˆè‹¹æœæ˜¯è¿™ä¹ˆçš„è¯´çš„ğŸ¶ï¼‰ã€‚</p>
<p>ä¸‹é¢ç»™å‡ºè‹¹æœå®˜æ–¹å¯¹äºçº¿ç¨‹çš„å®šä¹‰</p>
<blockquote>
<p>Threads are a relatively lightweight way to implement multiple paths of execution inside of an application.</p>
<p>ã€è¯‘ã€‘çº¿ç¨‹æ˜¯åœ¨åº”ç”¨ç¨‹åºå†…éƒ¨å®ç°å¤šä¸ªæ‰§è¡Œè·¯å¾„çš„ç›¸å¯¹è½»é‡çš„æ–¹æ³•ã€‚</p>
</blockquote>
<blockquote>
<p>From a technical standpoint, a thread is a combination of the kernel-level and application-level data structures needed to manage the execution of code. The kernel-level structures coordinate the dispatching of events to the thread and the preemptive scheduling of the thread on one of the available cores. The application-level structures include the call stack for storing function calls and the structures the application needs to manage and manipulate the threadâ€™s attributes and state.</p>
<p>ã€è¯‘ã€‘ä»æŠ€æœ¯è§’åº¦æ¥çœ‹ï¼Œçº¿ç¨‹æ˜¯ç®¡ç†ä»£ç æ‰§è¡Œæ‰€éœ€çš„<strong>å†…æ ¸çº§å’Œåº”ç”¨ç¨‹åºçº§</strong>æ•°æ®ç»“æ„çš„ç»„åˆã€‚å†…æ ¸è´Ÿè´£çº¿ç¨‹äº‹ä»¶çš„åˆ†å‘å’Œçº¿ç¨‹ä¼˜å…ˆçº§çš„è°ƒåº¦ï¼Œåº”ç”¨å±‚åˆ™è´Ÿè´£å­˜å‚¨çº¿ç¨‹å‡½æ•°ä¸­æ–­æ—¶çš„çŠ¶æ€å’Œå±æ€§çš„å­˜å‚¨æ–¹ä¾¿ä¸‹æ¬¡å†…æ ¸åˆ‡æ¢æ—¶å†ä»å­˜å‚¨çš„åœ°æ–¹è¿è¡Œã€‚</p>
</blockquote>
<p>çº¿ç¨‹çš„å®šä¹‰å¯ä»¥æ€»ç»“ä¸ºä»¥ä¸‹ä¸‰ç‚¹:</p>
<ul>
<li>çº¿ç¨‹æ˜¯è¿›ç¨‹çš„åŸºæœ¬æ‰§è¡Œå•å…ƒï¼Œä¸€ä¸ªè¿›ç¨‹çš„æ‰€æœ‰ä»»åŠ¡éƒ½åœ¨çº¿ç¨‹ä¸­æ‰§è¡Œã€‚</li>
<li>è¿›ç¨‹æƒ³è¦æ‰§è¡Œä»»åŠ¡ï¼Œå¿…é¡»å¾—æœ‰çº¿ç¨‹ï¼Œè¿›ç¨‹è‡³å°‘è¦æœ‰ä¸€æ¡çº¿ç¨‹ã€‚</li>
<li>ç¨‹åºå¯åŠ¨ä¼šé»˜è®¤å¼€å¯ä¸€æ¡çº¿ç¨‹ï¼Œè¿™æ¡çº¿ç¨‹è¢«ç§°ä¸ºä¸»çº¿ç¨‹æˆ– UI çº¿ç¨‹ã€‚</li>
</ul>
<p>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿›ç¨‹çš„å®šä¹‰ï¼š</p>
<ul>
<li>è¿›ç¨‹æ˜¯æŒ‡åœ¨ç³»ç»Ÿä¸­æ­£åœ¨è¿è¡Œçš„ä¸€ä¸ªåº”ç”¨ç¨‹åº</li>
<li>æ¯ä¸ªè¿›ç¨‹ä¹‹é—´æ˜¯ç‹¬ç«‹çš„ï¼Œæ¯ä¸ªè¿›ç¨‹å‡è¿è¡Œåœ¨å…¶ä¸“ç”¨çš„ä¸”å—ä¿æŠ¤çš„å†…å­˜ç©ºé—´å†…</li>
</ul>
<p>è¿™ä¸¤å¥è¯ä¸éš¾ç†è§£ï¼Œåªé’ˆå¯¹äº <code>iOS</code> æ¥è¯´ï¼Œä¸€ä¸ª <code>app</code> å°±æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œè€Œç”±äºæœ‰æ²™ç›’æœºåˆ¶ï¼Œæ¯ä¸ª <code>app</code> æ‰€å¯¹åº”çš„è¿›ç¨‹åªèƒ½è®¿é—®å½“å‰ <code>app</code> æ²™ç›’æ‰€å¯¹åº”çš„å†…å­˜ç©ºé—´ï¼Œæ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚</p>
<p>æˆ‘ä»¬çš„ <code>app</code> åªæœ‰ä¸€æ¡è¿›ç¨‹ï¼Œè€Œçº¿ç¨‹çš„è¯ï¼Œé»˜è®¤åªæœ‰ä¸€æ¡ä¸»çº¿ç¨‹ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å¤šçº¿ç¨‹æŠ€æœ¯æ¥å¼€çº¿ç¨‹ç„¶åå¯åŠ¨çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚è€Œè¿›ç¨‹ä¸çº¿ç¨‹ä¹‹é—´çš„å…³ç³»å¯ä»¥æ€»ç»“ä¸ºä¸‹åˆ—å‡ ç‚¹ï¼š</p>
<ul>
<li>åœ°å€ç©ºé—´ï¼šåŒä¸€è¿›ç¨‹çš„<strong>çº¿ç¨‹å…±äº«æœ¬è¿›ç¨‹</strong>çš„åœ°å€ç©ºé—´ï¼Œè€Œ<strong>è¿›ç¨‹ä¹‹é—´åˆ™æ˜¯ç‹¬ç«‹çš„</strong>åœ°å€ç©ºé—´ã€‚</li>
<li>èµ„æºæ‹¥æœ‰ï¼šåŒä¸€è¿›ç¨‹å†…çš„çº¿ç¨‹å…±äº«æœ¬è¿›ç¨‹çš„èµ„æºå¦‚å†…å­˜ã€I/Oã€CPU ç­‰ï¼Œä½†æ˜¯è¿›ç¨‹ä¹‹é—´èµ„æºæ˜¯ç‹¬ç«‹çš„ã€‚</li>
<li>ä¸€ä¸ªçº¿ç¨‹å´©æºƒåï¼Œåœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ä¸ä¼šå¯¹å…¶å®ƒè¿›ç¨‹äº§ç”Ÿå½±å“ï¼Œä½†æ˜¯ä¸€ä¸ªçº¿ç¨‹å´©æºƒåä¼šå¯¼è‡´æ•´ä¸ªè¿›ç¨‹çš„å´©æºƒï¼Œæ‰€ä»¥å¤šè¿›ç¨‹ç›¸æ¯”å¤šçº¿ç¨‹æ›´åŠ å¥å£®ã€‚</li>
<li>è¿›ç¨‹åˆ‡æ¢æ—¶ï¼Œæ¶ˆè€—çš„èµ„æºå¤§ï¼Œæ•ˆç‡ä½ã€‚æ‰€ä»¥æ¶‰åŠåˆ°é¢‘ç¹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶å€™ï¼Œä½¿ç”¨çº¿ç¨‹è¦å¥½äºè¿›ç¨‹ã€‚åŒæ ·çš„ï¼Œå¦‚æœè¦æ±‚åŒæ—¶è¿›è¡Œä¸”è¦å…±äº«æŸäº›å˜é‡çš„å¹¶å‘æ“ä½œï¼Œåªèƒ½ç”¨çº¿ç¨‹ï¼Œä¸èƒ½ç”¨è¿›ç¨‹ã€‚</li>
<li>æ‰§è¡Œè¿‡ç¨‹ï¼šæ¯ä¸ªç‹¬ç«‹çš„è¿›ç¨‹æœ‰ä¸€ä¸ªç¨‹åºè¿è¡Œçš„å…¥å£ã€é¡ºåºæ‰§è¡Œåºåˆ—å’Œç¨‹åºå…¥å£ã€‚ä½†æ˜¯çº¿ç¨‹ä¸èƒ½ç‹¬ç«‹æ‰§è¡Œï¼Œå¿…é¡»ä¾å­˜äºåº”ç”¨ç¨‹åºä¸­ï¼Œç”±åº”ç”¨ç¨‹åºæä¾›å¤šä¸ªçº¿ç¨‹æ‰§è¡Œæ§åˆ¶ã€‚</li>
<li>çº¿ç¨‹æ˜¯ CPU è°ƒåº¦çš„åŸºæœ¬å•ä½ï¼Œè¿›ç¨‹ä¸æ˜¯ã€‚</li>
</ul>
<h4 id="çº¿ç¨‹ç›¸å…³çš„æœ¯è¯­"><a href="#çº¿ç¨‹ç›¸å…³çš„æœ¯è¯­" class="headerlink" title="çº¿ç¨‹ç›¸å…³çš„æœ¯è¯­"></a>çº¿ç¨‹ç›¸å…³çš„æœ¯è¯­</h4><p>åœ¨æ·±å…¥è®¨è®ºçº¿ç¨‹åŠå…¶æ”¯æŒæŠ€æœ¯ä¹‹å‰ï¼Œæœ‰å¿…è¦å¼„æ¸…æ¥šä¸€äº›åŸºæœ¬æœ¯è¯­ã€‚</p>
<p>å¦‚æœä½ ç†Ÿæ‚‰ <code>UNIX</code> ç³»ç»Ÿï¼Œæœ¯è¯­ <code>ä»»åŠ¡</code> äºè¡¨ç¤ºæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ï¼Œä½†åœ¨æœ¬æ–‡ä¸­å¹¶ä¸æ˜¯è¿™æ ·å®šä¹‰çš„ã€‚</p>
<p>æœ¬æ–‡é‡‡ç”¨çš„æœ¯è¯­å¦‚ä¸‹:</p>
<ul>
<li>æœ¯è¯­ <code>çº¿ç¨‹</code> ç”¨äºæŒ‡ä»£ä»£ç çš„ç‹¬ç«‹æ‰§è¡Œè·¯å¾„ã€‚</li>
<li>æœ¯è¯­ <code>è¿›ç¨‹</code> ç”¨äºæŒ‡ä»£ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå®ƒå¯ä»¥åŒ…å«å¤šä¸ªçº¿ç¨‹ã€‚</li>
<li>æœ¯è¯­ <code>ä»»åŠ¡</code> ç”¨äºæŒ‡ä»£éœ€è¦æ‰§è¡Œçš„å·¥ä½œçš„æŠ½è±¡æ¦‚å¿µã€‚</li>
</ul>
<h4 id="çº¿ç¨‹çš„æ›¿ä»£æ–¹æ¡ˆ"><a href="#çº¿ç¨‹çš„æ›¿ä»£æ–¹æ¡ˆ" class="headerlink" title="çº¿ç¨‹çš„æ›¿ä»£æ–¹æ¡ˆ"></a>çº¿ç¨‹çš„æ›¿ä»£æ–¹æ¡ˆ</h4><p>æ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹ä¼šç»™æˆ‘ä»¬çš„ä»£ç å¸¦æ¥ä¸€å®šçš„<strong>ä¸ç¡®å®šæ€§</strong>ã€‚ç›¸å¯¹æ¥è¯´çº¿ç¨‹å±äº<strong>æŠ½è±¡å±‚æ¬¡æ¯”è¾ƒä½</strong>ä¸”ä½¿ç”¨èµ·æ¥æ¯”è¾ƒéº»çƒ¦çš„ä¸€ç§è®©åº”ç”¨ç¨‹åºæ”¯æŒå¹¶å‘çš„æ–¹æ¡ˆã€‚å¦‚æœä½ å¯¹äºç›´æ¥ä½¿ç”¨çº¿ç¨‹ä¸ç†Ÿæ‚‰çš„è¯ï¼Œé‚£ä¹ˆå¾ˆå®¹æ˜“é‡åˆ°çº¿ç¨‹åŒæ­¥å’Œæ—¶åºé—®é¢˜ï¼Œå…¶ä¸¥é‡æ€§å¯èƒ½ä»ç»†å¾®çš„é—®é¢˜åˆ°åº”ç”¨ç¨‹åºå´©æºƒå’Œç”¨æˆ·æ•°æ®æŸåã€‚</p>
<p>æ‰€ä»¥å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè‹¹æœå®˜æ–¹ç»™å‡ºäº†ä»¥ä¸‹å‡ ç§çº¿ç¨‹çš„æ›¿ä»£æ–¹æ¡ˆ:</p>
<ul>
<li><code>Operation Objects</code>: ä»»åŠ¡å¯¹è±¡(<code>NSOpeartion</code>)æ˜¯ <code>OS X 10.5</code> æ¨å‡ºçš„ä¸€ä¸ªç‰¹æ€§ã€‚é€šè¿‡å°è£…åœ¨å­çº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡ï¼Œéšè—åº•å±‚çš„çº¿ç¨‹ç®¡ç†çš„å…·ä½“ç»†èŠ‚ï¼Œè®©å¼€å‘è€…èšç„¦äºä»»åŠ¡æ‰§è¡Œçš„æœ¬èº«ã€‚é€šå¸¸æ¥è¯´ä»»åŠ¡å¯¹è±¡ä¼šä¸ä»»åŠ¡å¯¹è±¡é˜Ÿåˆ—(<code>NSOperationQueue</code>)ç»“åˆä½¿ç”¨ï¼Œæ¥å®ç°åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ä¸Šä»»åŠ¡çš„æ‰§è¡Œã€‚</li>
<li><code>GCD</code>: <code>OS 10.6</code> æ­£å¼æ¨å‡ºï¼Œ<code>GCD</code> æ˜¯å¦å¤–ä¸€ç§å¯ä»¥è®©å¼€å‘è€…æ— éœ€çŸ¥é“çº¿ç¨‹ç»†èŠ‚è€Œä¸“æ³¨äºä»»åŠ¡æœ¬èº«çš„ä¸€é¡¹æŠ€æœ¯ã€‚é€šè¿‡ä½¿ç”¨ <code>GCD</code>ï¼Œä½ å¯ä»¥å®šä¹‰ä½ éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œç„¶åæŠŠè¿™ä¸ªä»»åŠ¡åŠ å…¥åˆ°ä¸€ä¸ªé˜Ÿåˆ—ä¸­æ¥è®© <code>GCD</code> é€‰æ‹©åœ¨ä¸€ä¸ªåˆé€‚çš„çº¿ç¨‹ä¸Šæ‰§è¡Œè¿™ä¸ªä»»åŠ¡ã€‚é˜Ÿåˆ—è€ƒè™‘äº†å¯ç”¨æ ¸å¿ƒçš„æ•°é‡å’Œå½“å‰è´Ÿè½½ï¼Œè¿™æ ·ä¸ç›´æ¥ä½¿ç”¨çº¿ç¨‹ç›¸æ¯”å¯ä»¥æ›´æœ‰æ•ˆåœ°æ‰§è¡Œä»»åŠ¡ã€‚</li>
<li><code>Idle-time notifications</code>: ç©ºé—²æ—¶é€šçŸ¥ï¼Œå¯¹äºä¼˜å…ˆçº§å’Œå¤æ‚åº¦ç›¸å¯¹æ¥è¯´ä¸é«˜çš„ä»»åŠ¡ï¼Œç©ºé—²æ—¶é€šçŸ¥æŠ€æœ¯å¯ä»¥åœ¨åº”ç”¨ç¨‹åºç©ºé—²æ—¶æ‰§è¡Œä»»åŠ¡ã€‚<code>Cocoa</code> ä½¿ç”¨ <code>NSNotificationQueue</code> æ¥å®ç°è¿™ä¸€æŠ€æœ¯ã€‚ä¸ºäº†è·å¾—ç©ºé—²æ—¶é€šçŸ¥ï¼Œä½ éœ€è¦ä½¿ç”¨ <code>NSPostWhenIdle</code> é€‰é¡¹æ¥å‘ <code>NSNotificationQueue</code> é˜Ÿåˆ—å‘é€é€šçŸ¥ï¼Œç„¶åç›´åˆ° <code>Runloop</code> ç©ºé—²æ—¶ï¼Œé˜Ÿåˆ—æ‰ä¼šæ‰§è¡Œçš„é€šçŸ¥é‡Œé¢çš„å…·ä½“ä»»åŠ¡ã€‚</li>
</ul>
<blockquote>
<p><code>NSNotificationQueue</code> å®˜æ–¹å®šä¹‰</p>
<p>Whereas a notification center distributes notifications when posted, notifications placed into the queue can be delayed until the end of the current pass through the run loop or until the run loop is idle. Duplicate notifications can be coalesced so that only one notification is sent although multiple notifications are posted.</p>
<p>ã€è¯‘ã€‘é€šçŸ¥ä¸­å¿ƒæ”¶åˆ°å‘å‡ºçš„é€šçŸ¥åä¼šå‘åœ¨é€šçŸ¥ä¸­å¿ƒæ³¨å†Œçš„è§‚å¯Ÿè€…åˆ†å‘è¿™äº›é€šçŸ¥ï¼Œè€Œæ·»åŠ åˆ° <code>NSNotificationQueue</code> é˜Ÿåˆ—ä¸­çš„é€šçŸ¥åªä¼šåœ¨ä¸¤ç§æƒ…å†µä¸‹åˆ†å‘å‡ºå»ï¼Œåˆ†åˆ«æ˜¯å½“å‰ <code>Runloop</code> å³å°†é€€å‡ºæˆ–è€… <code>Runloop</code> å¤„äºç©ºé—²çŠ¶æ€æ—¶ã€‚é‡å¤çš„å‘ <code>NSNotificationQueue</code> é˜Ÿåˆ—ä¸­åŠ å…¥é€šçŸ¥ä¼šå¯¼è‡´ç›¸åŒçš„é€šçŸ¥è¢«åˆå¹¶ï¼Œè¿™æ ·åˆ°äº†å‘é€æ—¶æœºï¼Œå¯¹äºé‡å¤çš„é€šçŸ¥åªä¼šå‘é€ä¸€æ¡å‡ºå»ã€‚</p>
<p>A notification queue maintains notifications in first in, first out (FIFO) order. When a notification moves to the front of the queue, the queue posts it to the notification center, which in turn dispatches the notification to all objects registered as observers.</p>
<p>ã€è¯‘ã€‘ä¸€ä¸ªé€šçŸ¥é˜Ÿåˆ—ä»¥å…ˆè¿›å…ˆå‡ºçš„æ–¹å¼ç»´æŠ¤ç€é€šçŸ¥ã€‚å½“ä¸€ä¸ªé€šçŸ¥ç§»åŠ¨åˆ°äº†é˜Ÿåˆ—çš„å¤´éƒ¨ï¼Œé˜Ÿåˆ—ä¼šå°†è¿™ä¸ªé€šçŸ¥å‘å¾€é€šçŸ¥ä¸­å¿ƒï¼Œé€šçŸ¥ä¸­å¿ƒå°†é€šçŸ¥åˆ†æ´¾ç»™æ‰€æœ‰æ³¨å†Œä¸ºè§‚å¯Ÿè€…çš„å¯¹è±¡ã€‚</p>
<p>Every thread has a default notification queue, which is associated with the default notification center for the process. You can create your own notification queues and have multiple queues per center and thread.</p>
<p>ã€è¯‘ã€‘æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªé»˜è®¤çš„é€šçŸ¥é˜Ÿåˆ—ï¼Œå¹¶ä¸”è¿™ä¸ªé€šçŸ¥é˜Ÿåˆ—ä¼šä¸å½“å‰è¿›ç¨‹çš„é»˜è®¤çš„é€šçŸ¥ä¸­å¿ƒç›¸å…³è”ã€‚ä½†æ˜¯ä½ å¯ä»¥åˆ›å»ºè‡ªå·±çš„é€šçŸ¥é˜Ÿåˆ—ï¼Œä½¿å¾—æ¯ä¸ªé€šçŸ¥ä¸­å¿ƒå’Œçº¿ç¨‹æœ‰å¤šæ¡é€šçŸ¥é˜Ÿåˆ—</p>
</blockquote>
<blockquote>
<p>å…³äº <code>NSNotificationQueue</code> çš„æ›´å¤šåº•å±‚ç»†èŠ‚ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç«  <a href="https://www.jianshu.com/p/ce8ea320ec69" target="_blank" rel="noopener">ä¸€æ–‡å…¨è§£iOSé€šçŸ¥æœºåˆ¶</a></p>
</blockquote>
<ul>
<li><code>Asynchronous functions</code>: å¼‚æ­¥çš„å‡½æ•°ã€‚ç³»ç»Ÿè‡ªå¸¦çš„ <code>api</code> åŒ…å«è®¸å¤šå¯ä»¥ä¸ºä½ æä¾›è‡ªåŠ¨å¹¶å‘åŠŸèƒ½çš„å‡½æ•°ã€‚è¿™äº›å‡½æ•°çš„å®ç°ä½ æ— éœ€å…³å¿ƒï¼Œå®ƒä»¬ä¾æ‰˜äºç³»ç»Ÿçš„å®ˆæŠ¤è¿›ç¨‹å’Œè¿›ç¨‹æˆ–è€…ä¼šåˆ›å»ºå­çº¿ç¨‹æ¥æ‰§è¡Œä½ æ‰€éœ€è¦çš„ä»»åŠ¡ã€‚</li>
<li><code>Timers</code>: å®šæ—¶å™¨ã€‚ä½ å¯ä»¥åœ¨åº”ç”¨ç¨‹åºçš„ä¸»çº¿ç¨‹ä¸Šä½¿ç”¨å®šæ—¶å™¨æ¥æ‰§è¡Œå‘¨æœŸæ€§çš„ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡è™½ç„¶çç¢è€Œæ— æ³•ä½¿ç”¨çº¿ç¨‹ï¼Œä½†ä»éœ€è¦å®šæœŸè¿›è¡Œç»´æŠ¤ã€‚</li>
<li><code>Separate processes</code>: å°½ç®¡æ¯”çº¿ç¨‹æ›´é‡ï¼Œä½†æ˜¯åœ¨ä»»åŠ¡ä»…ä¸åº”ç”¨ç¨‹åºæœ‰åˆ‡çº¿å…³ç³»çš„æƒ…å†µä¸‹ï¼Œåˆ›å»ºå•ç‹¬çš„è¿›ç¨‹å¯èƒ½ä¼šå¾ˆæœ‰ç”¨ã€‚ å¦‚æœä»»åŠ¡éœ€è¦å¤§é‡å†…å­˜æˆ–å¿…é¡»ä½¿ç”¨ root ç‰¹æƒæ‰§è¡Œï¼Œåˆ™å¯ä»¥ä½¿ç”¨è¿›ç¨‹ã€‚ ä¾‹å¦‚ï¼Œå½“ 32 ä½åº”ç”¨ç¨‹åºå°†ç»“æœæ˜¾ç¤ºç»™ç”¨æˆ·æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ 64 ä½æœåŠ¡å™¨è¿›ç¨‹æ¥è®¡ç®—å¤§å‹æ•°æ®é›†ã€‚</li>
</ul>
<h4 id="çº¿ç¨‹æ”¯æŒ"><a href="#çº¿ç¨‹æ”¯æŒ" class="headerlink" title="çº¿ç¨‹æ”¯æŒ"></a>çº¿ç¨‹æ”¯æŒ</h4><h5 id="Cocoa-ä¸­çº¿ç¨‹ç›¸å…³çš„æŠ€æœ¯"><a href="#Cocoa-ä¸­çº¿ç¨‹ç›¸å…³çš„æŠ€æœ¯" class="headerlink" title="Cocoa ä¸­çº¿ç¨‹ç›¸å…³çš„æŠ€æœ¯"></a><code>Cocoa</code> ä¸­çº¿ç¨‹ç›¸å…³çš„æŠ€æœ¯</h5><ul>
<li><code>Cocoa Threads</code>: <code>Cocoa</code> ä½¿ç”¨ <code>NSThread</code> æ¥å®ç°çº¿ç¨‹ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œ<code>NSObject</code> è¿˜æä¾›äº†ä¸€æ½å­æ–¹æ³•æ¥æ´¾ç”Ÿçº¿ç¨‹å’Œåœ¨å·²å­˜åœ¨çº¿ç¨‹ä¸Šæ‰§è¡Œä»»åŠ¡ã€‚</li>
<li><code>POSIX threads</code>: <code>POSIX</code> æä¾›äº†åŸºäº <code>C</code> è¯­è¨€çš„ä¸€å¥—åˆ›å»ºçº¿ç¨‹çš„ <code>API</code>ã€‚å¦‚æœä¸æ˜¯åˆ›å»º <code>Cocoa</code> ç¨‹åºï¼Œé‚£ä¹ˆè¿™å°†æ˜¯æœ€å¥½çš„åˆ›å»ºçº¿ç¨‹çš„æ–¹æ¡ˆã€‚<code>POSIX</code> æ¥å£ä½¿ç”¨èµ·æ¥éå¸¸ç®€å•ï¼Œå¹¶ä¸”ä¸ºé…ç½®çº¿ç¨‹æä¾›äº†è¶³å¤Ÿçš„çµæ´»æ€§</li>
<li><code>Multiprocessing Services</code>: å¤šå¤„ç†æœåŠ¡æ˜¯ä»æ—§ç‰ˆ <code>Mac OS</code> è¿‡æ¸¡åˆ°çš„åº”ç”¨ç¨‹åºä½¿ç”¨çš„åŸºäº <code>C</code> çš„æ—§æ¥å£ã€‚æ­¤æŠ€æœ¯ä»…åœ¨ <code>OS X</code> ä¸­å¯ç”¨ï¼Œä»»ä½•æ–°å¼€å‘éƒ½åº”é¿å…ä½¿ç”¨ã€‚</li>
</ul>
<p>çº¿ç¨‹å¯åŠ¨ä¹‹åï¼Œä¸»è¦ä»¥ä¸‰ç§çŠ¶æ€è¿è¡Œï¼Œåˆ†åˆ«æ˜¯:</p>
<ul>
<li>è¿è¡Œæ€</li>
<li>å°±ç»ªæ€</li>
<li>é˜»å¡æ€</li>
</ul>
<p>å¦‚æœçº¿ç¨‹å½“å‰æœªåœ¨è¿è¡Œæ€ï¼Œåˆ™å®ƒè¦ä¹ˆè¢«é˜»å¡å¹¶ç­‰å¾…è¾“å…¥ï¼Œè¦ä¹ˆå‡†å¤‡è¿è¡Œï¼Œä½†å°šæœªè®¡åˆ’è¿™æ ·åšã€‚çº¿ç¨‹ç»§ç»­åœ¨è¿™äº›çŠ¶æ€ä¹‹é—´æ¥å›ç§»åŠ¨ï¼Œç›´åˆ°æœ€ç»ˆé€€å‡ºå¹¶è¿›å…¥ç»ˆæ­¢çŠ¶æ€ã€‚</p>
<h5 id="Runloop"><a href="#Runloop" class="headerlink" title="Runloop"></a>Runloop</h5><blockquote>
<p>A run loop is a piece of infrastructure used to manage events arriving asynchronously on a thread. A run loop works by monitoring one or more event sources for the thread. As events arrive, the system wakes up the thread and dispatches the events to the run loop, which then dispatches them to the handlers you specify. If no events are present and ready to be handled, the run loop puts the thread to sleep.</p>
<p>ã€è¯‘ã€‘ä¸€ä¸ªè¿è¡Œå¾ªç¯æ˜¯ä¸€ä¸ªå¤„ç†çº¿ç¨‹ä¸Šæ‰€æ¥æ”¶åˆ°çš„å¼‚æ­¥çš„äº‹ä»¶çš„ç»“æ„ã€‚è¿è¡Œå¾ªç¯ç®¡ç†çº¿ç¨‹ä¸Šçš„ä¸€ä¸ªæˆ–å¤šä¸ªäº‹ä»¶æºã€‚å½“äº‹ä»¶åˆ°è¾¾æ—¶ï¼Œç³»ç»Ÿå°†å”¤é†’çº¿ç¨‹å¹¶å°†äº‹ä»¶åˆ†é…ç»™è¿è¡Œå¾ªç¯ï¼Œç„¶åè¿è¡Œå¾ªç¯å°†å…¶åˆ†é…ç»™ä½ æŒ‡å®šçš„å¤„ç†ç¨‹åºã€‚å¦‚æœä¸å­˜åœ¨ä»»ä½•äº‹ä»¶æˆ–æœ‰å¾…å¤„ç†çš„äº‹ä»¶ï¼Œåˆ™è¿è¡Œå¾ªç¯ä¼šå°†çº¿ç¨‹ç½®äºç¡çœ çŠ¶æ€ã€‚</p>
</blockquote>
<blockquote>
<p>You are not required to use a run loop with any threads you create but doing so can provide a better experience for the user. Run loops make it possible to create long-lived threads that use a minimal amount of resources. Because a run loop puts its thread to sleep when there is nothing to do, it eliminates the need for polling, which wastes CPU cycles and prevents the processor itself from sleeping and saving power.</p>
<p>ã€è¯‘ã€‘ä½ ä¸éœ€è¦å¯¹ä½ æ‰€åˆ›å»ºçš„çº¿ç¨‹ä½¿ç”¨è¿è¡Œå¾ªç¯ï¼Œä½†æ˜¯ä½¿ç”¨è¿è¡Œå¾ªç¯å¯ä»¥æé«˜ç”¨æˆ·ä½“éªŒã€‚è¿è¡Œå¾ªç¯å¯ä»¥åˆ›å»ºä½¿ç”¨æœ€å°‘èµ„æºçš„å¸¸é©»çº¿ç¨‹ã€‚å› ä¸ºå½“æ²¡äº‹åšçš„æ—¶å€™ï¼Œè¿è¡Œå¾ªç¯ä¼šè®©çº¿ç¨‹ä¼‘çœ ï¼Œè¿™æ ·å°±ä¸è®¸éœ€è¦é€šè¿‡è½®è¯¢è¿™ç§éœ€è¦æ¶ˆè€— CPU çš„ä½æ•ˆæ“ä½œä»è€ŒèŠ‚èƒ½ã€‚</p>
</blockquote>
<blockquote>
<p>To configure a run loop, all you have to do is launch your thread, get a reference to the run loop object, install your event handlers, and tell the run loop to run. The infrastructure provided by OS X handles the configuration of the main threadâ€™s run loop for you automatically. If you plan to create long-lived secondary threads, however, you must configure the run loop for those threads yourself.</p>
<p>ã€è¯‘ã€‘è¦é…ç½®è¿è¡Œå¾ªç¯ï¼Œä½ è¦åšçš„å°±æ˜¯å¯åŠ¨çº¿ç¨‹ï¼Œè·å–è¿è¡Œå¾ªç¯å¯¹è±¡çš„å¼•ç”¨ï¼Œå®‰è£…äº‹ä»¶å¤„ç†ç¨‹åºï¼Œå¹¶å‘Šè¯‰è¿è¡Œå¾ªç¯è¿è¡Œã€‚ OS X æä¾›çš„åŸºç¡€ç»“æ„ä¼šè‡ªåŠ¨ä¸ºä½ å¤„ç†ä¸»çº¿ç¨‹è¿è¡Œå¾ªç¯çš„ã€‚ä½†æ˜¯ï¼Œå¦‚æœè®¡åˆ’åˆ›å»ºå¯¿å‘½é•¿çš„è¾…åŠ©çº¿ç¨‹ï¼Œåˆ™å¿…é¡»è‡ªå·±ä¸ºè¿™äº›çº¿ç¨‹é…ç½®è¿è¡Œå¾ªç¯ã€‚</p>
</blockquote>
<p>é€šè¿‡ä¸Šé¢å®˜æ–¹æ–‡æ¡£çš„æè¿°ï¼Œrunloop å…¶å®å’Œçº¿ç¨‹æ˜¯ç´§å¯†å…³è”çš„ï¼Œé€šè¿‡ runloop å¯ä»¥è®©å­çº¿ç¨‹ä¸€ç›´å­˜æ´»è€Œä¸è¢«ç³»ç»Ÿå›æ”¶ã€‚åŒæ—¶ï¼Œrunloop è¿˜èƒ½æå‡ç”¨æˆ·ä½“éªŒï¼Œå¯ä»¥é‡å¤çš„åœ¨å­çº¿ç¨‹å·¥ä½œè€Œæ— éœ€ä¸ºäº†æ‰§è¡Œä»»åŠ¡å¤šæ¬¡å¼€åŒæ ·å·¥ä½œå†…å®¹çš„çº¿ç¨‹ã€‚</p>
<h5 id="çº¿ç¨‹åŒæ­¥"><a href="#çº¿ç¨‹åŒæ­¥" class="headerlink" title="çº¿ç¨‹åŒæ­¥"></a>çº¿ç¨‹åŒæ­¥</h5><p>ä½¿ç”¨å¤šçº¿ç¨‹æŠ€æœ¯ä¼šé‡åˆ°å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€ä»½èµ„æºçš„æƒ…å†µï¼Œè€Œå¦‚æœè¿™äº›çº¿ç¨‹åŒæ—¶å°è¯•ä½¿ç”¨æˆ–ä¿®æ”¹èµ„æºï¼Œåˆ™ä¼šå‡ºç°ä¸¥é‡çš„é—®é¢˜ã€‚è§£å†³æ­¤é—®é¢˜çš„åŠæ³•é€šå¸¸æ¥è¯´æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯æ¶ˆé™¤å…±äº«èµ„æºï¼Œè®©æ¯ä¸ªçº¿ç¨‹ç‹¬äº«å…¶ç‰¹æœ‰çš„èµ„æºè¿›è¡Œæ“ä½œã€‚ç¬¬äºŒç§å°±æ˜¯é€šè¿‡ locks(é”), conditions(æ¡ä»¶), atomic operations(åŸå­æ“ä½œ)ç­‰å…¶å®ƒæŠ€æœ¯ã€‚æ˜¾ç„¶ç¬¬äºŒç§æ–¹æ¡ˆä½¿ç”¨é¢‘ç‡æ›´é«˜ã€‚</p>
<p>è‹¹æœå®˜æ–¹ç»™å‡ºäº†å‡ ç§çº¿ç¨‹é—´é€šä¿¡çš„æ–¹å¼ï¼Œç®€å•æ€»ç»“ä¸€ä¸‹å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>ç›´æ¥æ¶ˆæ¯ä¼ é€’</strong>: é€šè¿‡ <code>performSelector</code> çš„ä¸€ç³»åˆ—æ–¹æ³•ï¼Œå¯ä»¥å®ç°ç”±æŸä¸€çº¿ç¨‹æŒ‡å®šåœ¨å¦å¤–çš„çº¿ç¨‹ä¸Šæ‰§è¡Œä»»åŠ¡ã€‚å› ä¸ºä»»åŠ¡çš„æ‰§è¡Œä¸Šä¸‹æ–‡æ˜¯ç›®æ ‡çº¿ç¨‹ï¼Œè¿™ç§æ–¹å¼å‘é€çš„æ¶ˆæ¯å°†ä¼šè‡ªåŠ¨çš„è¢«åºåˆ—åŒ–ã€‚</li>
<li><strong>å…¨å±€å˜é‡ã€å…±äº«å†…å­˜å—å’Œå¯¹è±¡</strong>: åœ¨ä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´ä¼ é€’ä¿¡æ¯çš„å¦ä¸€ç§ç®€å•æ–¹æ³•æ˜¯ä½¿ç”¨å…¨å±€å˜é‡ï¼Œå…±äº«å¯¹è±¡æˆ–å…±äº«å†…å­˜å—ã€‚å°½ç®¡å…±äº«å˜é‡æ—¢å¿«é€Ÿåˆç®€å•ï¼Œä½†æ˜¯å®ƒä»¬æ¯”ç›´æ¥æ¶ˆæ¯ä¼ é€’æ›´è„†å¼±ã€‚å¿…é¡»ä½¿ç”¨é”æˆ–å…¶ä»–åŒæ­¥æœºåˆ¶ä»”ç»†ä¿æŠ¤å…±äº«å˜é‡ï¼Œä»¥ç¡®ä¿ä»£ç çš„æ­£ç¡®æ€§ã€‚ å¦åˆ™å¯èƒ½ä¼šå¯¼è‡´ç«äº‰çŠ¶å†µï¼Œæ•°æ®æŸåæˆ–å´©æºƒã€‚</li>
<li><strong>æ¡ä»¶æ‰§è¡Œ</strong>: æ¡ä»¶æ˜¯ä¸€ç§<strong>åŒæ­¥å·¥å…·</strong>ï¼Œå¯ç”¨äºæ§åˆ¶çº¿ç¨‹ä½•æ—¶æ‰§è¡Œä»£ç çš„ç‰¹å®šéƒ¨åˆ†ã€‚æ‚¨å¯ä»¥å°†æ¡ä»¶è§†ä¸ºå…³å®ˆï¼Œè®©çº¿ç¨‹ä»…åœ¨æ»¡è¶³æŒ‡å®šæ¡ä»¶æ—¶è¿è¡Œã€‚</li>
<li><strong><code>Runloop sources</code></strong>: ä¸€ä¸ªè‡ªå®šä¹‰çš„ <code>Runloop source</code> é…ç½®å¯ä»¥è®©ä¸€ä¸ªçº¿ç¨‹ä¸Šæ”¶åˆ°ç‰¹å®šçš„åº”ç”¨ç¨‹åºæ¶ˆæ¯ã€‚ç”±äº <code>Runloop source</code> æ˜¯äº‹ä»¶é©±åŠ¨çš„ï¼Œå› æ­¤åœ¨æ— äº‹å¯åšæ—¶ï¼Œçº¿ç¨‹ä¼šè‡ªåŠ¨è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œä»è€Œæé«˜äº†çº¿ç¨‹çš„æ•ˆç‡ã€‚</li>
<li><code>Ports and sockets</code>: åŸºäºç«¯å£çš„é€šä¿¡æ˜¯åœ¨ä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´è¿›è¡Œé€šä¿¡çš„ä¸€ç§æ›´ä¸ºå¤æ‚çš„æ–¹æ³•ï¼Œä½†å®ƒä¹Ÿæ˜¯ä¸€ç§éå¸¸å¯é çš„æŠ€æœ¯ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œç«¯å£å’Œå¥—æ¥å­—å¯ç”¨äºä¸å¤–éƒ¨å®ä½“ï¼ˆä¾‹å¦‚å…¶ä»–è¿›ç¨‹å’ŒæœåŠ¡ï¼‰è¿›è¡Œé€šä¿¡ã€‚ä¸ºäº†æé«˜æ•ˆç‡ï¼Œä½¿ç”¨ <code>Runloop source</code> æ¥å®ç°ç«¯å£ï¼Œå› æ­¤å½“ç«¯å£ä¸Šæ²¡æœ‰æ•°æ®ç­‰å¾…æ—¶ï¼Œçº¿ç¨‹å°†è¿›å…¥ç¡çœ çŠ¶æ€ã€‚</li>
<li><strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>: ä¼ ç»Ÿçš„å¤šå¤„ç†æœåŠ¡å®šä¹‰äº†å…ˆè¿›å…ˆå‡ºï¼ˆ<code>FIFO</code>ï¼‰é˜Ÿåˆ—æŠ½è±¡ï¼Œç”¨äºç®¡ç†ä¼ å…¥å’Œä¼ å‡ºæ•°æ®ã€‚å°½ç®¡æ¶ˆæ¯é˜Ÿåˆ—æ—¢ç®€å•åˆæ–¹ä¾¿ï¼Œä½†æ˜¯å®ƒä»¬ä¸å¦‚å…¶ä»–ä¸€äº›é€šä¿¡æŠ€æœ¯é«˜æ•ˆã€‚</li>
<li><strong><code>Cocoa</code> åˆ†å¸ƒå¼å¯¹è±¡</strong>: åˆ†å¸ƒå¼å¯¹è±¡æ˜¯ä¸€ç§ <code>Cocoa</code> æŠ€æœ¯ï¼Œå¯æä¾›åŸºäºç«¯å£çš„é€šä¿¡çš„é«˜çº§å®ç°ã€‚å°½ç®¡å¯ä»¥å°†è¿™ç§æŠ€æœ¯ç”¨äºçº¿ç¨‹é—´é€šä¿¡ï¼Œä½†æ˜¯å¼ºçƒˆå»ºè®®ä¸è¦è¿™æ ·åšï¼Œå› ä¸ºå®ƒä¼šäº§ç”Ÿå¤§é‡å¼€é”€ã€‚åˆ†å¸ƒå¼å¯¹è±¡æ›´é€‚åˆä¸å…¶ä»–è¿›ç¨‹è¿›è¡Œé€šä¿¡ï¼Œå°½ç®¡åœ¨è¿™äº›è¿›ç¨‹ä¹‹é—´è¿›è¡Œäº‹åŠ¡çš„å¼€é”€ä¹Ÿå¾ˆé«˜</li>
</ul>
<h4 id="ä½¿ç”¨çº¿ç¨‹çš„æ³¨æ„ç‚¹"><a href="#ä½¿ç”¨çº¿ç¨‹çš„æ³¨æ„ç‚¹" class="headerlink" title="ä½¿ç”¨çº¿ç¨‹çš„æ³¨æ„ç‚¹"></a>ä½¿ç”¨çº¿ç¨‹çš„æ³¨æ„ç‚¹</h4><ul>
<li>é¿å…æ˜¾å¼çš„åˆ›å»ºçº¿ç¨‹</li>
</ul>
<blockquote>
<p>æ‰‹åŠ¨ç¼–å†™çº¿ç¨‹åˆ›å»ºä»£ç å¾ˆç¹çï¼Œå¹¶ä¸”å¯èƒ½å®¹æ˜“å‡ºé”™ï¼Œå› æ­¤åº”å°½å¯èƒ½é¿å…è¿™æ ·åšã€‚</p>
<p><code>OS X</code> å’Œ <code>iOS</code> é€šè¿‡å…¶ä»– <code>API</code> ä¸ºå¹¶å‘æä¾›éšå¼æ”¯æŒã€‚ä¸å…¶è‡ªå·±åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¸å¦‚è€ƒè™‘ä½¿ç”¨å¼‚æ­¥ <code>API</code>ï¼Œ<code>GCD</code> æˆ–æ“ä½œå¯¹è±¡æ¥å®Œæˆå·¥ä½œã€‚è¿™äº›æŠ€æœ¯å¯ä»¥åœ¨åº•å±‚ä¸ºæ‚¨å®Œæˆä¸çº¿ç¨‹ç›¸å…³çš„å·¥ä½œï¼Œå¹¶ä¸”å¯ä»¥ä¿è¯æ­£ç¡®è¿›è¡Œã€‚æ­¤å¤–ï¼Œ<code>GCD</code> å’Œæ“ä½œå¯¹è±¡ç­‰æŠ€æœ¯æ—¨åœ¨æ ¹æ®å½“å‰ç³»ç»Ÿè´Ÿè½½è°ƒæ•´æ´»åŠ¨çº¿ç¨‹çš„æ•°é‡ï¼Œä»è€Œæ¯”æ‚¨è‡ªå·±çš„ä»£ç æ›´æœ‰æ•ˆåœ°ç®¡ç†çº¿ç¨‹ã€‚</p>
</blockquote>
<ul>
<li>è®©çº¿ç¨‹åˆç†çš„æ‰§è¡Œä»»åŠ¡</li>
</ul>
<blockquote>
<p>å¦‚æœå†³å®šæ‰‹åŠ¨åˆ›å»ºå’Œç®¡ç†çº¿ç¨‹ï¼Œè¯·è®°ä½çº¿ç¨‹ä¼šæ¶ˆè€—å®è´µçš„ç³»ç»Ÿèµ„æºã€‚æ‚¨åº”è¯¥å°½åŠ›ç¡®ä¿åˆ†é…ç»™çº¿ç¨‹çš„æ‰€æœ‰ä»»åŠ¡éƒ½å¯ä»¥é•¿æœŸæœ‰æ•ˆåœ°å·¥ä½œã€‚åŒæ—¶ï¼Œæ‚¨ä¸å¿…æ‹…å¿ƒç»ˆæ­¢èŠ±è´¹å¤§éƒ¨åˆ†ç©ºé—²æ—¶é—´çš„çº¿ç¨‹ã€‚çº¿ç¨‹å ç”¨çš„å†…å­˜éå¸¸å°‘ï¼Œå…¶ä¸­ä¸€äº›æ˜¯ <code>wired memory</code>ï¼Œå› æ­¤é‡Šæ”¾ç©ºé—²çº¿ç¨‹ä¸ä»…æœ‰åŠ©äºå‡å°‘åº”ç”¨ç¨‹åºçš„å†…å­˜å ç”¨ï¼Œè¿˜å¯ä»¥é‡Šæ”¾æ›´å¤šçš„ç‰©ç†å†…å­˜ä¾›å…¶ä»–ç³»ç»Ÿè¿›ç¨‹ä½¿ç”¨ã€‚</p>
</blockquote>
<blockquote>
<p>PS: Mac ä¸­çš„å†…å­˜ä½¿ç”¨å¯ä»¥åˆ†ä¸ºå››å¤§ç±»</p>
<ul>
<li><strong>Wired</strong>(è”åŠ¨): ç³»ç»Ÿæ ¸å¿ƒå ç”¨çš„ï¼Œæ°¸è¿œä¸ä¼šä»ç³»ç»Ÿç‰©ç†å†…å­˜ä¸­é©±é™¤ã€‚</li>
<li><strong>Active</strong>(æ´»è·ƒ): è¡¨ç¤ºè¿™äº›å†…å­˜æ•°æ®æ­£åœ¨ä½¿ç”¨ä¸­ï¼Œæˆ–è€…åˆšè¢«ä½¿ç”¨è¿‡ã€‚</li>
<li><strong>Inactive</strong>(éæ´»è·ƒ): è¡¨ç¤ºè¿™äº›å†…å­˜ä¸­çš„æ•°æ®æ˜¯æœ‰æ•ˆçš„ï¼Œä½†æ˜¯æœ€è¿‘æ²¡æœ‰è¢«ä½¿ç”¨ã€‚</li>
<li><strong>Free</strong>(å¯ç”¨ç©ºé—´): è¡¨ç¤ºè¿™äº›å†…å­˜ä¸­çš„æ•°æ®æ˜¯æ— æ•ˆçš„ï¼Œå³å†…å­˜å‰©ä½™é‡ã€‚</li>
</ul>
</blockquote>
<blockquote>
<p>å¼€å§‹ç»ˆæ­¢ç©ºé—²çº¿ç¨‹ä¹‹å‰ï¼Œåº”å§‹ç»ˆè®°å½•ä¸€ç»„åº”ç”¨ç¨‹åºå½“å‰æ€§èƒ½çš„åŸºå‡†æµ‹é‡å€¼ã€‚ å°è¯•æ›´æ”¹åï¼Œè¯·è¿›è¡Œå…¶ä»–æµ‹é‡ä»¥ç¡®è®¤æ›´æ”¹å®é™…ä¸Šåœ¨æé«˜æ€§èƒ½ï¼Œè€Œä¸æ˜¯æŸå®³æ€§èƒ½ã€‚</p>
</blockquote>
<ul>
<li>é¿å…å…±äº«æ•°æ®ç»“æ„</li>
</ul>
<blockquote>
<p>é¿å…ä¸çº¿ç¨‹ç›¸å…³çš„èµ„æºå†²çªçš„æœ€ç®€å•å’Œå®¹æ˜“çš„æ–¹æ³•æ˜¯ä¸ºç¨‹åºä¸­çš„æ¯ä¸ªçº¿ç¨‹æä¾›æ‰€éœ€æ•°æ®çš„è‡ªå·±çš„å‰¯æœ¬ã€‚å½“æ‚¨æœ€å°åŒ–çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡å’Œèµ„æºäº‰ç”¨æ—¶ï¼Œå¹¶è¡Œä»£ç æœ€æœ‰æ•ˆã€‚</p>
</blockquote>
<ul>
<li>çº¿ç¨‹å’Œç”¨æˆ·ç•Œé¢</li>
</ul>
<blockquote>
<p>å¦‚æœä½ çš„åº”ç”¨æœ‰å›¾å½¢åŒ–çš„ç”¨æˆ·ç•Œé¢ï¼Œå¼ºçƒˆå»ºè®®åœ¨åº”ç”¨ç¨‹åºçš„ä¸»çº¿ç¨‹ä¸Šæ¥æ”¶ç”¨æˆ·ç›¸å…³çš„äº‹ä»¶å’Œå¯åŠ¨ç•Œé¢æ›´æ–°çš„æ“ä½œã€‚è¿™ç§æ–¹æ³•æœ‰åŠ©äºé¿å…ä¸å¤„ç†ç”¨æˆ·äº‹ä»¶å’Œç»˜åˆ¶çª—å£å†…å®¹ç›¸å…³çš„åŒæ­¥é—®é¢˜ã€‚æŸäº›æ¡†æ¶ï¼ˆä¾‹å¦‚ <code>Cocoa</code>ï¼‰é€šå¸¸éœ€è¦æ­¤è¡Œä¸ºï¼Œä½†æ˜¯å³ä½¿å¯¹äºé‚£äº›ä¸éœ€è¦çš„æ¡†æ¶ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸Šä¿ç•™æ­¤è¡Œä¸ºä¹Ÿå…·æœ‰ç®€åŒ–ç®¡ç†ç”¨æˆ·ç•Œé¢çš„é€»è¾‘çš„ä¼˜åŠ¿ã€‚</p>
</blockquote>
<blockquote>
<p>å½“ç„¶ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œåœ¨éä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œå›¾å½¢æ“ä½œæ˜¯æœ‰åŠ©äºæé«˜æ€§èƒ½çš„ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å­çº¿ç¨‹æ¥åˆ›å»ºå’Œå¤„ç†å›¾åƒä»¥åŠæ‰§è¡Œå…¶ä»–ä¸å›¾åƒæœ‰å…³çš„è®¡ç®—æ“ä½œã€‚ä½†æ˜¯é‡åˆ°ä¸ç¡®å®šçš„å›¾å½¢æ“ä½œçš„æ—¶å€™ï¼Œæœ€å¥½åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚</p>
</blockquote>
<ul>
<li>æ³¨æ„çº¿ç¨‹é€€å‡ºæ—¶çš„é—®é¢˜</li>
</ul>
<blockquote>
<p>è¿›ç¨‹ä¸€ç›´è¿è¡Œåˆ°æ‰€æœ‰<strong>éåˆ†ç¦»çº¿ç¨‹</strong>éƒ½é€€å‡ºä¸ºæ­¢ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä»…å°†åº”ç”¨ç¨‹åºçš„ä¸»çº¿ç¨‹åˆ›å»ºä¸º<strong>éåˆ†ç¦»å¼</strong>ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥åˆ›å»º<strong>éåˆ†ç¦»</strong>çš„å­çº¿ç¨‹ã€‚ å½“ç”¨æˆ·é€€å‡ºåº”ç”¨ç¨‹åºæ—¶ï¼Œé€šå¸¸è®¤ä¸ºç«‹å³ç»ˆæ­¢æ‰€æœ‰åˆ†ç¦»çš„çº¿ç¨‹æ˜¯é€‚å½“çš„è¡Œä¸ºï¼Œå› ä¸ºåˆ†ç¦»çš„çº¿ç¨‹å®Œæˆçš„å·¥ä½œè¢«è®¤ä¸ºæ˜¯å¯é€‰çš„ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ çš„åº”ç”¨ç¨‹åºæ­£åœ¨ä½¿ç”¨åå°çº¿ç¨‹å°†æ•°æ®ä¿å­˜åˆ°ç£ç›˜æˆ–æ‰§è¡Œå…¶ä»–å…³é”®å·¥ä½œï¼Œåˆ™å¯èƒ½éœ€è¦å°†è¿™äº›çº¿ç¨‹åˆ›å»ºä¸ºéåˆ†ç¦»çº¿ç¨‹ï¼Œä»¥é˜²æ­¢åœ¨åº”ç”¨ç¨‹åºé€€å‡ºæ—¶ä¸¢å¤±æ•°æ®ã€‚</p>
</blockquote>
<blockquote>
<p>å°†çº¿ç¨‹åˆ›å»ºä¸º<strong>éåˆ†ç¦»çº¿ç¨‹</strong>ï¼ˆä¹Ÿç§°ä¸º<strong>å¯è¿æ¥çº¿ç¨‹</strong>ï¼‰éœ€è¦ä½ è¿›è¡Œé¢å¤–çš„å·¥ä½œã€‚å› ä¸ºå¤§å¤šæ•°é«˜çº§çº¿ç¨‹æŠ€æœ¯é»˜è®¤æƒ…å†µä¸‹éƒ½ä¸åˆ›å»º<strong>å¯è¿æ¥çº¿ç¨‹</strong>ï¼Œæ‰€ä»¥ä½ å¯èƒ½å¿…é¡»ä½¿ç”¨ <code>POSIX API</code> åˆ›å»ºçº¿ç¨‹ã€‚æ­¤å¤–ï¼Œä½ å¿…é¡»åœ¨åº”ç”¨ç¨‹åºçš„ä¸»çº¿ç¨‹ä¸­æ·»åŠ ä»£ç ï¼Œä»¥ä¾¿åœ¨éåˆ†ç¦»çº¿ç¨‹æœ€ç»ˆé€€å‡ºæ—¶åŠ å…¥å®ƒä»¬ã€‚</p>
</blockquote>
<ul>
<li>å¤„ç†å¼‚å¸¸</li>
</ul>
<blockquote>
<p>æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œå¼‚å¸¸å¤„ç†æœºåˆ¶ä¾èµ–äºå½“å‰çš„è°ƒç”¨å †æ ˆæ¥æ‰§è¡Œä»»ä½•å¿…è¦çš„æ¸…é™¤å·¥ä½œã€‚å› ä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„è°ƒç”¨å †æ ˆï¼Œæ‰€ä»¥æ¯ä¸ªçº¿ç¨‹è´Ÿè´£æ•è·è‡ªå·±çš„å¼‚å¸¸ã€‚åœ¨è¾…åŠ©çº¿ç¨‹ä¸­æœªèƒ½æ•è·å¼‚å¸¸ä¸åœ¨ä¸»çº¿ç¨‹ä¸­æœªèƒ½æ•è·å¼‚å¸¸ä¼šæœ‰ç›¸åŒçš„åæœï¼šè¿›ç¨‹ç»ˆæ­¢ã€‚ä½ ä¸èƒ½å°†æœªæ•è·çš„å¼‚å¸¸æŠ›å‡ºåˆ°å¦ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå¤„ç†ã€‚</p>
</blockquote>
<blockquote>
<p>å¦‚æœä½ éœ€è¦åœ¨å½“å‰çº¿ç¨‹ä¸­å°†å¼‚å¸¸æƒ…å†µé€šçŸ¥å¦ä¸€ä¸ªçº¿ç¨‹ï¼ˆä¾‹å¦‚ä¸»çº¿ç¨‹ï¼‰ï¼Œåˆ™åº”æ•è·è¯¥å¼‚å¸¸ï¼Œå¹¶ç®€å•åœ°å‘è¯¥å¦ä¸€ä¸ªçº¿ç¨‹å‘é€ä¸€æ¡æ¶ˆæ¯ï¼ŒæŒ‡å‡ºå‘ç”Ÿäº†ä»€ä¹ˆã€‚ æ ¹æ®æ‚¨çš„æ¨¡å‹å’Œæ‚¨è¦æ‰§è¡Œçš„æ“ä½œï¼Œæ•è·åˆ°å¼‚å¸¸çš„çº¿ç¨‹å¯ä»¥ç»§ç»­å¤„ç†ï¼ˆå¦‚æœå¯èƒ½çš„è¯ï¼‰ï¼Œç­‰å¾…æŒ‡ä»¤æˆ–ç›´æ¥é€€å‡ºã€‚</p>
</blockquote>
<blockquote>
<p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šè‡ªåŠ¨ä¸ºä½ åˆ›å»ºä¸€ä¸ªå¼‚å¸¸å¤„ç†ç¨‹åºã€‚ ä¾‹å¦‚ï¼Œ<code>Objective-C</code> ä¸­çš„<code>@synchronized</code> æŒ‡ä»¤åŒ…å«ä¸€ä¸ªéšå¼å¼‚å¸¸å¤„ç†ç¨‹åºã€‚</p>
</blockquote>
<ul>
<li>å½»åº•çš„é€€å‡ºçº¿ç¨‹</li>
</ul>
<blockquote>
<p>é€€å‡ºçº¿ç¨‹çš„æœ€ä½³æ–¹æ³•è‡ªç„¶æ˜¯è®©çº¿ç¨‹åˆ°è¾¾å…¶ä¸»å…¥å£ç‚¹ä¾‹ç¨‹çš„æœ«å°¾ã€‚å°½ç®¡æœ‰ç«‹å³ç»ˆæ­¢çº¿ç¨‹çš„åŠŸèƒ½ï¼Œä½†è¿™äº›åŠŸèƒ½ä»…åº”ä½œä¸ºæœ€åçš„æ‰‹æ®µä½¿ç”¨ã€‚åœ¨çº¿ç¨‹åˆ°è¾¾å…¶è‡ªç„¶ç»ˆç‚¹ä¹‹å‰ç»ˆæ­¢è¯¥çº¿ç¨‹ä¼šé˜»æ­¢è¯¥çº¿ç¨‹è‡ªèº«çš„æ¸…ç†ã€‚å¦‚æœçº¿ç¨‹å·²åˆ†é…å†…å­˜ï¼Œæ‰“å¼€æ–‡ä»¶æˆ–è·å–å…¶ä»–ç±»å‹çš„èµ„æºï¼Œåˆ™æ‚¨çš„ä»£ç å¯èƒ½æ— æ³•å›æ”¶è¿™äº›èµ„æºï¼Œä»è€Œå¯¼è‡´å†…å­˜æ³„æ¼æˆ–å…¶ä»–æ½œåœ¨é—®é¢˜ã€‚</p>
</blockquote>
<ul>
<li>åº“ä¸­çš„çº¿ç¨‹å®‰å…¨</li>
</ul>
<blockquote>
<p>å°½ç®¡åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜å¯ä»¥æ§åˆ¶åº”ç”¨ç¨‹åºæ˜¯å¦ä½¿ç”¨å¤šçº¿ç¨‹æ‰§è¡Œï¼Œä½†åº“å¼€å‘äººå‘˜ä¸èƒ½ã€‚åœ¨å¼€å‘åº“æ—¶ï¼Œå¿…é¡»å‡è®¾è°ƒç”¨åº”ç”¨ç¨‹åºæ˜¯å¤šçº¿ç¨‹çš„ï¼Œæˆ–è€…å¯ä»¥éšæ—¶åˆ‡æ¢åˆ°å¤šçº¿ç¨‹çš„ã€‚å› æ­¤ï¼Œä½ åº”è¯¥å§‹ç»ˆå¯¹ä»£ç çš„å…³é”®éƒ¨åˆ†ä½¿ç”¨é”ã€‚</p>
</blockquote>
<p>å¯¹äºåº“å¼€å‘äººå‘˜æ¥è¯´ï¼Œä»…å½“åº”ç”¨ç¨‹åºå˜æˆå¤šçº¿ç¨‹æ—¶æ‰åˆ›å»ºé”æ˜¯ä¸æ˜æ™ºçš„ã€‚å¦‚æœä½ éœ€è¦åœ¨æŸä¸ªæ—¶å€™é”å®šä»£ç ï¼Œè¯·åœ¨ä½¿ç”¨åº“çš„æ—©æœŸåˆ›å»º lock å¯¹è±¡ï¼Œæœ€å¥½æ˜¯é€šè¿‡æŸç§æ˜¾å¼è°ƒç”¨æ¥åˆå§‹åŒ–åº“ã€‚å°½ç®¡ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨é™æ€åº“åˆå§‹åŒ–å‡½æ•°æ¥åˆ›å»ºæ­¤ç±»é”ï¼Œä½†åªæœ‰åœ¨æ²¡æœ‰å…¶ä»–æ–¹æ³•æ—¶æ‰å°è¯•è¿™æ ·åšã€‚æ‰§è¡Œåˆå§‹åŒ–å‡½æ•°ä¼šå¢åŠ åŠ è½½åº“æ‰€éœ€çš„æ—¶é—´ï¼Œå¹¶å¯èƒ½å¯¹æ€§èƒ½äº§ç”Ÿä¸åˆ©å½±å“ã€‚</p>
<blockquote>
<p>å§‹ç»ˆè®°ä½åœ¨åº“ä¸­å¹³è¡¡äº’æ–¥é”çš„åŠ é”å’Œè§£é”ã€‚ä½ è¿˜åº”è¯¥è®°ä½å¯¹åº“ä¸­çš„æ•°æ®ç»“æ„åŠ é”ï¼Œè€Œä¸æ˜¯ä¾èµ–è°ƒç”¨ä»£ç æ¥æä¾›çº¿ç¨‹å®‰å…¨çš„ç¯å¢ƒã€‚</p>
<p>å¦‚æœä½ æ­£åœ¨å¼€å‘ <code>Cocoa</code> åº“ï¼Œé‚£ä¹ˆå¦‚æœä½ å¸Œæœ›åœ¨åº”ç”¨ç¨‹åºå˜ä¸ºå¤šçº¿ç¨‹æ—¶å¾—åˆ°é€šçŸ¥ï¼Œåˆ™å¯ä»¥æ³¨å†Œä¸º <code>NSWillBecomeMultiThreadedNotification</code> çš„è§‚å¯Ÿè€…ã€‚ä½†æ˜¯ï¼Œä½ ä¸åº”è¯¥ä¾èµ–äºæ¥æ”¶æ­¤é€šçŸ¥ï¼Œå› ä¸ºå®ƒå¯èƒ½åœ¨è°ƒç”¨åº“ä»£ç ä¹‹å‰è¢«å‘é€ã€‚</p>
</blockquote>
<h3 id="çº¿ç¨‹ç®¡ç†"><a href="#çº¿ç¨‹ç®¡ç†" class="headerlink" title="çº¿ç¨‹ç®¡ç†"></a>çº¿ç¨‹ç®¡ç†</h3><h4 id="çº¿ç¨‹å¼€é”€"><a href="#çº¿ç¨‹å¼€é”€" class="headerlink" title="çº¿ç¨‹å¼€é”€"></a>çº¿ç¨‹å¼€é”€</h4><ul>
<li>å†…æ ¸å±‚çš„æ•°æ®ç»“æ„ï¼šå¼€é”€ä¸º 1KBã€‚è¿™éƒ¨åˆ†ç”¨äºå­˜å‚¨çº¿ç¨‹æ•°æ®ç»“æ„å’Œå±æ€§ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†æ˜¯ä½œä¸ºæœ‰çº¿å†…å­˜åˆ†é…çš„ï¼Œå› æ­¤æ— æ³•åˆ†é¡µåˆ°ç£ç›˜ã€‚</li>
<li>æ ˆç©ºé—´ï¼šiOS ç¨‹åºä¸»çº¿ç¨‹å¼€é”€ä¸º 1MBï¼ŒmacOS ç¨‹åºä¸»çº¿ç¨‹å¼€é”€ä¸º 8MBï¼Œå­çº¿ç¨‹å¼€é”€ä¸º 512KBã€‚</li>
<li>åˆ›å»ºæ—¶é—´ï¼šå¤§çº¦ 90msï¼Œæ­¤å€¼åæ˜ åˆ›å»ºçº¿ç¨‹çš„åˆå§‹è°ƒç”¨ä¸çº¿ç¨‹çš„å…¥å£ç‚¹ä¾‹ç¨‹å¼€å§‹æ‰§è¡Œä¹‹é—´çš„æ—¶é—´ã€‚è¿™äº›æ•°å­—æ˜¯é€šè¿‡åˆ†æåœ¨åŸºäºè‹±ç‰¹å°”çš„ iMac ä¸Šåˆ›å»ºçº¿ç¨‹æ—¶ç”Ÿæˆçš„å¹³å‡å€¼å’Œä¸­å€¼æ¥ç¡®å®šçš„ï¼ŒiMac å…·æœ‰ä¸€ä¸ª 2GHz çš„åŒæ ¸å¤„ç†å™¨å’Œä¸€ä¸ªè¿è¡Œ OSX V10.5 çš„ 1GB RAMã€‚</li>
</ul>
<blockquote>
<p>ç”±äºå…¶åº•å±‚å†…æ ¸æ”¯æŒï¼Œ<code>Operation</code> å¯¹è±¡é€šå¸¸å¯ä»¥æ›´å¿«åœ°åˆ›å»ºçº¿ç¨‹ã€‚å®ƒä»¬ä¸æ˜¯æ¯æ¬¡éƒ½ä»å¤´å¼€å§‹åˆ›å»ºçº¿ç¨‹ï¼Œè€Œæ˜¯ä½¿ç”¨å·²ç»é©»ç•™åœ¨å†…æ ¸ä¸­çš„çº¿ç¨‹æ± æ¥èŠ‚çœåˆ†é…æ—¶é—´ã€‚</p>
</blockquote>
<h4 id="åˆ›å»ºçº¿ç¨‹"><a href="#åˆ›å»ºçº¿ç¨‹" class="headerlink" title="åˆ›å»ºçº¿ç¨‹"></a>åˆ›å»ºçº¿ç¨‹</h4><p>çº¿ç¨‹åˆ›å»ºå‡ºæ¥åå¿…é¡»è¦æ‰§è¡Œä»»åŠ¡æ‰æœ‰æ„ä¹‰ï¼Œä¸‹é¢ä»‹ç»å‡ ç§åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼ã€‚</p>
<h5 id="ä½¿ç”¨-NSThread-åˆ›å»ºçº¿ç¨‹"><a href="#ä½¿ç”¨-NSThread-åˆ›å»ºçº¿ç¨‹" class="headerlink" title="ä½¿ç”¨ NSThread åˆ›å»ºçº¿ç¨‹"></a>ä½¿ç”¨ NSThread åˆ›å»ºçº¿ç¨‹</h5><p>é€šè¿‡ <code>NSThread</code> åˆ›å»ºçº¿ç¨‹æœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<ul>
<li>ä½¿ç”¨ <code>detachNewThreadSelector:toTarget:withObject:</code> ç±»æ–¹æ³•æ¥æ´¾ç”Ÿæ–°çš„çº¿ç¨‹ã€‚</li>
<li>åˆ›å»ºä¸€ä¸ª <code>NSThread</code> å®ä¾‹å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ <code>start</code> æ–¹æ³•ã€‚</li>
</ul>
<blockquote>
<p>è¿™ä¸¤ç§æŠ€æœ¯éƒ½ä¼šåœ¨åº”ç”¨ç¨‹åºä¸­åˆ›å»º<strong>åˆ†ç¦»å¼çº¿ç¨‹</strong>ã€‚åˆ†ç¦»çš„çº¿ç¨‹æ„å‘³ç€å½“çº¿ç¨‹é€€å‡ºæ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å›æ”¶è¯¥çº¿ç¨‹çš„èµ„æºã€‚è¿™ä¹Ÿæ„å‘³ç€æ‚¨çš„ä»£ç ä»¥åä¸å¿…æ˜¾å¼åœ°ä¸çº¿ç¨‹è”æ¥ã€‚</p>
</blockquote>
<p>ä¸‹é¢ç»™å‡ºä¸¤ç§æ–¹å¼çš„å®é™…ç”¨æ³•:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[NSThread detachNewThreadSelector:@selector(myThreadMainMethod:) toTarget:self withObject:nil];</span><br><span class="line"></span><br><span class="line">NSThread* myThread = [[NSThread alloc] initWithTarget:self</span><br><span class="line">                                        selector:@selector(myThreadMainMethod:)</span><br><span class="line">                                        object:nil];</span><br><span class="line">[myThread start];  <span class="comment">// Actually create the thread</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæœ‰ä¸€ä¸ªæ³¨æ„ç‚¹ï¼Œé‡‡ç”¨å®ä¾‹åŒ– <code>NSThread</code> å¯¹è±¡çš„æ–¹å¼ï¼Œåªæœ‰è°ƒç”¨ <code>start</code> æ–¹æ³•åï¼Œåœ¨åº•å±‚çº¿ç¨‹æ‰ä¼šè¢«åˆ›å»ºå‡ºæ¥ã€‚</p>
<p>ä½¿ç”¨ <code>initWithTarget:selector:object:method</code> çš„å¦ä¸€ç§æ–¹æ³•æ˜¯å°† <code>NSThread</code> å­ç±»åŒ–å¹¶é‡å†™å…¶ <code>main</code> æ–¹æ³•ã€‚ä½ å¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•çš„é‡å†™ç‰ˆæœ¬æ¥ä½œä¸ºçº¿ç¨‹çš„ä¸»å…¥å£ç‚¹ã€‚</p>
<p>å¦‚æœä½ æœ‰ä¸€ä¸ªå·²ç»åˆ›å»ºå¥½å¹¶ä¸”åœ¨è¿è¡Œä¸­çš„ <code>NSThread</code> çº¿ç¨‹å¯¹è±¡ï¼Œä½ å¯ä»¥é€šè¿‡ <code>performSelector:onThread:withObject:waitUntilDone:</code> æ–¹æ³•æ¥å‘è¿™ä¸ªçº¿ç¨‹å‘é€æ¶ˆæ¯ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯ <code>NSObject</code> çš„åˆ†ç±»ä¸­çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ„å‘³ç€å‡ ä¹ä»»ä½•å¯¹è±¡éƒ½èƒ½é€‚ç”¨ã€‚ä½¿ç”¨è¿™ä¸ªæ–¹æ³•å‘é€çš„æ¶ˆæ¯å°†ç”±å¦ä¸€ä¸ªçº¿ç¨‹ç›´æ¥æ‰§è¡Œï¼Œä½œä¸ºå…¶æ­£å¸¸è¿è¡Œå¾ªç¯å¤„ç†çš„ä¸€éƒ¨åˆ†ã€‚å½“ç„¶ï¼Œè¿™æ„å‘³ç€ç›®æ ‡çº¿ç¨‹å¿…é¡»åœ¨å…¶è¿è¡Œå¾ªç¯ä¸­è¿è¡Œï¼‰ã€‚åœ¨è¿™è¿‡ç¨‹ä¸­ä½ å¯èƒ½è¿˜éœ€è¦é€‚ç”¨é”æ¥è¿›è¡Œçº¿ç¨‹åŒæ­¥ï¼Œå½“ç„¶ï¼Œè¿™æ¯”é€‚ç”¨åŸºäº port çš„çº¿ç¨‹é—´é€šä¿¡è¦ç®€å•ä¸€äº›ã€‚</p>
<p>è™½ç„¶ <code>performSelector:onThread:withObject:waitUntilDone:</code> æ–¹æ³•ç”¨èµ·æ¥å¾ˆç®€å•ï¼Œä½†æ˜¯å¯¹äºé¢‘ç¹é—´çš„çº¿ç¨‹é€šä¿¡æˆ–æ—¶é—´æ•æ„Ÿç±»çš„ä»»åŠ¡æ‰§è¡Œï¼Œè¯·ä¸è¦ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ã€‚</p>
<h5 id="ä½¿ç”¨-POSIX-åˆ›å»ºçº¿ç¨‹"><a href="#ä½¿ç”¨-POSIX-åˆ›å»ºçº¿ç¨‹" class="headerlink" title="ä½¿ç”¨ POSIX åˆ›å»ºçº¿ç¨‹"></a>ä½¿ç”¨ POSIX åˆ›å»ºçº¿ç¨‹</h5><blockquote>
<p>OS X å’Œ iOS ä¸ºä½¿ç”¨ POSIX çº¿ç¨‹ API åˆ›å»ºçº¿ç¨‹æä¾›äº†åŸºäº C çš„æ”¯æŒã€‚è¿™ç§æŠ€æœ¯å®é™…ä¸Šå¯ä»¥ç”¨äºä»»ä½•ç±»å‹çš„åº”ç”¨ç¨‹åºï¼ˆåŒ…æ‹¬ Cocoa å’Œ Cocoa Touch åº”ç”¨ç¨‹åºï¼‰ï¼Œå¦‚æœæ‚¨ä¸ºå¤šä¸ªå¹³å°ç¼–å†™è½¯ä»¶ï¼Œåˆ™å¯èƒ½æ›´æ–¹ä¾¿ã€‚ç”¨äºåˆ›å»ºçº¿ç¨‹çš„ <code>POSIX</code> ä¾‹ç¨‹è¢«é€‚å½“åœ°è°ƒç”¨ä¸º <code>pthread_create</code>ã€‚</p>
</blockquote>
<p>ä¸‹é¢æ˜¯å¯¹äº <code>pthread_create</code> çš„ç®€å•ä½¿ç”¨ç¤ºä¾‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;assert.h&gt;</span><br><span class="line">#include &lt;pthread.h&gt;</span><br><span class="line"> </span><br><span class="line">&#x2F;&#x2F; çº¿ç¨‹è¦æ‰§è¡Œçš„ä»»åŠ¡ </span><br><span class="line">void* PosixThreadMainRoutine(void* data)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; Do some work here.</span><br><span class="line"> </span><br><span class="line">    return NULL;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">&#x2F;&#x2F; å¯åŠ¨çº¿ç¨‹ </span><br><span class="line">void LaunchThread()</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; çº¿ç¨‹å±æ€§</span><br><span class="line">    pthread_attr_t  attr;</span><br><span class="line">    &#x2F;&#x2F; çº¿ç¨‹å¯¹è±¡</span><br><span class="line">    pthread_t       posixThreadID;</span><br><span class="line">    &#x2F;&#x2F; è¿”å›å€¼</span><br><span class="line">    int             returnVal;</span><br><span class="line"> </span><br><span class="line">    &#x2F;&#x2F; åˆå§‹åŒ–çº¿ç¨‹å±æ€§</span><br><span class="line">    returnVal &#x3D; pthread_attr_init(&amp;attr);</span><br><span class="line">    assert(!returnVal);</span><br><span class="line">    &#x2F;&#x2F; è®¾ç½®çº¿ç¨‹ä¸º detach çŠ¶æ€</span><br><span class="line">    returnVal &#x3D; pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED);</span><br><span class="line">    assert(!returnVal);</span><br><span class="line"> </span><br><span class="line">    &#x2F;&#x2F; åˆ›å»ºçº¿ç¨‹ï¼Œä¼ å…¥å±æ€§å’Œè¦æ‰§è¡Œçš„ä»»åŠ¡</span><br><span class="line">    int     threadError &#x3D; pthread_create(&amp;posixThreadID, &amp;attr, &amp;PosixThreadMainRoutine, NULL);</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; é”€æ¯å±æ€§</span><br><span class="line">    returnVal &#x3D; pthread_attr_destroy(&amp;attr);</span><br><span class="line">    assert(!returnVal);</span><br><span class="line">    if (threadError !&#x3D; 0)</span><br><span class="line">    &#123;</span><br><span class="line">         &#x2F;&#x2F; Report an error.</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…³äº <code>pthread</code> è¯¦ç»†çš„ä½¿ç”¨è¯·å‚è€ƒè¿™ç¯‡æ–‡ç«  <a href="https://kingcos.me/posts/2019/multithreading_techs_in_ios-1/" target="_blank" rel="noopener">iOS å¤šçº¿ç¨‹æŠ€æœ¯å®è·µä¹‹ pthreadsï¼ˆä¸€)</a></p>
<h5 id="ä½¿ç”¨-NSObject-æ´¾ç”Ÿçº¿ç¨‹"><a href="#ä½¿ç”¨-NSObject-æ´¾ç”Ÿçº¿ç¨‹" class="headerlink" title="ä½¿ç”¨ NSObject æ´¾ç”Ÿçº¿ç¨‹"></a>ä½¿ç”¨ NSObject æ´¾ç”Ÿçº¿ç¨‹</h5><p>æ‰€æœ‰ç»§æ‰¿äº <code>NSObject</code> çš„å¯¹è±¡éƒ½å¯ä»¥é€šè¿‡ <code>performSelectorInBackground:withObject:</code> æ¥åœ¨å­çº¿ç¨‹ä¸Šæ‰§è¡Œä»»åŠ¡ã€‚</p>
<p>è¿™ä¸ªæ–¹æ³•åº•å±‚å®é™…ä¸Šæ˜¯è°ƒç”¨çš„ <code>NSThread</code> ç±»æ–¹æ³• <code>detachNewThreadSelector:toTarget:withObject:</code> æ¥åˆ›å»ºçº¿ç¨‹å¹¶æ‰§è¡Œä»»åŠ¡ã€‚</p>
<h5 id="åœ¨-Cocoa-åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨-POSIX-çº¿ç¨‹"><a href="#åœ¨-Cocoa-åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨-POSIX-çº¿ç¨‹" class="headerlink" title="åœ¨ Cocoa åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ POSIX çº¿ç¨‹"></a>åœ¨ <code>Cocoa</code> åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ <code>POSIX</code> çº¿ç¨‹</h5><p>è™½ç„¶åœ¨ <code>Cocoa</code> ä¸­ä½¿ç”¨ <code>NSThread</code> æ˜¯åˆ›å»ºçº¿ç¨‹çš„ä¸»è¦æ–¹å¼ï¼Œä½†æ˜¯å½“éœ€è¦çš„æ—¶å€™ï¼Œè¿˜æ˜¯å¯ä»¥ä½¿ç”¨ <code>POSIX</code> çº¿ç¨‹çš„ã€‚ä½†æ˜¯éœ€è¦éµå®ˆä»¥ä¸‹å‡ ç‚¹:</p>
<ul>
<li><code>Protecting the Cocoa Frameworks</code>: ä¿æŠ¤ <code>Cocoa</code> ä¸­çš„æ¡†æ¶<ul>
<li>å¯¹äºå¤šçº¿ç¨‹åº”ç”¨ç¨‹åºï¼Œ<code>Cocoa</code> æ¡†æ¶ä½¿ç”¨é”å’Œå…¶ä»–å½¢å¼çš„å†…éƒ¨åŒæ­¥æ¥ç¡®ä¿å®ƒä»¬çš„è¡Œä¸ºæ­£ç¡®ã€‚ä½†æ˜¯ï¼Œä¸ºäº†é˜²æ­¢è¿™äº›é”åœ¨å•çº¿ç¨‹æƒ…å†µä¸‹é™ä½æ€§èƒ½ï¼Œåœ¨åº”ç”¨ç¨‹åºä½¿ç”¨ <code>NSThread</code> ç±»ç”Ÿæˆå…¶ç¬¬ä¸€ä¸ªæ–°çº¿ç¨‹ä¹‹å‰ï¼Œ<code>Cocoa</code> ä¸ä¼šåˆ›å»ºè¿™äº›åŒæ­¥çš„å…ƒç´ ã€‚å¦‚æœåªä½¿ç”¨ <code>POSIX</code> çº¿ç¨‹ä¾‹ç¨‹ç”Ÿæˆçº¿ç¨‹ï¼Œ<code>Cocoa</code> å°†ä¸ä¼šæ”¶åˆ°éœ€è¦çŸ¥é“åº”ç”¨ç¨‹åºç°åœ¨æ˜¯å¤šçº¿ç¨‹çš„é€šçŸ¥ã€‚å½“è¿™ç§æƒ…å†µå‘ç”Ÿæ—¶ï¼Œæ¶‰åŠ <code>Cocoa</code> æ¡†æ¶çš„æ“ä½œå¯èƒ½ä¼šç ´ååº”ç”¨ç¨‹åºçš„ç¨³å®šæ€§æˆ–å´©æºƒã€‚</li>
<li>è¦è®© <code>Cocoa</code> çŸ¥é“ä½ æ‰“ç®—ä½¿ç”¨ä¸ªçº¿ç¨‹ï¼Œä½ åªéœ€ä½¿ç”¨ <code>NSThread</code> ç±»ç”Ÿæˆä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶è®©è¯¥çº¿ç¨‹ç«‹å³é€€å‡ºã€‚ä½ çš„çº¿ç¨‹å…¥å£ç‚¹ä¸éœ€è¦åšä»»ä½•äº‹æƒ…ã€‚ä½¿ç”¨ <code>NSThread</code> ç”Ÿæˆä¸€ä¸ªçº¿ç¨‹çš„è¡Œä¸ºå°±è¶³ä»¥ç¡®ä¿ <code>Cocoa</code> æ¡†æ¶æ‰€éœ€çš„é”è¢«æ”¾ç½®åˆ°ä½ã€‚</li>
<li>å¦‚æœä¸ç¡®å®š <code>Cocoa</code> æ˜¯å¦è®¤ä¸ºä½ çš„åº”ç”¨ç¨‹åºæ˜¯å¤šçº¿ç¨‹çš„ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ <code>NSThread</code> çš„ <code>isMultiThreaded</code> æ–¹æ³•è¿›è¡Œæ£€æŸ¥ã€‚</li>
</ul>
</li>
<li>æ··åˆä½¿ç”¨ <code>Cocoa</code> ä¸­çš„é”ä¸ <code>POSIX</code> é”<ul>
<li>åœ¨åŒä¸€ä¸ªåº”ç”¨ç¨‹åºä¸­æ··åˆä½¿ç”¨ <code>POSIX</code> å’Œ <code>Cocoa</code> é”æ˜¯å®‰å…¨çš„ã€‚<code>Cocoa</code> é”å’Œæ¡ä»¶å¯¹è±¡æœ¬è´¨ä¸Šåªæ˜¯ <code>POSIX</code> äº’æ–¥é”å’Œæ¡ä»¶å¯¹è±¡çš„åŒ…è£…ã€‚ä½†æ˜¯ï¼Œå¯¹äºç»™å®šçš„é”ï¼Œå¿…é¡»å§‹ç»ˆä½¿ç”¨ç›¸åŒçš„æ¥å£æ¥åˆ›å»ºå’Œæ“ä½œè¯¥é”ã€‚æ¢å¥è¯è¯´ï¼Œä¸èƒ½ä½¿ç”¨ <code>Cocoa</code> çš„ <code>NSLock</code> å¯¹è±¡æ¥æ“ä½œä½¿ç”¨ <code>pthread_mutex_init</code> å‡½æ•°åˆ›å»ºçš„äº’æ–¥é”å¯¹è±¡ï¼Œåä¹‹äº¦ç„¶ã€‚</li>
</ul>
</li>
</ul>
<h4 id="é…ç½®çº¿ç¨‹å±æ€§"><a href="#é…ç½®çº¿ç¨‹å±æ€§" class="headerlink" title="é…ç½®çº¿ç¨‹å±æ€§"></a>é…ç½®çº¿ç¨‹å±æ€§</h4><p>åœ¨çº¿ç¨‹åˆ›å»ºä¹‹å‰æˆ–è€…ä¹‹åï¼Œä½ å¯èƒ½æƒ³è¦é…ç½®ä¸€äº›çº¿ç¨‹ç›¸å…³çš„å±æ€§ï¼Œå…·ä½“å†…å®¹å¦‚ä¸‹:</p>
<h5 id="é…ç½®çº¿ç¨‹æ‰€å æ ˆç©ºé—´å¤§å°"><a href="#é…ç½®çº¿ç¨‹æ‰€å æ ˆç©ºé—´å¤§å°" class="headerlink" title="é…ç½®çº¿ç¨‹æ‰€å æ ˆç©ºé—´å¤§å°"></a>é…ç½®çº¿ç¨‹æ‰€å æ ˆç©ºé—´å¤§å°</h5><blockquote>
<p>å¯¹äºä½ åˆ›å»ºçš„æ¯ä¸ªæ–°çº¿ç¨‹ï¼Œç³»ç»Ÿéƒ½ä¼šåœ¨è¿›ç¨‹ç©ºé—´ä¸­åˆ†é…ç‰¹å®šæ•°é‡çš„å†…å­˜ï¼Œä»¥å……å½“è¯¥çº¿ç¨‹çš„å †æ ˆã€‚</p>
<p>å †æ ˆç®¡ç†å †æ ˆå¸§ï¼Œçº¿ç¨‹å†…éƒ¨å£°æ˜çš„å±€éƒ¨å˜é‡å°±ä¼šå­˜äºæ­¤å¤„ã€‚</p>
</blockquote>
<p>è¦è®¾ç½®çº¿ç¨‹æ‰€å ç”¨çš„æ ˆç©ºé—´å¤§å°ï¼Œåªèƒ½åœ¨çº¿ç¨‹åˆ›å»ºä¹‹å‰æŒ‡å®šã€‚</p>
<ul>
<li>Cocoa</li>
</ul>
<p>é€šè¿‡å®ä¾‹åŒ– <code>NSThread</code> å¯¹è±¡ï¼Œç„¶ååœ¨è°ƒç”¨ <code>start</code> æ–¹æ³•ä¹‹å‰è°ƒç”¨ <code>setStackSize:</code> æ¥è®¾ç½®æ ˆç©ºé—´å¤§å°ã€‚</p>
<ul>
<li>POSIX</li>
</ul>
<p>åˆ›å»º <code>pthread_attr_t</code> ç»“æ„ä½“å¯¹è±¡ï¼Œç„¶åå°†å…¶ä¼ å…¥ <code>pthread_attr_setstacksize</code> æ–¹æ³•æ¥è®¾ç½®æ ˆå¤§å°ï¼Œç„¶åå°† <code>pthread_attr_t</code> ä¼ å…¥ <code>pthread_create</code> å‡½æ•°æ¥åˆ›å»º POSIX çº¿ç¨‹ã€‚</p>
<h5 id="é…ç½®-TLS"><a href="#é…ç½®-TLS" class="headerlink" title="é…ç½® TLS"></a>é…ç½® TLS</h5><p>æ¯ä¸ªçº¿ç¨‹ä¼šç»´æŠ¤ä¸€ä¸ªé”®å€¼å¯¹çš„å­—å…¸ï¼Œç”¨æ¥åœ¨çº¿ç¨‹æ‰§è¡Œè¿‡ç¨‹ä¸­å­˜å‚¨ä¸€äº›å†…å®¹ï¼Œè¿™ä¸ªå­—å…¸</p>
<p><code>Cocoa</code> å’Œ <code>POSIX</code> ä»¥ä¸åŒçš„æ–¹å¼å­˜å‚¨çº¿ç¨‹å­—å…¸ï¼Œå› æ­¤ä½ ä¸èƒ½æ··åˆå’ŒåŒ¹é…å¯¹è¿™ä¸¤ç§æŠ€æœ¯çš„è°ƒç”¨ã€‚ ä½†æ˜¯ï¼Œåªè¦æ‚¨åœ¨çº¿ç¨‹ä»£ç ä¸­åšæŒä½¿ç”¨ä¸€ç§æŠ€æœ¯ï¼Œæœ€ç»ˆç»“æœåº”è¯¥æ˜¯ç›¸ä¼¼çš„ã€‚åœ¨ <code>Cocoa</code> ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>NSThread</code> å¯¹è±¡çš„ <code>threadDictionary</code> æ–¹æ³•æ¥è·å– <code>TLS</code>ï¼Œä½ å¯ä»¥åœ¨è¯¥å¯¹è±¡ä¸­æ·»åŠ çº¿ç¨‹æ‰€éœ€çš„ä»»ä½•é”®ã€‚åœ¨ <code>POSIX</code> ä¸­ï¼Œä½¿ç”¨ <code>pthread_setspecific</code> å’Œ<code>pthread_getspecific</code> å‡½æ•°æ¥è®¾ç½®å’Œè·å– <code>TLS</code>ã€‚</p>
<h5 id="è®¾ç½®çº¿ç¨‹çš„åˆ†ç¦»çŠ¶æ€"><a href="#è®¾ç½®çº¿ç¨‹çš„åˆ†ç¦»çŠ¶æ€" class="headerlink" title="è®¾ç½®çº¿ç¨‹çš„åˆ†ç¦»çŠ¶æ€"></a>è®¾ç½®çº¿ç¨‹çš„åˆ†ç¦»çŠ¶æ€</h5><p>é€šè¿‡ <code>NSThread</code> åˆ›å»ºçš„çº¿ç¨‹é»˜è®¤æ˜¯åˆ†ç¦»å¼çš„ï¼Œå½“åº”ç”¨ç¨‹åºé€€å‡ºæ—¶ï¼Œè¿™ç§ç±»å‹çš„çº¿ç¨‹ä¹Ÿå°†é€€å‡ºï¼Œæ‰€ä»¥ä¸ºäº†æ‰§è¡Œè¯¸å¦‚åœ¨åº”ç”¨ç¨‹åºé€€å‡ºæ—¶ä¿å­˜æ•°æ®çš„ä»»åŠ¡ï¼Œéœ€è¦åˆ›å»º <code>joinable</code> ç±»å‹çš„çº¿ç¨‹ã€‚è€Œç›®å‰çš„æ–¹æ¡ˆåªæœ‰é€šè¿‡ <code>POSIX</code> æ¥å®ç°ï¼Œé€šè¿‡ <code>pthread_attr_setdetachstate</code> æ–¹æ³•æ¥è®¾ç½® <code>pthread_t</code> çš„å±æ€§æ¥è¾¾åˆ°éåˆ†ç¦»å¼çš„æ•ˆæœã€‚å½“ç„¶ï¼Œå¦‚æœæƒ³æ”¹å˜çº¿ç¨‹çš„çŠ¶æ€ï¼Œå¯ä»¥é€šè¿‡ <code>pthread_attr_setdetachstate</code> æ¥å°†çº¿ç¨‹è®¾ç½®ä¸ºåˆ†ç¦»å¼çš„ã€‚</p>
<h5 id="è®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§"><a href="#è®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§" class="headerlink" title="è®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§"></a>è®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§</h5><p>ä½ æ‰€åˆ›å»ºçš„çº¿ç¨‹éƒ½æœ‰ä¸ä¹‹å…³è”é»˜è®¤çš„ä¼˜å…ˆçº§ï¼Œå†…æ ¸åœ¨è°ƒåº¦çº¿ç¨‹çš„æ—¶å€™ï¼Œä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹ç›¸æ¯”äºä¼˜å…ˆçº§ä½çš„çº¿ç¨‹æ›´æœ‰å¯èƒ½æ€§æ‰§è¡Œã€‚ä½†æ˜¯ä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹å¹¶ä¸èƒ½ä¿è¯æœ‰å›ºå®šçš„è¿è¡Œæ—¶é—´ï¼Œåªæ˜¯æ›´å¯èƒ½è¢«è°ƒåº¦è€Œå·²ã€‚</p>
<blockquote>
<p>It is generally a good idea to leave the priorities of your threads at their default values. Increasing the priorities of some threads also increases the likelihood of starvation among lower-priority threads. If your application contains high-priority and low-priority threads that must interact with each other, the starvation of lower-priority threads may block other threads and create performance bottlenecks</p>
<p>ã€è¯‘ã€‘ é€šå¸¸æœ€å¥½å°†çº¿ç¨‹çš„ä¼˜å…ˆçº§ä¿ç•™ä¸ºé»˜è®¤å€¼ã€‚å¢åŠ æŸäº›çº¿ç¨‹çš„ä¼˜å…ˆçº§ä¹Ÿå¢åŠ äº†ä½ä¼˜å…ˆçº§çº¿ç¨‹ä¹‹é—´å‡ºç°é¥¥é¥¿çš„å¯èƒ½æ€§ã€‚å¦‚æœä½ çš„åº”ç”¨ç¨‹åºåŒ…å«å¿…é¡»ç›¸äº’äº¤äº’çš„é«˜ä¼˜å…ˆçº§å’Œä½ä¼˜å…ˆçº§çº¿ç¨‹ï¼Œåˆ™ä½ä¼˜å…ˆçº§çº¿ç¨‹çš„é¥¥é¥¿å¯èƒ½ä¼šé˜»å¡å…¶ä»–çº¿ç¨‹å¹¶é€ æˆæ€§èƒ½ç“¶é¢ˆã€‚</p>
<p>è¿™é‡Œå¯ä»¥è”æƒ³åˆ°å·²ç»ä¸å†å®‰å…¨çš„è‡ªæ—‹é” OSSpinLockï¼Œå…·ä½“å†…å®¹å‚è§ YYKit ä½œè€…çš„åšæ–‡ <a href="https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/" target="_blank" rel="noopener">ä¸å†å®‰å…¨çš„ OSSpinLock</a></p>
</blockquote>
<p>å¦‚æœä½ ç¡®å®æƒ³ä¿®æ”¹çº¿ç¨‹ä¼˜å…ˆçº§ï¼Œå¯¹äº <code>Cocoa</code> çº¿ç¨‹ï¼Œå¯ä»¥ä½¿ç”¨ <code>NSThread</code> çš„<code>setThreadPriority</code> ç±»æ–¹æ³•è®¾ç½®å½“å‰æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹çš„ä¼˜å…ˆçº§ã€‚å¯¹äº <code>POSIX</code> çº¿ç¨‹ï¼Œä½¿ç”¨ <code>pthread_setschedparam</code> å‡½æ•°ã€‚</p>
<h4 id="ç¼–å†™çº¿ç¨‹å…¥å£æ–¹æ³•"><a href="#ç¼–å†™çº¿ç¨‹å…¥å£æ–¹æ³•" class="headerlink" title="ç¼–å†™çº¿ç¨‹å…¥å£æ–¹æ³•"></a>ç¼–å†™çº¿ç¨‹å…¥å£æ–¹æ³•</h4><blockquote>
<p>åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒOS X ä¸­çº¿ç¨‹çš„å…¥å£ç‚¹ä¾‹ç¨‹çš„ç»“æ„ä¸å…¶ä»–å¹³å°ä¸Šçš„ç›¸åŒã€‚ä½ å¯ä»¥åˆå§‹åŒ–æ•°æ®ç»“æ„ï¼Œè¿›è¡Œä¸€äº›å·¥ä½œæˆ–æœ‰é€‰æ‹©åœ°è®¾ç½®è¿è¡Œå¾ªç¯ï¼Œå¹¶åœ¨çº¿ç¨‹ä»£ç å®Œæˆåè¿›è¡Œæ¸…ç†ã€‚æ ¹æ®ä½ çš„è®¾è®¡ï¼Œç¼–å†™è¾“å…¥ä¾‹ç¨‹æ—¶å¯èƒ½éœ€è¦é‡‡å–ä¸€äº›å…¶ä»–æ­¥éª¤ã€‚</p>
</blockquote>
<ul>
<li>åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± </li>
</ul>
<p>åœ¨ <code>Objective-C</code> æ¡†æ¶ä¸­é“¾æ¥çš„åº”ç”¨ç¨‹åºé€šå¸¸å¿…é¡»åœ¨å…¶<strong>æ¯ä¸ªçº¿ç¨‹ä¸­è‡³å°‘åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± </strong>ã€‚å¦‚æœåº”ç”¨ç¨‹åºä½¿ç”¨ <code>ARC</code>ï¼Œåˆ™è‡ªåŠ¨é‡Šæ”¾æ± å°†æ•è·ä»è¯¥çº¿ç¨‹è‡ªåŠ¨é‡Šæ”¾çš„æ‰€æœ‰å¯¹è±¡ã€‚</p>
<p>ä¸‹é¢çš„ä»£ç æ¼”ç¤ºäº†åœ¨ <code>MRC</code> ä¸‹éœ€è¦åœ¨çº¿ç¨‹å…¥å£æ–¹æ³•é‡Œé¢åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (void)myThreadMainRoutine</span><br><span class="line">&#123;</span><br><span class="line">    NSAutoreleasePool *pool &#x3D; [[NSAutoreleasePool alloc] init]; &#x2F;&#x2F; Top-level pool</span><br><span class="line"> </span><br><span class="line">    &#x2F;&#x2F; Do thread work here.</span><br><span class="line"> </span><br><span class="line">    [pool release];  &#x2F;&#x2F; Release the objects in the pool.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºé¡¶å±‚çš„è‡ªåŠ¨é‡Šæ”¾æ± ç›´åˆ°çº¿ç¨‹é€€å‡ºä¹‹åæ‰ä¼šé‡Šæ”¾å¯¹è±¡ï¼Œæ‰€ä»¥å¸¸é©»çº¿ç¨‹éœ€è¦åˆ›å»ºä¸€äº›é¢å¤–çš„è‡ªåŠ¨é‡Šæ”¾æ± æ¥è¾¾åˆ°ç»å¸¸æ€§çš„æ¸…ç†æ•ˆæœã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨è¿è¡Œå¾ªç¯çš„çº¿ç¨‹å¯èƒ½æ¯æ¬¡é€šè¿‡è¯¥è¿è¡Œå¾ªç¯éƒ½ä¼šåˆ›å»ºå¹¶é‡Šæ”¾ä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± ã€‚é¢‘ç¹é‡Šæ”¾å¯¹è±¡å¯ä»¥é˜²æ­¢åº”ç”¨ç¨‹åºçš„å†…å­˜å ç”¨è¿‡å¤§ï¼Œä»è€Œå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚ ä½†æ˜¯ï¼Œä¸ä»»ä½•ä¸æ€§èƒ½ç›¸å…³çš„è¡Œä¸ºä¸€æ ·ï¼Œä½ åº”è¯¥è¡¡é‡ä»£ç çš„å®é™…æ€§èƒ½ï¼Œå¹¶é€‚å½“è°ƒæ•´è‡ªåŠ¨é‡Šæ”¾æ± çš„ä½¿ç”¨ã€‚</p>
<ul>
<li>è®¾ç½®å¼‚å¸¸å¤„ç†</li>
</ul>
<p>å¦‚æœåœ¨ä½ çš„åº”ç”¨ç¨‹åºé‡Œé¢æ•è·å¹¶æŠ›å‡ºäº†å¼‚å¸¸ï¼Œé‚£ä¹ˆåœ¨çº¿ç¨‹çš„å…¥å£æ–¹æ³•ä¸­ä¹Ÿéœ€è¦åšç›¸åº”çš„å¤„ç†ï¼Œå¦‚æœæœ‰æŠ›å‡ºçš„å¼‚å¸¸åœ¨çº¿ç¨‹å†…éƒ¨æ²¡æœ‰è¢«æ•è·åˆ°å°†ä¼šå¯¼è‡´ç¨‹åºçš„é€€å‡ºã€‚ä½ å¯ä»¥ä½¿ç”¨ <code>C++</code> å’Œ <code>OC</code> é£æ ¼çš„ <code>final-try&amp;catch</code> ä»£ç å—æ¥å¤„ç†ã€‚</p>
<ul>
<li>è®¾ç½® RunLoop</li>
</ul>
<p>åœ¨å­çº¿ç¨‹ä¸Šæ‰§è¡Œä»»åŠ¡çš„æ—¶å€™ï¼Œæœ‰ä¸¤ç§é€‰æ‹©ï¼Œä¸€ç§æ˜¯æ‰§è¡Œå®Œä¹‹åçº¿ç¨‹ä¼šè‡ªåŠ¨é€€å‡ºï¼Œä¸€ç§æ˜¯å¸Œæœ›çº¿ç¨‹å¯ä»¥ä¸€ç›´å­˜æ´»æ¥å¤„ç†ä»»åŠ¡ã€‚ç¬¬ä¸€ç§æ–¹å¼ä¸éœ€è¦é¢å¤–çš„æ“ä½œï¼Œè€Œç¬¬äºŒç§æ–¹å¼åˆ™éœ€è¦ runloop çš„é…åˆã€‚è€Œ <code>iOS</code> å’Œ <code>macOS</code> ä¸­çš„æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰å¯¹åº”çš„ runloop å¯¹è±¡ï¼Œ<code>app</code> çš„ä¸»çº¿ç¨‹å¯åŠ¨ä¹‹åï¼Œå…¶å¯¹åº”çš„ä¸»è¿è¡Œå¾ªç¯ä¹Ÿä¼šè‡ªåŠ¨å¼€å¯ï¼Œä½†æ˜¯å¯¹äºå­çº¿ç¨‹æ¥è¯´ï¼Œåˆ™éœ€è¦æ‰‹åŠ¨å¼€å¯ã€‚</p>
<h4 id="ç»ˆæ­¢çº¿ç¨‹"><a href="#ç»ˆæ­¢çº¿ç¨‹" class="headerlink" title="ç»ˆæ­¢çº¿ç¨‹"></a>ç»ˆæ­¢çº¿ç¨‹</h4><p>é€€å‡ºçº¿ç¨‹çš„å»ºè®®æ–¹æ³•æ˜¯è®©å…¶æ­£å¸¸é€€å‡ºå…¶å…¥å£æ–¹æ³•ã€‚å°½ç®¡ <code>Cocoa</code>ï¼Œ<code>POSIX</code> å’Œ<code>Multiprocessing Services</code> æä¾›äº†ç›´æ¥æ€æ­»çº¿ç¨‹çš„ä¾‹ç¨‹ï¼Œä½†æ˜¯å¼ºçƒˆå»ºè®®ä¸è¦ä½¿ç”¨æ­¤ç±»ä¾‹ç¨‹ã€‚ç›´æ¥æ€æ­»çº¿ç¨‹ä¼šé˜²æ­¢å®ƒè‡ªå·±æ¸…ç†æ‰ä»è€Œå¯¼è‡´çº¿ç¨‹åˆ†é…çš„å†…å­˜å¯èƒ½ä¼šæ³„æ¼ï¼Œçº¿ç¨‹å½“å‰ä½¿ç”¨çš„ä»»ä½•å…¶ä»–èµ„æºå¯èƒ½æ— æ³•æ­£ç¡®æ¸…ç†ï¼Œä»è€Œåœ¨ä»¥åäº§ç”Ÿæ½œåœ¨é—®é¢˜ã€‚</p>
<p>å¦‚æœä½ é¢„è®¡éœ€è¦åœ¨æ“ä½œè¿‡ç¨‹ä¸­ç»ˆæ­¢çº¿ç¨‹ï¼Œåˆ™åº”ä»ä¸€å¼€å§‹å°±è®¾è®¡çº¿ç¨‹ä»¥å“åº”å–æ¶ˆæˆ–é€€å‡ºæ¶ˆæ¯ã€‚å¯¹äºé•¿æ—¶é—´è¿è¡Œçš„æ“ä½œï¼Œè¿™å¯èƒ½æ„å‘³ç€è¦å®šæœŸåœæ­¢å·¥ä½œå¹¶æ£€æŸ¥æ˜¯å¦æ”¶åˆ°æ­¤æ¶ˆæ¯ã€‚å¦‚æœç¡®å®æœ‰æ¶ˆæ¯è¦æ±‚çº¿ç¨‹é€€å‡ºï¼Œåˆ™è¯¥çº¿ç¨‹å°†æœ‰æœºä¼šæ‰§è¡Œæ‰€éœ€çš„æ¸…ç†å¹¶æ­£å¸¸é€€å‡ºï¼›å¦åˆ™ï¼Œå®ƒå¯ä»¥ç®€å•åœ°è¿”å›å·¥ä½œå¹¶å¤„ç†ä¸‹ä¸€ä¸ªæ•°æ®å—ã€‚</p>
<p>ä¸‹é¢æ˜¯é€šè¿‡ runloop ä»¥åŠ threadDictionary æ¥å®ç°å®šæ—¶æ£€æŸ¥æ˜¯å¦è¦é€€å‡ºçº¿ç¨‹çš„ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">- (void)threadMainRoutine</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; æ˜¯å¦è¿˜æœ‰æ›´å¤šå·¥ä½œè¦åš</span><br><span class="line">    BOOL moreWorkToDo &#x3D; YES;</span><br><span class="line">    &#x2F;&#x2F; æ˜¯å¦è¦é€€å‡ºçº¿ç¨‹</span><br><span class="line">    BOOL exitNow &#x3D; NO;</span><br><span class="line">    &#x2F;&#x2F; è·å–å½“å‰çº¿ç¨‹å¯¹åº”çš„ runloop å¯¹è±¡</span><br><span class="line">    NSRunLoop* runLoop &#x3D; [NSRunLoop currentRunLoop];</span><br><span class="line"> </span><br><span class="line">    &#x2F;&#x2F; å°† exitNow å­˜å…¥ threadDictionary ä¸­</span><br><span class="line">    NSMutableDictionary* threadDict &#x3D; [[NSThread currentThread] threadDictionary];</span><br><span class="line">    [threadDict setValue:[NSNumber numberWithBool:exitNow] forKey:@&quot;ThreadShouldExitNow&quot;];</span><br><span class="line"> </span><br><span class="line">    &#x2F;&#x2F; è®¾ç½® runloop çš„è¾“å…¥æº</span><br><span class="line">    [self myInstallCustomInputSource];</span><br><span class="line"> </span><br><span class="line">    while (moreWorkToDo &amp;&amp; !exitNow)</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F; å…·ä½“è¦åšçš„å·¥ä½œ</span><br><span class="line">        &#x2F;&#x2F; å®Œæˆæ—¶æ”¹å˜ moreWorkToDo çš„å€¼</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F; è®© runloop è·‘èµ·æ¥ï¼Œä½†å¦‚æœæ²¡æœ‰è¦è§¦å‘çš„è¾“å…¥æºï¼Œåˆ™ç«‹å³è¶…æ—¶ã€‚</span><br><span class="line">        [runLoop runUntilDate:[NSDate date]];</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F; æ£€æŸ¥è¾“å…¥æºå¤„ç†ç¨‹åºæ˜¯å¦æ›´æ”¹äº† exitNow å€¼</span><br><span class="line">        exitNow &#x3D; [[threadDict valueForKey:@&quot;ThreadShouldExitNow&quot;] boolValue];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yujiusheng.com/2021/05/17/iOS-%E5%BA%95%E5%B1%82-%E7%B1%BB%E6%8B%93%E5%B1%95%E5%92%8C%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="ä¸ªäººæŠ€æœ¯åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jasonçš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/17/iOS-%E5%BA%95%E5%B1%82-%E7%B1%BB%E6%8B%93%E5%B1%95%E5%92%8C%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1/" class="post-title-link" itemprop="url">iOS åº•å±‚ - ç±»æ‹“å±•å’Œå…³è”å¯¹è±¡</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-05-17 13:39:24 / ä¿®æ”¹æ—¶é—´ï¼š14:02:24" itemprop="dateCreated datePublished" datetime="2021-05-17T13:39:24+08:00">2021-05-17</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yujiusheng.com/2021/05/17/iOS-%E5%BA%95%E5%B1%82%E6%8E%A2%E7%B4%A2-%E5%88%86%E7%B1%BB%E7%9A%84%E5%8A%A0%E8%BD%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="ä¸ªäººæŠ€æœ¯åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jasonçš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/17/iOS-%E5%BA%95%E5%B1%82%E6%8E%A2%E7%B4%A2-%E5%88%86%E7%B1%BB%E7%9A%84%E5%8A%A0%E8%BD%BD/" class="post-title-link" itemprop="url">iOS åº•å±‚æ¢ç´¢ - åˆ†ç±»çš„åŠ è½½</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-05-17 11:20:09 / ä¿®æ”¹æ—¶é—´ï¼š13:38:57" itemprop="dateCreated datePublished" datetime="2021-05-17T11:20:09+08:00">2021-05-17</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="åˆæ¢æ‡’åŠ è½½ç±»"><a href="#åˆæ¢æ‡’åŠ è½½ç±»" class="headerlink" title="åˆæ¢æ‡’åŠ è½½ç±»"></a>åˆæ¢æ‡’åŠ è½½ç±»</h3><p>ä¸Šä¸€ç« æˆ‘ä»¬æ¢ç´¢äº† <code>iOS</code> ä¸­ç±»çš„åŠ è½½ï¼Œè®©æˆ‘ä»¬ç®€å•å›é¡¾ä¸€ä¸‹å¤§æ¦‚çš„æµç¨‹ã€‚</p>
<h4 id="ç±»çš„åŠ è½½å›é¡¾"><a href="#ç±»çš„åŠ è½½å›é¡¾" class="headerlink" title="ç±»çš„åŠ è½½å›é¡¾"></a>ç±»çš„åŠ è½½å›é¡¾</h4><ul>
<li><code>libObjc</code> å‘ <code>dyld</code> æ³¨å†Œäº†å›è°ƒ <code>_dyld_objc_notify_register</code>ï¼Œå½“ <code>dyld</code> æŠŠ <code>App</code> ä»¥åŠ <code>App</code> æ‰€ä¾èµ–çš„ä¸€ç³»åˆ— <code>Mach-O</code> é•œåƒåŠ è½½åˆ°å½“å‰ <code>App</code> è¢«åˆ†é…çš„å†…å­˜ç©ºé—´ä¹‹åï¼Œ<code>dyld</code> ä¼šé€šè¿‡ <code>_dyld_objc_notify_mapped</code> ä¹Ÿå°±æ˜¯ <code>map_images</code> æ¥é€šçŸ¥ <code>libObjc</code> æ¥å®Œæˆå…·ä½“çš„åŠ è½½å·¥ä½œï¼Œ<code>map_images</code> è¢«è°ƒç”¨ä¹‹åä¼šæ¥åˆ° <code>_read_images</code></li>
<li><code>_read_images</code><ul>
<li>ä¸»è¦ä¼šè¿›è¡Œç±»çš„åŠ è½½å·¥ä½œï¼Œä¼šæ’å…¥ <strong>æ‰€æœ‰çš„ç±»</strong> åˆ° <code>gdb_objc_realized_classes</code> å“ˆå¸Œè¡¨ä¸­ï¼ˆæ’å…¥æ–¹å¼ä¸º ç±»åä¸º <code>key</code>ï¼Œç±»å¯¹è±¡ä¸º<code>value</code>, ä¸åŒ…æ‹¬é€šè¿‡ <em>å…±äº«ç¼“å­˜</em> é‡Œé¢çš„ç±»ï¼‰ï¼ŒåŒæ—¶è¿˜ä¼šæŠŠç±»æ’å…¥åˆ° <code>allocatedClasses</code> è¿™ä¸ªé›†åˆé‡Œé¢ï¼Œæ³¨æ„ï¼Œ<code>allocatedClasses</code> çš„ç±»å‹ä¸º <code>NXHashTable</code>ï¼Œå¯ä»¥ç±»æ¯”ä¸º <code>NSSet</code>ï¼Œè€Œ <code>gdb_objc_realized_classes</code> çš„ç±»å‹ä¸º <code>NXMapTable</code>ï¼Œå¯ä»¥ç±»æ¯”ä¸º <code>NSDictionary</code></li>
<li>å¯¹æ‰€æœ‰çš„ç±»è¿›è¡Œé‡æ˜ å°„</li>
<li>å°†æ‰€æœ‰çš„ <code>SEL</code> æ’å…¥åˆ° <code>namedSelectors</code> å“ˆå¸Œè¡¨ä¸­(æ’å…¥æ–¹å¼ä¸ºï¼š<code>SEL</code> åç§°ä¸º <code>key</code>ï¼Œ<code>SEL</code> ä¸º<code>value</code>)</li>
<li>ä¿®å¤å‡½æ•°æŒ‡é’ˆé—ç•™</li>
<li>å°†æ‰€æœ‰çš„ <code>Protocol</code> æ’å…¥åˆ° <code>readProtocol</code> å“ˆå¸Œè¡¨ä¸­(æ’å…¥æ–¹å¼ä¸ºï¼š<code>Protocol</code> åç§°ä¸º <code>key</code>ï¼Œ<code>Protocol</code> ä¸º <code>value</code>)</li>
<li>å¯¹æ‰€æœ‰çš„ <code>Protocol</code> åšé‡æ˜ å°„</li>
<li>åˆå§‹åŒ–æ‰€æœ‰çš„<strong>éæ‡’åŠ è½½ç±»</strong>ï¼ŒåŒ…æ‹¬ <code>rw</code> å’Œ <code>ro</code> çš„åˆå§‹åŒ–æ“ä½œ</li>
<li>å¤„ç†æ‰€æœ‰çš„åˆ†ç±»(åŒ…æ‹¬ç±»çš„åˆ†ç±»å’Œå…ƒç±»çš„åˆ†ç±»)</li>
</ul>
</li>
</ul>
<h4 id="æ‡’åŠ è½½ç±»çš„å‘ç°"><a href="#æ‡’åŠ è½½ç±»çš„å‘ç°" class="headerlink" title="æ‡’åŠ è½½ç±»çš„å‘ç°"></a>æ‡’åŠ è½½ç±»çš„å‘ç°</h4><p>æˆ‘ä»¬è¿™ä¸ªæ—¶å€™è§‚å¯Ÿ <code>_read_images</code> æºç è¿™éƒ¨åˆ†çš„æ³¨é‡Š:</p>
<blockquote>
<p>Realize non-lazy classes (for +load methods and static instances)</p>
<p>å®ç°<strong>éæ‡’åŠ è½½</strong>ç±»(å®ç°äº† <code>+load</code> æ–¹æ³•å’Œé™æ€å®ä¾‹)</p>
</blockquote>
<p>ä»€ä¹ˆæ„æ€å‘¢ï¼Œæˆ‘ä»¬è¿™é‡Œå…¶å®æ‰“å°çš„éƒ½æ˜¯æ‰€è°“çš„<strong>éæ‡’åŠ è½½ç±»</strong>ï¼Œè¿™é‡Œé™¤äº†æˆ‘ä»¬è‡ªå·±å®ç°äº† <code>+load</code> æ–¹æ³•çš„ä¸¤ä¸ªç±»ä¹‹å¤–ï¼Œå…¶ä»–çš„å†…å®¹éƒ½æ˜¯ç³»ç»Ÿå†…ç½®çš„ç±»ï¼ŒåŒ…æ‹¬æˆ‘ä»¬ååˆ†ç†Ÿæ‚‰çš„ <code>NSObject</code> ç±»ã€‚é€šè¿‡è¿™é‡Œå…¶å®åè¿‡æ¥æ¨è®ºï¼Œæˆ‘ä»¬æ²¡æœ‰å®ç° <code>+load</code> æ–¹æ³•å°±æ˜¯æ‰€è°“çš„æ‡’åŠ è½½ç±»ï¼Œè¿™ç§ç±»å¹¶ä¸ä¼šåœ¨ <code>_read_images</code>ç¯èŠ‚è¢«åŠ è½½ï¼Œé‚£ä¹ˆåº”è¯¥æ˜¯åœ¨å“ªé‡ŒåŠ è½½å‘¢ï¼Ÿæˆ‘ä»¬ç¨å¾®æ€è€ƒä¸€ä¸‹ï¼Œæˆ‘ä»¬ä¸€èˆ¬ç¬¬ä¸€æ¬¡æ“ä½œä¸€ä¸ªç±»æ˜¯ä¸æ˜¯åœ¨åˆå§‹åŒ–è¿™ä¸ªç±»çš„æ—¶å€™ï¼Œè€Œåˆå§‹åŒ–ç±»ä¸å°±æ˜¯å‘é€<code>alloc</code>æ¶ˆæ¯å—ï¼Œè€Œæ ¹æ®æˆ‘ä»¬å‰é¢æ¢ç´¢æ¶ˆæ¯æŸ¥æ‰¾çš„çŸ¥è¯†ï¼Œåœ¨ç¬¬ä¸€æ¬¡å‘é€æŸä¸ªæ¶ˆæ¯çš„æ—¶å€™ï¼Œæ˜¯æ²¡æœ‰ç¼“å­˜çš„ï¼Œæ‰€ä»¥ä¼šæ¥åˆ°ä¸€ä¸ªéå¸¸é‡è¦çš„æ–¹æ³•å«<code>lookUpImpOrForward</code>ï¼Œæˆ‘ä»¬åœ¨<code>main.m</code>ä¸­<code>LGPerson</code>ç±»åˆå§‹åŒ–çš„åœ°æ–¹å’Œ<code>lookUpImpOrForward</code> å…¥å£å¤„æ‰“ä¸Šæ–­ç‚¹:</p>
<p>Tips: è¿™é‡Œæœ‰ä¸ªå°æŠ€å·§ï¼Œæˆ‘ä»¬å…ˆæ‰“å¼€ <code>main.m</code> æ–‡ä»¶ä¸­çš„æ–­ç‚¹ï¼Œç­‰æ–­ç‚¹æ¥åˆ°äº†æˆ‘ä»¬æƒ³è¦æ¢ç´¢çš„ <code>LGPerson</code> åˆå§‹åŒ–çš„ä½ç½®çš„æ—¶å€™ï¼Œæˆ‘ä»¬å†æ‰“å¼€ <code>lookUpImpOrForward</code> å¤„çš„æ–­ç‚¹ï¼Œè¿™æ ·æ‰èƒ½ç¡®ä¿å½“å‰æ‰§è¡Œ <code>lookUpImpOrForward</code> çš„æ˜¯æˆ‘ä»¬çš„ç ”ç©¶å¯¹è±¡ <code>LGPerson</code></p>
<p>å› ä¸ºæˆ‘ä»¬æ–­ç‚¹çš„ä½ç½®æ˜¯ <code>LGPerson</code> ç±»å‘é€ <code>alloc</code> æ¶ˆæ¯ï¼Œè€Œæ˜¾ç„¶ <code>alloc</code> ä½œä¸ºç±»æ–¹æ³•æ˜¯å­˜å‚¨åœ¨å…ƒç±»ä¸Šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ <code>lookUpImpOrForward</code> çš„ <code>cls</code> å…¶å®æ˜¯ <code>LGPerson</code> å…ƒç±»ã€‚é‚£ä¹ˆ <code>inst</code> å°±åº”è¯¥æ˜¯çœŸæ­£çš„å¯¹è±¡.</p>
<p>æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ï¼Œå¦‚æœç±»æ²¡æœ‰å®ç° <code>load</code> æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»å°±æ˜¯<strong>æ‡’åŠ è½½ç±»</strong>ï¼Œåä¹‹ã€è¿™ä¸ªç±»å¦‚æœå®ç°äº† <code>load</code> æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»å°±æ˜¯<strong>éæ‡’åŠ è½½ç±»</strong>ã€‚</p>
<h4 id="æ‡’åŠ è½½ç±»çš„æµç¨‹"><a href="#æ‡’åŠ è½½ç±»çš„æµç¨‹" class="headerlink" title="æ‡’åŠ è½½ç±»çš„æµç¨‹"></a>æ‡’åŠ è½½ç±»çš„æµç¨‹</h4><p>å…³äº<strong>éæ‡’åŠ è½½ç±»</strong>çš„åŠ è½½æµç¨‹æˆ‘ä»¬å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œæˆ‘ä»¬æ€»ç»“ä¸‹<strong>æ‡’åŠ è½½ç±»</strong>çš„æµç¨‹ï¼š</p>
<ul>
<li>ç±»ç¬¬ä¸€æ¬¡å‘é€æ¶ˆæ¯çš„æ—¶å€™æ˜¯æ²¡æœ‰ç¼“å­˜çš„ï¼Œæ‰€ä»¥ä¼šæ¥åˆ° <code>_class_lookupMethodAndLoadCache3</code> ï¼Œå…³äºè¿™ä¸ªæ–¹æ³•æˆ‘ä»¬åœ¨å‰é¢çš„æ¶ˆæ¯æŸ¥æ‰¾ç« èŠ‚å·²ç»ä»‹ç»è¿‡äº†ï¼Œä¸ç†Ÿæ‚‰çš„åŒå­¦å¯ä»¥å»æŸ¥é˜…ä¸€ä¸‹ã€‚</li>
<li><code>_class_lookupMethodAndLoadCache3</code> ä¼šè°ƒç”¨ <code>lookUpImpOrForward</code> ï¼Œè¿™ä¸ªæ–¹æ³•çš„é‡è¦æ€§åœ¨æˆ‘ä»¬å­¦ä¹  <code>Runtime</code> çš„è¿‡ç¨‹ä¸­ä¸è¨€è€Œå–»</li>
<li><code>lookUpImpOrForward</code> å†…éƒ¨ä¼šè¿›è¡Œä¸€ä¸‹åˆ¤æ–­ï¼Œå¦‚æœ <code>cls</code> æ²¡æœ‰è¢«å®ç°ï¼Œä¼šè°ƒç”¨ <code>realizeClassMaybeSwiftAndLeaveLocked</code> æ–¹æ³•</li>
<li><code>realizeClassMaybeSwiftAndLeaveLocked</code> æ–¹æ³•åˆä¼šè°ƒç”¨ <code>realizeClassMaybeSwiftMaybeRelock</code> æ–¹æ³•</li>
<li><code>realizeClassMaybeSwiftMaybeRelock</code> æ–¹æ³•å†…éƒ¨ä¼šè¿›è¡Œä¸€ä¸‹æ˜¯å¦æ˜¯ <code>Swift</code> çš„åˆ¤æ–­ï¼Œå¦‚æœä¸æ˜¯ <code>Swift</code> ç¯å¢ƒçš„è¯ï¼Œå°±ä¼šæ¥åˆ° <code>realizeClassWithoutSwift</code> ï¼Œä¹Ÿå°±æ˜¯æœ€ç»ˆçš„ç±»çš„åŠ è½½çš„åœ°æ–¹</li>
</ul>
<h3 id="åˆ†ç±»çš„åº•å±‚å®ç°"><a href="#åˆ†ç±»çš„åº•å±‚å®ç°" class="headerlink" title="åˆ†ç±»çš„åº•å±‚å®ç°"></a>åˆ†ç±»çš„åº•å±‚å®ç°</h3><p>åˆ†ç±»ä½œä¸º <code>Objective-C</code> ä¸­å¸¸è§çš„ç‰¹æ€§ï¼Œç›¸ä¿¡å¤§å®¶éƒ½ä¸ä¼šé™Œç”Ÿï¼Œä¸è¿‡åœ¨åº•å±‚å®ƒæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</p>
<h4 id="åˆ†ç±»çš„å®šä¹‰"><a href="#åˆ†ç±»çš„å®šä¹‰" class="headerlink" title="åˆ†ç±»çš„å®šä¹‰"></a>åˆ†ç±»çš„å®šä¹‰</h4><p>æˆ‘ä»¬æ ¹æ® <code>_category_t</code> æ¥åˆ° <code>libObjc</code> æºç ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œä¸è¿‡æˆ‘ä»¬éœ€è¦å»æ‰ä¸€ä¸‹ <code>_category_t</code> çš„ä¸‹åˆ’çº¿ï¼Œç„¶åä¸éš¾æ‰¾åˆ°åˆ†ç±»çœŸæ­£çš„å®šä¹‰æ‰€åœ¨ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">category_t</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">classref_t</span> cls;</span><br><span class="line">    WrappedPtr&lt;<span class="keyword">method_list_t</span>, PtrauthStrip&gt; instanceMethods;</span><br><span class="line">    WrappedPtr&lt;<span class="keyword">method_list_t</span>, PtrauthStrip&gt; classMethods;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">protocol_list_t</span> *<span class="title">protocols</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">property_list_t</span> *<span class="title">instanceProperties</span>;</span></span><br><span class="line">    <span class="comment">// Fields below this point are not always present on disk.</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">property_list_t</span> *_<span class="title">classProperties</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">method_list_t</span> *<span class="title">methodsForMeta</span><span class="params">(<span class="keyword">bool</span> isMeta)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isMeta) <span class="keyword">return</span> classMethods;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> instanceMethods;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">property_list_t</span> *<span class="title">propertiesForMeta</span><span class="params">(<span class="keyword">bool</span> isMeta, struct header_info *hi)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">protocol_list_t</span> *<span class="title">protocolsForMeta</span><span class="params">(<span class="keyword">bool</span> isMeta)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isMeta) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> protocols;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®åˆšæ‰ <code>clang</code> é‡å†™ä¹‹åçš„å†…å®¹ï¼Œæˆ‘ä»¬ä¸éš¾çœ‹å‡º</p>
<ul>
<li><p><code>name</code> : æ˜¯åˆ†ç±»æ‰€å…³è”çš„ç±»ï¼Œä¹Ÿå°±æ˜¯ç±»çš„åå­—ï¼Œè€Œä¸æ˜¯åˆ†ç±»çš„åå­—</p>
</li>
<li><p><code>cls</code> : æˆ‘ä»¬åœ¨å‰é¢å¯ä»¥çœ‹åˆ° <code>clang</code> é‡å†™åè¿™ä¸ªå€¼ä¸º 0ï¼Œä½†æ˜¯åé¢æœ‰æ³¨é‡Šä¸º <code>&amp;OBJC_CLASS_$_LGTeacher</code> ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ç±»å¯¹è±¡çš„å®šä¹‰ï¼Œæ‰€ä»¥è¿™é‡Œå…¶å®å°±æ˜¯æˆ‘ä»¬è¦æ‰©å±•çš„ç±»å¯¹è±¡ï¼Œåªæ˜¯åœ¨ç¼–è¯‘æœŸè¿™ä¸ªå€¼å¹¶ä¸å­˜åœ¨</p>
</li>
<li><p><code>instanceMethods</code> : åˆ†ç±»ä¸Šå­˜å‚¨çš„å®ä¾‹æ–¹æ³•</p>
</li>
<li><p><code>classMethods</code> ï¼šåˆ†ç±»ä¸Šå­˜å‚¨çš„ç±»æ–¹æ³•</p>
</li>
<li><p><code>protocols</code> ï¼šåˆ†ç±»æ‰€å®ç°çš„åè®®</p>
</li>
<li><p><code>instanceProperties</code> ï¼šåˆ†ç±»æ‰€å®šä¹‰çš„å®ä¾‹å±æ€§ï¼Œä¸è¿‡æˆ‘ä»¬ä¸€èˆ¬åœ¨åˆ†ç±»ä¸­æ·»åŠ å±æ€§éƒ½æ˜¯é€šè¿‡å…³è”å¯¹è±¡æ¥å®ç°çš„</p>
</li>
<li><p><code>_classProperties</code>ï¼šåˆ†ç±»æ‰€å®šä¹‰çš„ç±»å±æ€§ã€‚è¿™é‡Œæœ‰ä¸€è¡Œæ³¨é‡Šï¼š</p>
<blockquote>
<p>Fields below this point are not always present on disk.<br>ä¸‹é¢çš„å†…å®¹å¹¶ä¸æ˜¯ä¸€ç›´åœ¨ç£ç›˜ä¸Šä¿å­˜</p>
</blockquote>
</li>
</ul>
<p>ä¹Ÿå°±æ˜¯è¯´ <code>_classProperties</code> å…¶å®æ˜¯ä¸€ä¸ªç§æœ‰å±æ€§ï¼Œä½†å¹¶ä¸æ˜¯ä¸€ç›´éƒ½å­˜åœ¨çš„ã€‚</p>
<h3 id="åˆ†ç±»çš„åŠ è½½"><a href="#åˆ†ç±»çš„åŠ è½½" class="headerlink" title="åˆ†ç±»çš„åŠ è½½"></a>åˆ†ç±»çš„åŠ è½½</h3><p>æˆ‘ä»¬ç°åœ¨çŸ¥é“äº†ç±»åˆ†ä¸ºäº† <code>æ‡’åŠ è½½ç±»</code> å’Œ <code>éæ‡’åŠ è½½ç±»</code> ï¼Œå®ƒä»¬çš„åŠ è½½æ—¶æœºæ˜¯ä¸ä¸€æ ·çš„ï¼Œé‚£ä¹ˆåˆ†ç±»çš„åŠ è½½åˆæ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿæˆ‘ä»¬è¿˜æ˜¯åŒæ ·çš„å…ˆåˆ†ææ²¡æœ‰å®ç° <code>load</code> æ–¹æ³•çš„åˆ†ç±»çš„æƒ…å†µ:</p>
<p>ä½†æ˜¯æˆ‘ä»¬åœ¨åˆ†æå‰ï¼Œè¿˜è¦ææ¸…æ¥šä¸€ç‚¹ï¼Œåˆ†ç±»å¿…é¡»ä¾é™„äºç±»è€Œå­˜åœ¨ï¼Œå¦‚æœåªæœ‰åˆ†ç±»ï¼Œæ²¡æœ‰ç±»ï¼Œé‚£ä¹ˆä»é€»è¾‘ä¸Šæ˜¯è¯´ä¸é€šçš„ï¼Œå°±ç®—å®ç°äº†ï¼Œç¼–è¯‘å™¨ä¹Ÿä¼šå¿½ç•¥æ‰ã€‚è€Œå…³äºç±»æ˜¯æ‡’åŠ è½½è¿˜æ˜¯éæ‡’åŠ è½½çš„ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è¿˜è¦å†ç»†åˆ†ä¸€æ¬¡ã€‚</p>
<ul>
<li>æ‡’åŠ è½½åˆ†ç±»ä¸æ‡’åŠ è½½ç±»</li>
<li>æ‡’åŠ è½½åˆ†ç±»å’Œéæ‡’åŠ è½½ç±»</li>
</ul>
<h4 id="æ²¡æœ‰å®ç°-load-çš„åˆ†ç±»"><a href="#æ²¡æœ‰å®ç°-load-çš„åˆ†ç±»" class="headerlink" title="æ²¡æœ‰å®ç° load çš„åˆ†ç±»"></a>æ²¡æœ‰å®ç° load çš„åˆ†ç±»</h4><h5 id="ä¸æ‡’åŠ è½½ç±»é…åˆåŠ è½½"><a href="#ä¸æ‡’åŠ è½½ç±»é…åˆåŠ è½½" class="headerlink" title="ä¸æ‡’åŠ è½½ç±»é…åˆåŠ è½½"></a>ä¸æ‡’åŠ è½½ç±»é…åˆåŠ è½½</h5><p>æˆ‘ä»¬å…ˆåˆ†æç¬¬ä¸€ç§æƒ…å†µï¼Œä¹Ÿå°±æ˜¯ç±»å’Œåˆ†ç±»éƒ½ä¸å®ç° <code>load</code> æ–¹æ³•çš„æƒ…å†µã€‚<br>é¦–å…ˆï¼Œæ‡’åŠ è½½ç±»çš„æµç¨‹ä¸Šé¢æˆ‘ä»¬å·²ç»æ¢ç´¢è¿‡äº†ï¼Œåœ¨å‘ç±»<strong>ç¬¬ä¸€æ¬¡å‘é€æ¶ˆæ¯</strong>çš„æ—¶å€™ï¼Œæ‡’åŠ è½½ç±»æ‰ä¼šå¼€å§‹åŠ è½½ï¼Œè€Œæ ¹æ®æˆ‘ä»¬ä¸Šä¸€ç« ç±»çš„åŠ è½½æ¢ç´¢å†…å®¹ï¼Œåœ¨ <code>realizeClassWithoutSwift</code> æ–¹æ³•çš„æœ€åæœ‰ä¸€ä¸ª <code>methodizeClass</code> æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢ä¼šæœ‰ä¸€ä¸ª <code>Attach categories</code> çš„åœ°æ–¹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Attach categories.</span></span><br><span class="line"><span class="keyword">if</span> (previously) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isMeta) &#123;</span><br><span class="line">        objc::unattachedCategories.attachToClass(cls, previously,</span><br><span class="line">                                                 ATTACH_METACLASS);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// When a class relocates, categories with class methods</span></span><br><span class="line">        <span class="comment">// may be registered on the class itself rather than on</span></span><br><span class="line">        <span class="comment">// the metaclass. Tell attachToClass to look for those.</span></span><br><span class="line">        objc::unattachedCategories.attachToClass(cls, previously,</span><br><span class="line">                                                 ATTACH_CLASS_AND_METACLASS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">objc::unattachedCategories.attachToClass(cls, cls,</span><br><span class="line">                                         isMeta ? ATTACH_METACLASS : ATTACH_CLASS);</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬è¿›å…¥<code>unattachedCategories</code>çš„<code>attachToClass</code>æ–¹æ³•</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">attachToClass</span><span class="params">(Class cls, Class previously, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line">    ASSERT((flags &amp; ATTACH_CLASS) ||</span><br><span class="line">           (flags &amp; ATTACH_METACLASS) ||</span><br><span class="line">           (flags &amp; ATTACH_CLASS_AND_METACLASS));</span><br><span class="line">    <span class="keyword">auto</span> &amp;<span class="built_in">map</span> = <span class="built_in">get</span>();</span><br><span class="line">    <span class="keyword">auto</span> it = <span class="built_in">map</span>.<span class="built_in">find</span>(previously);</span><br><span class="line">    <span class="keyword">if</span> (it != <span class="built_in">map</span>.<span class="built_in">end</span>()) &#123;</span><br><span class="line">        category_list &amp;<span class="built_in">list</span> = it-&gt;second;</span><br><span class="line">        <span class="keyword">if</span> (flags &amp; ATTACH_CLASS_AND_METACLASS) &#123;</span><br><span class="line">            <span class="keyword">int</span> otherFlags = flags &amp; ~ATTACH_CLASS_AND_METACLASS;</span><br><span class="line">            attachCategories(cls, <span class="built_in">list</span>.<span class="built_in">array</span>(), <span class="built_in">list</span>.count(), otherFlags | ATTACH_CLASS);</span><br><span class="line">            attachCategories(cls-&gt;ISA(), <span class="built_in">list</span>.<span class="built_in">array</span>(), <span class="built_in">list</span>.count(), otherFlags | ATTACH_METACLASS);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            attachCategories(cls, <span class="built_in">list</span>.<span class="built_in">array</span>(), <span class="built_in">list</span>.count(), flags);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">map</span>.erase(it);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯æˆ‘ä»¬æ–­ç‚¹ä¹‹åå‘ç°è¿™ä¸ªæ—¶å€™é€šè¿‡ <code>unattachedCategoriesForClass</code> æ–¹æ³•å¹¶æ²¡æœ‰å–åˆ°åˆ†ç±»ï¼Œæˆ‘ä»¬æ­¤æ—¶ä¸å¦¨é€šè¿‡ <code>LLDB</code> æ‰“å°ä¸€ä¸‹å½“å‰ç±»é‡Œé¢æ˜¯å¦å·²ç»æŠŠåˆ†ç±»çš„å†…å®¹é™„åŠ ä¸Šäº†ã€‚<br>å‰é¢çš„æµç¨‹å¤§å®¶éƒ½å¾ˆç†Ÿæ‚‰äº†ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ <code>cls</code> çš„ <code>rw</code> ä¸­çš„ <code>methods</code> æ˜¯å¦æœ‰å†…å®¹ï¼š</p>
<p>è¿™æ ·è¿›ä¸€æ­¥è¯æ˜äº†ï¼Œå¦‚æœæ˜¯æ‡’åŠ è½½ç±»ï¼Œå¹¶ä¸”åˆ†ç±»ä¹Ÿæ˜¯æ‡’åŠ è½½ï¼Œé‚£ä¹ˆåˆ†ç±»çš„åŠ è½½å¹¶ä¸ä¼šæ¥åˆ° <code>unattachedCategoriesForClass</code> ï¼Œè€Œæ˜¯ç›´æ¥åœ¨ç¼–è¯‘æ—¶åŠ è½½åˆ°äº†ç±»çš„ <code>ro</code> é‡Œé¢ï¼Œç„¶ååœ¨è¿è¡Œæ—¶è¢«æ‹·è´åˆ°äº†ç±»çš„ <code>rw</code> é‡Œé¢ã€‚è¿™ä¸€ç‚¹å¯ä»¥é€šè¿‡ä¸‹é¢çš„ <code>LLDB</code> æ‰“å°æ¥è¯æ˜ã€‚</p>
<h5 id="ä¸éæ‡’åŠ è½½ç±»é…åˆåŠ è½½"><a href="#ä¸éæ‡’åŠ è½½ç±»é…åˆåŠ è½½" class="headerlink" title="ä¸éæ‡’åŠ è½½ç±»é…åˆåŠ è½½"></a>ä¸éæ‡’åŠ è½½ç±»é…åˆåŠ è½½</h5><p>åŒæ ·çš„é“ç†ï¼Œå½“ç±»ä¸ºéæ‡’åŠ è½½ç±»çš„æ—¶å€™ï¼Œèµ°çš„æ˜¯ <code>_read_images</code> é‡Œé¢çš„æµç¨‹ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬çš„æ‡’åŠ è½½åˆ†ç±»æ˜¯åœ¨å“ªåŠ è½½çš„å‘¢ï¼Ÿ</p>
<p>åˆ†ç±»è¿˜æ˜¯ä¸åœ¨è¿™ï¼ŒåŒæ—¶é€šè¿‡ <code>LLDB</code> æ‰“å°ï¼Œå‘ç°åˆ†ç±»çš„æ–¹æ³•å·²ç»åœ¨ç±»çš„ <code>ro</code> é‡Œé¢äº†ï¼Œæ‰€ä»¥è¯´åˆ†ç±»çš„åŠ è½½å…¶å®è·Ÿç±»çš„æ‡’åŠ è½½ä¸å¦å¹¶æ²¡æœ‰å…³ç³»ï¼Œä¹Ÿå°±æ˜¯è¯´æ‡’åŠ è½½çš„åˆ†ç±»éƒ½æ˜¯åœ¨ç¼–è¯‘æ—¶æœŸè¢«åŠ è½½çš„ã€‚</p>
<h4 id="å®ç°äº†-load-çš„åˆ†ç±»"><a href="#å®ç°äº†-load-çš„åˆ†ç±»" class="headerlink" title="å®ç°äº† load çš„åˆ†ç±»"></a>å®ç°äº† load çš„åˆ†ç±»</h4><p>æˆ‘ä»¬å†æ¥ç€åˆ†ä¸‹ä¸‹é¢ä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li>éæ‡’åŠ è½½åˆ†ç±»ä¸æ‡’åŠ è½½ç±»</li>
<li>éæ‡’åŠ è½½åˆ†ç±»å’Œéæ‡’åŠ è½½ç±»</li>
</ul>
<h5 id="ä¸æ‡’åŠ è½½ç±»é…åˆåŠ è½½-1"><a href="#ä¸æ‡’åŠ è½½ç±»é…åˆåŠ è½½-1" class="headerlink" title="ä¸æ‡’åŠ è½½ç±»é…åˆåŠ è½½"></a>ä¸æ‡’åŠ è½½ç±»é…åˆåŠ è½½</h5><p>å…¶å®æ‡’åŠ è½½å’Œéæ‡’åŠ è½½çš„æœ€å¤§åŒºåˆ«å°±æ˜¯åŠ è½½æ˜¯å¦æå‰ï¼Œè€Œå®ç°äº† <code>+load</code> æ–¹æ³•çš„åˆ†ç±»ï¼Œé¢å¯¹çš„æ˜¯æ‡’åŠ è½½çš„ç±»ï¼Œ<br>è€Œæ‡’åŠ è½½çš„ç±»æˆ‘ä»¬å‰é¢å·²ç»çŸ¥é“äº†ï¼Œæ˜¯åœ¨ç¬¬ä¸€æ¬¡å‘é€æ¶ˆæ¯çš„æ—¶å€™æ‰ä¼šè¢«åŠ è½½çš„ï¼Œé‚£æˆ‘ä»¬ç›´æ¥åœ¨<br><code>lookupImpOrForward</code> =&gt; <code>realizeClassMaybeSwiftAndLeaveLocked</code> =&gt; <code>realizeClassMaybeSwiftMaybeRelock</code> =&gt; <code>realizeClassWithoutSwift</code> =&gt; <code>methodizeClass</code> æµç¨‹ä¸­çš„ <code>methodizeClass</code> æ‰“ä¸Šæ–­ç‚¹ï¼Œçœ‹ä¸‹åœ¨è¿™é‡Œåˆ†ç±»ä¼šä¸ä¼šè¢«åŠ è½½ï¼š</p>
<p>è¿™ä¸€æ¬¡é€šè¿‡ <code>unattachedCategoriesForClass</code> å–å‡ºæ¥å€¼äº†ï¼Œå¹¶ä¸”åœ¨è¿™ä¹‹å‰ <code>cls</code> çš„ <code>ro</code> ä¸­å¹¶æ²¡æœ‰åˆ†ç±»çš„ <code>initialize</code> æ–¹æ³•ï¼š</p>
<p>ä¸ºä»€ä¹ˆèµ°çš„ä¸æ˜¯å‘é€æ¶ˆæ¯çš„æµç¨‹ï¼Œè€Œèµ°çš„æ˜¯ <code>load_images</code> é‡Œé¢çš„ <code>prepare_load_methods</code> æ–¹æ³•å‘¢ï¼Ÿæˆ‘ä»¬æ¥åˆ° <code>prepare_load_methods</code> æ–¹æ³•å¤„ï¼š</p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå…¶å®æ˜¯åœ¨è¿™é‡Œè°ƒç”¨äº† <code>realizeClassWithoutSwift</code> æ–¹æ³•æ¥åŠ è½½ç±»çš„ã€‚è€Œä¸Šé¢çš„ <code>_getObjc2NonlazyCategoryList</code> æ–¹æ³•æ˜¾ç¤ºå°±æ˜¯è·å–çš„æ‰€æœ‰çš„éæ‡’åŠ è½½åˆ†ç±»ï¼Œç„¶åéå†è¿™äº›éæ‡’åŠ è½½åˆ†ç±»ï¼Œç„¶åå»åŠ è½½è¿™äº›åˆ†ç±»æ‰€ä¾èµ–çš„ç±»ã€‚è¿™ä¸ªé€»è¾‘å¾ˆå¥½ç†è§£ï¼Œéæ‡’åŠ è½½åˆ†ç±»è®©æˆ‘ä»¬çš„æ‡’åŠ è½½ç±»å®ç°æå‰äº†ï¼Œæ‰€ä»¥è¯´æ‡’åŠ è½½ç±»<strong>å¹¶ä¸ä¸€å®š</strong>åªä¼šåœ¨ç¬¬ä¸€æ¬¡æ¶ˆæ¯å‘é€çš„æ—¶å€™åŠ è½½ï¼Œè¿˜è¦å–å†³äºæœ‰æ²¡æœ‰éæ‡’åŠ è½½çš„åˆ†ç±»ï¼Œå¦‚æœæœ‰éæ‡’åŠ è½½çš„åˆ†ç±»ï¼Œé‚£ä¹ˆå°±èµ°çš„æ˜¯ <code>load_images</code> é‡Œé¢çš„ <code>prepare_load_methods</code> çš„ <code>realizeClassWithoutSwift</code> ã€‚</p>
<h5 id="ä¸éæ‡’åŠ è½½ç±»é…åˆåŠ è½½-1"><a href="#ä¸éæ‡’åŠ è½½ç±»é…åˆåŠ è½½-1" class="headerlink" title="ä¸éæ‡’åŠ è½½ç±»é…åˆåŠ è½½"></a>ä¸éæ‡’åŠ è½½ç±»é…åˆåŠ è½½</h5><p>éæ‡’åŠ è½½ç±»çš„æµç¨‹æˆ‘ä»¬ä¹Ÿååˆ†ç†Ÿæ‚‰äº†ï¼Œåœ¨ <code>_read_images</code> é‡Œé¢è¿›è¡ŒåŠ è½½ï¼Œè€Œæ­¤æ—¶ï¼Œåˆ†ç±»ä¹Ÿæ˜¯éæ‡’åŠ è½½ã€‚æˆ‘ä»¬è¿˜æ˜¯åœ¨ <code>methodizeClass</code> é‡Œé¢è¿›è¡Œæ–­ç‚¹ï¼š</p>
<p>ç»“æœå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè¿™æ¬¡ä» <code>unattachedCategoriesForClass</code> æ–¹æ³•å–å‡ºæ¥çš„æ˜¯ <code>NULL</code> å€¼ï¼Œæ˜¾ç„¶åˆ†ç±»ä¸æ˜¯åœ¨è¿™ä¸ªåœ°æ–¹è¢«åŠ è½½çš„ï¼Œæˆ‘ä»¬å›åˆ° <code>_read_images</code> æ–¹æ³•ï¼Œè¿˜è®°å¾—é‚£ä¸ª <code>Discover categories</code> æµç¨‹å—ï¼Œæˆ‘ä»¬æ‰“å¼€é‡Œé¢çš„æ–­ç‚¹ï¼š</p>
<p>å…¶å® <code>attachCategories</code> è¿™ä¸ªæ–¹æ³•åªä¼šåœ¨å®ç°äº† <code>load</code> æ–¹æ³•çš„åˆ†ç±»ä¸‹æ‰ä¼šè¢«è°ƒç”¨ï¼Œè€Œæ¥åˆ° <code>attachCategories</code> ä¹‹å‰åˆå–å†³äºç±»æ˜¯å¦ä¸ºæ‡’åŠ è½½ï¼Œå¦‚æœæ˜¯æ‡’åŠ è½½ï¼Œé‚£ä¹ˆå°±åœ¨ <code>load_images</code> é‡Œé¢å»å¤„ç†ï¼Œå¦‚æœæ˜¯éæ‡’åŠ è½½ï¼Œé‚£ä¹ˆå°±åœ¨ <code>map_images</code> é‡Œé¢å»å¤„ç†ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æˆ‘ä»¬ä»Šå¤©æ¢ç´¢çš„å†…å®¹å¯èƒ½ä¼šæœ‰ç‚¹ç»•ï¼Œä¸è¿‡å…¶å®æ¢ç´¢ä¸‹æ¥ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿æŒç ”ç©¶é‡ç‚¹å°±å¾ˆç®€å•ã€‚åˆ†ç±»çš„åŠ è½½å…¶å®å¯ä»¥ç¬¼ç»Ÿçš„åˆ†ä¸ºå®ç° <code>load</code> æ–¹æ³•å’Œæ²¡æœ‰å®ç° <code>load</code> æ–¹æ³•ï¼š</p>
<ul>
<li>æ²¡æœ‰å®ç° <code>load</code> æ–¹æ³•çš„åˆ†ç±»ç”±ç¼–è¯‘æ—¶ç¡®å®š</li>
<li>å®ç°äº† <code>load</code> æ–¹æ³•çš„åˆ†ç±»ç”±è¿è¡Œæ—¶å»ç¡®å®š</li>
</ul>
<p>è¿™ä¹Ÿè¯´æ˜åˆ†ç±»çš„åŠ è½½å’Œç±»çš„åŠ è½½æ˜¯ä¸ä¸€æ ·çš„ï¼Œè€Œç»“åˆç€ç±»çš„æ‡’åŠ è½½ä¸å¦ï¼Œæˆ‘ä»¬æœ‰ä»¥ä¸‹çš„ç»“è®ºï¼š</p>
<ul>
<li>æ‡’åŠ è½½åˆ†ç±» + æ‡’åŠ è½½ç±»</li>
</ul>
<blockquote>
<p>ç±»çš„åŠ è½½åœ¨<strong>ç¬¬ä¸€æ¬¡æ¶ˆæ¯å‘é€</strong>çš„æ—¶å€™ï¼Œè€Œåˆ†ç±»çš„åŠ è½½åˆ™åœ¨<strong>ç¼–è¯‘æ—¶</strong></p>
</blockquote>
<ul>
<li>æ‡’åŠ è½½åˆ†ç±» + éæ‡’åŠ è½½ç±»</li>
</ul>
<blockquote>
<p>ç±»çš„åŠ è½½åœ¨ <code>_read_images</code> å¤„ï¼Œåˆ†ç±»çš„åŠ è½½è¿˜æ˜¯åœ¨<strong>ç¼–è¯‘æ—¶</strong></p>
</blockquote>
<ul>
<li>éæ‡’åŠ è½½åˆ†ç±» + æ‡’åŠ è½½ç±»</li>
</ul>
<blockquote>
<p>ç±»çš„åŠ è½½åœ¨ <code>load_images</code> å†…éƒ¨ï¼Œåˆ†ç±»çš„åŠ è½½åœ¨ç±»åŠ è½½ä¹‹åçš„ <code>methodizeClass</code></p>
</blockquote>
<ul>
<li>éæ‡’åŠ è½½åˆ†ç±» + éæ‡’åŠ è½½ç±»</li>
</ul>
<blockquote>
<p>ç±»çš„åŠ è½½åœ¨ <code>_read_images</code> å¤„ï¼Œåˆ†ç±»çš„åŠ è½½åœ¨ç±»åŠ è½½ä¹‹åçš„ <code>reMethodizeClass</code></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yujiusheng.com/2021/05/15/iOS-%E5%BA%95%E5%B1%82%E6%8E%A2%E7%B4%A2-%E7%B1%BB%E7%9A%84%E5%8A%A0%E8%BD%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="ä¸ªäººæŠ€æœ¯åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jasonçš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/15/iOS-%E5%BA%95%E5%B1%82%E6%8E%A2%E7%B4%A2-%E7%B1%BB%E7%9A%84%E5%8A%A0%E8%BD%BD/" class="post-title-link" itemprop="url">iOS åº•å±‚æ¢ç´¢ - ç±»çš„åŠ è½½</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-05-15 16:19:03" itemprop="dateCreated datePublished" datetime="2021-05-15T16:19:03+08:00">2021-05-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-05-17 11:03:49" itemprop="dateModified" datetime="2021-05-17T11:03:49+08:00">2021-05-17</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="åº”ç”¨çš„åŠ è½½å›é¡¾"><a href="#åº”ç”¨çš„åŠ è½½å›é¡¾" class="headerlink" title="åº”ç”¨çš„åŠ è½½å›é¡¾"></a>åº”ç”¨çš„åŠ è½½å›é¡¾</h3><p>ä¸Šä¸€ç« æˆ‘ä»¬å¯¹åº”ç”¨çš„åŠ è½½æœ‰äº†åˆæ­¥çš„è®¤è¯†ï¼Œæˆ‘ä»¬çŸ¥é“äº†</p>
<ul>
<li>ç³»ç»Ÿè°ƒç”¨ <code>exec()</code> ä¼šæˆ‘ä»¬çš„åº”ç”¨<strong>æ˜ å°„</strong>åˆ°æ–°çš„åœ°å€ç©ºé—´</li>
<li>ç„¶åé€šè¿‡ <code>dyld</code> è¿›è¡ŒåŠ è½½ã€é“¾æ¥ã€åˆå§‹åŒ–ä¸»ç¨‹åºå’Œä¸»ç¨‹åºæ‰€ä¾èµ–çš„å„ç§åŠ¨æ€åº“</li>
<li>æœ€ååœ¨ <code>initializeMainExecutable</code> æ–¹æ³•ä¸­ç»è¿‡ä¸€ç³»åˆ—åˆå§‹åŒ–è°ƒç”¨ <code>notifySingle</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šæ‰§è¡Œä¸€ä¸ª <code>load_images</code> çš„å›è°ƒ</li>
<li>ç„¶ååœ¨ <code>doModinitFuntions</code> å‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨ <code>__attribute__((constructor))</code> çš„ <code>c</code> å‡½æ•°</li>
<li>ç„¶å <code>dyld</code> è¿”å›ä¸»ç¨‹åºçš„å…¥å£å‡½æ•°ï¼Œå¼€å§‹è¿›å…¥ä¸»ç¨‹åºçš„ <code>main</code> å‡½æ•° åœ¨ <code>main</code> å‡½æ•°æ‰§è¡Œæ‰§è¡Œï¼Œå…¶å® <code>dyld</code> è¿˜ä¼šåœ¨æµç¨‹ä¸­åˆå§‹åŒ– <code>libSystem</code>ï¼Œè€Œ <code>libSystem</code> åˆä¼šå»åˆå§‹åŒ– <code>libDispatch</code>ï¼Œåœ¨ <code>libDispatch</code> åˆå§‹åŒ–æ–¹æ³•é‡Œé¢åˆä¼šæœ‰ä¸€æ­¥ <code>_os_object_init</code>ï¼Œåœ¨ <code>_os_object_init</code> å†…éƒ¨å°±ä¼šè°ƒèµ· <code>_objc_init</code>ã€‚è€Œå¯¹äº <code>_objc_init</code> æˆ‘ä»¬è¿˜éœ€è¦ç»§ç»­æ¢ç´¢ï¼Œå› ä¸ºè¿™é‡Œé¢ä¼šè¿›è¡Œç±»çš„åŠ è½½ç­‰ä¸€ç³»åˆ—é‡è¦çš„å·¥ä½œã€‚</li>
</ul>
<h3 id="æ¢ç´¢-objc-init"><a href="#æ¢ç´¢-objc-init" class="headerlink" title="æ¢ç´¢_objc_init"></a>æ¢ç´¢<code>_objc_init</code></h3><p>é¦–å…ˆæ¥åˆ° <code>libObjc</code> æºç çš„ <code>_objc_init</code> æ–¹æ³•å¤„ï¼Œä½ å¯ä»¥ç›´æ¥æ·»åŠ ä¸€ä¸ªç¬¦å·æ–­ç‚¹ <code>_objc_init</code> æˆ–è€…å…¨å±€æœç´¢å…³é”®å­—æ¥åˆ°è¿™é‡Œï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* _objc_init</span></span><br><span class="line"><span class="comment">* Bootstrap initialization. Registers our image notifier with dyld.</span></span><br><span class="line"><span class="comment">* Called by libSystem BEFORE library initialization time</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="keyword">void</span> _objc_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">bool</span> initialized = <span class="literal">false</span>;</span><br><span class="line">  	<span class="comment">//å¦‚æœå·²ç»åˆå§‹åŒ–ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (initialized) <span class="keyword">return</span>;</span><br><span class="line">    initialized = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// fixme defer initialization until an objc-using image is found?</span></span><br><span class="line">    environ_init();</span><br><span class="line">    tls_init();</span><br><span class="line">    static_init();</span><br><span class="line">    runtime_init();</span><br><span class="line">    exception_init();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __OBJC2__</span></span><br><span class="line">    <span class="keyword">cache_t</span>::init();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    _imp_implementationWithBlock_init();</span><br><span class="line">    _dyld_objc_notify_register(&amp;map_images, load_images, unmap_image);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __OBJC2__</span></span><br><span class="line">    didCallDyldNotifyRegister = <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="environ-init"><a href="#environ-init" class="headerlink" title="environ_init"></a><code>environ_init</code></h4><p>æˆ‘ä»¬ç›´æ¥çœ‹è°ƒç”¨çš„ç¬¬ä¸€ä¸ªæ–¹æ³•<code>environ_init</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* environ_init</span></span><br><span class="line"><span class="comment">* Read environment variables that affect the runtime.</span></span><br><span class="line"><span class="comment">* Also print environment variable help, if requested.</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">environ_init</span><span class="params">(<span class="keyword">void</span>)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (issetugid()) &#123;</span><br><span class="line">        <span class="comment">// All environment variables are silently ignored when setuid or setgid</span></span><br><span class="line">        <span class="comment">// This includes OBJC_HELP and OBJC_PRINT_OPTIONS themselves.</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// Turn off autorelease LRU coalescing by default for apps linked against</span></span><br><span class="line">    <span class="comment">// older SDKs. LRU coalescing can reorder releases and certain older apps</span></span><br><span class="line">    <span class="comment">// are accidentally relying on the ordering.</span></span><br><span class="line">    <span class="comment">// rdar://problem/63886091</span></span><br><span class="line"><span class="comment">//    if (!dyld_program_sdk_at_least(dyld_fall_2020_os_versions))</span></span><br><span class="line"><span class="comment">//        DisableAutoreleaseCoalescingLRU = true;</span></span><br><span class="line">    <span class="keyword">bool</span> PrintHelp = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> PrintOptions = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> maybeMallocDebugging = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// Scan environ[] directly instead of calling getenv() a lot.</span></span><br><span class="line">    <span class="comment">// This optimizes the case where none are set.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">char</span> **p = *_NSGetEnviron(); *p != nil; p++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strncmp</span>(*p, <span class="string">"Malloc"</span>, <span class="number">6</span>)  ||  <span class="number">0</span> == <span class="built_in">strncmp</span>(*p, <span class="string">"DYLD"</span>, <span class="number">4</span>)  ||  </span><br><span class="line">            <span class="number">0</span> == <span class="built_in">strncmp</span>(*p, <span class="string">"NSZombiesEnabled"</span>, <span class="number">16</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            maybeMallocDebugging = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> != <span class="built_in">strncmp</span>(*p, <span class="string">"OBJC_"</span>, <span class="number">5</span>)) <span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strncmp</span>(*p, <span class="string">"OBJC_HELP="</span>, <span class="number">10</span>)) &#123;</span><br><span class="line">            PrintHelp = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strncmp</span>(*p, <span class="string">"OBJC_PRINT_OPTIONS="</span>, <span class="number">19</span>)) &#123;</span><br><span class="line">            PrintOptions = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strncmp</span>(*p, <span class="string">"OBJC_DEBUG_POOL_DEPTH="</span>, <span class="number">22</span>)) &#123;</span><br><span class="line">            SetPageCountWarning(*p + <span class="number">22</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *value = <span class="built_in">strchr</span>(*p, <span class="string">'='</span>);</span><br><span class="line">        <span class="keyword">if</span> (!*value) <span class="keyword">continue</span>;</span><br><span class="line">        value++;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(Settings)/<span class="keyword">sizeof</span>(Settings[<span class="number">0</span>]); i++) &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">option_t</span> *opt = &amp;Settings[i];</span><br><span class="line">            <span class="keyword">if</span> ((<span class="keyword">size_t</span>)(value - *p) == <span class="number">1</span>+opt-&gt;envlen  &amp;&amp;  </span><br><span class="line">                <span class="number">0</span> == <span class="built_in">strncmp</span>(*p, opt-&gt;env, opt-&gt;envlen))</span><br><span class="line">            &#123;</span><br><span class="line">                *opt-&gt;var = (<span class="number">0</span> == <span class="built_in">strcmp</span>(value, <span class="string">"YES"</span>));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Special case: enable some autorelease pool debugging</span></span><br><span class="line">    <span class="comment">// when some malloc debugging is enabled </span></span><br><span class="line">    <span class="comment">// and OBJC_DEBUG_POOL_ALLOCATION is not set to something other than NO.</span></span><br><span class="line">    <span class="keyword">if</span> (maybeMallocDebugging) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *insert = getenv(<span class="string">"DYLD_INSERT_LIBRARIES"</span>);</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *zombie = getenv(<span class="string">"NSZombiesEnabled"</span>);</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *pooldebug = getenv(<span class="string">"OBJC_DEBUG_POOL_ALLOCATION"</span>);</span><br><span class="line">        <span class="keyword">if</span> ((getenv(<span class="string">"MallocStackLogging"</span>)</span><br><span class="line">             || getenv(<span class="string">"MallocStackLoggingNoCompact"</span>)</span><br><span class="line">             || (zombie &amp;&amp; (*zombie == <span class="string">'Y'</span> || *zombie == <span class="string">'y'</span>))</span><br><span class="line">             || (insert &amp;&amp; <span class="built_in">strstr</span>(insert, <span class="string">"libgmalloc"</span>)))</span><br><span class="line">            &amp;&amp;</span><br><span class="line">            (!pooldebug || <span class="number">0</span> == <span class="built_in">strcmp</span>(pooldebug, <span class="string">"YES"</span>)))</span><br><span class="line">        &#123;</span><br><span class="line">            DebugPoolAllocation = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//    if (!os_feature_enabled_simple(objc4, preoptimizedCaches, true)) &#123;</span></span><br><span class="line"><span class="comment">//        DisablePreoptCaches = true;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">// Print OBJC_HELP and OBJC_PRINT_OPTIONS output.</span></span><br><span class="line">    <span class="keyword">if</span> (PrintHelp  ||  PrintOptions) &#123;</span><br><span class="line">        <span class="keyword">if</span> (PrintHelp) &#123;</span><br><span class="line">            _objc_inform(<span class="string">"Objective-C runtime debugging. Set variable=YES to enable."</span>);</span><br><span class="line">            _objc_inform(<span class="string">"OBJC_HELP: describe available environment variables"</span>);</span><br><span class="line">            <span class="keyword">if</span> (PrintOptions) &#123;</span><br><span class="line">                _objc_inform(<span class="string">"OBJC_HELP is set"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            _objc_inform(<span class="string">"OBJC_PRINT_OPTIONS: list which options are set"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (PrintOptions) &#123;</span><br><span class="line">            _objc_inform(<span class="string">"OBJC_PRINT_OPTIONS is set"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(Settings)/<span class="keyword">sizeof</span>(Settings[<span class="number">0</span>]); i++) &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">option_t</span> *opt = &amp;Settings[i];            </span><br><span class="line">            <span class="keyword">if</span> (PrintHelp) _objc_inform(<span class="string">"%s: %s"</span>, opt-&gt;env, opt-&gt;help);</span><br><span class="line">            <span class="keyword">if</span> (PrintOptions &amp;&amp; *opt-&gt;var) _objc_inform(<span class="string">"%s is set"</span>, opt-&gt;env);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œä¸»è¦æ˜¯è¯»å–å½±å“ <code>Runtime</code> çš„ä¸€äº›ç¯å¢ƒå˜é‡ï¼Œå¦‚æœéœ€è¦ï¼Œè¿˜å¯ä»¥æ‰“å°ç¯å¢ƒå˜é‡å¸®åŠ©æç¤ºã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥åœ¨ç»ˆç«¯æµ‹è¯•ä¸€ä¸‹ï¼Œç›´æ¥è¾“å…¥<code>export OBJC-HELP=1</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">jason@<span class="number">192</span> ~ % <span class="keyword">export</span> OBJC_HELP=<span class="number">1</span></span><br><span class="line">jason@<span class="number">192</span> ~ % ls</span><br><span class="line">objc[<span class="number">6097</span>]: Objective-C runtime debugging. Set variable=YES to enable.</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_HELP: describe <span class="built_in">available</span> environment variables</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_PRINT_OPTIONS: <span class="built_in">list</span> which options are <span class="built_in">set</span></span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_PRINT_IMAGES: <span class="built_in">log</span> <span class="built_in">image</span> <span class="keyword">and</span> library names as they are loaded</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_PRINT_IMAGE_TIMES: measure duration of <span class="built_in">image</span> loading steps</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_PRINT_LOAD_METHODS: <span class="built_in">log</span> calls to class <span class="keyword">and</span> category +load methods</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_PRINT_INITIALIZE_METHODS: <span class="built_in">log</span> calls to class +initialize methods</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_PRINT_RESOLVED_METHODS: <span class="built_in">log</span> methods created by +resolveClassMethod: <span class="keyword">and</span> +resolveInstanceMethod:</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_PRINT_CLASS_SETUP: <span class="built_in">log</span> progress of class <span class="keyword">and</span> category <span class="built_in">setup</span></span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_PRINT_PROTOCOL_SETUP: <span class="built_in">log</span> progress of protocol <span class="built_in">setup</span></span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_PRINT_IVAR_SETUP: <span class="built_in">log</span> processing of non-fragile ivars</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_PRINT_VTABLE_SETUP: <span class="built_in">log</span> processing of class vtables</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_PRINT_VTABLE_IMAGES: <span class="built_in">print</span> vtable images showing overridden methods</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_PRINT_CACHE_SETUP: <span class="built_in">log</span> processing of method caches</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_PRINT_FUTURE_CLASSES: <span class="built_in">log</span> use of <span class="built_in">future</span> classes <span class="keyword">for</span> toll-<span class="built_in">free</span> bridging</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_PRINT_PREOPTIMIZATION: <span class="built_in">log</span> preoptimization courtesy of dyld shared cache</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_PRINT_CXX_CTORS: <span class="built_in">log</span> calls to C++ ctors <span class="keyword">and</span> dtors <span class="keyword">for</span> instance variables</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_PRINT_EXCEPTIONS: <span class="built_in">log</span> exception handling</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_PRINT_EXCEPTION_THROW: <span class="built_in">log</span> backtrace of every objc_exception_throw()</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_PRINT_ALT_HANDLERS: <span class="built_in">log</span> processing of exception alt handlers</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_PRINT_REPLACED_METHODS: <span class="built_in">log</span> methods replaced by category implementations</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_PRINT_DEPRECATION_WARNINGS: warn about calls to deprecated runtime functions</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_PRINT_POOL_HIGHWATER: <span class="built_in">log</span> high-water marks <span class="keyword">for</span> autorelease pools</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_PRINT_CUSTOM_CORE: <span class="built_in">log</span> classes with custom core methods</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_PRINT_CUSTOM_RR: <span class="built_in">log</span> classes with custom retain/<span class="built_in">release</span> methods</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_PRINT_CUSTOM_AWZ: <span class="built_in">log</span> classes with custom allocWithZone methods</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_PRINT_RAW_ISA: <span class="built_in">log</span> classes that require raw pointer isa fields</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_DEBUG_UNLOAD: warn about poorly-behaving bundles when unloaded</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_DEBUG_FRAGILE_SUPERCLASSES: warn about subclasses that may have been broken by subsequent changes to superclasses</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_DEBUG_NIL_SYNC: warn about @synchronized(nil), which does no synchronization</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_DEBUG_NONFRAGILE_IVARS: capriciously rearrange non-fragile ivars</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_DEBUG_ALT_HANDLERS: record more info about bad alt handler use</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_DEBUG_MISSING_POOLS: warn about autorelease with no pool in place, which may be a leak</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_DEBUG_POOL_ALLOCATION: halt when autorelease pools are popped out of order, <span class="keyword">and</span> allow heap debuggers to track autorelease pools</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_DEBUG_DUPLICATE_CLASSES: halt when multiple classes with the same name are present</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_DEBUG_DONT_CRASH: halt the <span class="built_in">process</span> by exiting instead of crashing</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_DISABLE_VTABLES: disable vtable dispatch</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_DISABLE_PREOPTIMIZATION: disable preoptimization courtesy of dyld shared cache</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_DISABLE_TAGGED_POINTERS: disable tagged pointer optimization of NSNumber et al.</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_DISABLE_TAG_OBFUSCATION: disable obfuscation of tagged pointers</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_DISABLE_NONPOINTER_ISA: disable non-pointer isa fields</span><br><span class="line">objc[<span class="number">6097</span>]: OBJC_DISABLE_INITIALIZE_FORK_SAFETY: disable safety checks <span class="keyword">for</span> +initialize after fork</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ä¸åŒçš„ç¯å¢ƒå˜é‡å¯¹åº”çš„å†…å®¹éƒ½è¢«æ‰“å°å‡ºæ¥äº†ã€‚</p>
<h4 id="tls-init"><a href="#tls-init" class="headerlink" title="tls_init"></a><code>tls_init</code></h4><p>æ¥ç€çœ‹<code>tls_init</code>æ–¹æ³•å†…éƒ¨ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">tls_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> SUPPORT_DIRECT_THREAD_KEYS</span></span><br><span class="line">    pthread_key_init_np(TLS_DIRECT_KEY, &amp;_objc_pthread_destroyspecific);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    _objc_pthread_key = tls_create(&amp;_objc_pthread_destroyspecific);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ‰§è¡Œçš„æ˜¯å…³äºçº¿ç¨‹ <code>key</code> çš„ç»‘å®šï¼Œæ¯”å¦‚æ¯ä¸ªçº¿ç¨‹æ•°æ®çš„ææ„å‡½æ•°ã€‚</p>
<h4 id="static-init"><a href="#static-init" class="headerlink" title="static_init"></a><code>static_init</code></h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* static_init</span></span><br><span class="line"><span class="comment">* Run C++ static constructor functions.</span></span><br><span class="line"><span class="comment">* libc calls _objc_init() before dyld would call our static constructors, </span></span><br><span class="line"><span class="comment">* so we have to do it ourselves.</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">static_init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> count;</span><br><span class="line">    <span class="keyword">auto</span> inits = getLibobjcInitializers(&amp;_mh_dylib_header, &amp;count);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        inits[i]();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">auto</span> offsets = getLibobjcInitializerOffsets(&amp;_mh_dylib_header, &amp;count);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        <span class="function">UnsignedInitializer <span class="title">init</span><span class="params">(offsets[i])</span></span>;</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¼šè¿è¡Œ <code>C++</code> çš„é™æ€æ„é€ å‡½æ•°ï¼Œåœ¨ <code>dyld</code> è°ƒç”¨æˆ‘ä»¬çš„é™æ€æ„é€ å‡½æ•°ä¹‹å‰ï¼Œ<code>libc</code> ä¼šè°ƒç”¨ <code>_objc_init</code>ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¿…é¡»è‡ªå·±æ¥åšï¼Œå¹¶ä¸”è¿™é‡Œåªä¼šåˆå§‹åŒ–ç³»ç»Ÿå†…ç½®çš„ <code>C++</code> é™æ€æ„é€ å‡½æ•°ï¼Œæˆ‘ä»¬è‡ªå·±ä»£ç é‡Œé¢å†™çš„å¹¶ä¸ä¼šåœ¨è¿™é‡Œåˆå§‹åŒ–ã€‚</p>
<h4 id="runtime-init"><a href="#runtime-init" class="headerlink" title="runtime_init"></a><code>runtime_init</code></h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">runtime_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    objc::unattachedCategories.init(<span class="number">32</span>);</span><br><span class="line">    objc::allocatedClasses.init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Runtimeç¯å¢ƒåˆå§‹åŒ–ï¼ŒunattachedCategorieså’ŒallocatedClassesä¸¤å¼ è¡¨çš„åˆå§‹åŒ–å·¥ä½œ</p>
<h4 id="exception-init"><a href="#exception-init" class="headerlink" title="exception_init"></a><code>exception_init</code></h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* exception_init</span></span><br><span class="line"><span class="comment">* Initialize libobjc's exception handling system.</span></span><br><span class="line"><span class="comment">* Called by map_images().</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">exception_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    old_terminate = <span class="built_in">std</span>::set_terminate(&amp;_objc_terminate);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ˜¯åˆå§‹åŒ– <code>libobjc</code> çš„å¼‚å¸¸å¤„ç†ç³»ç»Ÿï¼Œæˆ‘ä»¬ç¨‹åºè§¦å‘çš„å¼‚å¸¸éƒ½ä¼šæ¥åˆ°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* _objc_terminate</span></span><br><span class="line"><span class="comment">* Custom std::terminate handler.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* The uncaught exception callback is implemented as a std::terminate handler. </span></span><br><span class="line"><span class="comment">* 1. Check if there's an active exception</span></span><br><span class="line"><span class="comment">* 2. If so, check if it's an Objective-C exception</span></span><br><span class="line"><span class="comment">* 3. If so, call our registered callback with the object.</span></span><br><span class="line"><span class="comment">* 4. Finally, call the previous terminate handler.</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">void</span> <span class="params">(*old_terminate)</span><span class="params">(<span class="keyword">void</span>)</span> </span>= nil;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> _objc_terminate(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (PrintExceptions) &#123;</span><br><span class="line">        _objc_inform(<span class="string">"EXCEPTIONS: terminating"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! __cxa_current_exception_type()) &#123;</span><br><span class="line">        <span class="comment">// No current exception.</span></span><br><span class="line">        (*old_terminate)();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// There is a current exception. Check if it's an objc exception.</span></span><br><span class="line">        @<span class="keyword">try</span> &#123;</span><br><span class="line">            __cxa_rethrow();</span><br><span class="line">        &#125; @<span class="keyword">catch</span> (id e) &#123;</span><br><span class="line">            <span class="comment">// It's an objc object. Call Foundation's handler, if any.</span></span><br><span class="line">            (*uncaught_handler)((id)e);</span><br><span class="line">            (*old_terminate)();</span><br><span class="line">        &#125; @<span class="keyword">catch</span> (...) &#123;</span><br><span class="line">            <span class="comment">// It's not an objc object. Continue to C++ terminate.</span></span><br><span class="line">            (*old_terminate)();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>_objc_terminate</code> æ˜¯æœªå¤„ç†å¼‚å¸¸çš„å›è°ƒå‡½æ•°ï¼Œå…¶å†…éƒ¨é€»è¾‘å¦‚ä¸‹:</p>
<ul>
<li>æ£€æŸ¥æ˜¯å¦æ˜¯ä¸€ä¸ªæ´»è·ƒçš„å¼‚å¸¸</li>
<li>å¦‚æœæ˜¯æ´»è·ƒçš„å¼‚å¸¸ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯ <code>OC</code> æŠ›å‡ºçš„å¼‚å¸¸</li>
<li>å¦‚æœæ˜¯ <code>OC</code> æŠ›å‡ºçš„å¼‚å¸¸ï¼Œè°ƒç”¨ <code>uncaught_handeler</code> å›è°ƒå‡½æ•°æŒ‡é’ˆ</li>
<li>å¦‚æœä¸æ˜¯ <code>OC</code> æŠ›å‡ºçš„å¼‚å¸¸ï¼Œåˆ™ç»§ç»­ <code>C++</code> ç»ˆæ­¢æ“ä½œ</li>
</ul>
<h4 id="cache-t-init"><a href="#cache-t-init" class="headerlink" title="cache_t::init()"></a><code>cache_t::init()</code></h4><p>çœ‹å­—é¢é‡å¾ˆå®¹æ˜“çŒœåˆ°ï¼Œ<code>cache_t</code>å±æ€§çš„åˆå§‹åŒ–</p>
<h4 id="imp-implementationWithBlock-init"><a href="#imp-implementationWithBlock-init" class="headerlink" title="_imp_implementationWithBlock_init"></a><code>_imp_implementationWithBlock_init</code></h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Initialize the trampoline machinery. Normally this does nothing, as</span></span><br><span class="line"><span class="comment">/// everything is initialized lazily, but for certain processes we eagerly load</span></span><br><span class="line"><span class="comment">/// the trampolines dylib.</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">_imp_implementationWithBlock_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> TARGET_OS_OSX</span></span><br><span class="line">    <span class="comment">// Eagerly load libobjc-trampolines.dylib in certain processes. Some</span></span><br><span class="line">    <span class="comment">// programs (most notably QtWebEngineProcess used by older versions of</span></span><br><span class="line">    <span class="comment">// embedded Chromium) enable a highly restrictive sandbox profile which</span></span><br><span class="line">    <span class="comment">// blocks access to that dylib. If anything calls</span></span><br><span class="line">    <span class="comment">// imp_implementationWithBlock (as AppKit has started doing) then we'll</span></span><br><span class="line">    <span class="comment">// crash trying to load it. Loading it here sets it up before the sandbox</span></span><br><span class="line">    <span class="comment">// profile is enabled and blocks it.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// This fixes EA Origin (rdar://problem/50813789)</span></span><br><span class="line">    <span class="comment">// and Steam (rdar://problem/55286131)</span></span><br><span class="line">    <span class="keyword">if</span> (__progname &amp;&amp;</span><br><span class="line">        (<span class="built_in">strcmp</span>(__progname, <span class="string">"QtWebEngineProcess"</span>) == <span class="number">0</span> ||</span><br><span class="line">         <span class="built_in">strcmp</span>(__progname, <span class="string">"Steam Helper"</span>) == <span class="number">0</span>)) &#123;</span><br><span class="line">        Trampolines.Initialize();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯åŠ¨å›è°ƒæœºåˆ¶ã€‚é€šå¸¸ä¸ä¼šåšä»€ä¹ˆï¼Œå› ä¸ºæ‰€æœ‰çš„åˆå§‹åŒ–éƒ½æ˜¯æƒ°æ€§çš„ï¼Œä½†æ˜¯å¯¹äºæŸäº›è¿›ç¨‹ï¼Œæˆ‘ä»¬ä¼šè¿«ä¸åŠå¾…åœ°åŠ è½½trampolines dylibã€‚</p>
<h4 id="dyld-objc-notify-register"><a href="#dyld-objc-notify-register" class="headerlink" title="_dyld_objc_notify_register"></a><code>_dyld_objc_notify_register</code></h4><p>æ¥ä¸‹æ¥æ˜¯æˆ‘ä»¬ä»Šå¤©æ¢ç´¢çš„é‡ç‚¹äº†ï¼š <code>_dyld_objc_notify_register</code> ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹å®ƒçš„å®šä¹‰:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Note: only for use by objc runtime</span></span><br><span class="line"><span class="comment">// Register handlers to be called when objc images are mapped, unmapped, and initialized.</span></span><br><span class="line"><span class="comment">// Dyld will call back the "mapped" function with an array of images that contain an objc-image-info section.</span></span><br><span class="line"><span class="comment">// Those images that are dylibs will have the ref-counts automatically bumped, so objc will no longer need to</span></span><br><span class="line"><span class="comment">// call dlopen() on them to keep them from being unloaded.  During the call to _dyld_objc_notify_register(),</span></span><br><span class="line"><span class="comment">// dyld will call the "mapped" function with already loaded objc images.  During any later dlopen() call,</span></span><br><span class="line"><span class="comment">// dyld will also call the "mapped" function.  Dyld will call the "init" function when dyld would be called</span></span><br><span class="line"><span class="comment">// initializers in that image.  This is when objc calls any +load methods in that image.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">void</span> _dyld_objc_notify_register(_dyld_objc_notify_mapped    mapped,</span><br><span class="line">                                _dyld_objc_notify_init      init,</span><br><span class="line">                                _dyld_objc_notify_unmapped  unmapped);</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼šä»…ä¾› <code>objc</code> è¿è¡Œæ—¶ä½¿ç”¨<br>å½“ <code>objc</code> é•œåƒè¢«<strong>æ˜ å°„ï¼ˆmappedï¼‰</strong>ã€<strong>å¸è½½ï¼ˆunmappedï¼‰</strong>å’Œ<strong>åˆå§‹åŒ–ï¼ˆinitializedï¼‰</strong>çš„æ—¶å€™ï¼Œæ³¨å†Œçš„å›è°ƒå‡½æ•°å°±ä¼šè¢«è°ƒç”¨ã€‚<br>è¿™ä¸ªæ–¹æ³•æ˜¯ <code>dlyd</code> ä¸­å£°æ˜çš„ï¼Œä¸€æ—¦è°ƒç”¨è¯¥æ–¹æ³•ï¼Œè°ƒç”¨ç»“æœä¼šä½œä¸ºè¯¥å‡½æ•°çš„å‚æ•°å›ä¼ å›æ¥ã€‚æ¯”å¦‚ï¼Œå½“æ‰€æœ‰çš„ <code>images</code> ä»¥åŠ <code>section</code> ä¸º <code>objc-image-info</code> è¢«åŠ è½½ä¹‹åä¼šå›è°ƒ <code>mapped</code> æ–¹æ³•ã€‚<br><code>load</code> æ–¹æ³•ä¹Ÿå°†åœ¨è¿™ä¸ªæ–¹æ³•ä¸­è¢«è°ƒç”¨ã€‚</p>
<p><code>_dyld_objc_notify_register</code> æ–¹æ³•çš„ä¸‰ä¸ªå‚æ•° <code>map_images</code> ã€ <code>load_images</code> ã€ <code>unmap_image</code> å…¶å®éƒ½æ˜¯å‡½æ•°æŒ‡é’ˆï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*_dyld_objc_notify_mapped)</span><span class="params">(<span class="keyword">unsigned</span> count, <span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span> paths[], <span class="keyword">const</span> struct mach_header* <span class="keyword">const</span> mh[])</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*_dyld_objc_notify_init)</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* path, <span class="keyword">const</span> struct mach_header* mh)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*_dyld_objc_notify_unmapped)</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* path, <span class="keyword">const</span> struct mach_header* mh)</span></span>;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸‰ä¸ªå‡½æ•°æŒ‡é’ˆæ˜¯åœ¨ <code>dyld</code> ä¸­å›è°ƒçš„ï¼Œæˆ‘ä»¬æ‰“å¼€ <code>dyld</code> çš„æºç å³å¯ä¸€æ¢ç©¶ç«Ÿï¼Œæˆ‘ä»¬ç›´æ¥æœç´¢ <code>_dyld_objc_notify_register</code> :</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _dyld_objc_notify_register(_dyld_objc_notify_mapped    mapped,</span><br><span class="line">                                _dyld_objc_notify_init      init,</span><br><span class="line">                                _dyld_objc_notify_unmapped  unmapped)</span><br><span class="line">&#123;</span><br><span class="line">	dyld::registerObjCNotifiers(mapped, init, unmapped);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€æ¥åˆ° <code>dyld</code> çš„ <code>registerObjCNotifiers</code> æ–¹æ³•å†…éƒ¨ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">registerObjCNotifiers</span><span class="params">(_dyld_objc_notify_mapped mapped, _dyld_objc_notify_init init, _dyld_objc_notify_unmapped unmapped)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// record functions to call</span></span><br><span class="line">	sNotifyObjCMapped	= mapped;<span class="comment">//map_images</span></span><br><span class="line">	sNotifyObjCInit		= init;<span class="comment">//load_images</span></span><br><span class="line">	sNotifyObjCUnmapped = unmapped;<span class="comment">//unmap_images</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// call 'mapped' function with all images mapped so far</span></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		notifyBatchPartial(dyld_image_state_bound, <span class="literal">true</span>, <span class="literal">NULL</span>, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (<span class="keyword">const</span> <span class="keyword">char</span>* msg) &#123;</span><br><span class="line">		<span class="comment">// ignore request to abort during registration</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// &lt;rdar://problem/32209809&gt; call 'init' function on all images already init'ed (below libSystem)</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;ImageLoader*&gt;::iterator it=sAllImages.<span class="built_in">begin</span>(); it != sAllImages.<span class="built_in">end</span>(); it++) &#123;</span><br><span class="line">		ImageLoader* <span class="built_in">image</span> = *it;</span><br><span class="line">		<span class="keyword">if</span> ( (<span class="built_in">image</span>-&gt;getState() == dyld_image_state_initialized) &amp;&amp; <span class="built_in">image</span>-&gt;notifyObjC() ) &#123;</span><br><span class="line">			<span class="function">dyld3::ScopedTimer <span class="title">timer</span><span class="params">(DBG_DYLD_TIMING_OBJC_INIT, (<span class="keyword">uint64_t</span>)<span class="built_in">image</span>-&gt;machHeader(), <span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">			(*sNotifyObjCInit)(<span class="built_in">image</span>-&gt;getRealPath(), <span class="built_in">image</span>-&gt;machHeader());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> _dyld_objc_notify_mapped		sNotifyObjCMapped;</span><br><span class="line"><span class="keyword">static</span> _dyld_objc_notify_init		sNotifyObjCInit;</span><br><span class="line"><span class="keyword">static</span> _dyld_objc_notify_unmapped	sNotifyObjCUnmapped;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ä¸Šé¢çš„ä»£ç çš„å†…å®¹è¯´æ˜åœ¨<code>registerObjCNotifiers</code> å†…éƒ¨ï¼Œ <code>libObjc</code> ä¼ è¿‡æ¥çš„è¿™ä¸‰ä¸ªå‡½æ•°æŒ‡é’ˆè¢« <code>dyld</code> ä¿å­˜åœ¨äº†æœ¬åœ°é™æ€å˜é‡ä¸­ã€‚æ¢å¥è¯æ¥è¯´ï¼Œæœ€ç»ˆå‡½æ•°æŒ‡é’ˆæ˜¯å¦èƒ½è¢«è°ƒç”¨ï¼Œå–å†³äºè¿™ä¸‰ä¸ªé™æ€å˜é‡ï¼š</p>
<ul>
<li><code>sNotifyObjCMapped</code></li>
<li><code>sNotifyObjCInit</code></li>
<li><code>sNotifyObjCUnmapped</code></li>
</ul>
<p>æˆ‘ä»¬æ³¨æ„åˆ° <code>registerObjCNotifiers</code> çš„ <code>try-catch</code> è¯­å¥ä¸­çš„ <code>try</code> åˆ†æ”¯æ³¨é‡Šå¦‚ä¸‹ï¼š</p>
<blockquote>
<p>call â€˜mappedâ€™ function with all images mapped so far<br>è°ƒç”¨ <code>mapped</code> å‡½æ•°æ¥æ˜ å°„æ‰€æœ‰çš„é•œåƒ</p>
</blockquote>
<p>é‚£ä¹ˆä¹Ÿå°±æ˜¯è¯´ <code>notifyBatchPartial</code> é‡Œé¢ä¼šè¿›è¡ŒçœŸæ­£çš„å‡½æ•°æŒ‡é’ˆçš„è°ƒç”¨ï¼Œæˆ‘ä»¬è¿›å…¥è¿™ä¸ªæ–¹æ³•å†…éƒ¨ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">notifyBatchPartial</span><span class="params">(dyld_image_states state, <span class="keyword">bool</span> orLater, dyld_image_state_change_handler onlyHandler, <span class="keyword">bool</span> preflightOnly, <span class="keyword">bool</span> onlyObjCMappedNotification)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">			<span class="comment">//çœç•¥ä»£ç </span></span><br><span class="line">			<span class="comment">// tell objc about new images</span></span><br><span class="line">			<span class="keyword">if</span> ( (onlyHandler == <span class="literal">NULL</span>) &amp;&amp; ((state == dyld_image_state_bound) || (orLater &amp;&amp; (dyld_image_state_bound &gt; state))) &amp;&amp; (sNotifyObjCMapped != <span class="literal">NULL</span>) ) &#123;</span><br><span class="line">				<span class="keyword">const</span> <span class="keyword">char</span>* paths[imageCount];</span><br><span class="line">				<span class="keyword">const</span> mach_header* mhs[imageCount];</span><br><span class="line">				<span class="keyword">unsigned</span> objcImageCount = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; imageCount; ++i) &#123;</span><br><span class="line">					ImageLoader* <span class="built_in">image</span> = findImageByMachHeader(infos[i].imageLoadAddress);</span><br><span class="line">					<span class="keyword">bool</span> hasObjC = <span class="literal">false</span>;</span><br><span class="line">					<span class="keyword">if</span> ( <span class="built_in">image</span> != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">						<span class="keyword">if</span> ( <span class="built_in">image</span>-&gt;objCMappedNotified() )</span><br><span class="line">							<span class="keyword">continue</span>;</span><br><span class="line">						hasObjC = <span class="built_in">image</span>-&gt;notifyObjC();</span><br><span class="line">					&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> SUPPORT_ACCELERATE_TABLES</span></span><br><span class="line">					<span class="keyword">else</span> <span class="keyword">if</span> ( sAllCacheImagesProxy != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">						<span class="keyword">const</span> mach_header* mh;</span><br><span class="line">						<span class="keyword">const</span> <span class="keyword">char</span>* path;</span><br><span class="line">						<span class="keyword">unsigned</span> index;</span><br><span class="line">						<span class="keyword">if</span> ( sAllCacheImagesProxy-&gt;addressInCache(infos[i].imageLoadAddress, &amp;mh, &amp;path, &amp;index) ) &#123;</span><br><span class="line">							hasObjC = (mh-&gt;flags &amp; MH_HAS_OBJC);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">					<span class="keyword">if</span> ( hasObjC ) &#123;</span><br><span class="line">						paths[objcImageCount] = infos[i].imageFilePath;</span><br><span class="line">						mhs[objcImageCount]   = infos[i].imageLoadAddress;</span><br><span class="line">						++objcImageCount;</span><br><span class="line">						<span class="keyword">if</span> ( <span class="built_in">image</span> != <span class="literal">NULL</span> )</span><br><span class="line">							<span class="built_in">image</span>-&gt;setObjCMappedNotified();</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> ( objcImageCount != <span class="number">0</span> ) &#123;</span><br><span class="line">					<span class="function">dyld3::ScopedTimer <span class="title">timer</span><span class="params">(DBG_DYLD_TIMING_OBJC_MAP, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">					<span class="keyword">uint64_t</span> t0 = mach_absolute_time();</span><br><span class="line">					(*sNotifyObjCMapped)(objcImageCount, paths, mhs);<span class="comment">//å‡½æ•°æŒ‡é’ˆçœŸæ­£è°ƒç”¨çš„åœ°æ–¹</span></span><br><span class="line">					<span class="keyword">uint64_t</span> t1 = mach_absolute_time();</span><br><span class="line">					ImageLoader::fgTotalObjCSetupTime += (t1-t0);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//çœç•¥ä»£ç </span></span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ <code>notifyBatchPartial</code> æ–¹æ³•å†…éƒ¨ï¼Œè¿™é‡Œçš„æ³¨é‡Š:</p>
<blockquote>
<p>tell objc about new images å‘Šè¯‰ <code>objc</code> é•œåƒå·²ç»æ˜ å°„å®Œæˆäº†</p>
</blockquote>
<p>å¼„æ¸…æ¥šäº†ä¸‰ä¸ªå‡½æ•°æŒ‡é’ˆæ˜¯æ€ä¹ˆè°ƒç”¨çš„è¿˜ä¸å¤Ÿï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦æ·±å…¥å„ä¸ªå‡½æ•°çš„å†…éƒ¨çœ‹é‡Œé¢ç©¶ç«Ÿåšäº†ä»€ä¹ˆæ ·çš„äº‹æƒ…ã€‚</p>
<h3 id="æ¢ç´¢-map-images"><a href="#æ¢ç´¢-map-images" class="headerlink" title="æ¢ç´¢ map_images"></a>æ¢ç´¢ <code>map_images</code></h3><p>é¦–å…ˆæ˜¯ <code>map_images</code> ï¼Œæˆ‘ä»¬æ¥åˆ°å®ƒçš„å®ç°:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* map_images</span></span><br><span class="line"><span class="comment">* Process the given images which are being mapped in by dyld.</span></span><br><span class="line"><span class="comment">* Calls ABI-agnostic code after taking ABI-specific locks.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Locking: write-locks runtimeLock</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">map_images(<span class="keyword">unsigned</span> count, <span class="keyword">const</span> <span class="keyword">char</span> * <span class="keyword">const</span> paths[],</span><br><span class="line">           <span class="keyword">const</span> struct mach_header * <span class="keyword">const</span> mhdrs[])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">mutex_locker_t</span> <span class="title">lock</span><span class="params">(runtimeLock)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> map_images_nolock(count, paths, mhdrs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Process the given images which are being mapped in by dyld.<br>Calls ABI-agnostic code after taking ABI-specific locks.</p>
</blockquote>
<blockquote>
<p>å¤„ç†ç”± <code>dyld</code> æ˜ å°„çš„ç»™å®šé•œåƒ<br>å–å¾—ç‰¹å®šäº <code>ABI</code> çš„é”åï¼Œè°ƒç”¨ä¸ <code>ABI</code> æ— å…³çš„ä»£ç ã€‚</p>
</blockquote>
<p>è¿™é‡Œä¼šç»§ç»­å¾€ä¸‹èµ°åˆ° <code>map_images_nolock</code></p>
<p><code>map_images_nolock</code> å†…éƒ¨ä»£ç ååˆ†å†—é•¿ï¼Œæˆ‘ä»¬ç»è¿‡åˆ†æä¹‹åï¼Œå‰é¢çš„å·¥ä½œåŸºæœ¬ä¸Šéƒ½æ˜¯è¿›è¡Œé•œåƒæ–‡ä»¶ä¿¡æ¯çš„æå–ä¸ç»Ÿè®¡ï¼Œæ‰€ä»¥å¯ä»¥å®šä½åˆ°æœ€åçš„ <code>_read_images</code> ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (hCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    _read_images(hList, hCount, totalClasses, unoptimizedTotalClasses);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œè¿›å…¥ <code>_read_images</code> çš„æ¡ä»¶æ˜¯ <code>hCount</code> å¤§äº 0ï¼Œ <code>hCount</code> è¡¨ç¤ºçš„æ˜¯ <code>Mach-O</code> ä¸­ <code>header</code> çš„æ•°é‡</p>
<p>OKï¼Œæˆ‘ä»¬çš„ä¸»è§’ç™»åœºäº†ï¼Œ <code>_read_images</code> å’Œ <code>lookupImpOrForward</code> å¯ä»¥è¯´æ˜¯æˆ‘ä»¬å­¦ä¹  <code>Runtime</code> å’Œ <code>iOS</code> åº•å±‚é‡Œé¢éå¸¸é‡è¦çš„ä¸¤ä¸ªæ¦‚å¿µäº†ï¼Œ <code>lookUpImpOrForward</code> å·²ç»æ¢ç´¢è¿‡äº†ï¼Œå‰©ä¸‹çš„ <code>_read_images</code> æˆ‘ä»¬ä¹Ÿä¸èƒ½è½ä¸‹ã€‚</p>
<h4 id="read-imageså®šä¹‰"><a href="#read-imageså®šä¹‰" class="headerlink" title="_read_imageså®šä¹‰"></a>_read_imageså®šä¹‰</h4><p>Perform initial processing of the headers in the linked list beginning with headerList.<br>ä» <code>headerList</code> å¼€å§‹ï¼Œå¯¹å·²ç»é“¾æ¥äº†çš„ <code>Mach-O</code> é•œåƒè¡¨ä¸­çš„å¤´éƒ¨è¿›è¡Œåˆå§‹åŒ–å¤„ç†</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ª <code>_read_images</code> æœ‰æ¥è¿‘ 400 è¡Œä»£ç ã€‚</p>
<p>é€šè¿‡æŸ¥çœ‹ä»£ç ï¼Œä»¥åŠæ—¥å¿—æ‰“å°æç¤ºä¿¡æ¯ï¼Œæˆ‘ä»¬å¤§è‡´å¯ä»¥å°† <code>_read_images</code> åˆ†ä¸ºä¸‹é¢å‡ ä¸ªæµç¨‹:</p>
<h4 id="read-imageså…·ä½“æµç¨‹"><a href="#read-imageså…·ä½“æµç¨‹" class="headerlink" title="_read_imageså…·ä½“æµç¨‹"></a>_read_imageså…·ä½“æµç¨‹</h4><p><strong>doneOnce æµç¨‹</strong></p>
<p>æˆ‘ä»¬ä»ç¬¬ä¸€ä¸ªåˆ†æ”¯ <code>doneOnce</code> å¼€å§‹ï¼Œè¿™ä¸ªåè¯é¡¾åæ€ä¹‰ï¼Œåªä¼šæ‰§è¡Œä¸€æ¬¡ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EACH_HEADER \</span></span><br><span class="line">    hIndex = <span class="number">0</span>;         \</span><br><span class="line">    hIndex &lt; hCount &amp;&amp; (hi = hList[hIndex]); \</span><br><span class="line">    hIndex++</span><br><span class="line">    <span class="keyword">if</span> (!doneOnce) &#123;</span><br><span class="line">        doneOnce = YES;</span><br><span class="line">        launchTime = YES;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> SUPPORT_NONPOINTER_ISA</span></span><br><span class="line">        <span class="comment">// Disable non-pointer isa under some conditions.</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="meta-keyword">if</span> SUPPORT_INDEXED_ISA</span></span><br><span class="line">        <span class="comment">// Disable nonpointer isa if any image contains old Swift code</span></span><br><span class="line">        <span class="keyword">for</span> (EACH_HEADER) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hi-&gt;info()-&gt;containsSwift()  &amp;&amp;</span><br><span class="line">                hi-&gt;info()-&gt;swiftUnstableVersion() &lt; objc_image_info::SwiftVersion3)</span><br><span class="line">            &#123;</span><br><span class="line">                DisableNonpointerIsa = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">if</span> (PrintRawIsa) &#123;</span><br><span class="line">                    _objc_inform(<span class="string">"RAW ISA: disabling non-pointer isa because "</span></span><br><span class="line">                                 <span class="string">"the app or a framework contains Swift code "</span></span><br><span class="line">                                 <span class="string">"older than Swift 3.0"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>é€šè¿‡å® <code>SUPPORT_NONPOINTER_ISA</code> åˆ¤æ–­å½“å‰æ˜¯å¦æ”¯æŒå¼€å¯å†…å­˜ä¼˜åŒ–çš„ <code>isa</code><ul>
<li>å¦‚æœæ”¯æŒï¼Œåˆ™åœ¨æŸäº›æ¡ä»¶ä¸‹éœ€è¦ç¦ç”¨è¿™ä¸ªä¼˜åŒ–</li>
</ul>
</li>
<li>é€šè¿‡å® <code>SUPPORT_INDEXED_ISA</code> åˆ¤æ–­å½“å‰æ˜¯å¦æ˜¯å°†ç±»å­˜å‚¨åœ¨ <code>isa</code> ä½œä¸ºç±»è¡¨ç´¢å¼•<ul>
<li>å¦‚æœæ˜¯çš„è¯ï¼Œå†é€’å½’éå†æ‰€æœ‰çš„ <code>Mach-O</code> çš„å¤´éƒ¨ï¼Œå¹¶ä¸”åˆ¤æ–­å¦‚æœæ˜¯ <code>Swift 3.0</code> ä¹‹å‰çš„ä»£ç ï¼Œå°±éœ€è¦ç¦ç”¨å¯¹ <code>isa</code> çš„å†…å­˜ä¼˜åŒ–</li>
</ul>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">if</span> TARGET_OS_OSX</span></span><br><span class="line">        <span class="comment">// Disable non-pointer isa if the app is too old</span></span><br><span class="line">        <span class="comment">// (linked before OS X 10.11)</span></span><br><span class="line"><span class="comment">//        if (!dyld_program_sdk_at_least(dyld_platform_version_macOS_10_11)) &#123;</span></span><br><span class="line"><span class="comment">//            DisableNonpointerIsa = true;</span></span><br><span class="line"><span class="comment">//            if (PrintRawIsa) &#123;</span></span><br><span class="line"><span class="comment">//                _objc_inform("RAW ISA: disabling non-pointer isa because "</span></span><br><span class="line"><span class="comment">//                             "the app is too old.");</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Disable non-pointer isa if the app has a __DATA,__objc_rawisa section</span></span><br><span class="line">        <span class="comment">// New apps that load old extensions may need this.</span></span><br><span class="line">        <span class="keyword">for</span> (EACH_HEADER) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hi-&gt;mhdr()-&gt;filetype != MH_EXECUTE) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="built_in">size</span>;</span><br><span class="line">            <span class="keyword">if</span> (getsectiondata(hi-&gt;mhdr(), <span class="string">"__DATA"</span>, <span class="string">"__objc_rawisa"</span>, &amp;<span class="built_in">size</span>)) &#123;</span><br><span class="line">                DisableNonpointerIsa = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">if</span> (PrintRawIsa) &#123;</span><br><span class="line">                    _objc_inform(<span class="string">"RAW ISA: disabling non-pointer isa because "</span></span><br><span class="line">                                 <span class="string">"the app has a __DATA,__objc_rawisa section"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;  <span class="comment">// assume only one MH_EXECUTE image</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>é€šè¿‡å® <code>TARGET_OS_OSX</code> åˆ¤æ–­æ˜¯å¦æ˜¯ <code>macOS</code> æ‰§è¡Œç¯å¢ƒ</li>
<li>åˆ¤æ–­ <code>macOS</code> çš„ç³»ç»Ÿç‰ˆæœ¬ï¼Œå¦‚æœå°äº <code>10.11</code> åˆ™è¯´æ˜ <code>app</code> å¤ªé™ˆæ—§äº†ï¼Œéœ€è¦ç¦ç”¨æ‰ <code>non-pointer isa</code></li>
<li>ç„¶åå†éå†æ‰€æœ‰çš„ <code>Mach-O</code> çš„å¤´éƒ¨ï¼Œåˆ¤æ–­å¦‚æœæœ‰ <code>__DATA__,__objc_rawisa</code> æ®µçš„å­˜åœ¨ï¼Œåˆ™ç¦ç”¨æ‰ <code>non-pointer isa</code> ï¼Œå› ä¸ºå¾ˆå¤šæ–°çš„ <code>app</code> åŠ è½½è€çš„æ‰©å±•çš„æ—¶å€™ä¼šéœ€è¦è¿™æ ·çš„åˆ¤æ–­æ“ä½œã€‚</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// namedClasses</span></span><br><span class="line"><span class="comment">// Preoptimized classes don't go in this table.</span></span><br><span class="line"><span class="comment">// 4/3 is NXMapTable's load factor</span></span><br><span class="line"><span class="keyword">int</span> namedClassesSize = </span><br><span class="line">    (isPreoptimized() ? unoptimizedTotalClasses : totalClasses) * <span class="number">4</span> / <span class="number">3</span>;</span><br><span class="line">gdb_objc_realized_classes =</span><br><span class="line">    NXCreateMapTable(NXStrValueMapPrototype, namedClassesSize);</span><br></pre></td></tr></table></figure>

<p>é¢„å…ˆä¼˜åŒ–è¿‡çš„ç±»ä¸ä¼šåŠ å…¥åˆ° <code>gdb_objc_realized_classes</code> è¿™ä¸ªå“ˆå¸Œè¡¨ä¸­æ¥ï¼Œ <code>gdb_objc_realized_classes</code> å“ˆå¸Œè¡¨çš„è£…è½½å› å­ä¸º 0.75ï¼Œè¿™æ˜¯ä¸€ä¸ªç»è¿‡éªŒè¯çš„æ•ˆç‡å¾ˆé«˜çš„æ‰©å®¹ä¸´ç•Œå€¼ã€‚</p>
<ul>
<li>åŠ è½½æ‰€æœ‰ç±»åˆ°ç±»çš„ <code>gdb_objc_realized_classes</code> è¡¨ä¸­æ¥</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This is a misnomer: gdb_objc_realized_classes is actually a list of </span></span><br><span class="line"><span class="comment">// named classes not in the dyld shared cache, whether realized or not.</span></span><br><span class="line"><span class="comment">// This list excludes lazily named classes, which have to be looked up</span></span><br><span class="line"><span class="comment">// using a getClass hook.</span></span><br><span class="line">NXMapTable *gdb_objc_realized_classes;  <span class="comment">// exported for debuggers in objc-gdb.h</span></span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯ä¸€ä¸ªè¯¯ç§°ï¼šgdb_objc_realized_classes è¡¨å®é™…ä¸Šå­˜å‚¨çš„æ˜¯ä¸åœ¨ <code>dyld</code> å…±äº«ç¼“å­˜é‡Œé¢çš„å‘½åç±»ï¼Œæ— è®ºè¿™äº›ç±»æ˜¯å¦å®ç°</p>
<p>é™¤äº† <code>gdb_objc_realized_classes</code> è¡¨ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€å¼ è¡¨ <code>allocatedClasses</code> :</p>
<p>å…¶å® <code>gdb_objc_realized_classes</code> å¯¹ <code>allocatedClasses</code> æ˜¯ä¸€ç§åŒ…å«çš„å…³ç³»ï¼Œä¸€å¼ æ˜¯ç±»çš„æ€»è¡¨ï¼Œä¸€å¼ æ˜¯å·²ç»å¼€è¾Ÿäº†å†…å­˜çš„ç±»è¡¨.</p>
<h5 id="Discover-classes-æµç¨‹"><a href="#Discover-classes-æµç¨‹" class="headerlink" title="Discover classes æµç¨‹"></a>Discover classes æµç¨‹</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Discover classes. Fix up unresolved future classes. Mark bundle classes.</span></span><br><span class="line"><span class="keyword">bool</span> hasDyldRoots = dyld_shared_cache_some_image_overridden();</span><br><span class="line"><span class="keyword">for</span> (EACH_HEADER) &#123;</span><br><span class="line">    <span class="keyword">if</span> (! mustReadClasses(hi, hasDyldRoots)) &#123;</span><br><span class="line">        <span class="comment">// Image is sufficiently optimized that we need not call readClass()</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">classref_t</span> <span class="keyword">const</span> *classlist = _getObjc2ClassList(hi, &amp;count);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> headerIsBundle = hi-&gt;isBundle();</span><br><span class="line">    <span class="keyword">bool</span> headerIsPreoptimized = hi-&gt;hasPreoptimizedClasses();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        Class cls = (Class)classlist[i];</span><br><span class="line">        Class newCls = readClass(cls, headerIsBundle, headerIsPreoptimized);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (newCls != cls  &amp;&amp;  newCls) &#123;</span><br><span class="line">            <span class="comment">// Class was moved but not deleted. Currently this occurs </span></span><br><span class="line">            <span class="comment">// only when the new class resolved a future class.</span></span><br><span class="line">            <span class="comment">// Non-lazily realize the class below.</span></span><br><span class="line">            resolvedFutureClasses = (Class *)</span><br><span class="line">                <span class="built_in">realloc</span>(resolvedFutureClasses, </span><br><span class="line">                        (resolvedFutureClassCount+<span class="number">1</span>) * <span class="keyword">sizeof</span>(Class));</span><br><span class="line">            resolvedFutureClasses[resolvedFutureClassCount++] = newCls;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Discover classes. Fix up unresolved future classes. Mark bundle classes.<br>å‘ç°ç±»ã€‚ä¿®æ­£æœªè§£æçš„ <code>future</code> ç±»ï¼Œæ ‡è®° <code>bundle</code> ç±»ã€‚</p>
<ul>
<li>å…ˆé€šè¿‡ <code>_getObjc2ClassList</code> æ¥è·å–åˆ°æ‰€æœ‰çš„ç±»</li>
<li>æ¥ç€è¿˜æ˜¯éå†æ‰€æœ‰çš„ <code>Mach-O</code> çš„ <code>header</code> éƒ¨åˆ†ï¼Œç„¶åé€šè¿‡ <code>mustReadClasses</code> æ¥åˆ¤æ–­å“ªäº›æ¡ä»¶å¯ä»¥è·³è¿‡è¯»å–ç±»è¿™ä¸€æ­¥éª¤</li>
<li>è¯»å– <code>header</code> æ˜¯å¦æ˜¯ <code>Bundle</code></li>
<li>è¯»å– <code>header</code> æ˜¯å¦å¼€å¯äº† <strong>é¢„ä¼˜åŒ–</strong></li>
<li>éå† <code>_getObjc2ClassList</code> å–å‡ºçš„æ‰€æœ‰çš„ç±»<ul>
<li>é€šè¿‡ <code>readClass</code> æ¥è¯»å–ç±»ä¿¡æ¯</li>
<li>åˆ¤æ–­å¦‚æœä¸ç›¸ç­‰å¹¶ä¸” <code>readClass</code> ç»“æœä¸ä¸ºç©ºï¼Œåˆ™éœ€è¦é‡æ–°ä¸ºç±»å¼€è¾Ÿå†…å­˜</li>
</ul>
</li>
</ul>
<p><strong>Fix up remapped classes æµç¨‹</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Fix up remapped classes</span></span><br><span class="line"><span class="comment">// Class list and nonlazy class list remain unremapped.</span></span><br><span class="line"><span class="comment">// Class refs and super refs are remapped for message dispatching.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!noClassesRemapped()) &#123;</span><br><span class="line">    <span class="keyword">for</span> (EACH_HEADER) &#123;</span><br><span class="line">        Class *classrefs = _getObjc2ClassRefs(hi, &amp;count);</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            remapClassRef(&amp;classrefs[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// fixme why doesn't test future1 catch the absence of this?</span></span><br><span class="line">        classrefs = _getObjc2SuperRefs(hi, &amp;count);</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            remapClassRef(&amp;classrefs[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¿®å¤ é‡æ˜ å°„ç±»<br>ç±»è¡¨å’Œéæ‡’åŠ è½½ç±»è¡¨æ²¡æœ‰è¢«é‡æ˜ å°„ (ä¹Ÿå°±æ˜¯ <strong>_objc_classlist</strong>)<br>ç”±äºæ¶ˆæ¯è½¬å‘ï¼Œç±»å¼•ç”¨å’Œçˆ¶ç±»å¼•ç”¨ä¼šè¢«é‡æ˜ å°„ (ä¹Ÿå°±æ˜¯ <strong>_objc_classrefs</strong>)</p>
<ul>
<li>é€šè¿‡ <code>noClassesRemapped</code> æ–¹æ³•åˆ¤æ–­æ˜¯å¦æœ‰ç±»å¼•ç”¨(<strong>_objc_classrefs</strong>)éœ€è¦è¿›è¡Œé‡æ˜ å°„<ul>
<li>å¦‚æœéœ€è¦ï¼Œåˆ™éå† <code>EACH_HEADER</code></li>
<li>é€šè¿‡ <code>_getObjc2ClassRefs</code> å’Œ <code>_getObjc2SuperRefs</code> å–å‡ºå½“å‰éå†åˆ°çš„ <code>Mach-O</code> çš„ç±»å¼•ç”¨å’Œçˆ¶ç±»å¼•ç”¨ï¼Œç„¶åè°ƒç”¨ <code>remapClassRef</code> è¿›è¡Œé‡æ˜ å°„</li>
</ul>
</li>
</ul>
<p><strong>Fix up @selector references æµç¨‹</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Fix up @selector references</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">size_t</span> UnfixedSelectors;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">mutex_locker_t</span> <span class="title">lock</span><span class="params">(selLock)</span></span>;</span><br><span class="line">        <span class="keyword">for</span> (EACH_HEADER) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hi-&gt;hasPreoptimizedSelectors()) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">bool</span> isBundle = hi-&gt;isBundle();</span><br><span class="line">            SEL *sels = _getObjc2SelectorRefs(hi, &amp;count);</span><br><span class="line">            UnfixedSelectors += count;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">                <span class="keyword">const</span> <span class="keyword">char</span> *name = sel_cname(sels[i]);</span><br><span class="line">                SEL sel = sel_registerNameNoLock(name, isBundle);</span><br><span class="line">                <span class="keyword">if</span> (sels[i] != sel) &#123;</span><br><span class="line">                    sels[i] = sel;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="function">SEL <span class="title">sel_registerNameNoLock</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">bool</span> copy)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> __sel_registerName(name, <span class="number">0</span>, copy);  <span class="comment">// NO lock, maybe copy</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä¿®æ­£ <code>SEL</code> å¼•ç”¨</p>
</blockquote>
<ul>
<li>æ“ä½œå‰å…ˆåŠ ä¸€ä¸ª <code>selLock</code> é”</li>
<li>ç„¶åéå†<code>EACH_HEADER</code><ul>
<li>å¦‚æœå¼€å¯äº†<strong>é¢„ä¼˜åŒ–</strong>ï¼Œcontiue åˆ°ä¸‹ä¸€ä¸ª <code>Mach-O</code></li>
<li>é€šè¿‡ <code>_getObjc2SelectorRefs</code> æ‹¿åˆ°æ‰€æœ‰çš„ <code>SEL</code> å¼•ç”¨</li>
<li>ç„¶åå¯¹æ‰€æœ‰çš„ <code>SEL</code> å¼•ç”¨è°ƒç”¨ <code>sel_registerNameNoLock</code> è¿›è¡Œæ³¨å†Œ</li>
</ul>
</li>
</ul>
<p>ä¹Ÿå°±æ˜¯è¯´è¿™ä¸€æµç¨‹æœ€ä¸»è¦çš„ç›®çš„å°±æ˜¯æ³¨å†Œ <code>SEL</code> ï¼Œæˆ‘ä»¬æ³¨å†ŒçœŸæ­£å‘ç”Ÿçš„åœ°æ–¹: <code>__sel_registerName</code> ï¼Œè¿™ä¸ªå‡½æ•°å¦‚æœå¤§å®¶ç»å¸¸ç© <code>Runtime</code> è‚¯å®šä¸ä¼šé™Œç”Ÿï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> SEL __sel_registerName(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">bool</span> shouldLock, <span class="keyword">bool</span> copy) </span><br><span class="line">&#123;</span><br><span class="line">    SEL result = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shouldLock) selLock.assertUnlocked();</span><br><span class="line">    <span class="keyword">else</span> selLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!name) <span class="keyword">return</span> (SEL)<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    result = search_builtins(name);</span><br><span class="line">    <span class="keyword">if</span> (result) <span class="keyword">return</span> result;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">conditional_mutex_locker_t</span> <span class="title">lock</span><span class="params">(selLock, shouldLock)</span></span>;</span><br><span class="line">	<span class="keyword">auto</span> it = namedSelectors.<span class="built_in">get</span>().insert(name);</span><br><span class="line">	<span class="keyword">if</span> (it.second) &#123;</span><br><span class="line">		<span class="comment">// No match. Insert.</span></span><br><span class="line">		*it.first = (<span class="keyword">const</span> <span class="keyword">char</span> *)sel_alloc(name, copy);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> (SEL)*it.first;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ç®€å•åˆ†æä¸€ä¸‹ <code>__sel_registerName</code> æ–¹æ³•çš„æµç¨‹ï¼š</p>
<ul>
<li>åˆ¤æ–­æ˜¯å¦è¦åŠ é”</li>
<li>å¦‚æœ <code>sel</code> ä¸ºç©ºï¼Œåˆ™è¿”å›ä¸€ä¸ªç©ºçš„ <code>SEL</code></li>
<li>ä» <code>builtins</code> ä¸­æœç´¢ï¼Œçœ‹æ˜¯å¦å·²ç»æ³¨å†Œè¿‡ï¼Œå¦‚æœæ‰¾åˆ°ï¼Œç›´æ¥è¿”å›ç»“æœ</li>
<li>ä» <code>namedSelectors</code> å“ˆå¸Œè¡¨ä¸­æŸ¥è¯¢ï¼Œæ‰¾åˆ°äº†å°±è¿”å›ç»“æœ</li>
<li>å¦‚æœ <code>namedSelectors</code> æœªåˆå§‹åŒ–ï¼Œåˆ™åˆ›å»ºä¸€ä¸‹è¿™ä¸ªå“ˆå¸Œè¡¨</li>
<li>å¦‚æœä¸Šé¢çš„æµç¨‹éƒ½æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™éœ€è¦è°ƒç”¨ <code>sel_alloc</code> æ¥åˆ›å»ºä¸€ä¸‹ <code>SEL</code> ï¼Œç„¶åæŠŠæ–°åˆ›å»ºçš„ <code>SEL</code> æ’å…¥å“ˆå¸Œè¡¨ä¸­è¿›è¡Œç¼“å­˜çš„å¡«å……</li>
</ul>
<h5 id="Fix-up-old-objc-msgSend-fixup-call-sites-æµç¨‹"><a href="#Fix-up-old-objc-msgSend-fixup-call-sites-æµç¨‹" class="headerlink" title="Fix up old objc_msgSend_fixup call sites æµç¨‹"></a><strong>Fix up old objc_msgSend_fixup call sites æµç¨‹</strong></h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> SUPPORT_FIXUP</span></span><br><span class="line">    <span class="comment">// Fix up old objc_msgSend_fixup call sites</span></span><br><span class="line">    <span class="keyword">for</span> (EACH_HEADER) &#123;</span><br><span class="line">        <span class="keyword">message_ref_t</span> *refs = _getObjc2MessageRefs(hi, &amp;count);</span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (PrintVtables) &#123;</span><br><span class="line">            _objc_inform(<span class="string">"VTABLES: repairing %zu unsupported vtable dispatch "</span></span><br><span class="line">                         <span class="string">"call sites in %s"</span>, count, hi-&gt;fname());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            fixupMessageRef(refs+i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ts.<span class="built_in">log</span>(<span class="string">"IMAGE TIMES: fix up objc_msgSend_fixup"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>ä¿®æ­£æ—§çš„ <code>objc_msgSend_fixup</code> è°ƒç”¨</p>
<p>è¿™ä¸ªæµç¨‹çš„æ‰§è¡Œå‰ææ˜¯ <code>FIXUP</code> è¢«å¼€å¯ã€‚</p>
<ul>
<li>è¿˜æ˜¯è€å¥—è·¯ï¼Œéå†<code>EACH_HEADER</code><ul>
<li>é€šè¿‡ <code>_getObjc2MessageRefs</code> æ–¹æ³•æ¥è·å–å½“å‰éå†åˆ°çš„ <code>Mach-O</code> é•œåƒçš„æ‰€æœ‰æ¶ˆæ¯å¼•ç”¨</li>
<li>ç„¶åéå†è¿™äº›æ¶ˆæ¯å¼•ç”¨ï¼Œç„¶åè°ƒç”¨ <code>fixupMessageRef</code> è¿›è¡Œä¿®æ­£</li>
</ul>
</li>
</ul>
<h5 id="Discover-protocols-æµç¨‹"><a href="#Discover-protocols-æµç¨‹" class="headerlink" title="Discover protocols æµç¨‹"></a><strong>Discover protocols æµç¨‹</strong></h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Discover protocols. Fix up protocol refs.</span></span><br><span class="line"><span class="keyword">for</span> (EACH_HEADER) &#123;</span><br><span class="line">    <span class="keyword">extern</span> objc_class OBJC_CLASS_$_Protocol;</span><br><span class="line">    Class cls = (Class)&amp;OBJC_CLASS_$_Protocol;</span><br><span class="line">    ASSERT(cls);</span><br><span class="line">    NXMapTable *protocol_map = protocols();</span><br><span class="line">    <span class="keyword">bool</span> isPreoptimized = hi-&gt;hasPreoptimizedProtocols();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Skip reading protocols if this is an image from the shared cache</span></span><br><span class="line">    <span class="comment">// and we support roots</span></span><br><span class="line">    <span class="comment">// Note, after launch we do need to walk the protocol as the protocol</span></span><br><span class="line">    <span class="comment">// in the shared cache is marked with isCanonical() and that may not</span></span><br><span class="line">    <span class="comment">// be true if some non-shared cache binary was chosen as the canonical</span></span><br><span class="line">    <span class="comment">// definition</span></span><br><span class="line">    <span class="keyword">if</span> (launchTime &amp;&amp; isPreoptimized) &#123;</span><br><span class="line">        <span class="keyword">if</span> (PrintProtocols) &#123;</span><br><span class="line">            _objc_inform(<span class="string">"PROTOCOLS: Skipping reading protocols in image: %s"</span>,</span><br><span class="line">                         hi-&gt;fname());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">bool</span> isBundle = hi-&gt;isBundle();</span><br><span class="line">    <span class="keyword">protocol_t</span> * <span class="keyword">const</span> *protolist = _getObjc2ProtocolList(hi, &amp;count);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        readProtocol(protolist[i], cls, protocol_map, </span><br><span class="line">                     isPreoptimized, isBundle);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‘ç°åè®®ï¼Œå¹¶ä¿®æ­£åè®®å¼•ç”¨</p>
<h5 id="Fix-up-protocol-references-æµç¨‹"><a href="#Fix-up-protocol-references-æµç¨‹" class="headerlink" title="Fix up @protocol references æµç¨‹"></a><strong>Fix up @protocol references æµç¨‹</strong></h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Fix up @protocol references</span></span><br><span class="line"><span class="comment">// Preoptimized images may have the right </span></span><br><span class="line"><span class="comment">// answer already but we don't know for sure.</span></span><br><span class="line"><span class="keyword">for</span> (EACH_HEADER) &#123;</span><br><span class="line">    <span class="comment">// At launch time, we know preoptimized image refs are pointing at the</span></span><br><span class="line">    <span class="comment">// shared cache definition of a protocol.  We can skip the check on</span></span><br><span class="line">    <span class="comment">// launch, but have to visit @protocol refs for shared cache images</span></span><br><span class="line">    <span class="comment">// loaded later.</span></span><br><span class="line">    <span class="keyword">if</span> (launchTime &amp;&amp; hi-&gt;isPreoptimized())</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">protocol_t</span> **protolist = _getObjc2ProtocolRefs(hi, &amp;count);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        remapProtocolRef(&amp;protolist[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹æ‰€æœ‰çš„åè®®åšé‡æ˜ å°„</p>
<h5 id="Realize-non-lazy-classes-æµç¨‹"><a href="#Realize-non-lazy-classes-æµç¨‹" class="headerlink" title="Realize non-lazy classes æµç¨‹"></a><strong>Realize non-lazy classes æµç¨‹</strong></h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Realize non-lazy classes (for +load methods and static instances)</span></span><br><span class="line"><span class="keyword">for</span> (EACH_HEADER) &#123;</span><br><span class="line">    <span class="keyword">classref_t</span> <span class="keyword">const</span> *classlist = hi-&gt;nlclslist(&amp;count);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        Class cls = remapClass(classlist[i]);</span><br><span class="line">        <span class="keyword">if</span> (!cls) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        addClassTableEntry(cls);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cls-&gt;isSwiftStable()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cls-&gt;swiftMetadataInitializer()) &#123;</span><br><span class="line">                _objc_fatal(<span class="string">"Swift class %s with a metadata initializer "</span></span><br><span class="line">                            <span class="string">"is not allowed to be non-lazy"</span>,</span><br><span class="line">                            cls-&gt;nameForLogging());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// fixme also disallow relocatable classes</span></span><br><span class="line">            <span class="comment">// We can't disallow all Swift classes because of</span></span><br><span class="line">            <span class="comment">// classes like Swift.__EmptyArrayStorage</span></span><br><span class="line">        &#125;</span><br><span class="line">        realizeClassWithoutSwift(cls, nil);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆå§‹åŒ–<strong>éæ‡’åŠ è½½ç±»( <code>+load</code> æ–¹æ³•å’Œé™æ€å®ä¾‹</strong>)**</p>
<h5 id="Realize-newly-resolved-future-classes-æµç¨‹"><a href="#Realize-newly-resolved-future-classes-æµç¨‹" class="headerlink" title="Realize newly-resolved future classes æµç¨‹"></a><strong>Realize newly-resolved future classes æµç¨‹</strong></h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Realize newly-resolved future classes, in case CF manipulates them</span></span><br><span class="line"><span class="keyword">if</span> (resolvedFutureClasses) &#123;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; resolvedFutureClassCount; i++) &#123;</span><br><span class="line">        Class cls = resolvedFutureClasses[i];</span><br><span class="line">        <span class="keyword">if</span> (cls-&gt;isSwiftStable()) &#123;</span><br><span class="line">            _objc_fatal(<span class="string">"Swift class is not allowed to be future"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        realizeClassWithoutSwift(cls, nil);</span><br><span class="line">        cls-&gt;setInstancesRequireRawIsaRecursively(<span class="literal">false</span><span class="comment">/*inherited*/</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(resolvedFutureClasses);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆå§‹åŒ–æ–°è§£æå‡ºæ¥çš„ <code>future</code> ç±»</p>
<h5 id="Discover-categories-æµç¨‹"><a href="#Discover-categories-æµç¨‹" class="headerlink" title="Discover categories æµç¨‹"></a><strong>Discover categories æµç¨‹</strong></h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Discover categories. Only do this after the initial category</span></span><br><span class="line"><span class="comment">// attachment has been done. For categories present at startup,</span></span><br><span class="line"><span class="comment">// discovery is deferred until the first load_images call after</span></span><br><span class="line"><span class="comment">// the call to _dyld_objc_notify_register completes. rdar://problem/53119145</span></span><br><span class="line"><span class="keyword">if</span> (didInitialAttachCategories) &#123;</span><br><span class="line">    <span class="keyword">for</span> (EACH_HEADER) &#123;</span><br><span class="line">        load_categories_nolock(hi);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¤„ç†æ‰€æœ‰çš„åˆ†ç±»ï¼ŒåŒ…æ‹¬ç±»å’Œå…ƒç±»</p>
<p>åˆ°è¿™é‡Œï¼Œ <code>_read_images</code> çš„æµç¨‹å°±åˆ†æå®Œæ¯•ï¼Œæˆ‘ä»¬å¯ä»¥æ–°å»ºä¸€ä¸ªæ–‡ä»¶æ¥å»æ‰ä¸€äº›å¹²æ‰°çš„ä¿¡æ¯ï¼Œåªä¿ç•™æ ¸å¿ƒçš„é€»è¾‘ï¼Œè¿™æ ·ä»å®è§‚çš„è§’åº¦æ¥åˆ†ææ›´ç›´è§‚:</p>
<p><img src="/images/_read_image_schedule.png" alt="_read_image_schedule"></p>
<p>Q &amp; A ç¯èŠ‚<br>Qï¼š <code>dyld</code> ä¸»è¦é€»è¾‘æ˜¯åŠ è½½åº“ï¼Œä¹Ÿå°±æ˜¯é•œåƒæ–‡ä»¶ï¼Œä½†æ˜¯åŠ è½½å®Œæ˜¯æ€ä¹ˆè¯»å–çš„å‘¢ï¼Ÿ<br>Aï¼š <code>_read_images</code> æ˜¯çœŸæ­£è¯»å–çš„åœ°æ–¹</p>
<p>Q: <code>SEL</code> æ–¹æ³•ç¼–å·ä½•æ—¶åŠ è½½ï¼Ÿ<br>A: <code>_read_images</code></p>
<h4 id="read-class-åˆ†æ"><a href="#read-class-åˆ†æ" class="headerlink" title="read_class åˆ†æ"></a>read_class åˆ†æ</h4><p>æˆ‘ä»¬æ¢ç´¢äº† <code>_read_images</code> æ–¹æ³•çš„æµç¨‹ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬æŠŠç›®å…‰æ”¾åˆ°æœ¬æ–‡çš„ä¸»é¢˜ - <strong>ç±»çš„åŠ è½½</strong><br>æ—¢ç„¶æ˜¯ç±»çš„åŠ è½½ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨å‰é¢æ‰€æ¢ç´¢çš„ç±»çš„ç»“æ„ä¸­å‡ºç°çš„å†…å®¹éƒ½ä¼šä¸€ä¸€é‡ç°ã€‚<br>æ‰€ä»¥æˆ‘ä»¬ä¸å¦¨ç›´æ¥è¿›è¡Œæ–­ç‚¹è°ƒè¯•ï¼Œè®©æˆ‘ä»¬ç•¥è¿‡å…¶å®ƒå¹²æ‰°ä¿¡æ¯ï¼Œèšç„¦äºç±»çš„åŠ è½½ã€‚</p>
<ul>
<li>æ ¹æ®ä¸Šä¸€å°èŠ‚æˆ‘ä»¬æ¢ç´¢çš„ç»“æœï¼Œ <code>doneOnce</code> æµç¨‹ä¸­ä¼šåˆ›å»ºä¸¤ä¸ªå“ˆå¸Œè¡¨ï¼Œå¹¶æ²¡æœ‰æ¶‰åŠåˆ°ç±»çš„åŠ è½½ï¼Œæ‰€ä»¥æˆ‘ä»¬è·³è¿‡</li>
<li>æˆ‘ä»¬æ¥åˆ°ç¬¬äºŒä¸ªæµç¨‹ - <strong>ç±»å¤„ç†</strong></li>
</ul>
<p>æˆ‘ä»¬åœ¨<code>_read_images</code>å‡½æ•°ï¼Œå®šä½åˆ°ä¸‹é¢è¿™è¡Œä»£ç ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class cls = (Class)classlist[i];<span class="comment">//æ–­ç‚¹</span></span><br><span class="line">Class newCls = readClass(cls, headerIsBundle, headerIsPreoptimized);</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ° <code>cls</code> çš„å±æ€§ã€æ–¹æ³•ã€åè®®ä»¥åŠç±»åéƒ½ä¸ºç©ºï¼Œè¯´æ˜è¿™é‡Œç±»å¹¶æ²¡æœ‰è¢«çœŸæ­£åŠ è½½å®Œæˆï¼Œæˆ‘ä»¬æ¥ç€èšç„¦åˆ° <code>read_class</code> å‡½æ•°ä¸Šé¢ï¼Œæˆ‘ä»¬è¿›å…¥å…¶å†…éƒ¨å®ç°ï¼Œæˆ‘ä»¬å¤§è‡´æµè§ˆä¹‹åä¼šå®šä½åˆ°å¦‚ä¸‹å›¾æ‰€ç¤ºçš„ä»£ç ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* readClass</span></span><br><span class="line"><span class="comment">* Read a class and metaclass as written by a compiler.</span></span><br><span class="line"><span class="comment">* Returns the new class pointer. This could be: </span></span><br><span class="line"><span class="comment">* - cls</span></span><br><span class="line"><span class="comment">* - nil  (cls has a missing weak-linked superclass)</span></span><br><span class="line"><span class="comment">* - something else (space for this class was reserved by a future class)</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Note that all work performed by this function is preflighted by </span></span><br><span class="line"><span class="comment">* mustReadClasses(). Do not change this function without updating that one.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Locking: runtimeLock acquired by map_images or objc_readClassPair</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function">Class <span class="title">readClass</span><span class="params">(Class cls, <span class="keyword">bool</span> headerIsBundle, <span class="keyword">bool</span> headerIsPreoptimized)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *mangledName = cls-&gt;nonlazyMangledName();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (missingWeakSuperclass(cls)) &#123;</span><br><span class="line">        <span class="comment">// No superclass (probably weak-linked). </span></span><br><span class="line">        <span class="comment">// Disavow any knowledge of this subclass.</span></span><br><span class="line">        <span class="keyword">if</span> (PrintConnecting) &#123;</span><br><span class="line">            _objc_inform(<span class="string">"CLASS: IGNORING class '%s' with "</span></span><br><span class="line">                         <span class="string">"missing weak-linked superclass"</span>, </span><br><span class="line">                         cls-&gt;nameForLogging());</span><br><span class="line">        &#125;</span><br><span class="line">        addRemappedClass(cls, nil);</span><br><span class="line">        cls-&gt;setSuperclass(nil);</span><br><span class="line">        <span class="keyword">return</span> nil;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    cls-&gt;fixupBackwardDeployingStableSwift();</span><br><span class="line"></span><br><span class="line">    Class replacing = nil;</span><br><span class="line">    <span class="keyword">if</span> (mangledName != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Class newCls = popFutureNamedClass(mangledName)) &#123;</span><br><span class="line">            <span class="comment">// This name was previously allocated as a future class.</span></span><br><span class="line">            <span class="comment">// Copy objc_class to future class's struct.</span></span><br><span class="line">            <span class="comment">// Preserve future's rw data block.</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (newCls-&gt;isAnySwift()) &#123;</span><br><span class="line">                _objc_fatal(<span class="string">"Can't complete future class request for '%s' "</span></span><br><span class="line">                            <span class="string">"because the real class is too big."</span>,</span><br><span class="line">                            cls-&gt;nameForLogging());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">class_rw_t</span> *rw = newCls-&gt;data();</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">class_ro_t</span> *old_ro = rw-&gt;ro();</span><br><span class="line">            <span class="built_in">memcpy</span>(newCls, cls, <span class="keyword">sizeof</span>(objc_class));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Manually set address-discriminated ptrauthed fields</span></span><br><span class="line">            <span class="comment">// so that newCls gets the correct signatures.</span></span><br><span class="line">            newCls-&gt;setSuperclass(cls-&gt;getSuperclass());</span><br><span class="line">            newCls-&gt;initIsa(cls-&gt;getIsa());</span><br><span class="line"></span><br><span class="line">            rw-&gt;set_ro((<span class="keyword">class_ro_t</span> *)newCls-&gt;data());</span><br><span class="line">            newCls-&gt;setData(rw);</span><br><span class="line">            freeIfMutable((<span class="keyword">char</span> *)old_ro-&gt;getName());</span><br><span class="line">            <span class="built_in">free</span>((<span class="keyword">void</span> *)old_ro);</span><br><span class="line"></span><br><span class="line">            addRemappedClass(cls, newCls);</span><br><span class="line"></span><br><span class="line">            replacing = cls;</span><br><span class="line">            cls = newCls;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (headerIsPreoptimized  &amp;&amp;  !replacing) &#123;</span><br><span class="line">        <span class="comment">// class list built in shared cache</span></span><br><span class="line">        <span class="comment">// fixme strict assert doesn't work because of duplicates</span></span><br><span class="line">        <span class="comment">// ASSERT(cls == getClass(name));</span></span><br><span class="line">        ASSERT(mangledName == <span class="literal">nullptr</span> || getClassExceptSomeSwift(mangledName));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mangledName) &#123; <span class="comment">//some Swift generic classes can lazily generate their names</span></span><br><span class="line">            addNamedClass(cls, mangledName, replacing);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Class meta = cls-&gt;ISA();</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">class_ro_t</span> *metaRO = meta-&gt;bits.safe_ro();</span><br><span class="line">            ASSERT(metaRO-&gt;getNonMetaclass() &amp;&amp; <span class="string">"Metaclass with lazy name must have a pointer to the corresponding nonmetaclass."</span>);</span><br><span class="line">            ASSERT(metaRO-&gt;getNonMetaclass() == cls &amp;&amp; <span class="string">"Metaclass nonmetaclass pointer must equal the original class."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        addClassTableEntry(cls);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// for future reference: shared cache never contains MH_BUNDLEs</span></span><br><span class="line">    <span class="keyword">if</span> (headerIsBundle) &#123;</span><br><span class="line">        cls-&gt;data()-&gt;flags |= RO_FROM_BUNDLE;</span><br><span class="line">        cls-&gt;ISA()-&gt;data()-&gt;flags |= RO_FROM_BUNDLE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> cls;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹èµ·æ¥ç±»çš„ä¿¡æ¯åœ¨è¿™é‡Œå®Œæˆäº†åŠ è½½ï¼Œé‚£ä¹ˆä¸ºäº†éªŒè¯æˆ‘ä»¬çš„çŒœæƒ³ï¼Œç›´æ¥æ–­ç‚¹è°ƒè¯•ä¸€ä¸‹ä½†å‘ç°æ–­ç‚¹æ ¹æœ¬èµ°ä¸è¿›æ¥ï¼ŒåŸå› åœ¨äºè¿™é‡Œçš„åˆ¤æ–­è¯­å¥</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Class newCls = popFutureNamedClass(mangledName))</span><br></pre></td></tr></table></figure>

<p>åˆ¤æ–­å½“å‰ä¼ å…¥çš„ç±»çš„ç±»åæ˜¯å¦æœ‰ <code>future</code> ç±»çš„å®ç°ï¼Œä½†æ˜¯æˆ‘ä»¬åˆšæ‰å·²ç»æ‰“å°äº†ï¼Œç±»åæ˜¯ç©ºçš„ï¼Œæ‰€ä»¥è‚¯å®šä¸ä¼šæ‰§è¡Œè¿™é‡Œã€‚æˆ‘ä»¬æ¥ç€å¾€ä¸‹èµ°ï¼š</p>
<ul>
<li>addNamedClass å†…éƒ¨å…¶å®æ˜¯å°† <code>cls</code> æ’å…¥åˆ° <code>gdb_objc_realized_classes</code> è¡¨</li>
<li>addclassTableEntry å†…éƒ¨æ˜¯å°† <code>cls</code> æ’å…¥åˆ° <code>allocatedClasses</code> è¡¨</li>
</ul>
<p>åˆ†æå®Œ <code>read_class</code> ï¼Œæˆ‘ä»¬å›åˆ° <code>_read_images</code> æ–¹æ³•</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>read_class</code> è¿”å›çš„ <code>newCls</code> ä¼šè¿›è¡Œä¸€ä¸ªåˆ¤æ–­ï¼Œåˆ¤æ–­ä¸ä¼ å…¥ <code>read_class</code> ä¹‹å‰çš„ <code>cls</code> æ˜¯å¦ç›¸ç­‰ï¼Œè€Œåœ¨ <code>read_class</code> å†…éƒ¨åªæœ‰ä¸€ä¸ªåœ°æ–¹å¯¹ç±»çš„å†…å®¹è¿›è¡Œäº†æ”¹åŠ¨ï¼Œä½†æ˜¯æˆ‘ä»¬åˆšæ‰æµ‹è¯•äº†æ˜¯è¿›ä¸å»çš„ï¼Œæ‰€ä»¥è¿™ä¸ª <code>if</code> é‡Œé¢çš„å†…å®¹æˆ‘ä»¬å¯ä»¥ç•¥è¿‡ï¼Œä¹Ÿå°±æ˜¯è¯´ <code>resolvedFutureClasses</code> çš„å†…å®¹æˆ‘ä»¬éƒ½å¯ä»¥æš‚æ—¶ç•¥è¿‡ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹ <code>readClass</code> ï¼š</p>
<ul>
<li>åˆ¤æ–­æ˜¯ä¸æ˜¯è¦åæœŸå¤„ç†çš„ç±»<ul>
<li>å¦‚æœæ˜¯çš„è¯ï¼Œå°±å–å‡ºåæœŸå¤„ç†çš„ç±»ï¼Œè¯»å–è¿™ä¸ªç±»çš„ <code>data()</code> ç±»è®¾ç½® <code>ro/rw</code></li>
</ul>
</li>
<li>addNamedClass æ’å…¥æ€»è¡¨</li>
<li>addClassTableEntry æ’å…¥å·²å¼€è¾Ÿå†…å­˜çš„ç±»çš„è¡¨</li>
</ul>
<h4 id="realizeClassWithoutSwift-åˆ†æ"><a href="#realizeClassWithoutSwift-åˆ†æ" class="headerlink" title="realizeClassWithoutSwift åˆ†æ"></a>realizeClassWithoutSwift åˆ†æ</h4><p>é€šè¿‡åˆ†æ <code>read_class</code> ï¼Œæˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼Œç±»å·²ç»è¢«æ³¨å†Œåˆ°ä¸¤ä¸ªå“ˆå¸Œè¡¨ä¸­å»äº†ï¼Œé‚£ä¹ˆç°åœ¨ä¸€åˆ‡æ—¶æœºéƒ½å·²ç»æˆç†Ÿäº†ã€‚ä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯è¦ç•¥è¿‡åƒ <code>Fix up remapped classes</code> ã€ <code>Fix up @selector references</code> ã€ <code>fix up old objc_msgSend_fixup call sites</code> ã€ <code>Discover protocols. Fix up protocol refs</code> ã€ <code>Fix up @protocol references</code> ï¼Œå› ä¸ºæˆ‘ä»¬çš„é‡ç‚¹æ˜¯ç±»çš„åŠ è½½ï¼Œæˆ‘ä»¬æœ€ç»ˆæ¥åˆ°äº† <code>Realize non-lazy classes (for +load methods and static instances)</code> ï¼Œç•¥å»æ— å…³ä¿¡æ¯ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„<br>ä¸»è§’ <code>realizeClassWithoutSwift</code> é—ªäº®ç™»åœºäº†ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* realizeClassWithoutSwift</span></span><br><span class="line"><span class="comment">* Performs first-time initialization on class cls, </span></span><br><span class="line"><span class="comment">* including allocating its read-write data.</span></span><br><span class="line"><span class="comment">* Does not perform any Swift-side initialization.</span></span><br><span class="line"><span class="comment">* Returns the real class structure for the class. </span></span><br><span class="line"><span class="comment">* Locking: runtimeLock must be write-locked by the caller</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> Class <span class="title">realizeClassWithoutSwift</span><span class="params">(Class cls, Class previously)</span></span></span><br></pre></td></tr></table></figure>

<p>ä»æ–¹æ³•çš„åç§°ä»¥åŠæ–¹æ³•æ³¨é‡Šæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œ <code>realizeClassWithoutSwift</code> æ˜¯è¿›è¡Œç±»çš„ç¬¬ä¸€æ¬¡åˆå§‹åŒ–æ“ä½œï¼ŒåŒ…æ‹¬åˆ†é…è¯»å†™æ•°æ®ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ <code>rw</code> ï¼Œä½†æ˜¯å¹¶ä¸ä¼šè¿›è¡Œä»»ä½•çš„ <code>Swift</code> ç«¯åˆå§‹åŒ–ã€‚æˆ‘ä»¬ç›´æ¥èšç„¦ä¸‹é¢çš„ä»£ç ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Normal class. Allocate writeable class data.</span></span><br><span class="line">rw = objc::zalloc&lt;<span class="keyword">class_rw_t</span>&gt;();</span><br><span class="line">rw-&gt;set_ro(ro);</span><br><span class="line">rw-&gt;flags = RW_REALIZED|RW_REALIZING|isMeta;</span><br><span class="line">cls-&gt;setData(rw);</span><br></pre></td></tr></table></figure>

<ul>
<li>é€šè¿‡ <code>zalloc</code> å¼€è¾Ÿå†…å­˜ç©ºé—´ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ <code>rw</code></li>
<li>æŠŠ <code>cls</code> å–å‡ºæ¥çš„ <code>ro</code> èµ‹å€¼ç»™è¿™ä¸ª <code>rw</code></li>
<li>å°† <code>rw</code> è®¾ç½®åˆ° <code>cls</code> èº«ä¸Š</li>
</ul>
<p>å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°ï¼Œæ­¤æ—¶ <code>rw</code> è¿˜æ˜¯ä¸ºç©ºï¼Œè¯´æ˜è¿™é‡Œåªæ˜¯å¯¹ <code>rw</code> è¿›è¡Œäº†åˆå§‹åŒ–ï¼Œä½†æ˜¯æ–¹æ³•ã€å±æ€§ã€åè®®è¿™äº›éƒ½æ²¡æœ‰è¢«æ·»åŠ ä¸Šã€‚</p>
<p>æˆ‘ä»¬æ¥ç€å¾€ä¸‹èµ°:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Realize superclass and metaclass, if they aren't already.</span></span><br><span class="line"><span class="comment">// This needs to be done after RW_REALIZED is set above, for root classes.</span></span><br><span class="line"><span class="comment">// This needs to be done after class index is chosen, for root metaclasses.</span></span><br><span class="line"><span class="comment">// This assumes that none of those classes have Swift contents,</span></span><br><span class="line"><span class="comment">//   or that Swift's initializers have already been called.</span></span><br><span class="line"><span class="comment">//   fixme that assumption will be wrong if we add support</span></span><br><span class="line"><span class="comment">//   for ObjC subclasses of Swift classes.</span></span><br><span class="line">supercls = realizeClassWithoutSwift(remapClass(cls-&gt;getSuperclass()), nil);</span><br><span class="line">metacls = realizeClassWithoutSwift(remapClass(cls-&gt;ISA()), nil);</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°çˆ¶ç±»å’Œå…ƒç±»éƒ½ä¼šé€’å½’è°ƒç”¨ <code>realizeClassWithoutSwift</code> æ¥åˆå§‹åŒ–å„è‡ªçš„ <code>rw</code> ã€‚ä¸ºä»€ä¹ˆåœ¨ç±»çš„åŠ è½½æ“ä½œé‡Œé¢è¦å»åŠ è½½ç±»å’Œå…ƒç±»å‘¢ï¼Ÿå›å¿†ä¸€ä¸‹ç±»çš„ç»“æ„ï¼Œç­”æ¡ˆå¾ˆç®€å•ï¼Œè¦ä¿è¯ <code>superclass</code> å’Œ <code>isa</code> çš„å®Œæ•´æ€§ï¼Œä¹Ÿå°±æ˜¯ä¿è¯ç±»çš„å®Œæ•´æ€§ï¼Œ</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Update superclass and metaclass in case of remapping</span></span><br><span class="line">cls-&gt;setSuperclass(supercls);</span><br><span class="line">cls-&gt;initClassIsa(metacls);</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä»£ç å°±æ˜¯æœ€å¥½çš„è¯æ˜ï¼Œåˆå§‹åŒ–å®Œæ¯•çš„çˆ¶ç±»å’Œå…ƒç±»è¢«èµ‹å€¼åˆ°äº†ç±»çš„ <code>superclass</code> å’Œ <code>isa</code> ä¸Šé¢ã€‚</p>
<p>æ¥ç€å¾€ä¸‹èµ°å¯ä»¥çœ‹åˆ°ï¼Œä¸å…‰è¦æŠŠçˆ¶ç±»å…³è”åˆ°ç±»ä¸Šé¢ï¼Œè¿˜è¦è®©çˆ¶ç±»çŸ¥é“å­ç±»çš„å­˜åœ¨ã€‚</p>
<p>æœ€åä¸€è¡Œä»£ç æ˜¯ <code>methodizeClass(cls)</code> ï¼Œæ³¨é‡Šæ˜¾ç¤ºçš„æ˜¯ <code>attach categories</code> ï¼Œé™„åŠ åˆ†ç±»åˆ°ç±»ï¼Ÿæˆ‘ä»¬è¿›å…¥å…¶å†…éƒ¨å®ç°ä¸€æ¢ç©¶ç«Ÿã€‚</p>
<p>åœ¨æ¢ç´¢ <code>methodizeClass</code> å‰ï¼Œæˆ‘ä»¬å…ˆæ€»ç»“ä¸€ä¸‹ <code>realizeClassWithoutSwift</code> :</p>
<ul>
<li>è¯»å– <code>class</code> çš„ <code>data()</code></li>
<li><code>ro/rw</code> èµ‹å€¼</li>
<li>çˆ¶ç±»å’Œå…ƒç±»å®ç°<ul>
<li>supercls = realizeClassWithoutSwift(remapClass(cls-&gt;superclass))</li>
<li>metacls = realizeClassWithoutSwift(remapClass(cls-&gt;ISA()))</li>
</ul>
</li>
<li>çˆ¶ç±»å’Œå…ƒç±»å½’å±å…³ç³»<ul>
<li>cls-&gt;superclass = supercls</li>
<li>cls-&gt;initClassIsa(metacls)</li>
</ul>
</li>
<li>å°†å½“å‰ç±»é“¾æ¥åˆ°å…¶çˆ¶ç±»çš„å­ç±»åˆ—è¡¨ addSubclass(supercls, cls)</li>
</ul>
<h4 id="methodizeClass-åˆ†æ"><a href="#methodizeClass-åˆ†æ" class="headerlink" title="methodizeClass åˆ†æ"></a>methodizeClass åˆ†æ</h4><p>realizeClassWithoutSwiftæ–¹æ³•æœ€åä¸€è¡Œè°ƒç”¨çš„æ˜¯<code>methodizeClass</code>æ–¹æ³•</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* methodizeClass</span></span><br><span class="line"><span class="comment">* Fixes up cls's method list, protocol list, and property list.</span></span><br><span class="line"><span class="comment">* Attaches any outstanding categories.</span></span><br><span class="line"><span class="comment">* Locking: runtimeLock must be held by the caller</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">methodizeClass</span><span class="params">(Class cls, Class previously)</span></span></span><br></pre></td></tr></table></figure>

<p>å¯¹ç±»çš„æ–¹æ³•åˆ—è¡¨ã€åè®®åˆ—è¡¨å’Œå±æ€§åˆ—è¡¨è¿›è¡Œä¿®æ­£<br>é™„åŠ  <code>category</code> åˆ°ç±»ä¸Šé¢æ¥</p>
<p>æˆ‘ä»¬ç›´æ¥å¾€ä¸‹é¢èµ°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Install methods and properties that the class implements itself.</span></span><br><span class="line"><span class="keyword">method_list_t</span> *<span class="built_in">list</span> = ro-&gt;baseMethods();</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">list</span>) &#123;</span><br><span class="line">    prepareMethodLists(cls, &amp;<span class="built_in">list</span>, <span class="number">1</span>, YES, isBundleClass(cls), <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">if</span> (rwe) rwe-&gt;methods.attachLists(&amp;<span class="built_in">list</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ä» <code>ro</code> ä¸­å–å‡º<strong>æ–¹æ³•åˆ—è¡¨</strong>é™„åŠ åˆ° <code>rw</code> ä¸Š</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">property_list_t</span> *proplist = ro-&gt;baseProperties;</span><br><span class="line"><span class="keyword">if</span> (rwe &amp;&amp; proplist) &#123;</span><br><span class="line">    rwe-&gt;properties.attachLists(&amp;proplist, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ä» <code>ro</code> ä¸­å–å‡º<strong>å±æ€§åˆ—è¡¨</strong>é™„åŠ åˆ° <code>rw</code> ä¸Š</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protocol_list_t</span> *protolist = ro-&gt;baseProtocols;</span><br><span class="line"><span class="keyword">if</span> (rwe &amp;&amp; protolist) &#123;</span><br><span class="line">    rwe-&gt;protocols.attachLists(&amp;protolist, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ä» <code>ro</code> ä¸­å–å‡º<strong>åè®®åˆ—è¡¨</strong>é™„åŠ åˆ° <code>rw</code> ä¸Š</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Attach categories.</span></span><br><span class="line"><span class="keyword">if</span> (previously) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isMeta) &#123;</span><br><span class="line">        objc::unattachedCategories.attachToClass(cls, previously,</span><br><span class="line">                                                 ATTACH_METACLASS);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// When a class relocates, categories with class methods</span></span><br><span class="line">        <span class="comment">// may be registered on the class itself rather than on</span></span><br><span class="line">        <span class="comment">// the metaclass. Tell attachToClass to look for those.</span></span><br><span class="line">        objc::unattachedCategories.attachToClass(cls, previously,</span><br><span class="line">                                                 ATTACH_CLASS_AND_METACLASS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">objc::unattachedCategories.attachToClass(cls, cls,</span><br><span class="line">                                         isMeta ? ATTACH_METACLASS : ATTACH_CLASS);</span><br></pre></td></tr></table></figure>

<ul>
<li>ä» <code>cls</code> ä¸­å–å‡ºæœªé™„åŠ çš„åˆ†ç±»è¿›è¡Œé™„åŠ æ“ä½œ</li>
</ul>
<h3 id="æ¢ç´¢-load-images"><a href="#æ¢ç´¢-load-images" class="headerlink" title="æ¢ç´¢ load_images"></a>æ¢ç´¢ load_images</h3><p>æˆ‘ä»¬æ¥ç€æ¢ç´¢ <code>_dyld_objc_notify_register</code> çš„ç¬¬äºŒä¸ªå‚æ•° <code>load_images</code> ï¼Œè¿™ä¸ªå‡½æ•°æŒ‡é’ˆæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™è°ƒç”¨çš„å‘¢ï¼ŒåŒæ ·çš„ï¼Œæˆ‘ä»¬æ¥ç€åœ¨ <code>dyld</code> æºç ä¸­æœç´¢å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆ <code>sNotifyObjCInit</code> :</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;ImageLoader*&gt;::iterator it=sAllImages.<span class="built_in">begin</span>(); it != sAllImages.<span class="built_in">end</span>(); it++) &#123;</span><br><span class="line">	ImageLoader* <span class="built_in">image</span> = *it;</span><br><span class="line">	<span class="keyword">if</span> ( (<span class="built_in">image</span>-&gt;getState() == dyld_image_state_initialized) &amp;&amp; <span class="built_in">image</span>-&gt;notifyObjC() ) &#123;</span><br><span class="line">		<span class="function">dyld3::ScopedTimer <span class="title">timer</span><span class="params">(DBG_DYLD_TIMING_OBJC_INIT, (<span class="keyword">uint64_t</span>)<span class="built_in">image</span>-&gt;machHeader(), <span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">		(*sNotifyObjCInit)(<span class="built_in">image</span>-&gt;getRealPath(), <span class="built_in">image</span>-&gt;machHeader());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ <code>notifySingle</code> æ–¹æ³•å†…éƒ¨ï¼Œ <code>sNotifyObjCInit</code> å‡½æ•°æŒ‡é’ˆè¢«è°ƒç”¨äº†ã€‚æ ¹æ®æˆ‘ä»¬ä¸Šä¸€ç¯‡æ–‡ç« æ¢ç´¢ <code>dyld</code> åº•å±‚å¯ä»¥çŸ¥é“ï¼Œ <code>_load_images</code> åº”è¯¥æ˜¯å¯¹äºæ¯ä¸€ä¸ªåŠ è½½è¿›æ¥çš„ <code>Mach-O</code> é•œåƒéƒ½ä¼šé€’å½’è°ƒç”¨ä¸€æ¬¡ã€‚</p>
<p>æˆ‘ä»¬æ¥åˆ° <code>libObjc</code> æºç ä¸­ <code>load_images</code> çš„å®šä¹‰å¤„:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* load_images</span></span><br><span class="line"><span class="comment">* Process +load in the given images which are being mapped in by dyld.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Locking: write-locks runtimeLock and loadMethodLock</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">bool</span> <span class="title">hasLoadMethods</span><span class="params">(<span class="keyword">const</span> headerType *mhdr)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">prepare_load_methods</span><span class="params">(<span class="keyword">const</span> headerType *mhdr)</span></span>;</span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">load_images(<span class="keyword">const</span> <span class="keyword">char</span> *path __unused, <span class="keyword">const</span> struct mach_header *mh)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!didInitialAttachCategories &amp;&amp; didCallDyldNotifyRegister) &#123;</span><br><span class="line">        didInitialAttachCategories = <span class="literal">true</span>;</span><br><span class="line">        loadAllCategories();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Return without taking locks if there are no +load methods here.</span></span><br><span class="line">    <span class="keyword">if</span> (!hasLoadMethods((<span class="keyword">const</span> headerType *)mh)) <span class="keyword">return</span>;</span><br><span class="line">    <span class="function"><span class="keyword">recursive_mutex_locker_t</span> <span class="title">lock</span><span class="params">(loadMethodLock)</span></span></span><br><span class="line"><span class="function">    <span class="comment">// Discover load methods</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">mutex_locker_t</span> <span class="title">lock2</span><span class="params">(runtimeLock)</span></span>;</span><br><span class="line">        prepare_load_methods((<span class="keyword">const</span> headerType *)mh);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Call +load methods (without runtimeLock - re-entrant)</span></span><br><span class="line">    call_load_methods();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¤„ç†ç”± <code>dyld</code> æ˜ å°„çš„ç»™å®šé•œåƒä¸­çš„ <code>+load</code> æ–¹æ³•</p>
</blockquote>
<ul>
<li>åˆ¤æ–­æ˜¯å¦æœ‰ <code>load</code> æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰ï¼Œç›´æ¥è¿”å›</li>
<li>æœç´¢ <code>load</code> æ–¹æ³•ï¼Œå…·ä½“å®ç°é€šè¿‡ <code>prepare_load_methods</code></li>
<li>è°ƒç”¨ <code>load</code> æ–¹æ³•ï¼Œå…·ä½“å®ç°é€šè¿‡ <code>call_load_methods</code></li>
</ul>
<h4 id="prepare-load-methods-åˆ†æ"><a href="#prepare-load-methods-åˆ†æ" class="headerlink" title="prepare_load_methods åˆ†æ"></a>prepare_load_methods åˆ†æ</h4><p>ä»è¿™ä¸ªæ–¹æ³•åç§°ï¼Œæˆ‘ä»¬çŒœæµ‹è¿™é‡Œåº”è¯¥åšçš„æ˜¯ <code>load</code> æ–¹æ³•çš„ä¸€äº›é¢„å¤„ç†å·¥ä½œï¼Œè®©æˆ‘ä»¬æ¥åˆ°æºç è¿›è¡Œåˆ†æï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_load_methods</span><span class="params">(<span class="keyword">const</span> headerType *mhdr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> count, i;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line">    <span class="keyword">classref_t</span> <span class="keyword">const</span> *classlist = </span><br><span class="line">        _getObjc2NonlazyClassList(mhdr, &amp;count);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        schedule_class_load(remapClass(classlist[i]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">category_t</span> * <span class="keyword">const</span> *categorylist = _getObjc2NonlazyCategoryList(mhdr, &amp;count);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        <span class="keyword">category_t</span> *cat = categorylist[i];</span><br><span class="line">        Class cls = remapClass(cat-&gt;cls);</span><br><span class="line">        <span class="keyword">if</span> (!cls) <span class="keyword">continue</span>;  <span class="comment">// category for ignored weak-linked class</span></span><br><span class="line">        <span class="keyword">if</span> (cls-&gt;isSwiftStable()) &#123;</span><br><span class="line">            _objc_fatal(<span class="string">"Swift class extensions and categories on Swift "</span></span><br><span class="line">                        <span class="string">"classes are not allowed to have +load methods"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        realizeClassWithoutSwift(cls, nil);</span><br><span class="line">        ASSERT(cls-&gt;ISA()-&gt;isRealized());</span><br><span class="line">        add_category_to_loadable_list(cat);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* prepare_load_methods</span></span><br><span class="line"><span class="comment">* Schedule +load for classes in this image, any un-+load-ed </span></span><br><span class="line"><span class="comment">* superclasses in other images, and any categories in this image.</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="comment">// Recursively schedule +load for cls and any un-+load-ed superclasses.</span></span><br><span class="line"><span class="comment">// cls must already be connected.</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">schedule_class_load</span><span class="params">(Class cls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!cls) <span class="keyword">return</span>;</span><br><span class="line">    ASSERT(cls-&gt;isRealized());  <span class="comment">// _read_images should realize</span></span><br><span class="line">    <span class="keyword">if</span> (cls-&gt;data()-&gt;flags &amp; RW_LOADED) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// Ensure superclass-first ordering</span></span><br><span class="line">    schedule_class_load(cls-&gt;getSuperclass());</span><br><span class="line">    add_class_to_loadable_list(cls);</span><br><span class="line">    cls-&gt;setInfo(RW_LOADED); </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* add_class_to_loadable_list</span></span><br><span class="line"><span class="comment">* Class cls has just become connected. Schedule it for +load if</span></span><br><span class="line"><span class="comment">* it implements a +load method.</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_class_to_loadable_list</span><span class="params">(Class cls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    IMP method;</span><br><span class="line">    loadMethodLock.assertLocked();</span><br><span class="line">    method = cls-&gt;getLoadMethod();</span><br><span class="line">    <span class="keyword">if</span> (!method) <span class="keyword">return</span>;  <span class="comment">// Don't bother if cls has no +load method</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (PrintLoading) &#123;</span><br><span class="line">        _objc_inform(<span class="string">"LOAD: class '%s' scheduled for +load"</span>, </span><br><span class="line">                     cls-&gt;nameForLogging());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (loadable_classes_used == loadable_classes_allocated) &#123;</span><br><span class="line">        loadable_classes_allocated = loadable_classes_allocated*<span class="number">2</span> + <span class="number">16</span>;</span><br><span class="line">        loadable_classes = (struct loadable_class *)</span><br><span class="line">            <span class="built_in">realloc</span>(loadable_classes,</span><br><span class="line">                              loadable_classes_allocated *</span><br><span class="line">                              <span class="keyword">sizeof</span>(struct loadable_class));</span><br><span class="line">    &#125;</span><br><span class="line">    loadable_classes[loadable_classes_used].cls = cls;</span><br><span class="line">    loadable_classes[loadable_classes_used].method = method;</span><br><span class="line">    loadable_classes_used++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>é¦–å…ˆé€šè¿‡ <code>_getObjc2NonlazyClassList</code> è·å–æ‰€æœ‰å·²ç»åŠ è½½è¿›å»çš„ç±»åˆ—è¡¨</p>
</li>
<li><p>ç„¶åé€šè¿‡<code>schedule_class_load</code> éå†è¿™äº›ç±»</p>
<ul>
<li>é€’å½’è°ƒç”¨éå†çˆ¶ç±»çš„ <code>load</code> æ–¹æ³•ï¼Œç¡®ä¿çˆ¶ç±»çš„ <code>load</code> æ–¹æ³•é¡ºåºæ’åœ¨å­ç±»çš„å‰é¢</li>
<li>é€šè¿‡ <code>add_class_to_loadable_list</code> , æŠŠç±»çš„ <code>load</code> æ–¹æ³•å­˜åœ¨ <code>loadable_classes</code> é‡Œé¢</li>
</ul>
</li>
<li><p>å®Œæˆ <code>schedule_class_load</code> ä¹‹åï¼Œé€šè¿‡ <code>_getObjc2NonlazyCategoryList</code> å–å‡ºæ‰€æœ‰åˆ†ç±»æ•°æ®</p>
</li>
<li><p>ç„¶åéå†è¿™äº›åˆ†ç±»</p>
<ul>
<li>é€šè¿‡ <code>realizeClassWithoutSwift</code> æ¥é˜²æ­¢ç±»æ²¡æœ‰åˆå§‹åŒ–ï¼Œå¦‚æœå·²ç»åˆå§‹åŒ–äº†åˆ™ä¸å½±å“</li>
<li>é€šè¿‡ <code>add_category_to_loadable_list</code> ï¼ŒåŠ è½½åˆ†ç±»ä¸­çš„ <code>load</code> æ–¹æ³•åˆ° <code>loadable_categories</code> é‡Œé¢</li>
</ul>
</li>
</ul>
<h4 id="call-load-methods-åˆ†æ"><a href="#call-load-methods-åˆ†æ" class="headerlink" title="call_load_methods åˆ†æ"></a>call_load_methods åˆ†æ</h4><p>é€šè¿‡åç§°æˆ‘ä»¬å¯ä»¥çŸ¥é“ <code>call_load_methods</code> åº”è¯¥å°±æ˜¯ <code>load</code> æ–¹æ³•è¢«è°ƒç”¨çš„åœ°æ–¹äº†ã€‚æˆ‘ä»¬ç›´æ¥çœ‹æºç ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* call_load_methods</span></span><br><span class="line"><span class="comment">* Call all pending class and category +load methods.</span></span><br><span class="line"><span class="comment">* Class +load methods are called superclass-first. </span></span><br><span class="line"><span class="comment">* Category +load methods are not called until after the parent class's +load.</span></span><br><span class="line"><span class="comment">* </span></span><br><span class="line"><span class="comment">* This method must be RE-ENTRANT, because a +load could trigger </span></span><br><span class="line"><span class="comment">* more image mapping. In addition, the superclass-first ordering </span></span><br><span class="line"><span class="comment">* must be preserved in the face of re-entrant calls. Therefore, </span></span><br><span class="line"><span class="comment">* only the OUTERMOST call of this function will do anything, and </span></span><br><span class="line"><span class="comment">* that call will handle all loadable classes, even those generated </span></span><br><span class="line"><span class="comment">* while it was running.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* The sequence below preserves +load ordering in the face of </span></span><br><span class="line"><span class="comment">* image loading during a +load, and make sure that no </span></span><br><span class="line"><span class="comment">* +load method is forgotten because it was added during </span></span><br><span class="line"><span class="comment">* a +load call.</span></span><br><span class="line"><span class="comment">* Sequence:</span></span><br><span class="line"><span class="comment">* 1. Repeatedly call class +loads until there aren't any more</span></span><br><span class="line"><span class="comment">* 2. Call category +loads ONCE.</span></span><br><span class="line"><span class="comment">* 3. Run more +loads if:</span></span><br><span class="line"><span class="comment">*    (a) there are more classes to load, OR</span></span><br><span class="line"><span class="comment">*    (b) there are some potential category +loads that have </span></span><br><span class="line"><span class="comment">*        still never been attempted.</span></span><br><span class="line"><span class="comment">* Category +loads are only run once to ensure "parent class first" </span></span><br><span class="line"><span class="comment">* ordering, even if a category +load triggers a new loadable class </span></span><br><span class="line"><span class="comment">* and a new loadable category attached to that class. </span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Locking: loadMethodLock must be held by the caller </span></span><br><span class="line"><span class="comment">*   All other locks must not be held.</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">call_load_methods</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">bool</span> loading = NO;</span><br><span class="line">    <span class="keyword">bool</span> more_categories;</span><br><span class="line">    loadMethodLock.assertLocked();</span><br><span class="line">    <span class="comment">// Re-entrant calls do nothing; the outermost call will finish the job.</span></span><br><span class="line">    <span class="keyword">if</span> (loading) <span class="keyword">return</span>;</span><br><span class="line">    loading = YES;</span><br><span class="line">    <span class="keyword">void</span> *pool = objc_autoreleasePoolPush();</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// 1. Repeatedly call class +loads until there aren't any more</span></span><br><span class="line">        <span class="keyword">while</span> (loadable_classes_used &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            call_class_loads();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2. Call category +loads ONCE</span></span><br><span class="line">        more_categories = call_category_loads();</span><br><span class="line">        <span class="comment">// 3. Run more +loads if there are classes OR more untried categories</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (loadable_classes_used &gt; <span class="number">0</span>  ||  more_categories);</span><br><span class="line">    objc_autoreleasePoolPop(pool);</span><br><span class="line">    loading = NO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>call_load_methods<br>è°ƒç”¨ç±»å’Œç±»åˆ«ä¸­æ‰€æœ‰æœªå†³çš„ <code>+load</code> æ–¹æ³•<br>ç±»é‡Œé¢ <code>+load</code> æ–¹æ³•æ˜¯çˆ¶ç±»ä¼˜å…ˆè°ƒç”¨çš„<br>è€Œåœ¨çˆ¶ç±»çš„ <code>+load</code> ä¹‹åæ‰ä¼šè°ƒç”¨åˆ†ç±»çš„ <code>+load</code> æ–¹æ³•</p>
</blockquote>
<ul>
<li>é€šè¿‡ <code>objc_autoreleasePoolPush</code> å‹æ ˆä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± </li>
<li><code>do-while</code>å¾ªç¯å¼€å§‹<ul>
<li>å¾ªç¯è°ƒç”¨ç±»çš„ <code>+load</code> æ–¹æ³•ç›´åˆ°æ‰¾ä¸åˆ°ä¸ºæ­¢</li>
<li>è°ƒç”¨ä¸€æ¬¡åˆ†ç±»ä¸­çš„ <code>+load</code> æ–¹æ³•</li>
</ul>
</li>
<li>é€šè¿‡ <code>objc_autoreleasePoolPop</code> å‡ºæ ˆä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± </li>
</ul>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>è‡³æ­¤ï¼Œ <code>_objc_init</code> å’Œ <code>_dyld_objc_notify_register</code> æˆ‘ä»¬å°±åˆ†æå®Œäº†ï¼Œæˆ‘ä»¬å¯¹ç±»çš„åŠ è½½æœ‰äº†æ›´ç»†è‡´çš„è®¤çŸ¥ã€‚ <code>iOS</code> åº•å±‚æœ‰æ—¶å€™æ¢ç´¢èµ·æ¥ç¡®å®å¾ˆæ¯ç‡¥ï¼Œä½†æ˜¯å¦‚æœèƒ½æ‰¾åˆ°é«˜æ•ˆçš„æ–¹æ³•ä»¥åŠæ˜ç¡®è‡ªå·±çš„æ‰€æ¢ç´¢çš„æ–¹å‘ï¼Œä¼šè®©è‡ªå·±ä»å®è§‚ä¸Šé‡æ–°å®¡è§†è¿™é—¨æŠ€æœ¯ã€‚æ˜¯çš„ï¼ŒæŠ€æœ¯åªæ˜¯å·¥å…·ï¼Œæˆ‘ä»¬ä¸èƒ½è¢«æŠ€æœ¯æ‰€ç»‘æ¶ï¼Œæˆ‘ä»¬è¦åšåˆ°æœ‰çš„æ”¾çŸ¢çš„å»æ¢ç´¢ï¼Œè¿™æ ·æ‰èƒ½äº‹åŠåŠŸå€ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yujiusheng.com/2021/05/14/iOS%E5%BA%95%E5%B1%82%EF%BC%9A%E5%BA%94%E7%94%A8%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B-main()%E5%87%BD%E6%95%B0%E4%B9%8B%E5%89%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="ä¸ªäººæŠ€æœ¯åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jasonçš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/14/iOS%E5%BA%95%E5%B1%82%EF%BC%9A%E5%BA%94%E7%94%A8%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B-main()%E5%87%BD%E6%95%B0%E4%B9%8B%E5%89%8D/" class="post-title-link" itemprop="url">iOSåº•å±‚ï¼šåº”ç”¨åŠ è½½æµç¨‹ main()å‡½æ•°ä¹‹å‰</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-05-14 09:57:56" itemprop="dateCreated datePublished" datetime="2021-05-14T09:57:56+08:00">2021-05-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-05-17 11:12:23" itemprop="dateModified" datetime="2021-05-17T11:12:23+08:00">2021-05-17</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Appä»ç‚¹å‡»å›¾æ ‡å°±å¼€å¯äº†ç”Ÿå‘½å‘¨æœŸï¼Œæœ¬æ–‡ä»Appå¯åŠ¨å¼€å§‹æ¢ç´¢ã€‚</p>
<h3 id="å‰å¯¼çŸ¥è¯†"><a href="#å‰å¯¼çŸ¥è¯†" class="headerlink" title="å‰å¯¼çŸ¥è¯†"></a>å‰å¯¼çŸ¥è¯†</h3><h4 id="Mach-Oæ–‡ä»¶"><a href="#Mach-Oæ–‡ä»¶" class="headerlink" title="Mach-Oæ–‡ä»¶"></a>Mach-Oæ–‡ä»¶</h4><p>Mach-O is a bunch of file types for different run time executables.<br><code>Mach-O</code> æ˜¯ <code>iOS</code> ç³»ç»Ÿä¸åŒè¿è¡Œæ—¶æœŸ<strong>å¯æ‰§è¡Œçš„æ–‡ä»¶</strong>çš„æ–‡ä»¶ç±»å‹ç»Ÿç§°ã€‚</p>
<p>ç»´åŸºç™¾ç§‘ä¸Šå…³äº <code>Mach-O</code> çš„æè¿°ï¼š</p>
<blockquote>
<p>Mach-O æ˜¯ Mach object æ–‡ä»¶æ ¼å¼çš„ç¼©å†™ï¼Œå®ƒæ˜¯ä¸€ç§ç”¨äºè®°å½•å¯æ‰§è¡Œæ–‡ä»¶ã€å¯¹è±¡ä»£ç ã€å…±äº«åº“ã€åŠ¨æ€åŠ è½½ä»£ç å’Œå†…å­˜è½¬å‚¨çš„æ–‡ä»¶æ ¼å¼ã€‚ä½œä¸º a.out æ ¼å¼çš„æ›¿ä»£å“ï¼ŒMach-O æä¾›äº†æ›´å¥½çš„æ‰©å±•æ€§ï¼Œå¹¶æå‡äº†ç¬¦å·è¡¨ä¸­ä¿¡æ¯çš„è®¿é—®é€Ÿåº¦ã€‚<br>å¤§å¤šæ•°åŸºäº Mach å†…æ ¸çš„æ“ä½œç³»ç»Ÿéƒ½ä½¿ç”¨ Mach-Oã€‚NeXTSTEPã€OS X å’Œ iOS æ˜¯ä½¿ç”¨è¿™ç§æ ¼å¼ä½œä¸ºæœ¬åœ°å¯æ‰§è¡Œæ–‡ä»¶ã€åº“å’Œå¯¹è±¡ä»£ç çš„ä¾‹å­ã€‚</p>
</blockquote>
<p><code>Mach-O</code>æœ‰ä¸‰ç§æ–‡ä»¶ç±»å‹ï¼šExecutable<code>ã€</code>Dylib<code>ã€</code>Bundle</p>
<ul>
<li><p>ExecutableLç±»å‹</p>
<p>So the first executable, thatâ€™s the main binary in an app, itâ€™s also the main binary in an app extension.<br><code>Executable</code> æ˜¯ <code>app</code> çš„äºŒè¿›åˆ¶ä¸»æ–‡ä»¶ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ <code>app extension</code> çš„äºŒè¿›åˆ¶ä¸»æ–‡ä»¶</p>
<p>æˆ‘ä»¬ä¸€èˆ¬å¯ä»¥åœ¨ <code>Xcode</code> é¡¹ç›®ä¸­çš„ <code>Products</code> æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°å®ƒ.</p>
</li>
<li><p><code>Dylib</code>ç±»å‹</p>
<p>A dylib is a dynamic library, on other platforms meet, you may know those as DSOs or DLLs.<br><code>dylib</code> æ˜¯åŠ¨æ€åº“ï¼Œåœ¨å…¶ä»–å¹³å°ä¹Ÿå« <code>DSO</code> æˆ–è€… <code>DLL</code>ã€‚</p>
<p>å¯¹äºæ¥è§¦ <code>iOS</code> å¼€å‘æ¯”è¾ƒæ—©çš„åŒå­¦ï¼Œå¯èƒ½çŸ¥é“æˆ‘ä»¬åœ¨ <code>Xcode 7</code> ä¹‹å‰æ·»åŠ ä¸€äº›æ¯”å¦‚ <code>sqlite</code> çš„åº“çš„æ—¶å€™ï¼Œå…¶åç¼€åä¸º <code>dylib</code>ï¼Œè€Œ <code>Xcode 7</code> ä¹‹ååç¼€åéƒ½æ”¹æˆäº† <code>tbd</code>ã€‚</p>
<p>è¿™é‡Œå¼•ç”¨ <a href="https://stackoverflow.com/questions/31450690/why-xcode-7-shows-tbd-instead-of-dylib" target="_blank" rel="noopener">StackoverFlow</a> ä¸Šçš„ä¸€ç¯‡å›ç­”ã€‚</p>
<blockquote>
<p>So it appears that the .dylib file is the actual library of binary code that your project is using and is located in the /usr/lib/ directory on the userâ€™s device. The .tbd file, on the other hand, is just a text file that is included in your project and serves as a link to the required .dylib binary. Since this text file is much smaller than the binary library, it makes the SDKâ€™s download size smaller.</p>
</blockquote>
<p>åˆšåˆšæˆ‘ä»¬ç®€å•ä»‹ç»äº†åŠ¨æ€åº“ï¼Œè¿˜æœ‰ä¸€ç§åº“æ˜¯é™æ€åº“ï¼Œä»–ä»¬çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ã€‚</p>
<p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ç¼–è¯‘çš„è¿‡ç¨‹ï¼š</p>
<p><img src="/images/compile_process.png" alt="compile_process"></p>
<p>å½“ç„¶ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­é—´å…¶å®è¿˜è®¾è®¡åˆ°ç¼–è¯‘å™¨å‰ç«¯çš„ <code>è¯æ³•åˆ†æ</code>ã€<code>è¯­æ³•åˆ†æ</code>ã€<code>è¯­ä¹‰åˆ†æ</code>ã€<code>ä¼˜åŒ–</code> ç­‰æµç¨‹ï¼Œæˆ‘ä»¬åœ¨åé¢æ¢ç´¢ <code>LLVM</code> å’Œ <code>Clang</code> çš„æ—¶å€™ä¼šè¯¦ç»†ä»‹ç»ã€‚</p>
<p>å›åˆ°åˆšæ‰çš„è¯é¢˜ï¼Œé™æ€åº“å’ŒåŠ¨æ€åº“çš„åŒºåˆ«ï¼š</p>
<blockquote>
<p>Static frameworks are linked at <strong>compile time</strong>. Dynamic frameworks are linked <strong>at runtime</strong>.</p>
</blockquote>
<p>é™æ€åº“å’ŒåŠ¨æ€åº“éƒ½æ˜¯ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œåªæ˜¯ç”¨æ³•ä¸åŒã€‚é‚£ä¸ºä»€ä¹ˆè¦åˆ†åŠ¨æ€å’Œé™æ€åº“å‘¢ï¼Ÿ</p>
<p><img src="/images/static_link.png" alt="static_link"></p>
<p><img src="/images/dyld_link.png" alt="dyld_link"></p>
<p>é€šè¿‡ä¸Šé¢ä¸¤å¹…å›¾æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼š</p>
<ul>
<li>é™æ€åº“è¡¨ç°ä¸ºï¼šåœ¨é“¾æ¥é˜¶æ®µä¼šå°†æ±‡ç¼–ç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶å’Œå¼•ç”¨çš„åº“ä¸€èµ·é“¾æ¥æ‰“åŒ…åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­ã€‚</li>
<li>åŠ¨æ€åº“çš„è¡¨ç°ä¸ºï¼šç¨‹åºç¼–è¯‘å¹¶ä¸ä¼šé“¾æ¥åˆ°ç›®æ ‡ä»£ç ä¸­ï¼Œåœ¨ç¨‹åºå¯æ‰§è¡Œæ–‡ä»¶é‡Œé¢ä¼šä¿ç•™å¯¹åŠ¨æ€åº“çš„å¼•ç”¨ï¼Œå…¶ä¸­åŠ¨æ€åº“åˆ†ä¸ºåŠ¨æ€é“¾æ¥åº“å’ŒåŠ¨æ€åŠ è½½åº“ã€‚<ul>
<li>åŠ¨æ€é“¾æ¥åº“ï¼šåœ¨æ²¡æœ‰è¢«åŠ è½½åˆ°å†…å­˜çš„å‰æä¸‹ï¼Œå½“å¯æ‰§è¡Œæ–‡ä»¶è¢«åŠ è½½ï¼ŒåŠ¨æ€åº“ä¹Ÿéšç€è¢«åŠ è½½åˆ°å†…å­˜ä¸­ã€‚åœ¨<code>Linked Framework and Libraries</code>è®¾ç½®çš„ä¸€äº›<code>share libraries</code>ã€‚ã€éšç€ç¨‹åºå¯åŠ¨è€Œå¯åŠ¨ã€‘</li>
<li>åŠ¨æ€åŠ è½½åº“ï¼šå½“éœ€è¦çš„æ—¶å€™å†ä½¿ç”¨<code>dlopen</code>ç­‰é€šè¿‡ä»£ç æˆ–è€…å‘½ä»¤çš„æ–¹å¼æ¥åŠ è½½ã€‚ã€åœ¨ç¨‹åºå¯åŠ¨ä¹‹åã€‘</li>
</ul>
</li>
</ul>
</li>
<li><p><code>Bundle</code>ç±»å‹</p>
<p>Now a bundleâ€™s a special kind of dylib that you cannot link against, all you can do is load it at run time by an dlopen and thatâ€™s used on a Mac OS for plug-ins.<br>ç°é˜¶æ®µ Bundle æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„ dylibï¼Œä½ æ˜¯æ— æ³•å¯¹å…¶è¿›è¡Œé“¾æ¥çš„ã€‚ä½ æ‰€èƒ½åšçš„æ˜¯åœ¨ Runtime è¿è¡Œæ—¶å»é€šè¿‡ dlopen æ¥åŠ è½½å®ƒï¼Œå®ƒå¯ä»¥åœ¨ macOS ä¸Šç”¨äºæ’ä»¶ã€‚</p>
</li>
<li><p><code>Image</code>å’Œ<code>Framework</code></p>
<p>Image refers to any of these three types.<br>é•œåƒæ–‡ä»¶åŒ…å«äº†ä¸Šè¿°çš„ä¸‰ç§æ–‡ä»¶ç±»å‹</p>
<p>a framework is a dylib with a special directory structure around it to holds files needed by that dylib.<br>æœ‰å¾ˆå¤šä¸œè¥¿éƒ½å«åš Frameworkï¼Œä½†åœ¨æœ¬æ–‡ä¸­ï¼ŒFramework æŒ‡çš„æ˜¯ä¸€ä¸ª dylibï¼Œå®ƒå‘¨å›´æœ‰ä¸€ä¸ªç‰¹æ®Šçš„ç›®å½•ç»“æ„æ¥ä¿å­˜è¯¥ dylib æ‰€éœ€çš„æ–‡ä»¶ã€‚</p>
</li>
</ul>
<h4 id="Mach-Oç»“æ„åˆ†æ"><a href="#Mach-Oç»“æ„åˆ†æ" class="headerlink" title="Mach-Oç»“æ„åˆ†æ"></a>Mach-Oç»“æ„åˆ†æ</h4><h5 id="segmentæ®µ"><a href="#segmentæ®µ" class="headerlink" title="segmentæ®µ"></a><code>segment</code>æ®µ</h5><p><img src="/images/Mach-O.png" alt="Mach-O"></p>
<p><code>Mach-O</code>é•œåƒæ–‡ä»¶æ˜¯ç”±<code>segments</code>æ®µç»„æˆçš„ã€‚</p>
<ul>
<li><p>æ®µçš„åç§°ä¸ºå¤§å†™æ ¼å¼</p>
<p>æ‰€æœ‰çš„æ®µéƒ½æ˜¯ <code>page size</code> çš„å€æ•°ã€‚</p>
</li>
<li><p>arm64 ä¸Šæ®µå¤§å°ä¸º <code>16</code> å­—èŠ‚</p>
</li>
<li><p>å…¶å®ƒæ¶æ„ä¸º <code>4</code> å­—èŠ‚</p>
</li>
</ul>
<p>è¿™é‡Œå†æåŠä¸€ä¸‹è™šæ‹Ÿå†…å­˜å’Œå†…å­˜é¡µçš„çŸ¥è¯†ï¼š</p>
<p><code>å…·æœ‰ VM æœºåˆ¶çš„æ“ä½œç³»ç»Ÿï¼Œä¼šå¯¹æ¯ä¸ªè¿è¡Œçš„è¿›ç¨‹åˆ›å»ºä¸€ä¸ªé€»è¾‘åœ°å€ç©ºé—´ logical address space æˆ–è€…å«è™šæ‹Ÿåœ°å€ç©ºé—´ virtual address spaceï¼›è¯¥ç©ºé—´çš„å¤§å°ç”±æ“ä½œç³»ç»Ÿä½æ•°å†³å®šï¼š32 ä½çš„æ“ä½œç³»ç»Ÿï¼Œå…¶é€»è¾‘åœ°å€ç©ºé—´çš„å¤§å°ä¸º 4GBï¼Œ64ä½çš„æ“ä½œç³»ç»Ÿä¸º 2^34 GBï¼ˆå…¶è®¡ç®—æ–¹å¼æ˜¯ 2^32 || 2^64(ç†è®ºä¸Šæ˜¯64ä½ï¼Œx86 Intel æ˜¯48ä½)ï¼‰ã€‚</code><br><img src="/images/vitual_memory.png" alt="vitual_memory"></p>
<p><code>è™šæ‹Ÿåœ°å€ç©ºé—´(æˆ–è€…é€»è¾‘åœ°å€ç©ºé—´)ä¼šè¢«åˆ†ä¸ºç›¸åŒå¤§å°çš„å—ï¼Œè¿™äº›å—è¢«ç§°ä¸ºå†…å­˜é¡µï¼ˆpageï¼‰ã€‚è®¡ç®—æœºå¤„ç†å™¨å’Œå®ƒçš„å†…å­˜ç®¡ç†å•å…ƒï¼ˆMMU - memory management uinitï¼‰ç»´æŠ¤ç€ä¸€å¼ å°†ç¨‹åºçš„é€»è¾‘åœ°å€ç©ºé—´æ˜ å°„åˆ°ç‰©ç†åœ°å€ä¸Šçš„åˆ†é¡µè¡¨</code>page table<code>ã€‚</code></p>
<p><code>åœ¨</code>masOS<code>å’Œæ—©ç‰ˆæœ¬çš„</code>iOS<code>ä¸­ï¼Œåˆ†é¡µçš„å¤§å°ä¸º</code>4kB<code>ã€‚åœ¨ä¹‹åçš„åŸºäº</code>A7<code>å’Œ</code>A8<code>çš„ç³»ç»Ÿä¸­ï¼Œè™šæ‹Ÿå†…å­˜ï¼ˆ</code>64<code>ä½çš„åœ°å€ç©ºé—´ï¼‰åœ°å€ç©ºé—´çš„åˆ†é¡µå¤§å°å˜ä¸ºäº†</code>16KB<code>ï¼Œè€Œç‰©ç†RAMä¸Šçš„å†…å­˜åˆ†é¡µå¤§å°ä»ç„¶ç»´æŒåœ¨</code>4KB<code>ï¼›åŸºäºA9åŠä¹‹åçš„ç³»ç»Ÿï¼Œè™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜çš„åˆ†é¡µéƒ½æ˜¯</code>16KB<code>ã€‚</code></p>
<h5 id="section"><a href="#section" class="headerlink" title="section"></a>section</h5><p><img src="/images/Mach-O_section.png" alt="Mach-O_section"></p>
<p>åœ¨ segment æ®µå†…éƒ¨è¿˜æœ‰è®¸å¤šçš„ section åŒºã€‚section åç§°ä¸ºå°å†™æ ¼å¼ã€‚</p>
<p>But sections are really just a subrange of a segment, they donâ€™t have any of the constraints of being page size, but they are non-overlapping.<br>ä½†æ˜¯ sections èŠ‚å®é™…ä¸Šåªæ˜¯ä¸€ä¸ª segment æ®µçš„å­èŒƒå›´ï¼Œå®ƒä»¬æ²¡æœ‰é¡µé¢å¤§å°çš„ä»»ä½•é™åˆ¶ï¼Œä½†æ˜¯å®ƒä»¬æ˜¯ä¸é‡å çš„ã€‚</p>
<p>é€šè¿‡<code>MachOView</code>å·¥å…·æŸ¥çœ‹Appçš„äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶å¯ä»¥çœ‹åˆ°ï¼š</p>
<p><img src="/images/section_show.png" alt="section_show"></p>
<h4 id="å¸¸è§çš„segments"><a href="#å¸¸è§çš„segments" class="headerlink" title="å¸¸è§çš„segments"></a>å¸¸è§çš„<code>segments</code></h4><ul>
<li><p><code>_TEXT</code>:ä»£ç æ®µï¼ŒåŒ…æ‹¬å¤´æ–‡ä»¶ã€ä»£ç å’Œå¸¸é‡ã€‚åªè¯»ä¸å¯ä¿®æ”¹</p>
<p><img src="/images/_TEXT_image.png" alt="_TEXT_image"></p>
</li>
<li><p><code>_DATA</code>ï¼šæ•°æ®æ®µï¼ŒåŒ…æ‹¬å…¨å±€å˜é‡ï¼Œé™æ€å˜é‡ç­‰ã€‚å¯è¯»å¯å†™ã€‚</p>
<p><img src="/images/_DATA_image.png" alt="_DATA_image"></p>
</li>
<li><p><code>_LINKEDIT</code>ï¼šå¦‚ä½•åŠ è½½ç¨‹åºçš„å…ƒæ•°æ®, åŒ…å«äº†æ–¹æ³•å’Œå˜é‡çš„å…ƒæ•°æ®ï¼ˆä½ç½®ï¼Œåç§»é‡ï¼‰ï¼Œä»¥åŠä»£ç ç­¾åç­‰ä¿¡æ¯ã€‚åªè¯»ä¸å¯ä¿®æ”¹ã€‚</p>
<p><img src="/images/_LINKEDIT_image.png" alt="_LINKEDIT_image"></p>
</li>
</ul>
<h5 id="Mach-O-Universal-Files"><a href="#Mach-O-Universal-Files" class="headerlink" title="Mach-O Universal Files"></a>Mach-O Universal Files</h5><p><img src="/images/Mach-o_UniversalFiles.png" alt="Mach-o_UniversalFiles"></p>
<p><code>Mach-O</code> é€šç”¨æ–‡ä»¶ï¼Œå°†å¤šç§æ¶æ„çš„ <code>Mach-O</code> æ–‡ä»¶åˆå¹¶è€Œæˆã€‚å®ƒé€šè¿‡ <code>header</code> æ¥è®°å½•ä¸åŒæ¶æ„åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡ï¼Œ<code>segement</code> å å¤šä¸ªåˆ†é¡µï¼Œ<code>header</code>å ä¸€é¡µçš„ç©ºé—´ã€‚å¯èƒ½æœ‰äººä¼šè§‰å¾— <code>header</code> å•ç‹¬å ä¸€é¡µä¼šæµªè´¹ç©ºé—´ï¼Œä½†è¿™æœ‰åˆ©äºè™šæ‹Ÿå†…å­˜çš„å®ç°ã€‚</p>
<h4 id="è™šæ‹Ÿå†…å­˜"><a href="#è™šæ‹Ÿå†…å­˜" class="headerlink" title="è™šæ‹Ÿå†…å­˜"></a>è™šæ‹Ÿå†…å­˜</h4><p><img src="/images/virtualMemory_image.png" alt="virtualMemory_image"></p>
<p>è™šæ‹Ÿå†…å­˜æ˜¯ä¸€å±‚<strong>é—´æ¥å¯»å€</strong>ã€‚</p>
<p>è™šæ‹Ÿå†…å­˜è§£å†³çš„æ˜¯ç®¡ç†æ‰€æœ‰è¿›ç¨‹ä½¿ç”¨<strong>ç‰©ç† RAM</strong> çš„é—®é¢˜ã€‚é€šè¿‡æ·»åŠ é—´æ¥å±‚æ¥è®©æ¯ä¸ªè¿›ç¨‹ä½¿ç”¨<strong>é€»è¾‘åœ°å€ç©ºé—´</strong>ï¼Œå®ƒå¯ä»¥æ˜ å°„åˆ° RAM ä¸Šçš„æŸä¸ªç‰©ç†é¡µä¸Šã€‚è¿™ç§æ˜ å°„ä¸æ˜¯ä¸€å¯¹ä¸€çš„ï¼Œé€»è¾‘åœ°å€å¯èƒ½æ˜ å°„ä¸åˆ° RAM ä¸Šï¼Œä¹Ÿå¯èƒ½æœ‰å¤šä¸ªé€»è¾‘åœ°å€æ˜ å°„åˆ°åŒä¸€ä¸ªç‰©ç† RAM ä¸Šã€‚</p>
<ul>
<li>é’ˆå¯¹ç¬¬ä¸€ç§æƒ…å†µï¼Œå½“è¿›ç¨‹è¦å­˜å‚¨é€»è¾‘åœ°å€å†…å®¹æ—¶ä¼šè§¦å‘ page faultã€‚</li>
<li>è€Œç¬¬äºŒç§æƒ…å†µå°±æ˜¯å¤šè¿›ç¨‹å…±äº«å†…å­˜ã€‚</li>
<li>å¯¹äºæ–‡ä»¶å¯ä»¥ä¸ç”¨ä¸€æ¬¡æ€§è¯»å…¥æ•´ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨åˆ†é¡µæ˜ å°„ mmap() çš„æ–¹å¼è¯»å–ã€‚ä¹Ÿå°±æ˜¯æŠŠæ–‡ä»¶æŸä¸ªç‰‡æ®µæ˜ å°„åˆ°è¿›ç¨‹é€»è¾‘å†…å­˜çš„æŸä¸ªé¡µä¸Šã€‚å½“æŸä¸ªæƒ³è¦è¯»å–çš„é¡µæ²¡æœ‰åœ¨å†…å­˜ä¸­ï¼Œå°±ä¼šè§¦å‘ page faultï¼Œå†…æ ¸åªä¼šè¯»å…¥é‚£ä¸€é¡µï¼Œå®ç°æ–‡ä»¶çš„æ‡’åŠ è½½ã€‚ä¹Ÿå°±æ˜¯è¯´ Mach-O æ–‡ä»¶ä¸­çš„ __TEXT æ®µå¯ä»¥æ˜ å°„åˆ°å¤šä¸ªè¿›ç¨‹ï¼Œå¹¶å¯ä»¥æ‡’åŠ è½½ï¼Œä¸”è¿›ç¨‹ä¹‹é—´å…±äº«å†…å­˜ã€‚</li>
<li>__DATA æ®µæ˜¯å¯è¯»å†™çš„ã€‚è¿™é‡Œä½¿ç”¨åˆ°äº† Copy-On-Write æŠ€æœ¯ï¼Œç®€ç§° COWã€‚ä¹Ÿå°±æ˜¯å¤šä¸ªè¿›ç¨‹å…±äº«ä¸€é¡µå†…å­˜ç©ºé—´æ—¶ï¼Œä¸€æ—¦æœ‰è¿›ç¨‹è¦åšå†™æ“ä½œï¼Œå®ƒä¼šå…ˆå°†è¿™é¡µå†…å­˜å†…å®¹å¤åˆ¶ä¸€ä»½å‡ºæ¥ï¼Œç„¶åé‡æ–°æ˜ å°„é€»è¾‘åœ°å€åˆ°æ–°çš„ RAM é¡µä¸Šã€‚ä¹Ÿå°±æ˜¯è¿™ä¸ªè¿›ç¨‹è‡ªå·±æ‹¥æœ‰äº†é‚£é¡µå†…å­˜çš„æ‹·è´ã€‚è¿™å°±æ¶‰åŠåˆ°äº† clean/dirty page çš„æ¦‚å¿µã€‚dirty page å«æœ‰è¿›ç¨‹è‡ªå·±çš„ä¿¡æ¯ï¼Œè€Œ clean page å¯ä»¥è¢«å†…æ ¸é‡æ–°ç”Ÿæˆï¼ˆé‡æ–°è¯»ç£ç›˜ï¼‰ã€‚æ‰€ä»¥ dirty page çš„ä»£ä»·å¤§äº clean pageã€‚</li>
</ul>
<h4 id="å¤šè¿›ç¨‹åŠ è½½Mach-Oé•œåƒ"><a href="#å¤šè¿›ç¨‹åŠ è½½Mach-Oé•œåƒ" class="headerlink" title="å¤šè¿›ç¨‹åŠ è½½Mach-Oé•œåƒ"></a>å¤šè¿›ç¨‹åŠ è½½<code>Mach-O</code>é•œåƒ</h4><p><img src="/images/Mach-O_image_loading.png" alt="Mach-O_image_loading"></p>
<ul>
<li>æ‰€ä»¥åœ¨å¤šä¸ªè¿›ç¨‹åŠ è½½ Mach-O é•œåƒæ—¶ __TEXT å’Œ __LINKEDIT å› ä¸ºåªè¯»ï¼Œéƒ½æ˜¯å¯ä»¥å…±äº«å†…å­˜çš„ï¼Œè¯»å–é€Ÿåº¦å°±ä¼šå¾ˆå¿«ã€‚</li>
<li>è€Œ __DATA å› ä¸ºå¯è¯»å†™ï¼Œå°±æœ‰å¯èƒ½ä¼šäº§ç”Ÿ dirty pageï¼Œå¦‚æœæ£€æµ‹åˆ°æœ‰ clean page å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œåä¹‹å°±éœ€è¦é‡æ–°è¯»å– DATA pageã€‚ä¸€æ—¦äº§ç”Ÿäº† dirty pageï¼Œå½“ dyld æ‰§è¡Œç»“æŸåï¼Œ__LINKEDIT éœ€è¦é€šçŸ¥å†…æ ¸å½“å‰é¡µé¢ä¸å†éœ€è¦äº†ï¼Œå½“åˆ«äººéœ€è¦çš„ä½¿ç”¨æ—¶å€™å°±å¯ä»¥é‡æ–° clean è¿™äº›é¡µé¢ã€‚</li>
</ul>
<h4 id="ASLR"><a href="#ASLR" class="headerlink" title="ASLR"></a>ASLR</h4><p><code>ASLR</code> (Address Space Layout Randomization) åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ï¼Œé•œåƒä¼šåœ¨éšæœºçš„åœ°å€ä¸ŠåŠ è½½ã€‚</p>
<h4 id="Code-Signing"><a href="#Code-Signing" class="headerlink" title="Code Signing"></a>Code Signing</h4><p>å¯èƒ½æˆ‘ä»¬è®¤ä¸º <code>Xcode</code> ä¼šæŠŠæ•´ä¸ªæ–‡ä»¶éƒ½åšåŠ å¯† <code>hash</code> å¹¶ç”¨åšæ•°å­—ç­¾åã€‚å…¶å®ä¸ºäº†åœ¨è¿è¡Œæ—¶éªŒè¯ <code>Mach-O</code> æ–‡ä»¶çš„ç­¾åï¼Œå¹¶ä¸æ˜¯æ¯æ¬¡é‡å¤è¯»å…¥æ•´ä¸ªæ–‡ä»¶ï¼Œè€Œæ˜¯æŠŠæ¯é¡µå†…å®¹éƒ½ç”Ÿæˆä¸€ä¸ªå•ç‹¬çš„åŠ å¯†æ•£åˆ—å€¼ï¼Œå¹¶å­˜å‚¨åœ¨ <code>__LINKEDIT</code> ä¸­ã€‚è¿™ä½¿å¾—æ–‡ä»¶æ¯é¡µçš„å†…å®¹éƒ½èƒ½åŠæ—¶è¢«æ ¡éªŒç¡®å¹¶ä¿ä¸è¢«ç¯¡æ”¹ã€‚</p>
<h4 id="exec"><a href="#exec" class="headerlink" title="exec()"></a><code>exec()</code></h4><p><img src="/images/exec_image.png" alt="exec_image"></p>
<p>Exec is a system call. When you trap into the kernel, you basically say I want to replace this process with this new program.</p>
<p>exec() æ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ã€‚ç³»ç»Ÿå†…æ ¸æŠŠåº”ç”¨æ˜ å°„åˆ°æ–°çš„åœ°å€ç©ºé—´ï¼Œä¸”æ¯æ¬¡èµ·å§‹ä½ç½®éƒ½æ˜¯éšæœºçš„ï¼ˆå› ä¸ºä½¿ç”¨ ASLRï¼‰ã€‚å¹¶å°†èµ·å§‹ä½ç½®åˆ° 0x000000 è¿™æ®µèŒƒå›´çš„è¿›ç¨‹æƒé™éƒ½æ ‡è®°ä¸ºä¸å¯è¯»å†™ä¸å¯æ‰§è¡Œã€‚å¦‚æœæ˜¯ 32 ä½è¿›ç¨‹ï¼Œè¿™ä¸ªèŒƒå›´è‡³å°‘æ˜¯ 4KBï¼›å¯¹äº 64 ä½è¿›ç¨‹åˆ™è‡³å°‘æ˜¯ 4GB ã€‚NULL æŒ‡é’ˆå¼•ç”¨å’ŒæŒ‡é’ˆæˆªæ–­è¯¯å·®éƒ½æ˜¯ä¼šè¢«å®ƒæ•è·ã€‚è¿™ä¸ªèŒƒå›´ä¹Ÿå«åš PAGEZEROã€‚</p>
<h4 id="dyld"><a href="#dyld" class="headerlink" title="dyld"></a><code>dyld</code></h4><p><img src="/images/dyld_image.png" alt="dyld_image"></p>
<p><code>Unix çš„å‰äºŒåå¹´å¾ˆå®‰é€¸ï¼Œå› ä¸ºé‚£æ—¶è¿˜æ²¡æœ‰å‘æ˜åŠ¨æ€é“¾æ¥åº“ã€‚æœ‰äº†åŠ¨æ€é“¾æ¥åº“åï¼Œä¸€ä¸ªç”¨äºåŠ è½½é“¾æ¥åº“çš„å¸®åŠ©ç¨‹åºè¢«åˆ›å»ºã€‚åœ¨è‹¹æœçš„å¹³å°é‡Œæ˜¯ dyldï¼Œå…¶ä»– Unix ç³»ç»Ÿä¹Ÿæœ‰ ld.soã€‚ å½“å†…æ ¸å®Œæˆæ˜ å°„è¿›ç¨‹çš„å·¥ä½œåä¼šå°†åå­—ä¸º dyld çš„ Mach-O æ–‡ä»¶æ˜ å°„åˆ°è¿›ç¨‹ä¸­çš„éšæœºåœ°å€ï¼Œå®ƒå°† PC å¯„å­˜å™¨è®¾ä¸º dyld çš„åœ°å€å¹¶è¿è¡Œã€‚dyld åœ¨åº”ç”¨è¿›ç¨‹ä¸­è¿è¡Œçš„å·¥ä½œæ˜¯åŠ è½½åº”ç”¨ä¾èµ–çš„æ‰€æœ‰åŠ¨æ€é“¾æ¥åº“ï¼Œå‡†å¤‡å¥½è¿è¡Œæ‰€éœ€çš„ä¸€åˆ‡ï¼Œå®ƒæ‹¥æœ‰çš„æƒé™è·Ÿåº”ç”¨ä¸€æ ·ã€‚</code></p>
<h4 id="dyldæµç¨‹"><a href="#dyldæµç¨‹" class="headerlink" title="dyldæµç¨‹"></a><code>dyld</code>æµç¨‹</h4><p><img src="/images/dyld_process_image.png" alt="dyld_process_image"></p>
<ul>
<li><p>Load dylibs<br><code>ä»ä¸»æ‰§è¡Œæ–‡ä»¶çš„ header è·å–åˆ°éœ€è¦åŠ è½½çš„æ‰€ä¾èµ–åŠ¨æ€åº“åˆ—è¡¨ï¼Œè€Œ header æ—©å°±è¢«å†…æ ¸æ˜ å°„è¿‡ã€‚ç„¶åå®ƒéœ€è¦æ‰¾åˆ°æ¯ä¸ª dylibï¼Œç„¶åæ‰“å¼€æ–‡ä»¶è¯»å–æ–‡ä»¶èµ·å§‹ä½ç½®ï¼Œç¡®ä¿å®ƒæ˜¯ Mach-O æ–‡ä»¶ã€‚æ¥ç€ä¼šæ‰¾åˆ°ä»£ç ç­¾åå¹¶å°†å…¶æ³¨å†Œåˆ°å†…æ ¸ã€‚ç„¶ååœ¨ dylib æ–‡ä»¶çš„æ¯ä¸ª segment ä¸Šè°ƒç”¨ mmap()ã€‚åº”ç”¨æ‰€ä¾èµ–çš„ dylib æ–‡ä»¶å¯èƒ½ä¼šå†ä¾èµ–å…¶ä»– dylibï¼Œæ‰€ä»¥ dyld æ‰€éœ€è¦åŠ è½½çš„æ˜¯åŠ¨æ€åº“åˆ—è¡¨ä¸€ä¸ªé€’å½’ä¾èµ–çš„é›†åˆã€‚ä¸€èˆ¬åº”ç”¨ä¼šåŠ è½½ 100 åˆ° 400 ä¸ª dylib æ–‡ä»¶ï¼Œä½†å¤§éƒ¨åˆ†éƒ½æ˜¯ç³»ç»Ÿ dylibï¼Œå®ƒä»¬ä¼šè¢«é¢„å…ˆè®¡ç®—å’Œç¼“å­˜èµ·æ¥ï¼ŒåŠ è½½é€Ÿåº¦å¾ˆå¿«ã€‚</code></p>
</li>
<li><p>Fix-ups<br><code>åœ¨åŠ è½½æ‰€æœ‰çš„åŠ¨æ€é“¾æ¥åº“ä¹‹åï¼Œå®ƒä»¬åªæ˜¯å¤„åœ¨ç›¸äº’ç‹¬ç«‹çš„çŠ¶æ€ï¼Œéœ€è¦å°†å®ƒä»¬ç»‘å®šèµ·æ¥ï¼Œè¿™å°±æ˜¯ Fix-upsã€‚ä»£ç ç­¾åä½¿å¾—æˆ‘ä»¬ä¸èƒ½ä¿®æ”¹æŒ‡ä»¤ï¼Œé‚£æ ·å°±ä¸èƒ½è®©ä¸€ä¸ª dylib çš„è°ƒç”¨å¦ä¸€ä¸ª dylibã€‚è¿™æ—¶éœ€è¦åŠ å¾ˆå¤šé—´æ¥å±‚ã€‚
ç°ä»£ code-gen è¢«å«åšåŠ¨æ€ PICï¼ˆPosition Independent Codeï¼‰ï¼Œæ„å‘³ç€ä»£ç å¯ä»¥è¢«åŠ è½½åˆ°é—´æ¥çš„åœ°å€ä¸Šã€‚å½“è°ƒç”¨å‘ç”Ÿæ—¶ï¼Œcode-gen å®é™…ä¸Šä¼šåœ¨ __DATA æ®µä¸­åˆ›å»ºä¸€ä¸ªæŒ‡å‘è¢«è°ƒç”¨è€…çš„æŒ‡é’ˆï¼Œç„¶ååŠ è½½æŒ‡é’ˆå¹¶è·³è½¬è¿‡å»ã€‚æ‰€ä»¥ dyld åšçš„äº‹æƒ…å°±æ˜¯ä¿®æ­£ï¼ˆfix-upï¼‰æŒ‡é’ˆå’Œæ•°æ®ã€‚Fix-up æœ‰ä¸¤ç§ç±»å‹ï¼Œrebasing å’Œ bindingã€‚</code></p>
</li>
<li><p>Rebasing å’Œ Binding</p>
<p><code>Rebasingï¼šåœ¨é•œåƒå†…éƒ¨è°ƒæ•´æŒ‡é’ˆçš„æŒ‡å‘
Bindingï¼šå°†æŒ‡é’ˆæŒ‡å‘é•œåƒå¤–éƒ¨çš„å†…å®¹</code></p>
</li>
</ul>
<p><code>dyld</code> çš„æ—¶é—´çº¿ç”±ä¸Šå›¾å¯çŸ¥ä¸ºï¼š</p>
<p>Load dylibs -&gt; Rebase -&gt; Bind -&gt; ObjC -&gt; Initializers</p>
<h4 id="dyld2-amp-amp-dyld3"><a href="#dyld2-amp-amp-dyld3" class="headerlink" title="dyld2 &amp;&amp; dyld3"></a>dyld2 &amp;&amp; dyld3</h4><p><img src="/images/dyld3_image.png" alt="dyld3_image"></p>
<p>åœ¨ <code>iOS 13</code> ä¹‹å‰ï¼Œæ‰€æœ‰çš„ç¬¬ä¸‰æ–¹ <code>App</code> éƒ½æ˜¯é€šè¿‡ <code>dyld 2</code> æ¥å¯åŠ¨ <code>App</code> çš„ï¼Œä¸»è¦è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>è§£æ <code>Mach-O</code> çš„ <code>Header</code> å’Œ <code>Load Commands</code>ï¼Œæ‰¾åˆ°å…¶ä¾èµ–çš„åº“ï¼Œå¹¶é€’å½’æ‰¾åˆ°æ‰€æœ‰ä¾èµ–çš„åº“</li>
<li>åŠ è½½ <code>Mach-O</code> æ–‡ä»¶</li>
<li>è¿›è¡Œç¬¦å·æŸ¥æ‰¾</li>
<li>ç»‘å®šå’Œå˜åŸº</li>
<li>è¿è¡Œåˆå§‹åŒ–ç¨‹åº</li>
</ul>
<p>dyld3 è¢«åˆ†ä¸ºäº†ä¸‰ä¸ªç»„ä»¶ï¼š</p>
<ul>
<li>ä¸€ä¸ªè¿›ç¨‹å¤–çš„ MachO è§£æå™¨<ul>
<li>é¢„å…ˆå¤„ç†äº†æ‰€æœ‰å¯èƒ½å½±å“å¯åŠ¨é€Ÿåº¦çš„ search pathã€@rpaths å’Œç¯å¢ƒå˜é‡</li>
<li>ç„¶ååˆ†æ Mach-O çš„ Header å’Œä¾èµ–ï¼Œå¹¶å®Œæˆäº†æ‰€æœ‰ç¬¦å·æŸ¥æ‰¾çš„å·¥ä½œ</li>
<li>æœ€åå°†è¿™äº›ç»“æœåˆ›å»ºæˆäº†ä¸€ä¸ªå¯åŠ¨é—­åŒ…</li>
<li>è¿™æ˜¯ä¸€ä¸ªæ™®é€šçš„ daemon è¿›ç¨‹ï¼Œå¯ä»¥ä½¿ç”¨é€šå¸¸çš„æµ‹è¯•æ¶æ„</li>
</ul>
</li>
<li>ä¸€ä¸ªè¿›ç¨‹å†…çš„å¼•æ“ï¼Œç”¨æ¥è¿è¡Œå¯åŠ¨é—­åŒ…<ul>
<li>è¿™éƒ¨åˆ†åœ¨è¿›ç¨‹ä¸­å¤„ç†</li>
<li>éªŒè¯å¯åŠ¨é—­åŒ…çš„å®‰å…¨æ€§ï¼Œç„¶åæ˜ å°„åˆ° dylib ä¹‹ä¸­ï¼Œå†è·³è½¬åˆ° main å‡½æ•°</li>
<li>ä¸éœ€è¦è§£æ Mach-O çš„ Header å’Œä¾èµ–ï¼Œä¹Ÿä¸éœ€è¦ç¬¦å·æŸ¥æ‰¾ã€‚</li>
</ul>
</li>
<li>ä¸€ä¸ªå¯åŠ¨é—­åŒ…ç¼“å­˜æœåŠ¡<ul>
<li>ç³»ç»Ÿ App çš„å¯åŠ¨é—­åŒ…è¢«æ„å»ºåœ¨ä¸€ä¸ª Shared Cache ä¸­ï¼Œ æˆ‘ä»¬ç”šè‡³ä¸éœ€è¦æ‰“å¼€ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶</li>
<li>å¯¹äºç¬¬ä¸‰æ–¹çš„ Appï¼Œæˆ‘ä»¬ä¼šåœ¨ App å®‰è£…æˆ–è€…å‡çº§çš„æ—¶å€™æ„å»ºè¿™ä¸ªå¯åŠ¨é—­åŒ…ã€‚</li>
<li>åœ¨ iOSã€tvOSã€watchOSä¸­ï¼Œè¿™è¿™ä¸€åˆ‡éƒ½æ˜¯ App å¯åŠ¨ä¹‹å‰å®Œæˆçš„ã€‚åœ¨ macOS ä¸Šï¼Œç”±äºæœ‰ Side Load Appï¼Œè¿›ç¨‹å†…å¼•æ“ä¼šåœ¨é¦–æ¬¡å¯åŠ¨çš„æ—¶å€™å¯åŠ¨ä¸€ä¸ª daemon è¿›ç¨‹ï¼Œä¹‹åå°±å¯ä»¥ä½¿ç”¨å¯åŠ¨é—­åŒ…å¯åŠ¨äº†ã€‚</li>
</ul>
</li>
</ul>
<p>dyld 3 æŠŠå¾ˆå¤šè€—æ—¶çš„æŸ¥æ‰¾ã€è®¡ç®—å’Œ I/O çš„äº‹å‰éƒ½é¢„å…ˆå¤„ç†å¥½äº†ï¼Œè¿™ä½¿å¾—å¯åŠ¨é€Ÿåº¦æœ‰äº†å¾ˆå¤§çš„æå‡ã€‚</p>
<p>å¥½äº†ï¼Œå…ˆå¯¼çŸ¥è¯†å°±æ€»ç»“åˆ°è¿™é‡Œï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬è°ƒæ•´å‘¼å¸è¿›å…¥ä¸‹ä¸€ç« ~</p>
<h3 id="AppåŠ è½½åˆ†æ"><a href="#AppåŠ è½½åˆ†æ" class="headerlink" title="AppåŠ è½½åˆ†æ"></a>AppåŠ è½½åˆ†æ</h3><p>æˆ‘ä»¬åœ¨æ¢ç´¢ <code>iOS</code> åº•å±‚çš„æ—¶å€™ï¼Œå¯¹äºå¯¹è±¡ã€ç±»ã€æ–¹æ³•æœ‰äº†ä¸€å®šçš„è®¤çŸ¥å“¦ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±ä¸€èµ·æ¥æ¢ç´¢ä¸€ä¸‹åº”ç”¨æ˜¯æ€ä¹ˆåŠ è½½çš„ã€‚</p>
<p>æˆ‘ä»¬ç›´æ¥æ–°å»ºä¸€ä¸ª <code>Single View App</code> çš„é¡¹ç›®ï¼Œç„¶ååœ¨ <code>main.m</code> ä¸­æ‰“ä¸€ä¸ªæ–­ç‚¹:</p>
<p><img src="/images/demoMain_image.png" alt="demoMain_image"></p>
<p>å¯ä»¥çœ‹åˆ°å †æ ˆä¿¡æ¯ä¸ºï¼š</p>
<p><img src="/images/launch_stack_image.png" alt="launch_stack_image"></p>
<p>å¯ä»¥çœ‹åˆ°å †æ ˆæ ˆåº•æ˜¯<code>_dyld_start</code>ï¼Œè¯´æ˜AppåŠ è½½æ˜¯ä»<code>_dyld_start</code>å¼€å§‹çš„</p>
<h4 id="dyld-start"><a href="#dyld-start" class="headerlink" title="_dyld_start"></a>_dyld_start</h4><p>æˆ‘ä»¬åœ¨æºç é‡Œå…¨å±€æœç´¢_dyld_startã€‚<a href="https://opensource.apple.com/tarballs/dyld/" target="_blank" rel="noopener">æºç ä¸‹è½½åœ°å€</a>,æˆ‘è¿™é‡Œä¸‹è½½çš„ç‰ˆæœ¬æ˜¯832.7.3ï¼Œæˆ‘ä»¬å¯ä»¥æ¥åˆ° <code>dyldStartup.s</code> è¿™ä¸ªæ±‡ç¼–æ–‡ä»¶ï¼Œç„¶åæˆ‘ä»¬èšç„¦äº <code>arm64</code> æ¶æ„ä¸‹çš„æ±‡ç¼–ä»£ç :</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __arm64__ &amp;&amp; !TARGET_OS_SIMULATOR</span></span><br><span class="line">	.<span class="built_in">text</span></span><br><span class="line">	.align <span class="number">2</span></span><br><span class="line">	.globl __dyld_start</span><br><span class="line">__dyld_start:</span><br><span class="line">	mov 	x28, sp</span><br><span class="line">	<span class="keyword">and</span>     sp, x28, #~<span class="number">15</span>		<span class="comment">// force 16-byte alignment of stack</span></span><br><span class="line">	mov	x0, #<span class="number">0</span></span><br><span class="line">	mov	x1, #<span class="number">0</span></span><br><span class="line">	stp	x1, x0, [sp, #<span class="number">-16</span>]!	<span class="comment">// make aligned terminating frame</span></span><br><span class="line">	mov	fp, sp			<span class="comment">// set up fp to point to terminating frame</span></span><br><span class="line">	sub	sp, sp, #<span class="number">16</span>             <span class="comment">// make room for local variables</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __LP64__</span></span><br><span class="line">	ldr     x0, [x28]               <span class="comment">// get app's mh into x0</span></span><br><span class="line">	ldr     x1, [x28, #<span class="number">8</span>]           <span class="comment">// get argc into x1 (kernel passes 32-bit int argc as 64-bits on stack to keep alignment)</span></span><br><span class="line">	add     x2, x28, #<span class="number">16</span>            <span class="comment">// get argv into x2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	ldr     w0, [x28]               <span class="comment">// get app's mh into x0</span></span><br><span class="line">	ldr     w1, [x28, #<span class="number">4</span>]           <span class="comment">// get argc into x1 (kernel passes 32-bit int argc as 64-bits on stack to keep alignment)</span></span><br><span class="line">	add     w2, w28, #<span class="number">8</span>             <span class="comment">// get argv into x2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	adrp	x3,___dso_handle@page</span><br><span class="line">	add 	x3,x3,___dso_handle@pageoff <span class="comment">// get dyld's mh in to x4</span></span><br><span class="line">	mov	x4,sp                   <span class="comment">// x5 has &amp;startGlue</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// call dyldbootstrap::start(app_mh, argc, argv, dyld_mh, &amp;startGlue)</span></span><br><span class="line">	bl	__ZN13dyldbootstrap5startEPKN5dyld311MachOLoadedEiPPKcS3_Pm</span><br><span class="line">	mov	x16,x0                  <span class="comment">// save entry point address in x16</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __LP64__</span></span><br><span class="line">	ldr     x1, [sp]</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	ldr     w1, [sp]</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	cmp	x1, #<span class="number">0</span></span><br><span class="line">	b.ne	Lnew</span><br></pre></td></tr></table></figure>

<p>å¯¹äºè¿™é‡Œçš„æ±‡ç¼–ä»£ç ï¼Œæˆ‘ä»¬è‚¯å®šä¹Ÿæ²¡å¿…è¦é€è¡Œåˆ†æï¼Œæˆ‘ä»¬ç›´æ¥å®šä½åˆ° <code>bl</code> è¯­å¥åé¢(<code>bl</code> åœ¨æ±‡ç¼–å±‚é¢æ˜¯è·³è½¬çš„æ„æ€)ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// call dyldbootstrap::start(app_mh, argc, argv, dyld_mh, &amp;startGlue)</span></span><br><span class="line">	bl	__ZN13dyldbootstrap5startEPKN5dyld311MachOLoadedEiPPKcS3_Pm</span><br></pre></td></tr></table></figure>

<p>çœ‹æ³¨é‡Šå¯ä»¥çŸ¥é“ï¼Œè°ƒç”¨ä½äº dyldbootstrap å‘½åç©ºé—´ä¸‹çš„ start æ–¹æ³•ï¼Œæˆ‘ä»¬ç»§ç»­æœç´¢ä¸€ä¸‹è¿™ä¸ª start æ–¹æ³•ï¼Œç»“æœä½äº dyldInitialization.cpp æ–‡ä»¶(ä»æ–‡ä»¶åæˆ‘ä»¬å¯ä»¥çœ‹å‡ºè¯¥æ–‡ä»¶ä¸»è¦æ˜¯ç”¨æ¥åˆå§‹åŒ– dyld)ï¼Œè¿™é‡ŒæŸ¥æ‰¾ start çš„æ—¶å€™å¯èƒ½ä¼šæœ‰å¾ˆå¤šç»“æœï¼Œæˆ‘ä»¬å…¶å®å¯ä»¥å…ˆæœç´¢å‘½åç©ºé—´ï¼Œå†æœç´¢ start æ–¹æ³•ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This is code to bootstrap dyld.  This work in normally done for a program by dyld and crt.</span></span><br><span class="line"><span class="comment">//  In dyld we have to do this manually.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">uintptr_t</span> <span class="title">start</span><span class="params">(<span class="keyword">const</span> dyld3::MachOLoaded* appsMachHeader, <span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[],</span></span></span><br><span class="line"><span class="function"><span class="params">				<span class="keyword">const</span> dyld3::MachOLoaded* dyldsMachHeader, <span class="keyword">uintptr_t</span>* startGlue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Emit kdebug tracepoint to indicate dyld bootstrap has started &lt;rdar://46878536&gt;</span></span><br><span class="line">    dyld3::kdebug_trace_dyld_marker(DBG_DYLD_TIMING_BOOTSTRAP_START, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// if kernel had to slide dyld, we need to fix up load sensitive locations</span></span><br><span class="line">	<span class="comment">// we have to do this before using any global variables</span></span><br><span class="line">  <span class="comment">// dyld é‡å®šå‘</span></span><br><span class="line">    rebaseDyld(dyldsMachHeader);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// kernel sets up env pointer to be just past end of agv array</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>** envp = &amp;argv[argc+<span class="number">1</span>];</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// kernel sets up apple pointer to be just past end of envp array</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>** apple = envp;</span><br><span class="line">	<span class="keyword">while</span>(*apple != <span class="literal">NULL</span>) &#123; ++apple; &#125;</span><br><span class="line">	++apple;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// set up random value for stack canary</span></span><br><span class="line">  <span class="comment">// æ ˆæº¢å‡ºä¿æŠ¤</span></span><br><span class="line">	__guard_setup(apple);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DYLD_INITIALIZER_SUPPORT</span></span><br><span class="line">	<span class="comment">// run all C++ initializers inside dyld</span></span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–dyld</span></span><br><span class="line">	runDyldInitializers(argc, argv, envp, apple);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	_subsystem_init(apple);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// now that we are done bootstrapping dyld, call dyld's main</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> appsSlide = appsMachHeader-&gt;getSlide();</span><br><span class="line">	<span class="keyword">return</span> dyld::_main((macho_header*)appsMachHeader, appsSlide, argc, argv, envp, apple, startGlue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>start</code>æ–¹æ³•ä¸»è¦åšäº†å¾ˆå¤š<code>dyld</code>çš„<code>åˆå§‹åŒ–</code>å·¥ä½œï¼š</p>
<ul>
<li><code>rebaseDyld</code>   <code>dyldé‡å®šä½</code></li>
<li><code>__guard_setup</code>   <code>æ ˆæº¢å‡ºä¿æŠ¤</code></li>
</ul>
<p>åœ¨ç»“æŸ<code>dyldåˆå§‹åŒ–</code>å·¥ä½œåï¼Œå‡½æ•°è°ƒç”¨ <code>dyld::_main()</code> å‡½æ•°ï¼Œå†å°†è¿”å›å€¼ä¼ é€’ç»™<code>__dyld_start</code>å»è°ƒç”¨çœŸæ­£çš„<code>main</code>å‡½æ•°ã€‚</p>
<h4 id="dyld-main"><a href="#dyld-main" class="headerlink" title="dyld::_main"></a>dyld::_main</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Entry point for dyld.  The kernel loads dyld and jumps to __dyld_start which</span></span><br><span class="line"><span class="comment">// sets up some registers and call this function.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Returns address of main() in target program which __dyld_start jumps to</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">uintptr_t</span></span><br><span class="line">_main(<span class="keyword">const</span> macho_header* mainExecutableMH, <span class="keyword">uintptr_t</span> mainExecutableSlide, </span><br><span class="line">		<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[], <span class="keyword">const</span> <span class="keyword">char</span>* envp[], <span class="keyword">const</span> <span class="keyword">char</span>* apple[], </span><br><span class="line">		<span class="keyword">uintptr_t</span>* startGlue)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">///çœç•¥ä»£ç </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>_mainæ–¹æ³•</code> å®˜æ–¹çš„æ³¨é‡Šå¦‚ä¸‹ï¼š</p>
<blockquote>
<p><code>dyld</code> çš„å…¥å£ã€‚å†…æ ¸åŠ è½½äº† <code>dyld</code> ç„¶åè·³è½¬åˆ° <code>__dyld_start</code> æ¥è®¾ç½®ä¸€äº›å¯„å­˜å™¨çš„å€¼ç„¶åè°ƒç”¨åˆ°äº†è¿™ä¸ªæ–¹æ³•ã€‚<br>è¿”å› <code>__dyld_start</code> æ‰€è·³è½¬åˆ°çš„ç›®æ ‡ç¨‹åºçš„ <code>main</code> å‡½æ•°åœ°å€ã€‚</p>
</blockquote>
<p><code>dyld</code>æµç¨‹å¯æ€»ç»“ä¸ºä¹ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li>ç¬¬ä¸€æ­¥ï¼š<code>è®¾ç½®è¿è¡Œç¯å¢ƒ</code></li>
<li>ç¬¬äºŒæ­¥ï¼š<code>åŠ è½½å…±äº«ç¼“å­˜</code></li>
<li>ç¬¬ä¸‰æ­¥ï¼š<code>å®ä¾‹åŒ–ä¸»ç¨‹åº</code></li>
<li>ç¬¬å››æ­¥ï¼š<code>åŠ è½½æ’å…¥çš„åŠ¨æ€åº“</code></li>
<li>ç¬¬äº”æ­¥ï¼š<code>é“¾æ¥ä¸»ç¨‹åº</code></li>
<li>ç¬¬å…­æ­¥ï¼š<code>é“¾æ¥æ’å…¥çš„åŠ¨æ€åº“</code></li>
<li>ç¬¬ä¸ƒæ­¥ï¼š<code>æ‰§è¡Œå¼±å¼•ç”¨ç»‘å®š</code></li>
<li>ç¬¬å…«æ­¥ï¼š<code>æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•</code></li>
<li>ç¬¬ä¹æ­¥ï¼š<code>æŸ¥æ‰¾ç¨‹åºå…¥å£mainç„¶åè¿”å›</code></li>
</ul>
<h5 id="ç¬¬ä¸€æ­¥ï¼šè®¾ç½®è¿è¡Œç¯å¢ƒ"><a href="#ç¬¬ä¸€æ­¥ï¼šè®¾ç½®è¿è¡Œç¯å¢ƒ" class="headerlink" title="ç¬¬ä¸€æ­¥ï¼šè®¾ç½®è¿è¡Œç¯å¢ƒ"></a>ç¬¬ä¸€æ­¥ï¼šè®¾ç½®è¿è¡Œç¯å¢ƒ</h5><p>è¿™ä¸€æ­¥ä¸»è¦æ˜¯è®¾ç½®ç¨‹åºçš„<code>è¿è¡Œç¯å¢ƒ</code>ï¼Œ<code>è¿è¡Œæ¡ä»¶</code>ç­‰å‡†å¤‡å·¥ä½œï¼ŒåŒ…æ‹¬<code>ç¯å¢ƒ</code>ï¼Œ<code>å¹³å°</code>ï¼Œ<code>ç‰ˆæœ¬</code>ï¼Œ<code>è·¯å¾„</code>ï¼Œ<code>ä¸»æœº</code>ä¿¡æ¯ï¼Œè®¾ç½®<code>ç¨‹åºä¸Šä¸‹æ–‡ä¿¡æ¯</code>ç­‰</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–ä¸»ç¨‹åºçš„hash</span></span><br><span class="line">    mainExecutableCDHash = mainExecutableCDHashBuffer;</span><br><span class="line"><span class="comment">// è·å–ä¸»ç¨‹åºçš„macho_headerç»“æ„</span></span><br><span class="line">    sMainExecutableMachHeader = mainExecutableMH;</span><br><span class="line"><span class="comment">// è·å–ä¸»ç¨‹åºçš„slideå€¼</span></span><br><span class="line">    sMainExecutableSlide = mainExecutableSlide;</span><br><span class="line"><span class="comment">// è®¾ç½®ä¸Šä¸‹æ–‡ä¿¡æ¯</span></span><br><span class="line">    setContext(mainExecutableMH, argc, argv, envp, apple);</span><br><span class="line"><span class="comment">// è·å–ä¸»ç¨‹åºè·¯å¾„</span></span><br><span class="line">    sExecPath = _simple_getenv(apple, <span class="string">"executable_path"</span>);</span><br><span class="line"><span class="comment">// è¿›ç¨‹çš„å¤´ç¯å¢ƒé…ç½®</span></span><br><span class="line">    configureProcessRestrictions(mainExecutableMH, envp);</span><br><span class="line"><span class="comment">// æ£€æµ‹ç¯å¢ƒå˜é‡</span></span><br><span class="line">    checkEnvironmentVariables(envp);</span><br><span class="line">    defaultUninitializedFallbackPaths(envp);</span><br><span class="line"><span class="comment">// è·å–ä¸»æœºä¿¡æ¯ å¯ç†è§£ä¸º ç¨‹åºç»“æ„</span></span><br><span class="line">    getHostInfo(mainExecutableMH, mainExecutableSlide);</span><br></pre></td></tr></table></figure>

<h5 id="ç¬¬äºŒæ­¥ï¼šåŠ è½½å…±äº«ç¼“å­˜"><a href="#ç¬¬äºŒæ­¥ï¼šåŠ è½½å…±äº«ç¼“å­˜" class="headerlink" title="ç¬¬äºŒæ­¥ï¼šåŠ è½½å…±äº«ç¼“å­˜"></a><strong>ç¬¬äºŒæ­¥ï¼šåŠ è½½å…±äº«ç¼“å­˜</strong></h5><p>é¦–å…ˆæ£€æŸ¥<code>dyld</code>å…±äº«ç¼“å­˜åŒºæ˜¯å¦<code>ç¦ç”¨</code>ï¼Œ<code>iOS</code>å¿…é¡»<code>å¼€å¯</code>ï¼Œåœ¨<code>checkSharedRegionDisable</code>é‡Œé¢<code>iOS</code>ç¯å¢ƒä¸‹æ³¨é‡Šï¼š</p>
<p><code>// iOS cannot run without shared region</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ£€æŸ¥ç¼“å­˜å…±äº«åŒºåŸŸæ˜¯å¦å¼€å¯</span></span><br><span class="line">    checkSharedRegionDisable((dyld3::MachOLoaded*)mainExecutableMH, mainExecutableSlide);</span><br><span class="line"><span class="comment">// å…±äº«ç¼“å­˜åŠ è½½</span></span><br><span class="line">    mapSharedCache();</span><br><span class="line"><span class="comment">// mapSharedCache å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mapSharedCache</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    dyld3::SharedCacheOptions opts;</span><br><span class="line">    opts.cacheDirOverride   = sSharedCacheOverrideDir;</span><br><span class="line">    opts.forcePrivate       = (gLinkContext.sharedRegionMode == ImageLoader::kUsePrivateSharedRegion);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __x86_64__ &amp;&amp; !TARGET_OS_SIMULATOR</span></span><br><span class="line">    opts.useHaswell         = sHaswell;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    opts.useHaswell         = <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    opts.verbose            = gLinkContext.verboseMapping;</span><br><span class="line"><span class="comment">//--- åŠ è½½dyldç¼“å­˜ä¸»å‡½æ•°</span></span><br><span class="line">    loadDyldCache(opts, &amp;sSharedCacheLoadInfo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update global state</span></span><br><span class="line">    <span class="keyword">if</span> ( sSharedCacheLoadInfo.loadAddress != <span class="literal">nullptr</span> ) &#123;</span><br><span class="line">        gLinkContext.dyldCache                              = sSharedCacheLoadInfo.loadAddress;</span><br><span class="line">        dyld::gProcessInfo-&gt;processDetachedFromSharedRegion = opts.forcePrivate;</span><br><span class="line">        dyld::gProcessInfo-&gt;sharedCacheSlide                = sSharedCacheLoadInfo.slide;</span><br><span class="line">        dyld::gProcessInfo-&gt;sharedCacheBaseAddress          = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)sSharedCacheLoadInfo.loadAddress;</span><br><span class="line">        sSharedCacheLoadInfo.loadAddress-&gt;getUUID(dyld::gProcessInfo-&gt;sharedCacheUUID);</span><br><span class="line">        dyld3::kdebug_trace_dyld_image(DBG_DYLD_UUID_SHARED_CACHE_A, sSharedCacheLoadInfo.path, (<span class="keyword">const</span> <span class="keyword">uuid_t</span> *)&amp;dyld::gProcessInfo-&gt;sharedCacheUUID[<span class="number">0</span>], &#123;<span class="number">0</span>,<span class="number">0</span>&#125;, &#123;&#123; <span class="number">0</span>, <span class="number">0</span> &#125;&#125;, (<span class="keyword">const</span> mach_header *)sSharedCacheLoadInfo.loadAddress);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// loadDyldCacheå‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">loadDyldCache</span><span class="params">(<span class="keyword">const</span> SharedCacheOptions&amp; options, SharedCacheLoadInfo* results)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    results-&gt;loadAddress        = <span class="number">0</span>;</span><br><span class="line">    results-&gt;slide              = <span class="number">0</span>;</span><br><span class="line">    results-&gt;errorMessage       = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> TARGET_OS_SIMULATOR</span></span><br><span class="line">    <span class="comment">// simulator only supports mmap()ing cache privately into process</span></span><br><span class="line">    <span class="keyword">return</span> mapCachePrivate(options, results);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="keyword">if</span> ( options.forcePrivate ) &#123;</span><br><span class="line">        <span class="comment">// mmap cache into this process only</span></span><br><span class="line">        <span class="keyword">return</span> mapCachePrivate(options, results);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// fast path: when cache is already mapped into shared region</span></span><br><span class="line">        <span class="keyword">bool</span> hasError = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> ( reuseExistingCache(options, results) ) &#123;</span><br><span class="line">            hasError = (results-&gt;errorMessage != <span class="literal">nullptr</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// slow path: this is first process to load cache</span></span><br><span class="line">            hasError = mapCacheSystemWide(options, results);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> hasError;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>mapSharedCache</code>å‡½æ•°ä¸»è¦è°ƒç”¨<code>loadDyldCache</code> å‡½æ•°ï¼Œ<code>loadDyldCache</code>å‡½æ•°ä¸»è¦æœ‰ä¸‰ç§æ–¹å¼åŠ è½½å…±äº«ç¼“å­˜ï¼š</p>
<ul>
<li><code>mapCachePrivate()</code> ä»…åŠ è½½åˆ°å½“å‰è¿›ç¨‹</li>
<li>å…±äº«ç¼“å­˜å·²ç»åŠ è½½è¿‡ï¼Œä¸åšä»»ä½•å¤„ç†</li>
<li><code>mapCacheSystemWide()</code> æœªåŠ è½½è¿‡ï¼Œé¦–æ¬¡åŠ è½½</li>
</ul>
<h5 id="ç¬¬ä¸‰æ­¥ï¼šå®ä¾‹åŒ–ä¸»ç¨‹åº"><a href="#ç¬¬ä¸‰æ­¥ï¼šå®ä¾‹åŒ–ä¸»ç¨‹åº" class="headerlink" title="ç¬¬ä¸‰æ­¥ï¼šå®ä¾‹åŒ–ä¸»ç¨‹åº"></a><strong>ç¬¬ä¸‰æ­¥ï¼šå®ä¾‹åŒ–ä¸»ç¨‹åº</strong></h5><p>è¿™ä¸€æ­¥ä¸»è¦æ˜¯å°†ä¸»ç¨‹åºçš„<code>Mach-O</code>åŠ è½½è¿›å†…å­˜ï¼Œå¹¶å®ä¾‹åŒ–ä¸€ä¸ª<code>ImageLoader</code>ã€‚<code>instantiateFromLoadedImage()</code> é¦–å…ˆè°ƒç”¨<code>isCompatibleMachO()</code> å‡½æ•°æ£€æµ‹å½“å‰è¿›ç¨‹çš„<code>magic</code>ã€<code>cputype</code>ã€<code>cpusubtype</code> ç­‰ç›¸å…³å±æ€§ï¼Œåˆ¤æ–­<code>Mach-O</code>æ–‡ä»¶çš„<code>å…¼å®¹æ€§</code>ï¼Œå¦‚æœå…¼å®¹æ€§æ»¡è¶³ï¼Œå°±è°ƒç”¨<code>ImageLoaderMachO::instantiateMainExecutable()</code>å®ä¾‹åŒ–ä¸»ç¨‹åºçš„<code>ImageLoader</code>ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¬¬ä¸‰æ­¥ï¼šå®ä¾‹åŒ–ä¸»ç¨‹åº</span></span><br><span class="line">        sMainExecutable = instantiateFromLoadedImage(mainExecutableMH, mainExecutableSlide, sExecPath);</span><br><span class="line">        gLinkContext.mainExecutable = sMainExecutable;</span><br><span class="line">        gLinkContext.mainExecutableCodeSigned = hasCodeSignatureLoadCommand(mainExecutableMH);</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The kernel maps in main executable before dyld gets control.  We need to </span></span><br><span class="line"><span class="comment">// make an ImageLoader* for the already mapped in main executable.</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> ImageLoaderMachO* <span class="title">instantiateFromLoadedImage</span><span class="params">(<span class="keyword">const</span> macho_header* mh, <span class="keyword">uintptr_t</span> slide, <span class="keyword">const</span> <span class="keyword">char</span>* path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// try mach-o loader</span></span><br><span class="line">    <span class="keyword">if</span> ( isCompatibleMachO((<span class="keyword">const</span> <span class="keyword">uint8_t</span>*)mh, path) ) &#123;</span><br><span class="line">        ImageLoader* <span class="built_in">image</span> = ImageLoaderMachO::instantiateMainExecutable(mh, slide, path, gLinkContext);</span><br><span class="line">        addImage(<span class="built_in">image</span>);</span><br><span class="line">        <span class="keyword">return</span> (ImageLoaderMachO*)<span class="built_in">image</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">throw</span> <span class="string">"main executable not a known format"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create image for main executable</span></span><br><span class="line"><span class="function">ImageLoader* <span class="title">ImageLoaderMachO::instantiateMainExecutable</span><span class="params">(<span class="keyword">const</span> macho_header* mh, <span class="keyword">uintptr_t</span> slide, <span class="keyword">const</span> <span class="keyword">char</span>* path, <span class="keyword">const</span> LinkContext&amp; context)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//dyld::log("ImageLoader=%ld, ImageLoaderMachO=%ld, ImageLoaderMachOClassic=%ld, ImageLoaderMachOCompressed=%ld\n",</span></span><br><span class="line">    <span class="comment">//  sizeof(ImageLoader), sizeof(ImageLoaderMachO), sizeof(ImageLoaderMachOClassic), sizeof(ImageLoaderMachOCompressed));</span></span><br><span class="line">    <span class="keyword">bool</span> compressed;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> segCount;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> libCount;</span><br><span class="line">    <span class="keyword">const</span> linkedit_data_command* codeSigCmd;</span><br><span class="line">    <span class="keyword">const</span> encryption_info_command* encryptCmd;</span><br><span class="line">    sniffLoadCommands(mh, path, <span class="literal">false</span>, &amp;compressed, &amp;segCount, &amp;libCount, context, &amp;codeSigCmd, &amp;encryptCmd);</span><br><span class="line">    <span class="comment">// instantiate concrete class based on content of load commands</span></span><br><span class="line">    <span class="keyword">if</span> ( compressed ) </span><br><span class="line">        <span class="keyword">return</span> ImageLoaderMachOCompressed::instantiateMainExecutable(mh, slide, path, segCount, libCount, context);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">#<span class="keyword">if</span> SUPPORT_CLASSIC_MACHO</span><br><span class="line">        <span class="keyword">return</span> ImageLoaderMachOClassic::instantiateMainExecutable(mh, slide, path, segCount, libCount, context);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        <span class="keyword">throw</span> <span class="string">"missing LC_DYLD_INFO load command"</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>instantiateMainExecutable()</code>  å‡½æ•°ä¸­é€šè¿‡<code>sniffLoadCommands()</code> åˆ¤æ–­è¿™ä¸ª<code>mach-o</code>æ–‡ä»¶æ˜¯<code>æ™®é€šçš„</code>è¿˜æ˜¯<code>å‹ç¼©</code>çš„LINKEDITï¼Œä»¥åŠå®ƒæœ‰å¤šå°‘æ®µã€‚<br> æœ€åæ ¹æ®<code>compressed</code> æ˜¯å¦å‹ç¼©æ¥å®ä¾‹åŒ–æœ€åè¿”å›çš„<code>ImageLoader</code>ã€‚</p>
<h5 id="ç¬¬å››æ­¥ï¼šåŠ è½½æ’å…¥çš„åŠ¨æ€åº“"><a href="#ç¬¬å››æ­¥ï¼šåŠ è½½æ’å…¥çš„åŠ¨æ€åº“" class="headerlink" title="ç¬¬å››æ­¥ï¼šåŠ è½½æ’å…¥çš„åŠ¨æ€åº“"></a><strong>ç¬¬å››æ­¥ï¼šåŠ è½½æ’å…¥çš„åŠ¨æ€åº“</strong></h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¬¬å››æ­¥ï¼šåŠ è½½æ’å…¥çš„åŠ¨æ€åº“</span></span><br><span class="line">        <span class="keyword">if</span>  ( sEnv.DYLD_INSERT_LIBRARIES != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span>* lib = sEnv.DYLD_INSERT_LIBRARIES; *lib != <span class="literal">NULL</span>; ++lib) </span><br><span class="line">                loadInsertedDylib(*lib);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p><code>loadInsertedDylib()</code> å‡½æ•°ä¸­è®¾ç½®äº†ä¸€ä¸ª<code>LoadContext</code>ï¼Œå¹¶ä¸ºå®ƒé…ç½®ä¸€äº›å‚æ•°åï¼Œè°ƒç”¨<code>load()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ImageLoader* <span class="title">load</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* path, <span class="keyword">const</span> LoadContext&amp; context, <span class="keyword">unsigned</span>&amp; cacheIndex)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line"><span class="comment">// try all path permutations and check against existing loaded images</span></span><br><span class="line"></span><br><span class="line">    ImageLoader* <span class="built_in">image</span> = loadPhase0(path, orgPath, context, cacheIndex, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">image</span> != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">        CRSetCrashLogMessage2(<span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">image</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// try all path permutations and try open() until first success</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">const</span> <span class="keyword">char</span>*&gt; exceptions;</span><br><span class="line">    <span class="built_in">image</span> = loadPhase0(path, orgPath, context, cacheIndex, &amp;exceptions);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !TARGET_OS_SIMULATOR</span></span><br><span class="line">    <span class="comment">// &lt;rdar://problem/16704628&gt; support symlinks on disk to a path in dyld shared cache</span></span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">image</span> == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="built_in">image</span> = loadPhase2cache(path, orgPath, context, cacheIndex, &amp;exceptions);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    CRSetCrashLogMessage2(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">image</span> != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">        <span class="comment">// &lt;rdar://problem/6916014&gt; leak in dyld during dlopen when using DYLD_ variables</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">const</span> <span class="keyword">char</span>*&gt;::iterator it = exceptions.<span class="built_in">begin</span>(); it != exceptions.<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">            <span class="built_in">free</span>((<span class="keyword">void</span>*)(*it));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// if loaded image is not from cache, but original path is in cache</span></span><br><span class="line">        <span class="comment">// set gSharedCacheOverridden flag to disable some ObjC optimizations</span></span><br><span class="line">        <span class="keyword">if</span> ( !gSharedCacheOverridden &amp;&amp; !<span class="built_in">image</span>-&gt;inSharedCache() &amp;&amp; <span class="built_in">image</span>-&gt;isDylib() &amp;&amp; dyld3::MachOFile::isSharedCacheEligiblePath(path) &amp;&amp; inSharedCache(path) ) &#123;</span><br><span class="line">            gSharedCacheOverridden = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">image</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ç¬¬äº”æ­¥ï¼šé“¾æ¥ä¸»ç¨‹åº"><a href="#ç¬¬äº”æ­¥ï¼šé“¾æ¥ä¸»ç¨‹åº" class="headerlink" title="ç¬¬äº”æ­¥ï¼šé“¾æ¥ä¸»ç¨‹åº"></a><strong>ç¬¬äº”æ­¥ï¼šé“¾æ¥ä¸»ç¨‹åº</strong></h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¬¬äº”æ­¥ï¼šé“¾æ¥ä¸»ç¨‹åº        Executableï¼šå¯æ‰§è¡Œçš„æ„æ€</span></span><br><span class="line">        link(sMainExecutable, sEnv.DYLD_BIND_AT_LAUNCH, </span><br><span class="line">        <span class="literal">true</span>, ImageLoader::RPathChain(<span class="literal">NULL</span>, <span class="literal">NULL</span>), <span class="number">-1</span>);</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨<code>link()</code>å‡½æ•°å°†å®ä¾‹åŒ–åçš„ä¸»ç¨‹åºè¿›è¡Œ<code>åŠ¨æ€ä¿®æ­£</code>ï¼Œè®©äºŒè¿›åˆ¶å˜ä¸ºå¯æ­£å¸¸æ‰§è¡Œçš„çŠ¶æ€ã€‚<code>link()</code>å‡½æ•°å†…éƒ¨è°ƒç”¨äº†<code>ImgaeLoader::link()</code> å‡½æ•°ï¼Œä¸»è¦åšäº†ä¸‹é¢å‡ ä»¶äº‹ï¼š</p>
<ul>
<li>this-&gt;<code>recursiveLoadLibraries()</code>  é€’å½’åŠ è½½ä¾èµ–åº“è¿›å†…å­˜</li>
<li>this-&gt;<code>recursiveUpdateDepth()</code>   é€’å½’æ›´æ–°ä¾èµ–åº“çš„è·¯å¾„</li>
<li>this-&gt;<code>recursiveRebaseWithAccounting()</code>   é€’å½’é‡å®šä½ä¸»ç¨‹åºå’Œä¾èµ–åº“</li>
<li>this-&gt;<code>recursiveBindWithAccounting()</code>   é€’å½’å°†ä¸»ç¨‹åºå’Œä¾èµ–åº“æ‰§è¡Œç¬¦å·è¡¨ç»‘å®šï¼ˆé“¾æ¥åŠ¨æ€åº“ä½¿ç”¨ï¼‰</li>
<li>this-&gt;<code>weakBind()</code>   å¦‚æœä¸æ˜¯æ­£åœ¨é“¾æ¥ä¸»ç¨‹åºäºŒè¿›åˆ¶ï¼Œé‚£å°±ä¸»ç¨‹åºå¼±ç¬¦å·ç»‘å®šï¼ˆé“¾æ¥åŠ¨æ€åº“ä½¿ç”¨ï¼‰</li>
<li>this-&gt;<code>recursiveApplyInterposing()</code>   é€’å½’ç”³è¯·å¯æ’å…¥ä¾èµ–åº“æƒé™</li>
<li>this-&gt;<code>recursiveMakeDataReadOnly()</code>   é€’å½’è®¾ç½®æ‰€æœ‰ä¿¡æ¯åªè¯»ï¼ˆé“¾æ¥åŠ¨æ€åº“ä½¿ç”¨ï¼‰</li>
<li>this-&gt;<code>recursiveGetDOFSections()</code>  æ³¨å†ŒDOFèŠ‚</li>
</ul>
<p>ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ImageLoader::link</span><span class="params">(<span class="keyword">const</span> LinkContext&amp; context, <span class="keyword">bool</span> forceLazysBound, <span class="keyword">bool</span> preflightOnly, <span class="keyword">bool</span> neverUnload, <span class="keyword">const</span> RPathChain&amp; loaderRPaths, <span class="keyword">const</span> <span class="keyword">char</span>* imagePath)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="comment">// clear error strings</span></span><br><span class="line">    (*context.setErrorStrings)(<span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span> t0 = mach_absolute_time();</span><br><span class="line">       <span class="comment">// é€’å½’åŠ è½½ä¾èµ–åº“è¿›å†…å­˜</span></span><br><span class="line">    <span class="keyword">this</span>-&gt;recursiveLoadLibraries(context, preflightOnly, loaderRPaths, imagePath);</span><br><span class="line">    context.notifyBatch(dyld_image_state_dependents_mapped, preflightOnly);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// we only do the loading step for preflights</span></span><br><span class="line">    <span class="keyword">if</span> ( preflightOnly )</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> t1 = mach_absolute_time();</span><br><span class="line">       <span class="comment">// é€’å½’æ›´æ–°ä¾èµ–åº“çš„è·¯å¾„</span></span><br><span class="line">    context.clearAllDepths();</span><br><span class="line">    <span class="keyword">this</span>-&gt;recursiveUpdateDepth(context.imageCount());</span><br><span class="line"></span><br><span class="line">    __block <span class="keyword">uint64_t</span> t2, t3, t4, t5;</span><br><span class="line">    &#123;</span><br><span class="line">        dyld3::ScopedTimer(DBG_DYLD_TIMING_APPLY_FIXUPS, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        t2 = mach_absolute_time();</span><br><span class="line">        <span class="comment">// é€’å½’é‡å®šä½ä¸»ç¨‹åºå’Œä¾èµ–åº“</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;recursiveRebaseWithAccounting(context);</span><br><span class="line">        context.notifyBatch(dyld_image_state_rebased, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        t3 = mach_absolute_time();</span><br><span class="line">        <span class="keyword">if</span> ( !context.linkingMainExecutable )</span><br><span class="line">            <span class="comment">// é€’å½’å°†ä¸»ç¨‹åºå’Œä¾èµ–åº“æ‰§è¡Œç¬¦å·è¡¨ç»‘å®š</span></span><br><span class="line">            <span class="keyword">this</span>-&gt;recursiveBindWithAccounting(context, forceLazysBound, neverUnload);</span><br><span class="line"></span><br><span class="line">        t4 = mach_absolute_time();</span><br><span class="line">        <span class="keyword">if</span> ( !context.linkingMainExecutable )</span><br><span class="line">        <span class="comment">// å¦‚æœä¸æ˜¯æ­£åœ¨é“¾æ¥ä¸»ç¨‹åºäºŒè¿›åˆ¶ï¼Œé‚£å°±ä¸»ç¨‹åºå¼±ç¬¦å·ç»‘å®š</span></span><br><span class="line">            <span class="keyword">this</span>-&gt;weakBind(context);</span><br><span class="line">        t5 = mach_absolute_time();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// interpose any dynamically loaded images</span></span><br><span class="line">    <span class="keyword">if</span> ( !context.linkingMainExecutable &amp;&amp; (fgInterposingTuples.<span class="built_in">size</span>() != <span class="number">0</span>) ) &#123;</span><br><span class="line">        <span class="function">dyld3::ScopedTimer <span class="title">timer</span><span class="params">(DBG_DYLD_TIMING_APPLY_INTERPOSING, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">        <span class="comment">// é€’å½’ç”³è¯·å¯æ’å…¥ä¾èµ–åº“æƒé™</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;recursiveApplyInterposing(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// now that all fixups are done, make __DATA_CONST segments read-only</span></span><br><span class="line">    <span class="keyword">if</span> ( !context.linkingMainExecutable )</span><br><span class="line">      <span class="comment">// é€’å½’è®¾ç½®æ‰€æœ‰ä¿¡æ¯åªè¯»</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;recursiveMakeDataReadOnly(context);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( !context.linkingMainExecutable )</span><br><span class="line">        context.notifyBatch(dyld_image_state_bound, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span> t6 = mach_absolute_time();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( context.registerDOFs != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;DOFInfo&gt; dofs;</span><br><span class="line">       <span class="comment">//  æ³¨å†ŒDOFèŠ‚</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;recursiveGetDOFSections(context, dofs);</span><br><span class="line">        context.registerDOFs(dofs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">uint64_t</span> t7 = mach_absolute_time();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clear error strings</span></span><br><span class="line">    (*context.setErrorStrings)(<span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    fgTotalLoadLibrariesTime += t1 - t0;</span><br><span class="line">    fgTotalRebaseTime += t3 - t2;</span><br><span class="line">    fgTotalBindTime += t4 - t3;</span><br><span class="line">    fgTotalWeakBindTime += t5 - t4;</span><br><span class="line">    fgTotalDOF += t7 - t6;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// done with initial dylib loads</span></span><br><span class="line">    fgNextPIEDylibAddress = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ç¬¬å…­æ­¥ï¼šé“¾æ¥æ’å…¥çš„åŠ¨æ€åº“"><a href="#ç¬¬å…­æ­¥ï¼šé“¾æ¥æ’å…¥çš„åŠ¨æ€åº“" class="headerlink" title="ç¬¬å…­æ­¥ï¼šé“¾æ¥æ’å…¥çš„åŠ¨æ€åº“"></a><strong>ç¬¬å…­æ­¥ï¼šé“¾æ¥æ’å…¥çš„åŠ¨æ€åº“</strong></h5><p>è¿™ä¸€æ­¥è·Ÿé“¾æ¥ä¸»ç¨‹åºä¸€æ ·ï¼Œå°†<code>sAllImages</code>ä¸­çš„<code>ImageLoader</code>éå†å‡ºæ¥ï¼Œç„¶åè°ƒç”¨<code>link()</code>è¿›è¡Œé“¾æ¥ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>sAllImages</code>ä¸­ä¿å­˜çš„ç¬¬ä¸€ä¸ªæ˜¯<code>ä¸»ç¨‹åº</code>çš„é•œåƒï¼Œæ‰€ä»¥è¦è·å–æ‰€æœ‰çš„åŠ¨æ€åº“çš„<code>ImageLoader</code>ï¼Œå°±å¿…é¡»ä»<code>i + 1</code> å¼€å§‹éå†ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>; i &lt; sInsertedDylibCount; ++i) &#123;</span><br><span class="line">    ImageLoader* <span class="built_in">image</span> = sAllImages[i+<span class="number">1</span>];</span><br><span class="line">    link(<span class="built_in">image</span>, sEnv.DYLD_BIND_AT_LAUNCH, <span class="literal">true</span>, ImageLoader::RPathChain(<span class="literal">NULL</span>, <span class="literal">NULL</span>), <span class="number">-1</span>);</span><br><span class="line">    <span class="built_in">image</span>-&gt;setNeverUnloadRecursive();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ç¬¬ä¸ƒæ­¥ï¼šæ‰§è¡Œä¸»ç¨‹åºå¼±ç¬¦å·ç»‘å®š"><a href="#ç¬¬ä¸ƒæ­¥ï¼šæ‰§è¡Œä¸»ç¨‹åºå¼±ç¬¦å·ç»‘å®š" class="headerlink" title="ç¬¬ä¸ƒæ­¥ï¼šæ‰§è¡Œä¸»ç¨‹åºå¼±ç¬¦å·ç»‘å®š"></a><strong>ç¬¬ä¸ƒæ­¥ï¼šæ‰§è¡Œä¸»ç¨‹åºå¼±ç¬¦å·ç»‘å®š</strong></h5><p><code>weakBind()</code>é¦–å…ˆé€šè¿‡<code>getCoalescedImages()</code>åˆå¹¶æ‰€æœ‰åŠ¨æ€åº“çš„<code>å¼±ç¬¦å·</code>åˆ°ä¸€ä¸ªåˆ—è¡¨é‡Œï¼Œç„¶åè°ƒç”¨<code>initializeCoalIterator()</code>å¯¹éœ€è¦ç»‘å®šçš„å¼±ç¬¦å·è¿›è¡Œæ’åºï¼Œæ¥ç€è°ƒç”¨<code>incrementCoalIterator()</code>è¯»å–<code>dyld_info_command</code>ç»“æ„çš„<code>weak_bind_off</code>å’Œ<code>weak_bind_size</code>å­—æ®µï¼Œç¡®å®šå¼±ç¬¦å·çš„<code>æ•°æ®åç§»</code>ä¸å¤§å°ï¼Œæœ€ç»ˆè¿›è¡Œå¼±ç¬¦å·ç»‘å®š</p>
<h5 id="ç¬¬å…«æ­¥ï¼šæ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•"><a href="#ç¬¬å…«æ­¥ï¼šæ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•" class="headerlink" title="ç¬¬å…«æ­¥ï¼šæ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•"></a><strong>ç¬¬å…«æ­¥ï¼šæ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•</strong></h5><p>è¿™ä¸€æ­¥å°±å¼€å§‹è¿›è¡Œåˆå§‹åŒ–å·¥ä½œäº†ï¼Œ<code>initializeMainExecutable()</code> å‡½æ•°ä¸­è°ƒç”¨ <code>runInitializers()</code> å‡½æ•°ï¼Œæ¥ç€ä¾æ¬¡è°ƒç”¨ <code>processInitializers()</code> å‡½æ•°è¿›è¡Œä¸€äº›åˆå§‹åŒ–å‡†å¤‡å·¥ä½œï¼Œæ¥ç€<code>recursiveInitialization()</code> å‡½æ•°è°ƒç”¨è¿›è¡Œåˆå§‹åŒ–å·¥ä½œï¼Œæ¥ç€å…¨å±€æœç´¢<code>recursiveInitialization(</code>ï¼Œæ‰¾åˆ°<code>ImageLoader.cpp</code>ä¸­çš„æ­¤æ–¹æ³•å®šä¹‰ï¼Œçœ‹é‡ç‚¹ï¼Œå‡½æ•°é‡Œé¢æˆ‘ä»¬çœ‹åˆ°<code>noffitySingle()å•ä¸ªé€šçŸ¥æ³¨å…¥</code>ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ImageLoader::recursiveInitialization</span><span class="params">(<span class="keyword">const</span> LinkContext&amp; context, <span class="keyword">mach_port_t</span> this_thread, <span class="keyword">const</span> <span class="keyword">char</span>* pathToInitialize,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          InitializerTimingList&amp; timingInfo, UninitedUpwards&amp; uninitUps)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">recursive_lock <span class="title">lock_info</span><span class="params">(this_thread)</span></span>;</span><br><span class="line">    recursiveSpinLock(lock_info);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( fState &lt; dyld_image_state_dependents_initialized<span class="number">-1</span> ) &#123;</span><br><span class="line">        <span class="keyword">uint8_t</span> oldState = fState;</span><br><span class="line">        <span class="comment">// break cycles</span></span><br><span class="line">        fState = dyld_image_state_dependents_initialized<span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// initialize lower level libraries first</span></span><br><span class="line">            <span class="comment">// å…ˆåˆå§‹åŒ–åº•å±‚ä¾èµ–åº“</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>; i &lt; libraryCount(); ++i) &#123;</span><br><span class="line">                ImageLoader* dependentImage = libImage(i);</span><br><span class="line">                <span class="keyword">if</span> ( dependentImage != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">                    <span class="comment">// don't try to initialize stuff "above" me yet</span></span><br><span class="line">                    <span class="keyword">if</span> ( libIsUpward(i) ) &#123;</span><br><span class="line">                        uninitUps.imagesAndPaths[uninitUps.count] = &#123; dependentImage, libPath(i) &#125;;</span><br><span class="line">                        uninitUps.count++;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> ( dependentImage-&gt;fDepth &gt;= fDepth ) &#123;</span><br><span class="line">                        dependentImage-&gt;recursiveInitialization(context, this_thread, libPath(i), timingInfo, uninitUps);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// record termination order</span></span><br><span class="line">            <span class="comment">// è®°å½•ç»ˆç«¯åºå·</span></span><br><span class="line">            <span class="keyword">if</span> ( <span class="keyword">this</span>-&gt;needsTermination() )</span><br><span class="line">                context.terminationRecorder(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// let objc know we are about to initialize this image</span></span><br><span class="line">            <span class="comment">// å•ä¸ªé€šçŸ¥æ³¨å…¥ é€šçŸ¥å‘ŠçŸ¥å¤§å®¶æˆ‘è¦å¼€å§‹åˆå§‹åŒ–å•¦ï¼Œä½ ä»¬èµ¶ç´§å»åšåˆå§‹åŒ–çš„å·¥ä½œ</span></span><br><span class="line">            <span class="keyword">uint64_t</span> t1 = mach_absolute_time();</span><br><span class="line">            fState = dyld_image_state_dependents_initialized;</span><br><span class="line">            oldState = fState;</span><br><span class="line">            context.notifySingle(dyld_image_state_dependents_initialized, <span class="keyword">this</span>, &amp;timingInfo);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// initialize this image</span></span><br><span class="line">            <span class="keyword">bool</span> hasInitializers = <span class="keyword">this</span>-&gt;doInitialization(context);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// let anyone know we finished initializing this image</span></span><br><span class="line">            fState = dyld_image_state_initialized;</span><br><span class="line">            oldState = fState;</span><br><span class="line">            context.notifySingle(dyld_image_state_initialized, <span class="keyword">this</span>, <span class="literal">NULL</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> ( hasInitializers ) &#123;</span><br><span class="line">                <span class="keyword">uint64_t</span> t2 = mach_absolute_time();</span><br><span class="line">                timingInfo.addTime(<span class="keyword">this</span>-&gt;getShortName(), t2-t1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (<span class="keyword">const</span> <span class="keyword">char</span>* msg) &#123;</span><br><span class="line">            <span class="comment">// this image is not initialized</span></span><br><span class="line">            fState = oldState;</span><br><span class="line">            recursiveSpinUnLock();</span><br><span class="line">            <span class="keyword">throw</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    recursiveSpinUnLock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ¢ç´¢-objc-init"><a href="#æ¢ç´¢-objc-init" class="headerlink" title="æ¢ç´¢ _objc_init"></a>æ¢ç´¢ _objc_init</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _objc_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">bool</span> initialized = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (initialized) <span class="keyword">return</span>;</span><br><span class="line">    initialized = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// fixme defer initialization until an objc-using image is found?</span></span><br><span class="line">    environ_init();</span><br><span class="line">    tls_init();</span><br><span class="line">    static_init();</span><br><span class="line">    runtime_init();</span><br><span class="line">    exception_init();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __OBJC2__</span></span><br><span class="line">    <span class="keyword">cache_t</span>::init();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    _imp_implementationWithBlock_init();</span><br><span class="line"></span><br><span class="line">    _dyld_objc_notify_register(&amp;map_images, load_images, unmap_image);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __OBJC2__</span></span><br><span class="line">    didCallDyldNotifyRegister = <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡LLDBæ¥æ–­æ‰è°ƒè¯•<code>_objc_init</code>,ç„¶åé€šè¿‡<code>bt</code>å‘½ä»¤æ‰“å°å‡ºå½“å‰çš„è°ƒç”¨å †æ ˆï¼Œæ ¹æ®ä¸Šä¸€èŠ‚æˆ‘ä»¬æ¢ç´¢<code>dyld</code>æºç ï¼Œæ„Ÿè§‰å¾ˆæ¸…æ™°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(lldb) bt</span><br><span class="line">* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1</span><br><span class="line">  * frame #<span class="number">0</span>: <span class="number">0x00000001002d29c4</span> libobjc.A.dylib`_objc_init at objc-os.mm:<span class="number">925</span>:<span class="number">9</span></span><br><span class="line">    frame #<span class="number">1</span>: <span class="number">0x000000010044f0bc</span> libdispatch.dylib`_os_object_init + <span class="number">13</span></span><br><span class="line">    frame #<span class="number">2</span>: <span class="number">0x000000010045fafc</span> libdispatch.dylib`libdispatch_init + <span class="number">282</span></span><br><span class="line">    frame #<span class="number">3</span>: <span class="number">0x00007fff6a99c791</span> libSystem.B.dylib`libSystem_initializer + <span class="number">220</span></span><br><span class="line">    frame #<span class="number">4</span>: <span class="number">0x000000010002f1d3</span> dyld`ImageLoaderMachO::doModInitFunctions(ImageLoader::LinkContext <span class="keyword">const</span>&amp;) + <span class="number">535</span></span><br><span class="line">    frame #<span class="number">5</span>: <span class="number">0x000000010002f5de</span> dyld`ImageLoaderMachO::doInitialization(ImageLoader::LinkContext <span class="keyword">const</span>&amp;) + <span class="number">40</span></span><br><span class="line">    frame #<span class="number">6</span>: <span class="number">0x0000000100029ffb</span> dyld`ImageLoader::recursiveInitialization(ImageLoader::LinkContext <span class="keyword">const</span>&amp;, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">char</span> <span class="keyword">const</span>*, ImageLoader::InitializerTimingList&amp;, ImageLoader::UninitedUpwards&amp;) + <span class="number">493</span></span><br><span class="line">    frame #<span class="number">7</span>: <span class="number">0x0000000100029f66</span> dyld`ImageLoader::recursiveInitialization(ImageLoader::LinkContext <span class="keyword">const</span>&amp;, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">char</span> <span class="keyword">const</span>*, ImageLoader::InitializerTimingList&amp;, ImageLoader::UninitedUpwards&amp;) + <span class="number">344</span></span><br><span class="line">    frame #<span class="number">8</span>: <span class="number">0x00000001000280b4</span> dyld`ImageLoader::processInitializers(ImageLoader::LinkContext <span class="keyword">const</span>&amp;, <span class="keyword">unsigned</span> <span class="keyword">int</span>, ImageLoader::InitializerTimingList&amp;, ImageLoader::UninitedUpwards&amp;) + <span class="number">188</span></span><br><span class="line">    frame #<span class="number">9</span>: <span class="number">0x0000000100028154</span> dyld`ImageLoader::runInitializers(ImageLoader::LinkContext <span class="keyword">const</span>&amp;, ImageLoader::InitializerTimingList&amp;) + <span class="number">82</span></span><br><span class="line">    frame #<span class="number">10</span>: <span class="number">0x0000000100016662</span> dyld`dyld::initializeMainExecutable() + <span class="number">129</span></span><br><span class="line">    frame #<span class="number">11</span>: <span class="number">0x000000010001bbba</span> dyld`dyld::_main(macho_header <span class="keyword">const</span>*, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">int</span>, <span class="keyword">char</span> <span class="keyword">const</span>**, <span class="keyword">char</span> <span class="keyword">const</span>**, <span class="keyword">char</span> <span class="keyword">const</span>**, <span class="keyword">unsigned</span> <span class="keyword">long</span>*) + <span class="number">6667</span></span><br><span class="line">    frame #<span class="number">12</span>: <span class="number">0x0000000100015227</span> dyld`dyldbootstrap::start(dyld3::MachOLoaded <span class="keyword">const</span>*, <span class="keyword">int</span>, <span class="keyword">char</span> <span class="keyword">const</span>**, dyld3::MachOLoaded <span class="keyword">const</span>*, <span class="keyword">unsigned</span> <span class="keyword">long</span>*) + <span class="number">453</span></span><br><span class="line">    frame #<span class="number">13</span>: <span class="number">0x0000000100015025</span> dyld`_dyld_start + <span class="number">37</span></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>dyld</code> çš„æœ€åä¸€ä¸ªæµç¨‹æ˜¯ <code>doModInitFunctions</code> æ–¹æ³•çš„æ‰§è¡Œã€‚</p>
<p>æˆ‘ä»¬æ‰“å¼€ <code>libSystem</code> çš„æºç ï¼Œå…¨å±€æœç´¢ <code>libSystem_initializer</code> å¯ä»¥çœ‹åˆ°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">	_dyld_initializer();</span><br><span class="line">	_libSystem_ktrace_init_func(DYLD);</span><br><span class="line"></span><br><span class="line">	libdispatch_init();</span><br><span class="line">	_libSystem_ktrace_init_func(LIBDISPATCH);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !TARGET_OS_DRIVERKIT</span></span><br><span class="line">	_libxpc_initializer();</span><br><span class="line">	_libSystem_ktrace_init_func(LIBXPC);</span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬æ‰“å¼€ <code>libDispatch</code> çš„æºç ï¼Œå…¨å±€æœç´¢ <code>libdispatch_init</code> å¯ä»¥çœ‹åˆ°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">	<span class="keyword">void</span></span><br><span class="line">libdispatch_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//çœç•¥ä»£ç </span></span><br><span class="line">	_dispatch_hw_config_init();</span><br><span class="line">	_dispatch_time_init();</span><br><span class="line">	_dispatch_vtable_init();</span><br><span class="line">  <span class="comment">//è°ƒç”¨</span></span><br><span class="line">	_os_object_init();</span><br><span class="line">	_voucher_init();</span><br><span class="line">	_dispatch_introspection_init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å†æœç´¢<code>_os_object_init</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">_os_object_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	_objc_init();</span><br><span class="line">	Block_callbacks_RR callbacks = &#123;</span><br><span class="line">		<span class="keyword">sizeof</span>(Block_callbacks_RR),</span><br><span class="line">		(<span class="keyword">void</span> (*)(<span class="keyword">const</span> <span class="keyword">void</span> *))&amp;objc_retain,</span><br><span class="line">		(<span class="keyword">void</span> (*)(<span class="keyword">const</span> <span class="keyword">void</span> *))&amp;objc_release,</span><br><span class="line">		(<span class="keyword">void</span> (*)(<span class="keyword">const</span> <span class="keyword">void</span> *))&amp;_os_objc_destructInstance</span><br><span class="line">	&#125;;</span><br><span class="line">	_Block_use_RR2(&amp;callbacks);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DISPATCH_COCOA_COMPAT</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *v = getenv(<span class="string">"OBJC_DEBUG_MISSING_POOLS"</span>);</span><br><span class="line">	<span class="keyword">if</span> (v) _os_object_debug_missing_pools = _dispatch_parse_bool(v);</span><br><span class="line">	v = getenv(<span class="string">"DISPATCH_DEBUG_MISSING_POOLS"</span>);</span><br><span class="line">	<span class="keyword">if</span> (v) _os_object_debug_missing_pools = _dispatch_parse_bool(v);</span><br><span class="line">	v = getenv(<span class="string">"LIBDISPATCH_DEBUG_MISSING_POOLS"</span>);</span><br><span class="line">	<span class="keyword">if</span> (v) _os_object_debug_missing_pools = _dispatch_parse_bool(v);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®Œç¾~ï¼Œ<code>_objc_init</code> åœ¨è¿™é‡Œå°±è¢«è°ƒç”¨äº†ã€‚æ‰€ä»¥ <code>_objc_init</code> çš„æµç¨‹æ˜¯</p>
<p>dyld -&gt; libSystem -&gt; libDispatch -&gt; libObjc -&gt; <code>_objc_init</code></p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æœ¬æ–‡ä¸»è¦æ¢ç´¢äº† app å¯åŠ¨ä¹‹å dyld çš„æµç¨‹ï¼Œæ•´ä¸ªåˆ†æè¿‡ç¨‹ç¡®å®æ¯”è¾ƒå¤æ‚ï¼Œä½†åœ¨æ¢ç´¢çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸ä»…å¯¹åº•å±‚æºç æœ‰äº†æ–°çš„è®¤çŸ¥ï¼ŒåŒæ—¶å¯¹äºä¼˜åŒ–æˆ‘ä»¬ app å¯åŠ¨ä¹Ÿæ˜¯æœ‰å¾ˆå¤šå¥½å¤„çš„ã€‚ä¸‹ä¸€ç« ï¼Œæˆ‘ä»¬ä¼šå¯¹ objc_init å†…éƒ¨çš„ map_images å’Œ load_images è¿›è¡Œæ›´æ·±å…¥çš„åˆ†æã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yujiusheng.com/2021/05/13/iOS%E5%BA%95%E5%B1%82%EF%BC%9Astatic_init%E3%80%81gdb_objc_realized_classes&remapped_clasass_map&future_named_class_map/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="ä¸ªäººæŠ€æœ¯åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jasonçš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/13/iOS%E5%BA%95%E5%B1%82%EF%BC%9Astatic_init%E3%80%81gdb_objc_realized_classes&remapped_clasass_map&future_named_class_map/" class="post-title-link" itemprop="url">iOSåº•å±‚ï¼šstatic_initã€gdb_objc_realized_classes&remapped_clasass_map&future_named_class_map</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-05-13 13:58:39 / ä¿®æ”¹æ—¶é—´ï¼š16:51:43" itemprop="dateCreated datePublished" datetime="2021-05-13T13:58:39+08:00">2021-05-13</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="static-init"><a href="#static-init" class="headerlink" title="static_init"></a>static_init</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* static_init</span></span><br><span class="line"><span class="comment">* Run C++ static constructor functions.</span></span><br><span class="line"><span class="comment">* libc calls _objc_init() before dyld would call our static constructors, </span></span><br><span class="line"><span class="comment">* so we have to do it ourselves.</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">static_init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> count;</span><br><span class="line">    <span class="keyword">auto</span> inits = getLibobjcInitializers(&amp;_mh_dylib_header, &amp;count);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        inits[i]();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">auto</span> offsets = getLibobjcInitializerOffsets(&amp;_mh_dylib_header, &amp;count);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        <span class="function">UnsignedInitializer <span class="title">init</span><span class="params">(offsets[i])</span></span>;</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¼šè¿è¡Œ <code>C++</code> çš„é™æ€æ„é€ å‡½æ•°ï¼Œåœ¨ <code>dyld</code> è°ƒç”¨æˆ‘ä»¬çš„é™æ€æ„é€ å‡½æ•°ä¹‹å‰ï¼Œ<code>libc</code> ä¼šè°ƒç”¨ <code>_objc_init</code>ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¿…é¡»è‡ªå·±æ¥åšï¼Œå¹¶ä¸”è¿™é‡Œåªä¼šåˆå§‹åŒ–ç³»ç»Ÿå†…ç½®çš„ <code>C++</code> é™æ€æ„é€ å‡½æ•°ï¼Œæˆ‘ä»¬è‡ªå·±ä»£ç é‡Œé¢å†™çš„å¹¶ä¸ä¼šåœ¨è¿™é‡Œåˆå§‹åŒ–ã€‚</p>
<p>é€šè¿‡å…¶æ³¨é‡Šï¼Œæˆ‘ä»¬å¤§æ¦‚çŸ¥é“static_initå‡½æ•°çš„ä½œç”¨æ˜¯è¿è¡ŒC++çš„é™æ€æ„é€ å‡½æ•°ã€‚å…¶åŸå› åœ¨äºdyldè°ƒç”¨æˆ‘ä»¬çš„é™æ€æ„é€ å‡½æ•°æ™šäºlibcè°ƒç”¨_objc_initå‡½æ•°ã€‚</p>
<p>ç»§ç»­æ·±å…¥è®²è§£<code>static_init</code>æ–¹æ³•ï¼Œå¯ä»¥çœ‹å‡ºï¼Œ<code>getLibobjcInitializers</code>æ–¹æ³•æ˜¯å®ƒçš„å®ç°ä¸»ä½“ï¼Œç‚¹å‡»è¿›å…¥å¯ä»¥çœ‹åˆ°å¦‚ä¸‹å®ç°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GETSECT(getLibobjcInitializers,       UnsignedInitializer, <span class="string">"__objc_init_func"</span>);</span><br></pre></td></tr></table></figure>

<p>è¿™å°±èƒ½ç†è§£æˆ‘ä»¬æ–‡ç« å¼€å¤´æå‡ºçš„<code>static_init()</code>æ–¹æ³•çš„å«ä¹‰äº†ã€‚å…¶å®å°±æ˜¯æ‰¾å‡º<code>__objc_init_func</code>åŒºçš„æ•°æ®ï¼Œè·å–äº†<code>Initializer</code>æŒ‡é’ˆï¼Œç„¶åæŒ‰é¡ºåºè°ƒç”¨ã€‚</p>
<p>ç”±äºå…¨å±€å˜é‡éƒ½åœ¨ <code>mod_init_func</code> è¿™ä¸ªåŒºä¸­ï¼Œé‚£è¿™å°±ç»™æˆ‘ä»¬ä¼˜åŒ– App å¯åŠ¨æä¾›äº†ä¸€ä¸ªæ€è·¯ï¼šæˆ‘ä»¬å¯ä»¥é€šè¿‡ hook è¿™ä¸ªåŒºä¸­æ‰€æœ‰çš„å‡½æ•°ä¸ºè‡ªå·±çš„å‡½æ•°ï¼Œå¹¶åœ¨æˆ‘ä»¬çš„å‡½æ•°ä¸­æ·»åŠ æ—¶é—´èŠ‚ç‚¹æ¥è®¡æ—¶ï¼Œä»è€Œäº†è§£åœ¨ main å‡½æ•°ä¹‹å‰çš„è€—æ—¶æƒ…å†µï¼Œè¿™ä¹Ÿå¯ä»¥ä¸ºæˆ‘ä»¬ APP æä¾›ä¼˜åŒ–å€Ÿé‰´ã€‚</p>
<p>å…¶æƒ³æ³•å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨ load æ–¹æ³•ä¸­ hook <code>__mod_init_func</code> çš„æ–¹æ³•ã€‚éƒ¨åˆ†æºä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">+ (void)load&#123;</span><br><span class="line"></span><br><span class="line">    sInitInfos &#x3D; [NSMutableArray new];</span><br><span class="line"></span><br><span class="line">    g_initializer &#x3D; new std::vector&lt;MemoryType&gt;();</span><br><span class="line"></span><br><span class="line">    g_cur_index &#x3D; -1;</span><br><span class="line"></span><br><span class="line">    g_aslr &#x3D; 0;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    hookModInitFunc();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥åŠ</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hookModInitFunc</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    Dl_info info;</span><br><span class="line"></span><br><span class="line">    dladdr((<span class="keyword">const</span> <span class="keyword">void</span> *)hookModInitFunc, &amp;info);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __LP64__</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//        const struct mach_header *mhp = _dyld_get_image_header(0); // both works as below line</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">mach_header</span> *<span class="title">mhp</span> = (<span class="title">struct</span> <span class="title">mach_header</span>*)<span class="title">info</span>.<span class="title">dli_fbase</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="built_in">size</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    MemoryType *memory = (<span class="keyword">uint32_t</span>*)getsectiondata(mhp, <span class="string">"__DATA"</span>, <span class="string">"__mod_init_func"</span>, &amp; <span class="built_in">size</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span> <span class="comment">/* defined(__LP64__) */</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">mach_header_64</span> *<span class="title">mhp</span> = (<span class="title">struct</span> <span class="title">mach_header_64</span>*)<span class="title">info</span>.<span class="title">dli_fbase</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="built_in">size</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    MemoryType *memory = (<span class="keyword">uint64_t</span>*)getsectiondata(mhp, <span class="string">"__DATA"</span>, <span class="string">"__mod_init_func"</span>, &amp; <span class="built_in">size</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* defined(__LP64__) */</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> idx = <span class="number">0</span>; idx &lt; <span class="built_in">size</span>/<span class="keyword">sizeof</span>(<span class="keyword">void</span>*); ++idx)&#123;</span><br><span class="line"></span><br><span class="line">        MemoryType original_ptr = memory[idx];</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¿å­˜åŸå…ˆçš„æ–¹æ³•æŒ‡é’ˆ</span></span><br><span class="line"></span><br><span class="line">        g_initializer-&gt;push_back(original_ptr);</span><br><span class="line"></span><br><span class="line"><span class="comment">//å°†åŸå…ˆçš„æ–¹æ³•æ›¿æ¢ä¸ºæˆ‘ä»¬è‡ªå·±çš„æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">        memory[idx] = (MemoryType)myInitFunc_Initializer;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    NSLog(@<span class="string">"zero mod init func : size = %@"</span>,@(<span class="built_in">size</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    [sInitInfos addObject:[NSString stringWithFormat:@<span class="string">"ASLR=%p"</span>,mhp]];</span><br><span class="line"></span><br><span class="line">    g_aslr = (MemoryType)mhp;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åæ˜¯å±•ç¤ºæ–¹æ³•ä»¥åŠæ¶ˆè€—æ—¶é•¿ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myInitFunc_Initializer</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[], <span class="keyword">const</span> <span class="keyword">char</span>* envp[], <span class="keyword">const</span> <span class="keyword">char</span>* apple[], <span class="keyword">const</span> struct MyProgramVars* vars)</span></span>&#123;</span><br><span class="line">    ++g_cur_index;</span><br><span class="line">    OriginalInitializer func = (OriginalInitializer)g_initializer-&gt;at(g_cur_index);</span><br><span class="line"></span><br><span class="line">    CFTimeInterval start = CFAbsoluteTimeGetCurrent();</span><br><span class="line"></span><br><span class="line">    func(argc,argv,envp,apple,vars);</span><br><span class="line"></span><br><span class="line">    CFTimeInterval <span class="built_in">end</span> = CFAbsoluteTimeGetCurrent();</span><br><span class="line">    sSumInitTime += <span class="number">1000.0</span> * (<span class="built_in">end</span>-start);</span><br><span class="line">    NSString *cost = [NSString stringWithFormat:@<span class="string">"%p=%@"</span>,func,@(<span class="number">1000.0</span>*(<span class="built_in">end</span> - start))];</span><br><span class="line">    [sInitInfos addObject:cost];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="gdb-objc-realized-classes"><a href="#gdb-objc-realized-classes" class="headerlink" title="gdb_objc_realized_classes"></a>gdb_objc_realized_classes</h3><p>gdb_objc_realized_classes çš„ä½œç”¨å·²ç»å¾ˆæ˜æ˜¾äº†ï¼Œå³æ˜¯å¯¹æ‰€æœ‰çš„ç±»è¿›è¡Œç¼“å­˜ï¼šä»å¯¹åº”çš„ section ä¸­è¯»å–æ‰€æœ‰çš„ç±»ï¼Œå–å‡ºæ¥åä»¥ mangledName ä½œä¸ºé”®ï¼Œä»¥ class ç»“æ„ä½“ä½œä¸ºå€¼ã€‚</p>
<h3 id="remapped-class-map"><a href="#remapped-class-map" class="headerlink" title="remapped_class_map"></a>remapped_class_map</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* remappedClasses</span></span><br><span class="line"><span class="comment">* Returns the oldClass =&gt; newClass map for realized future classes.</span></span><br><span class="line"><span class="comment">* Returns the oldClass =&gt; nil map for ignored weak-linked classes.</span></span><br><span class="line"><span class="comment">* Locking: runtimeLock must be read- or write-locked by the caller</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line">static objc::DenseMap&lt;Class, Class&gt; *remappedClasses(bool create)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> objc::LazyInitDenseMap&lt;Class, Class&gt; remapped_class_map;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line">    <span class="comment">// start big enough to hold CF's classes and a few others</span></span><br><span class="line">    <span class="keyword">return</span> remapped_class_map.<span class="built_in">get</span>(create, <span class="number">32</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>remap classï¼Œå­—é¢æ„æ€æ˜¯ é‡æ–°æ˜ å°„ classï¼Œé‚£è‚¯å®šæœ‰ä¸€ä¸ªæ˜ å°„è€…å’Œæ˜ å°„ç»“æœã€‚map çš„é”®æ˜¯ clsï¼Œä¹Ÿå°±æ˜¯ section ä¸­æ‹¿åˆ°çš„ clsï¼Œè€Œ value å°±æ˜¯æˆ‘ä»¬ remap çš„ç»“æœ</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Class <span class="title">readClass</span><span class="params">(Class cls, <span class="keyword">bool</span> headerIsBundle, <span class="keyword">bool</span> headerIsPreoptimized)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *mangledName = cls-&gt;nonlazyMangledName();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (missingWeakSuperclass(cls)) &#123;</span><br><span class="line">        <span class="comment">// No superclass (probably weak-linked). </span></span><br><span class="line">        <span class="comment">// Disavow any knowledge of this subclass.</span></span><br><span class="line">        <span class="keyword">if</span> (PrintConnecting) &#123;</span><br><span class="line">            _objc_inform(<span class="string">"CLASS: IGNORING class '%s' with "</span></span><br><span class="line">                         <span class="string">"missing weak-linked superclass"</span>, </span><br><span class="line">                         cls-&gt;nameForLogging());</span><br><span class="line">        &#125;</span><br><span class="line">        addRemappedClass(cls, nil);</span><br><span class="line">        cls-&gt;setSuperclass(nil);</span><br><span class="line">        <span class="keyword">return</span> nil;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    cls-&gt;fixupBackwardDeployingStableSwift();</span><br><span class="line"></span><br><span class="line">    Class replacing = nil;</span><br><span class="line">    <span class="keyword">if</span> (mangledName != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Class newCls = popFutureNamedClass(mangledName)) &#123;</span><br><span class="line">            <span class="comment">// This name was previously allocated as a future class.</span></span><br><span class="line">            <span class="comment">// Copy objc_class to future class's struct.</span></span><br><span class="line">            <span class="comment">// Preserve future's rw data block.</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (newCls-&gt;isAnySwift()) &#123;</span><br><span class="line">                _objc_fatal(<span class="string">"Can't complete future class request for '%s' "</span></span><br><span class="line">                            <span class="string">"because the real class is too big."</span>,</span><br><span class="line">                            cls-&gt;nameForLogging());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">class_rw_t</span> *rw = newCls-&gt;data();</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">class_ro_t</span> *old_ro = rw-&gt;ro();</span><br><span class="line">            <span class="built_in">memcpy</span>(newCls, cls, <span class="keyword">sizeof</span>(objc_class));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Manually set address-discriminated ptrauthed fields</span></span><br><span class="line">            <span class="comment">// so that newCls gets the correct signatures.</span></span><br><span class="line">            newCls-&gt;setSuperclass(cls-&gt;getSuperclass());</span><br><span class="line">            newCls-&gt;initIsa(cls-&gt;getIsa());</span><br><span class="line"></span><br><span class="line">            rw-&gt;set_ro((<span class="keyword">class_ro_t</span> *)newCls-&gt;data());</span><br><span class="line">            newCls-&gt;setData(rw);</span><br><span class="line">            freeIfMutable((<span class="keyword">char</span> *)old_ro-&gt;getName());</span><br><span class="line">            <span class="built_in">free</span>((<span class="keyword">void</span> *)old_ro);</span><br><span class="line"></span><br><span class="line">            addRemappedClass(cls, newCls);</span><br><span class="line"></span><br><span class="line">            replacing = cls;</span><br><span class="line">            cls = newCls;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (headerIsPreoptimized  &amp;&amp;  !replacing) &#123;</span><br><span class="line">        <span class="comment">// class list built in shared cache</span></span><br><span class="line">        <span class="comment">// fixme strict assert doesn't work because of duplicates</span></span><br><span class="line">        <span class="comment">// ASSERT(cls == getClass(name));</span></span><br><span class="line">        ASSERT(mangledName == <span class="literal">nullptr</span> || getClassExceptSomeSwift(mangledName));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mangledName) &#123; <span class="comment">//some Swift generic classes can lazily generate their names</span></span><br><span class="line">            addNamedClass(cls, mangledName, replacing);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Class meta = cls-&gt;ISA();</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">class_ro_t</span> *metaRO = meta-&gt;bits.safe_ro();</span><br><span class="line">            ASSERT(metaRO-&gt;getNonMetaclass() &amp;&amp; <span class="string">"Metaclass with lazy name must have a pointer to the corresponding nonmetaclass."</span>);</span><br><span class="line">            ASSERT(metaRO-&gt;getNonMetaclass() == cls &amp;&amp; <span class="string">"Metaclass nonmetaclass pointer must equal the original class."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        addClassTableEntry(cls);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// for future reference: shared cache never contains MH_BUNDLEs</span></span><br><span class="line">    <span class="keyword">if</span> (headerIsBundle) &#123;</span><br><span class="line">        cls-&gt;data()-&gt;flags |= RO_FROM_BUNDLE;</span><br><span class="line">        cls-&gt;ISA()-&gt;data()-&gt;flags |= RO_FROM_BUNDLE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> cls;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡è¿™ä¸ªå‡½æ•°æˆ‘ä»¬å‘ç°ï¼Œæœ‰ä¸¤ä¸ªåˆ†æ”¯æœ‰æœºä¼šè¿›å…¥æ–¹æ³• addRemappedClassï¼Œä¸€ä¸ªæ˜¯ missingWeakSuperclass æ–¹æ³•æ˜¯å¦ä¸ºçœŸï¼Œå¦å¤–ä¸€ä¸ªæ˜¯ popFutureNamedClass(mangledName) æ–¹æ³•è¿”å›æ˜¯å¦ä¸ºçœŸã€‚è¿™é‡Œä¼šæœ‰ä¸¤ä¸ªæ¦‚å¿µ</p>
<ol>
<li>WeakSuperclass</li>
<li>FutureNamedClass</li>
</ol>
<p>è€Œè¿™ä¸¤ä¸ªæ¡ä»¶ä¸ºtrue çš„æƒ…å†µå°±æ˜¯éœ€è¦ remap çš„æƒ…å†µã€‚</p>
<h3 id="missingWeakSuperclass"><a href="#missingWeakSuperclass" class="headerlink" title="missingWeakSuperclass"></a>missingWeakSuperclass</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* missingWeakSuperclass</span></span><br><span class="line"><span class="comment">* Return YES if some superclass of cls was weak-linked and is missing.</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">bool</span> </span><br><span class="line">missingWeakSuperclass(Class cls)</span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(!cls-&gt;isRealized());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!cls-&gt;getSuperclass()) &#123;</span><br><span class="line">        <span class="comment">// superclass nil. This is normal for root classes only.</span></span><br><span class="line">        <span class="keyword">return</span> (!(cls-&gt;data()-&gt;flags &amp; RO_ROOT));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// superclass not nil. Check if a higher superclass is missing.</span></span><br><span class="line">        Class supercls = remapClass(cls-&gt;getSuperclass());</span><br><span class="line">        ASSERT(cls != cls-&gt;getSuperclass());</span><br><span class="line">        ASSERT(cls != supercls);</span><br><span class="line">        <span class="keyword">if</span> (!supercls) <span class="keyword">return</span> YES;</span><br><span class="line">        <span class="keyword">if</span> (supercls-&gt;isRealized()) <span class="keyword">return</span> NO;</span><br><span class="line">        <span class="keyword">return</span> missingWeakSuperclass(supercls);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»£ç çš„æ³¨é‡Šå·²ç»ä¸€ç›®äº†ç„¶ï¼šè¯¥å‡½æ•°å°±æ˜¯åˆ¤æ–­æŸä¸ª class çš„çˆ¶ç±»æ˜¯å¦æ˜¯ weak-linked å¹¶ä¸”ç¼ºå¤±äº†ã€‚é‚£ ä»€ä¹ˆå«åš weak-linkedï¼Ÿæ¯”å¦‚ NSObject æ˜¯å¦æ˜¯ weak-linbked ï¼Ÿå¾ˆæ˜¾ç„¶ä¸æ˜¯çš„ã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯ weak-linkedï¼Ÿ</p>
<p>weak-linked<br>æˆ‘ä»¬å¼€å‘çš„æ—¶å€™ï¼Œéƒ½ä¼šä½¿ç”¨æœ€æ–°çš„SDKï¼Œä½†æ˜¯ä¸ºäº†è®©è€çš„è®¾å¤‡å¯ä»¥ä¸‹è½½å¹¶è¿è¡Œæˆ‘ä»¬çš„åº”ç”¨ï¼Œå°±è¦å°†Deployment Targetè®¾ç½®æˆä¹‹å‰ç³»ç»Ÿçš„ç‰ˆæœ¬å·ã€‚ä¾‹å¦‚æˆ‘ä»¬åº”ç”¨ä½¿ç”¨iOS 8.1çš„SDKï¼ŒDeployment Targetè®¾ç½®æˆiOS 5.1.1ï¼Œè™½ç„¶æˆ‘ä»¬å¼€å‘çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯8.1çš„SDKï¼Œä½†æ˜¯ç¨‹åºè¿è¡Œåœ¨çš„è®¾å¤‡ä¸­å´å¯èƒ½æ˜¯6.0 or 7.0çš„SDKä¸Šï¼ŒæŒ‰ç…§è‹¹æœçš„è¯´æ³•ï¼Œå¦‚æœæˆ‘ä»¬åº”ç”¨ä½¿ç”¨äº†æœ€æ–°SDKå¼•å…¥çš„ç‰¹æ€§ï¼Œæ¯”å¦‚ç¬¦å·ã€å‡½æ•°ç­‰ï¼Œé‚£ä¹ˆåœ¨ç‰ˆæœ¬è¾ƒæ—§çš„è®¾å¤‡ä¸Šå°±è¿è¡Œä¸äº†ã€‚ä¸‹é¢æ˜¯è‹¹æœå®˜æ–¹æ–‡æ¡£çš„ä¸€æ®µè¯ï¼š<br>Normally, if an application uses a new feature in a framework, it is unable to run on earlier versions of the framework that do not support that feature. Such applications would either fail to launch or crash when an attempt to use the feature was made.<br>é‚£ä¹ˆä¸ºä»€ä¹ˆæˆ‘ä»¬ä½¿ç”¨æœ€æ–°çš„SDKå¼€å‘çš„åº”ç”¨å´å¯ä»¥è¿è¡Œåœ¨æ—§çš„ç³»ç»Ÿä¸­å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä½¿ç”¨äº†å¼±å¼•ç”¨ã€‚èµ„æ–™é‡Œé¢è¯´è¿‡ï¼Œæˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„frameworkï¼Œå¦‚æœéœ€è¦åšç‰ˆæœ¬å…¼å®¹ï¼Œé‚£ä¹ˆå°±è¦å¯¹ä»ŠååŠ å…¥çš„ç¬¦å·ç­‰ä½¿ç”¨å¼±å¼•ç”¨ï¼Œä½¿ç”¨äº†å¼±å¼•ç”¨ä¹‹åï¼Œå³ä½¿åœ¨ç‰ˆæœ¬è¾ƒæ—§çš„ç¯å¢ƒä¸‹è·‘ï¼Œä¹Ÿå¯ä»¥è¿è¡Œï¼Œåªæ˜¯ç›¸åº”çš„ç¬¦å·æ˜¯NULLï¼Œä¸‹é¢å°±æ˜¯æ•™æˆ‘ä»¬æ€æ ·å®šä¹‰å¼±å¼•ç”¨ã€‚æœ‰ä¸€ç‚¹éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œå¦‚æœä¸€ä¸ªframeworkæ²¡æœ‰ä¸ºæ–°åŠ å…¥çš„ç¬¦å·åŠ å…¥å¼±å¼•ç”¨ï¼Œé‚£ä¹Ÿä¸å¿…æ‹…å¿ƒï¼Œæˆ‘ä»¬åªè¦åœ¨é“¾æ¥æ—¶å¼±å¼•ç”¨æ•´ä¸ªframeworkå°±å¥½ï¼Œæ–¹æ³•å°±æ˜¯é“¾æ¥çš„æ—¶å€™ä½¿ç”¨ -weak_framework frameworkName</p>
<p>ä¸€ä¸ªä½¿ç”¨ weak çš„å®ä¾‹ä¸ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">extern int MyWeakLinkedFunction() __attribute__((weak_import));</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">    int result &#x3D; 0;</span><br><span class="line">    if (MyWeakLinkedFunction !&#x3D; NULL)</span><br><span class="line">    &#123;</span><br><span class="line">        result &#x3D; MyWeakLinkedFunction();</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šä»£ç ç‰‡æ®µæ¥è‡ªè‹¹æœå®˜ç½‘ã€‚</p>
<p>è¿™ä¹ˆä¸€æ¥ï¼Œ missingWeakSuperclass çš„ä½œç”¨çš„ä½œç”¨å°±ä¸è¨€è€Œå–»äº†ï¼šæŸ¥çœ‹ cls ç±»çš„ç¥–å®—ç±»ä¸­æ˜¯å¦æœ‰ç±»æ˜¯ weak-linked çš„ï¼Œå¹¶ä¸”å·²ç» missingï¼Œç¥–å®—ç±»é‡Œæœ‰ missing weak-linked çš„ï¼Œåˆ™ cls çš„æ‰€æœ‰ä¿¡æ¯ä¹Ÿæ˜¯ä¸å¯ä¿¡çš„ï¼Œæ‰€ä»¥å°†å…¶æ·»åŠ åˆ°é‡æ˜ å°„è¡¨é‡Œï¼Œæ˜ å°„ä¸ºnilï¼Œå³ cls -&gt; nilã€‚</p>
<h3 id="future-named-class-map"><a href="#future-named-class-map" class="headerlink" title="future_named_class_map"></a>future_named_class_map</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* futureNamedClasses</span></span><br><span class="line"><span class="comment">* Returns the classname =&gt; future class map for unrealized future classes.</span></span><br><span class="line"><span class="comment">* Locking: runtimeLock must be held by the caller</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="keyword">static</span> NXMapTable *future_named_class_map = nil;</span><br><span class="line"><span class="function"><span class="keyword">static</span> NXMapTable *<span class="title">futureNamedClasses</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line">    <span class="keyword">if</span> (future_named_class_map) <span class="keyword">return</span> future_named_class_map;</span><br><span class="line">    <span class="comment">// future_named_class_map is big enough for CF's classes and a few others</span></span><br><span class="line">    future_named_class_map = </span><br><span class="line">        NXCreateMapTable(NXStrValueMapPrototype, <span class="number">32</span>);</span><br><span class="line">    <span class="keyword">return</span> future_named_class_map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢ä»£ç æ˜¯åˆ›å»ºä»£ç ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹ä½¿ç”¨</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Used by CoreFoundation's toll-free bridging.</span></span><br><span class="line"><span class="comment"> * Return the id of the named class.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @return The id of the named class, or an uninitialized class</span></span><br><span class="line"><span class="comment"> *  structure that will be used for the class when and if it does </span></span><br><span class="line"><span class="comment"> *  get loaded.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @warning Do not call this function yourself.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">OBJC_EXPORT Class _Nonnull</span><br><span class="line">objc_getFutureClass(<span class="keyword">const</span> <span class="keyword">char</span> * _Nonnull name) </span><br><span class="line">    OBJC_AVAILABLE(<span class="number">10.5</span>, <span class="number">2.0</span>, <span class="number">9.0</span>, <span class="number">1.0</span>, <span class="number">2.0</span>)</span><br><span class="line">    OBJC_ARC_UNAVAILABLE;</span><br></pre></td></tr></table></figure>

<p>çœ‹æ³¨é‡Šæœ‰ä¸ªè­¦å‘Šï¼Œä¸è¦ä¸»åŠ¨è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚ä¸‹é¢æ˜¯å…·ä½“çš„å®ç°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* objc_getFutureClass.  Return the id of the named class.</span></span><br><span class="line"><span class="comment">* If the class does not exist, return an uninitialized class </span></span><br><span class="line"><span class="comment">* structure that will be used for the class when and if it </span></span><br><span class="line"><span class="comment">* does get loaded.</span></span><br><span class="line"><span class="comment">* Not thread safe. </span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function">Class <span class="title">objc_getFutureClass</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Class cls;</span><br><span class="line">    <span class="comment">// YES unconnected, NO class handler</span></span><br><span class="line">    <span class="comment">// (unconnected is OK because it will someday be the real class)</span></span><br><span class="line">    cls = look_up_class(name, YES, NO);</span><br><span class="line">    <span class="keyword">if</span> (cls) &#123;</span><br><span class="line">        <span class="keyword">if</span> (PrintFuture) &#123;</span><br><span class="line">            _objc_inform(<span class="string">"FUTURE: found %p already in use for %s"</span>, </span><br><span class="line">                         (<span class="keyword">void</span>*)cls, name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cls;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// No class or future class with that name yet. Make one.</span></span><br><span class="line">    <span class="comment">// fixme not thread-safe with respect to </span></span><br><span class="line">    <span class="comment">// simultaneous library load or getFutureClass.</span></span><br><span class="line">    <span class="keyword">return</span> _objc_allocateFutureClass(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­å‡½æ•° look_up_class è¿™é‡Œå…ˆä¸å¤šåšä»‹ç»äº†ï¼Œé‡Œé¢é€»è¾‘è¾ƒå¤šï¼Œè€Œä¸”ä¸æ˜¯è¿™ä¸ªå‡½æ•°çš„é‡ç‚¹ï¼Œé‡ç‚¹æ˜¯æœ€åä¸€å¥ï¼š<code>_objc_allocateFutureClass(name)</code> å®ƒæ‰æ˜¯ä» hash map ä¸­è·å–å¯¹åº”å€¼çš„å‡½æ•°ï¼Œå…¶å®ç°å¦‚ä¸‹ ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* _objc_allocateFutureClass</span></span><br><span class="line"><span class="comment">* Allocate an unresolved future class for the given class name.</span></span><br><span class="line"><span class="comment">* Returns any existing allocation if one was already made.</span></span><br><span class="line"><span class="comment">* Assumes the named class doesn't exist yet.</span></span><br><span class="line"><span class="comment">* Locking: acquires runtimeLock</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line">Class _objc_allocateFutureClass(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">mutex_locker_t</span> <span class="title">lock</span><span class="params">(runtimeLock)</span></span>;</span><br><span class="line">    Class cls;</span><br><span class="line">    NXMapTable *<span class="built_in">map</span> = futureNamedClasses();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((cls = (Class)NXMapGet(<span class="built_in">map</span>, name))) &#123;</span><br><span class="line">        <span class="comment">// Already have a future class for this name.</span></span><br><span class="line">        <span class="keyword">return</span> cls;</span><br><span class="line">    &#125;</span><br><span class="line">    cls = _calloc_class(<span class="keyword">sizeof</span>(objc_class));</span><br><span class="line">    addFutureNamedClass(name, cls);</span><br><span class="line">    <span class="keyword">return</span> cls;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¾ˆå®¹æ˜“ç†è§£ï¼šæœ‰çš„è¯å°±é€šè¿‡æ–¹æ³• NXMapGet å–å‡ºæ¥ï¼Œæ²¡æœ‰çš„è¯åˆ™åˆ›å»ºã€‚</p>
<p>æˆ‘ä»¬å†çœ‹ä¸€ä¸‹ä¸€å‡ºä»£ç </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* popFutureNamedClass</span></span><br><span class="line"><span class="comment">* Removes the named class from the unrealized future class list, </span></span><br><span class="line"><span class="comment">* because it has been realized.</span></span><br><span class="line"><span class="comment">* Returns nil if the name is not used by a future class.</span></span><br><span class="line"><span class="comment">* Locking: runtimeLock must be held by the caller</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> Class <span class="title">popFutureNamedClass</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    Class cls = nil;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (future_named_class_map) &#123;</span><br><span class="line">        cls = (Class)NXMapKeyFreeingRemove(future_named_class_map, name);</span><br><span class="line">        <span class="keyword">if</span> (cls &amp;&amp; NXCountMapTable(future_named_class_map) == <span class="number">0</span>) &#123;</span><br><span class="line">            NXFreeMapTable(future_named_class_map);</span><br><span class="line">            future_named_class_map = nil;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cls;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ–¹æ³•æœ‰ç‚¹ç†Ÿæ‚‰äº†ï¼Œæ­£æ˜¯ä¸Šæ–‡ä»‹ç»çš„ remap çš„æ¡ä»¶ä¹‹ä¸€ã€‚ä¸Šä¸€ç¯‡æ–‡ç« è®²è¿°çš„æ˜¯ç¬¬ä¸€ä¸ªæ¡ä»¶ï¼Œæœ¬æ–‡è®²çš„æ˜¯ç¬¬äºŒä¸ªæ¡ä»¶ã€‚è¿™ä¸¤ä¸ªæ¡ä»¶æ— è®ºå“ªä¸€ä¸ªç¬¦åˆéƒ½ä¼šè°ƒç”¨æ–¹æ³•ï¼šaddRemappedClassï¼Œå³å‘ remapped_class_map ä¸­æ’å…¥æ•°æ®</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>future named class çš„ä»‹ç»å°±åˆ°è¿™é‡Œäº†ï¼Œå¸Œæœ›å¤§å®¶æœ‰æ‰€æ”¶è·ã€‚å…¶å®ç¬”è€…çœ‹æ¥ï¼Œä¸ç®¡æ˜¯ä¸Šä¸€ç¯‡æ–‡ç« çš„ remapped_class_map è¿˜æ˜¯æœ¬æ–‡çš„ future_named_class_map é‡Œé¢çš„æ•°æ®éƒ½æ˜¯ç©ºã€‚remapped_class_map æœ‰æ•°æ®æ˜¯éœ€è¦ä¸€å®šæ¡ä»¶ï¼Œè€Œ future_named_class_map æœ‰æ•°æ®ä¹Ÿæ˜¯éœ€è¦å…ˆ add çš„ï¼Œæ‰€ä»¥å¤§å®¶å¯¹äºè¿™ä¸¤ä¸ª map åªéœ€è¦æœ‰ä¸ªå¤§æ¦‚çš„æ¦‚å¿µå°±å¥½ï¼Œåé¢å¦‚æœçœŸçš„ç¢°åˆ°ä»–ä»¬æœ‰æ•°æ®ï¼Œæˆ‘ä»¬åœ¨è¯¦ç»†åˆ†æã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yujiusheng.com/2021/05/13/iOS%E5%BA%95%E5%B1%82%EF%BC%9A%E6%87%92%E5%8A%A0%E8%BD%BD%E7%B1%BB%E4%B8%8E%E9%9D%9E%E6%87%92%E5%8A%A0%E8%BD%BD%E7%B1%BB-realizeClass%E3%80%81methodizeClass/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="ä¸ªäººæŠ€æœ¯åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jasonçš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/13/iOS%E5%BA%95%E5%B1%82%EF%BC%9A%E6%87%92%E5%8A%A0%E8%BD%BD%E7%B1%BB%E4%B8%8E%E9%9D%9E%E6%87%92%E5%8A%A0%E8%BD%BD%E7%B1%BB-realizeClass%E3%80%81methodizeClass/" class="post-title-link" itemprop="url">iOSåº•å±‚ï¼šæ‡’åŠ è½½ç±»ä¸éæ‡’åŠ è½½ç±» realizeClassã€methodizeClass</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-05-13 09:22:10 / ä¿®æ”¹æ—¶é—´ï¼š13:56:24" itemprop="dateCreated datePublished" datetime="2021-05-13T09:22:10+08:00">2021-05-13</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>æ‡’åŠ è½½ç±»å…¶å®å°±æ˜¯æŒ‡ç±»çš„åŠ è½½åœ¨ç¬¬ä¸€æ¬¡æ¶ˆæ¯å‘é€ä¹‹å‰ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬åœ¨ç±»ä¸­å®ç°äº†+loadæ–¹æ³•ï¼Œé‚£ä¹ˆç±»çš„åŠ è½½å°±ä¼šæå‰åˆ°pre-mainä¹‹å‰,æå‰åŠ è½½çš„ç±»å°±ç§°ä¹‹ä¸ºéæ‡’åŠ è½½ç±»ã€‚</p>
<h3 id="ç±»çš„åŠ è½½"><a href="#ç±»çš„åŠ è½½" class="headerlink" title="ç±»çš„åŠ è½½"></a>ç±»çš„åŠ è½½</h3><p>realizeClassWithoutSwiftæˆ‘ä»¬å…ˆçœ‹å…¶æºç å®ç°ï¼Œå› ä¸ºæˆ‘ä»¬è¿™é‡Œä¸»è¦æ¢ç©¶çš„æ˜¯åŠ è½½ï¼Œå…¶ä¸­åŠ è½½å…·ä½“åšçš„äº‹æƒ…ä¸åšè¿‡å¤šè¯´æ˜ï¼ŒæŠŠéƒ¨åˆ†æºç è¿›è¡Œäº†çœç•¥ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> Class <span class="title">realizeClassWithoutSwift</span><span class="params">(Class cls, Class previously)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line">    <span class="keyword">class_rw_t</span> *rw;<span class="comment">//è¯»å†™åŒºï¼Œè¿è¡ŒæœŸé—´è¿›è¡Œ</span></span><br><span class="line">    Class supercls;</span><br><span class="line">    Class metacls;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!cls) <span class="keyword">return</span> nil;</span><br><span class="line">    <span class="keyword">if</span> (cls-&gt;isRealized()) &#123;</span><br><span class="line">        validateAlreadyRealizedClass(cls);</span><br><span class="line">        <span class="keyword">return</span> cls;</span><br><span class="line">    &#125;</span><br><span class="line">    ASSERT(cls == remapClass(cls));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fixme verify class is not in an un-dlopened part of the shared cache?</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> ro = (<span class="keyword">const</span> <span class="keyword">class_ro_t</span> *)cls-&gt;data();</span><br><span class="line">    <span class="keyword">auto</span> isMeta = ro-&gt;flags &amp; RO_META;</span><br><span class="line">    <span class="keyword">if</span> (ro-&gt;flags &amp; RO_FUTURE) &#123;</span><br><span class="line">        <span class="comment">// This was a future class. rw data is already allocated.</span></span><br><span class="line">        rw = cls-&gt;data();</span><br><span class="line">        ro = cls-&gt;data()-&gt;ro();</span><br><span class="line">        ASSERT(!isMeta);</span><br><span class="line">        cls-&gt;changeInfo(RW_REALIZED|RW_REALIZING, RW_FUTURE);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Normal class. Allocate writeable class data.</span></span><br><span class="line">        rw = objc::zalloc&lt;<span class="keyword">class_rw_t</span>&gt;();</span><br><span class="line">        rw-&gt;set_ro(ro);</span><br><span class="line">        rw-&gt;flags = RW_REALIZED|RW_REALIZING|isMeta;</span><br><span class="line">        cls-&gt;setData(rw);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cls-&gt;cache.initializeToEmptyOrPreoptimizedInDisguise();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> FAST_CACHE_META</span></span><br><span class="line">    <span class="keyword">if</span> (isMeta) cls-&gt;cache.setBit(FAST_CACHE_META);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Choose an index for this class.</span></span><br><span class="line">    <span class="comment">// Sets cls-&gt;instancesRequireRawIsa if indexes no more indexes are available</span></span><br><span class="line">    cls-&gt;chooseClassArrayIndex();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (PrintConnecting) &#123;</span><br><span class="line">        _objc_inform(<span class="string">"CLASS: realizing class '%s'%s %p %p #%u %s%s"</span>,</span><br><span class="line">                     cls-&gt;nameForLogging(), isMeta ? <span class="string">" (meta)"</span> : <span class="string">""</span>, </span><br><span class="line">                     (<span class="keyword">void</span>*)cls, ro, cls-&gt;classArrayIndex(),</span><br><span class="line">                     cls-&gt;isSwiftStable() ? <span class="string">"(swift)"</span> : <span class="string">""</span>,</span><br><span class="line">                     cls-&gt;isSwiftLegacy() ? <span class="string">"(pre-stable swift)"</span> : <span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Realize superclass and metaclass, if they aren't already.</span></span><br><span class="line">    <span class="comment">// This needs to be done after RW_REALIZED is set above, for root classes.</span></span><br><span class="line">    <span class="comment">// This needs to be done after class index is chosen, for root metaclasses.</span></span><br><span class="line">    <span class="comment">// This assumes that none of those classes have Swift contents,</span></span><br><span class="line">    <span class="comment">//   or that Swift's initializers have already been called.</span></span><br><span class="line">    <span class="comment">//   fixme that assumption will be wrong if we add support</span></span><br><span class="line">    <span class="comment">//   for ObjC subclasses of Swift classes.</span></span><br><span class="line">  	<span class="comment">//çˆ¶ç±»åŠ è½½</span></span><br><span class="line">    supercls = realizeClassWithoutSwift(remapClass(cls-&gt;getSuperclass()), nil);</span><br><span class="line">  	<span class="comment">//å…ƒç±»ä¹ŸåŠ è½½äº†</span></span><br><span class="line">    metacls = realizeClassWithoutSwift(remapClass(cls-&gt;ISA()), nil);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> SUPPORT_NONPOINTER_ISA</span></span><br><span class="line">    <span class="keyword">if</span> (isMeta) &#123;</span><br><span class="line">        <span class="comment">// Metaclasses do not need any features from non pointer ISA</span></span><br><span class="line">        <span class="comment">// This allows for a faspath for classes in objc_retain/objc_release.</span></span><br><span class="line">        cls-&gt;setInstancesRequireRawIsa();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Disable non-pointer isa for some classes and/or platforms.</span></span><br><span class="line">        <span class="comment">// Set instancesRequireRawIsa.</span></span><br><span class="line">        <span class="keyword">bool</span> instancesRequireRawIsa = cls-&gt;instancesRequireRawIsa();</span><br><span class="line">        <span class="keyword">bool</span> rawIsaIsInherited = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">bool</span> hackedDispatch = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DisableNonpointerIsa) &#123;</span><br><span class="line">            <span class="comment">// Non-pointer isa disabled by environment or app SDK version</span></span><br><span class="line">            instancesRequireRawIsa = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!hackedDispatch  &amp;&amp;  <span class="number">0</span> == <span class="built_in">strcmp</span>(ro-&gt;getName(), <span class="string">"OS_object"</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// hack for libdispatch et al - isa also acts as vtable pointer</span></span><br><span class="line">            hackedDispatch = <span class="literal">true</span>;</span><br><span class="line">            instancesRequireRawIsa = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (supercls  &amp;&amp;  supercls-&gt;getSuperclass()  &amp;&amp;</span><br><span class="line">                 supercls-&gt;instancesRequireRawIsa())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// This is also propagated by addSubclass()</span></span><br><span class="line">            <span class="comment">// but nonpointer isa setup needs it earlier.</span></span><br><span class="line">            <span class="comment">// Special case: instancesRequireRawIsa does not propagate</span></span><br><span class="line">            <span class="comment">// from root class to root metaclass</span></span><br><span class="line">            instancesRequireRawIsa = <span class="literal">true</span>;</span><br><span class="line">            rawIsaIsInherited = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (instancesRequireRawIsa) &#123;</span><br><span class="line">            cls-&gt;setInstancesRequireRawIsaRecursively(rawIsaIsInherited);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// SUPPORT_NONPOINTER_ISA</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update superclass and metaclass in case of remapping</span></span><br><span class="line">    cls-&gt;setSuperclass(supercls);</span><br><span class="line">    cls-&gt;initClassIsa(metacls);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reconcile instance variable offsets / layout.</span></span><br><span class="line">    <span class="comment">// This may reallocate class_ro_t, updating our ro variable.</span></span><br><span class="line">    <span class="keyword">if</span> (supercls  &amp;&amp;  !isMeta) reconcileInstanceVariables(cls, supercls, ro);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set fastInstanceSize if it wasn't set already.</span></span><br><span class="line">    cls-&gt;setInstanceSize(ro-&gt;instanceSize);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Copy some flags from ro to rw</span></span><br><span class="line">    <span class="keyword">if</span> (ro-&gt;flags &amp; RO_HAS_CXX_STRUCTORS) &#123;</span><br><span class="line">        cls-&gt;setHasCxxDtor();</span><br><span class="line">        <span class="keyword">if</span> (! (ro-&gt;flags &amp; RO_HAS_CXX_DTOR_ONLY)) &#123;</span><br><span class="line">            cls-&gt;setHasCxxCtor();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Propagate the associated objects forbidden flag from ro or from</span></span><br><span class="line">    <span class="comment">// the superclass.</span></span><br><span class="line">    <span class="keyword">if</span> ((ro-&gt;flags &amp; RO_FORBIDS_ASSOCIATED_OBJECTS) ||</span><br><span class="line">        (supercls &amp;&amp; supercls-&gt;forbidsAssociatedObjects()))</span><br><span class="line">    &#123;</span><br><span class="line">        rw-&gt;flags |= RW_FORBIDS_ASSOCIATED_OBJECTS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Connect this class to its superclass's subclass lists</span></span><br><span class="line">    <span class="keyword">if</span> (supercls) &#123;</span><br><span class="line">        addSubclass(supercls, cls);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        addRootClass(cls);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Attach categories</span></span><br><span class="line">    methodizeClass(cls, previously);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cls;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="methodizeClass"><a href="#methodizeClass" class="headerlink" title="methodizeClass"></a>methodizeClass</h4><p>å…³æ³¨åˆ°<code>methodizeClass(cls,previously)</code>æ–¹æ³•ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">methodizeClass</span><span class="params">(Class cls, Class previously)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> isMeta = cls-&gt;isMetaClass();</span><br><span class="line">    <span class="keyword">auto</span> rw = cls-&gt;data();</span><br><span class="line">    <span class="keyword">auto</span> ro = rw-&gt;ro();</span><br><span class="line">    <span class="keyword">auto</span> rwe = rw-&gt;ext();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Methodizing for the first time</span></span><br><span class="line">    <span class="keyword">if</span> (PrintConnecting) &#123;</span><br><span class="line">        _objc_inform(<span class="string">"CLASS: methodizing class '%s' %s"</span>, </span><br><span class="line">                     cls-&gt;nameForLogging(), isMeta ? <span class="string">"(meta)"</span> : <span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Install methods and properties that the class implements itself.</span></span><br><span class="line">  	<span class="comment">// æ–¹æ³•åˆ—è¡¨ </span></span><br><span class="line">    <span class="keyword">method_list_t</span> *<span class="built_in">list</span> = ro-&gt;baseMethods();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">list</span>) &#123;</span><br><span class="line">        prepareMethodLists(cls, &amp;<span class="built_in">list</span>, <span class="number">1</span>, YES, isBundleClass(cls), <span class="literal">nullptr</span>);</span><br><span class="line">        <span class="keyword">if</span> (rwe) rwe-&gt;methods.attachLists(&amp;<span class="built_in">list</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// å±æ€§åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">property_list_t</span> *proplist = ro-&gt;baseProperties;</span><br><span class="line">    <span class="keyword">if</span> (rwe &amp;&amp; proplist) &#123;</span><br><span class="line">        rwe-&gt;properties.attachLists(&amp;proplist, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// åè®®åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">protocol_list_t</span> *protolist = ro-&gt;baseProtocols;</span><br><span class="line">    <span class="keyword">if</span> (rwe &amp;&amp; protolist) &#123;</span><br><span class="line">        rwe-&gt;protocols.attachLists(&amp;protolist, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Root classes get bonus method implementations if they don't have </span></span><br><span class="line">    <span class="comment">// them already. These apply before category replacements.</span></span><br><span class="line">    <span class="keyword">if</span> (cls-&gt;isRootMetaclass()) &#123;</span><br><span class="line">        <span class="comment">// root metaclass</span></span><br><span class="line">        addMethod(cls, @selector(initialize), (IMP)&amp;objc_noop_imp, <span class="string">""</span>, NO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Attach categories.</span></span><br><span class="line">    <span class="keyword">if</span> (previously) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isMeta) &#123;</span><br><span class="line">            objc::unattachedCategories.attachToClass(cls, previously,</span><br><span class="line">                                                     ATTACH_METACLASS);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// When a class relocates, categories with class methods</span></span><br><span class="line">            <span class="comment">// may be registered on the class itself rather than on</span></span><br><span class="line">            <span class="comment">// the metaclass. Tell attachToClass to look for those.</span></span><br><span class="line">            objc::unattachedCategories.attachToClass(cls, previously,</span><br><span class="line">                                                     ATTACH_CLASS_AND_METACLASS);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    objc::unattachedCategories.attachToClass(cls, cls,</span><br><span class="line">                                             isMeta ? ATTACH_METACLASS : ATTACH_CLASS);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DEBUG</span></span><br><span class="line">    <span class="comment">// Debug: sanity-check all SELs; log method list contents</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; meth : rw-&gt;methods()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (PrintConnecting) &#123;</span><br><span class="line">            _objc_inform(<span class="string">"METHOD %c[%s %s]"</span>, isMeta ? <span class="string">'+'</span> : <span class="string">'-'</span>, </span><br><span class="line">                         cls-&gt;nameForLogging(), sel_getName(meth.name()));</span><br><span class="line">        &#125;</span><br><span class="line">        ASSERT(sel_registerName(sel_getName(meth.name())) == meth.name());</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±æ­¤å¯å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š</p>
<ul>
<li>è™½ç„¶å®ç°ç±»è°ƒç”¨çš„<code>methodizeClass</code>-&gt;<code>attachToClass</code>åæ²¡è°ƒç”¨<code>attachCategories</code>æ–¹æ³•ï¼Œä½†æ˜¯<code>load_images</code>-&gt;<code>loadAllCategories</code>åä¼šè°ƒç”¨<code>attachCategories</code>æ–¹æ³•ã€‚</li>
<li><code>attachCategories</code>æ–¹æ³•ä¸­è¿›è¡Œäº†<code>rwe</code>åˆå§‹åŒ–ã€‚</li>
</ul>
<p>æ ¹æ®æ–¹æ³•çš„æ³¨é‡Šæˆ‘ä»¬å¯ä»¥è§£è¯»å‡ºä»¥ä¸‹ä¿¡æ¯ï¼š</p>
<ul>
<li>å¯¹ç±»clsæ‰§è¡Œé¦–æ¬¡åˆå§‹åŒ–</li>
<li>åŒ…æ‹¬åˆ†é…è¯»å†™æ•°æ®ã€‚</li>
<li>ä¸æ‰§è¡Œä»»ä½•Swiftä¾§åˆå§‹åŒ–ã€‚</li>
<li>è¿”å›ç±»çš„å®é™…ç±»ç»“æ„ã€‚</li>
<li>é”å®š:runtimeLockå¿…é¡»ç”±è°ƒç”¨è€…å†™é”</li>
</ul>
<p>å¯¹æ–¹æ³•çš„å®ç°çš„ä¸€äº›æ¦‚å¿µè¿›è¡Œè§£è¯»<br> roï¼šå¹²å‡€å†…å­˜(Clean Memory),å­˜æ”¾çš„æ˜¯ç±»çš„åŸå§‹æ•°æ®<br> rwï¼šè„å†…å­˜(Dirty Memory) ï¼Œè¿è¡Œæ—¶ä¼šå¯¹ç±»å†…å­˜è¿›è¡ŒåŠ¨æ€çš„ä¿®æ”¹æ‰€ä»¥æ‰æœ‰rwï¼Œrwæœ€åˆæ˜¯ä»roä¸­è¯»å–çš„æ•°æ®ã€‚<br> rweï¼šæ–°å¢å†…å®¹ï¼Œè¿è¡Œæ—¶åŠ¨æ€ä¿®æ”¹ç±»æ‰ä¼šç”Ÿæˆrweï¼Œrweçš„åŸå§‹æ•°æ®æ˜¯ä»rwä¸­è¯»å–çš„ã€‚<br> supercls = realizeClassWithoutSwift(remapClass(cls-&gt;superclass), nil);æ²¿ç€ç»§æ‰¿é“¾é€’å½’è°ƒç”¨realizeClassWithoutSwiftã€‚<br> metacls = realizeClassWithoutSwift(remapClass(cls-&gt;ISA()), nil);æ²¿ç€isaèµ°ä½é€’å½’è°ƒç”¨realizeClassWithoutSwiftã€‚<br> æ‰€ä»¥å¦‚æœä¸€ä¸ªç±»åŠ è½½äº†ï¼Œå…¶ç»§æ‰¿é“¾ä¸Šçš„çˆ¶ç±»ã€isaå¯¹åº”çš„å…ƒç±»ç­‰éƒ½ä¼šåŠ è½½ã€‚</p>
<h3 id="æ‡’åŠ è½½ç±»"><a href="#æ‡’åŠ è½½ç±»" class="headerlink" title="æ‡’åŠ è½½ç±»"></a>æ‡’åŠ è½½ç±»</h3><p>æˆ‘ä»¬å®ç°äº†+loadæ–¹æ³•ç±»çš„åŠ è½½å°±ä¼šæå‰ï¼Œ+loadæ˜¯å¦‚ä½•å½±å“ç±»çš„åŠ è½½çš„æ—¶æœºçš„å‘¢ï¼Ÿ<br> load_imagesæºç ä¸­æœ‰è¯´æ˜åœ¨dyldæ˜ å°„çš„é•œåƒä¸­å¤„ç†+loadï¼Œæˆ‘ä»¬éœ€è¦å»çœ‹çœ‹load_imagesä¸­æ˜¯å¦‚ä½•å¤„ç†+loadæ–¹æ³•çš„ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">load_images(<span class="keyword">const</span> <span class="keyword">char</span> *path __unused, <span class="keyword">const</span> struct mach_header *mh)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!didInitialAttachCategories &amp;&amp; didCallDyldNotifyRegister) &#123;</span><br><span class="line">        didInitialAttachCategories = <span class="literal">true</span>;</span><br><span class="line">        loadAllCategories();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return without taking locks if there are no +load methods here.</span></span><br><span class="line">  	<span class="comment">//å¦‚æœæ²¡æœ‰+loadæ–¹æ³• åˆ™è¿”å› ä¸å¸¦é”</span></span><br><span class="line">    <span class="keyword">if</span> (!hasLoadMethods((<span class="keyword">const</span> headerType *)mh)) <span class="keyword">return</span>;</span><br><span class="line">		<span class="comment">//åŠ é€’å½’é”</span></span><br><span class="line">    <span class="function"><span class="keyword">recursive_mutex_locker_t</span> <span class="title">lock</span><span class="params">(loadMethodLock)</span></span>;</span><br><span class="line">    <span class="comment">// Discover load methods</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">mutex_locker_t</span> <span class="title">lock2</span><span class="params">(runtimeLock)</span></span>;</span><br><span class="line">        prepare_load_methods((<span class="keyword">const</span> headerType *)mh);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Call +load methods (without runtimeLock - re-entrant)</span></span><br><span class="line">    call_load_methods();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>hasLoadMethods:</code>åˆ¤æ–­çš„æ¡ä»¶æœ‰ä¸¤ä¸ªï¼š</p>
<ul>
<li>_getObjc2NonlazyClassList:è·å–æ‰€æœ‰ç±»ä¸­çš„Loadæ–¹æ³•æ•°é‡</li>
<li>_getObjc2NonlazyCategoryList:è·å–æ‰€æœ‰åˆ†ç±»ä¸­çš„Loadæ–¹æ³•æ•°é‡</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Quick scan for +load methods that doesn't take a lock.</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">hasLoadMethods</span><span class="params">(<span class="keyword">const</span> headerType *mhdr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> count;</span><br><span class="line">    <span class="keyword">if</span> (_getObjc2NonlazyClassList(mhdr, &amp;count)  &amp;&amp;  count &gt; <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (_getObjc2NonlazyCategoryList(mhdr, &amp;count)  &amp;&amp;  count &gt; <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœå­˜åœ¨<code>+load</code>æ–¹æ³•ï¼Œåé¢åŠ é”åå¼€å§‹è¿›å…¥<code>prepare_load_methods</code>å‡½æ•°ï¼Œå®ƒçš„ä½œç”¨æ˜¯å‘ç°æ‰€æœ‰çš„<code>+load</code>æ–¹æ³•ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_load_methods</span><span class="params">(<span class="keyword">const</span> headerType *mhdr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> count, i;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line">		<span class="comment">//è·å–éæ‡’åŠ è½½ç±»</span></span><br><span class="line">    <span class="keyword">classref_t</span> <span class="keyword">const</span> *classlist = </span><br><span class="line">        _getObjc2NonlazyClassList(mhdr, &amp;count);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        <span class="comment">//å¾ªç¯éå†åŠ è½½éæ‡’åŠ è½½ç±»çš„loadæ–¹æ³•åˆ°loadable_classes</span></span><br><span class="line">        schedule_class_load(remapClass(classlist[i]));</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">//è·å–éæ‡’åŠ è½½åˆ†ç±»åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">category_t</span> * <span class="keyword">const</span> *categorylist = _getObjc2NonlazyCategoryList(mhdr, &amp;count);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        <span class="keyword">category_t</span> *cat = categorylist[i];</span><br><span class="line">        Class cls = remapClass(cat-&gt;cls);</span><br><span class="line">        <span class="keyword">if</span> (!cls) <span class="keyword">continue</span>;  <span class="comment">// category for ignored weak-linked class</span></span><br><span class="line">        <span class="keyword">if</span> (cls-&gt;isSwiftStable()) &#123;</span><br><span class="line">            _objc_fatal(<span class="string">"Swift class extensions and categories on Swift "</span></span><br><span class="line">                        <span class="string">"classes are not allowed to have +load methods"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœç±»æ²¡æœ‰åˆå§‹åŒ–å°±å»åˆå§‹åŒ–</span></span><br><span class="line">        realizeClassWithoutSwift(cls, nil);</span><br><span class="line">        ASSERT(cls-&gt;ISA()-&gt;isRealized());</span><br><span class="line">        add_category_to_loadable_list(cat);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>prepare_load_methodsä¸­åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š<br> 1.è·å–éæ‡’åŠ è½½ç±»åˆ—è¡¨ï¼ŒçŒœæµ‹è¿™é‡Œåº”è¯¥å·²ç»åŠ è½½äº†å¯¹åº”çš„ç±»ï¼Œå¾ªç¯éå†åŠ è½½éæ‡’åŠ è½½ç±»çš„loadæ–¹æ³•åˆ°loadable_classes.å…¶ä¸­å…³é”®çš„æ–¹æ³•schedule_class_loadã€add_class_to_loadable_listã€‚<br> 2.è·å–éæ‡’åŠ è½½åˆ†ç±»åˆ—è¡¨ï¼Œå¾ªç¯éå†å»åŠ è½½éæ‡’åŠ è½½åˆ†ç±»çš„ load æ–¹æ³•åˆ° loadable_categoriesã€‚<br> å…¶ä¸­å…³é”®çš„æ–¹æ³•add_category_to_loadable_listã€‚<br> éæ‡’åŠ è½½åˆ†ç±»éå†æ—¶ï¼Œæœ‰ä¸€ä¸ªå¤„ç†realizeClassWithoutSwift(cls, nil)ï¼Œåœ¨éå†åŠ è½½éæ‡’åŠ è½½ç±»çš„loadæ–¹æ³•æ—¶ï¼Œä¼šè°ƒç”¨realizeClassWithoutSwiftï¼Œå¦‚æœåˆ†ç±»å¯¹åº”çš„ç±»æ²¡æœ‰è®°è½½ï¼Œåœ¨è¿™é‡Œå°±ä¼šè¢«åŠ è½½ã€‚</p>
<h3 id="æ‡’åŠ è½½ç±»-1"><a href="#æ‡’åŠ è½½ç±»-1" class="headerlink" title="æ‡’åŠ è½½ç±»"></a>æ‡’åŠ è½½ç±»</h3><p>å¯¹äºæ‡’åŠ è½½ç±»ï¼Œæ˜¯åœ¨ç¬¬ä¸€æ¬¡æ¶ˆæ¯å‘é€<code>objc_msgSend</code>,è°ƒç”¨<code>lookUpImpOrForward</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">NEVER_INLINE</span><br><span class="line"><span class="function">IMP <span class="title">lookUpImpOrForward</span><span class="params">(id inst, SEL sel, Class cls, <span class="keyword">int</span> behavior)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> IMP forward_imp = (IMP)_objc_msgForward_impcache;</span><br><span class="line">    IMP imp = nil;</span><br><span class="line">    Class curClass;</span><br><span class="line">    runtimeLock.assertUnlocked();</span><br><span class="line">    <span class="keyword">if</span> (slowpath(!cls-&gt;isInitialized())) &#123;</span><br><span class="line">        <span class="comment">// The first message sent to a class is often +new or +alloc, or +self</span></span><br><span class="line">        <span class="comment">// which goes through objc_opt_* or various optimized entry points.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// However, the class isn't realized/initialized yet at this point,</span></span><br><span class="line">        <span class="comment">// and the optimized entry points fall down through objc_msgSend,</span></span><br><span class="line">        <span class="comment">// which ends up here.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// We really want to avoid caching these, as it can cause IMP caches</span></span><br><span class="line">        <span class="comment">// to be made with a single entry forever.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Note that this check is racy as several threads might try to</span></span><br><span class="line">        <span class="comment">// message a given class for the first time at the same time,</span></span><br><span class="line">        <span class="comment">// in which case we might cache anyway.</span></span><br><span class="line">        behavior |= LOOKUP_NOCACHE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// runtimeLock is held during isRealized and isInitialized checking</span></span><br><span class="line">    <span class="comment">// to prevent races against concurrent realization.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// runtimeLock is held during method search to make</span></span><br><span class="line">    <span class="comment">// method-lookup + cache-fill atomic with respect to method addition.</span></span><br><span class="line">    <span class="comment">// Otherwise, a category could be added but ignored indefinitely because</span></span><br><span class="line">    <span class="comment">// the cache was re-filled with the old value after the cache flush on</span></span><br><span class="line">    <span class="comment">// behalf of the category.</span></span><br><span class="line"></span><br><span class="line">    runtimeLock.lock();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We don't want people to be able to craft a binary blob that looks like</span></span><br><span class="line">    <span class="comment">// a class but really isn't one and do a CFI attack.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// To make these harder we want to make sure this is a class that was</span></span><br><span class="line">    <span class="comment">// either built into the binary or legitimately registered through</span></span><br><span class="line">    <span class="comment">// objc_duplicateClass, objc_initializeClassPair or objc_allocateClassPair.</span></span><br><span class="line">    checkIsKnownClass(cls);</span><br><span class="line">		<span class="comment">//å…³æ³¨è¿™é‡Œ</span></span><br><span class="line">    cls = realizeAndInitializeIfNeeded_locked(inst, cls, behavior &amp; LOOKUP_INITIALIZE);</span><br><span class="line">    <span class="comment">// runtimeLock may have been dropped but is now locked again</span></span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line">    curClass = cls;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The code used to lookup the class's cache again right after</span></span><br><span class="line">    <span class="comment">// we take the lock but for the vast majority of the cases</span></span><br><span class="line">    <span class="comment">// evidence shows this is a miss most of the time, hence a time loss.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// The only codepath calling into this without having performed some</span></span><br><span class="line">    <span class="comment">// kind of cache lookup is class_getInstanceMethod().</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">unsigned</span> attempts = unreasonableClassCount();;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (curClass-&gt;cache.isConstantOptimizedCache(<span class="comment">/* strict */</span><span class="literal">true</span>)) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> CONFIG_USE_PREOPT_CACHES</span></span><br><span class="line">            imp = cache_getImp(curClass, sel);</span><br><span class="line">            <span class="keyword">if</span> (imp) <span class="keyword">goto</span> done_unlock;</span><br><span class="line">            curClass = curClass-&gt;cache.preoptFallbackClass();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// curClass method list.</span></span><br><span class="line">            Method meth = getMethodNoSuper_nolock(curClass, sel);</span><br><span class="line">            <span class="keyword">if</span> (meth) &#123;</span><br><span class="line">                imp = meth-&gt;imp(<span class="literal">false</span>);</span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (slowpath((curClass = curClass-&gt;getSuperclass()) == nil)) &#123;</span><br><span class="line">                <span class="comment">// No implementation found, and method resolver didn't help.</span></span><br><span class="line">                <span class="comment">// Use forwarding.</span></span><br><span class="line">                imp = forward_imp;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Halt if there is a cycle in the superclass chain.</span></span><br><span class="line">        <span class="keyword">if</span> (slowpath(--attempts == <span class="number">0</span>)) &#123;</span><br><span class="line">            _objc_fatal(<span class="string">"Memory corruption in class list."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Superclass cache.</span></span><br><span class="line">        imp = cache_getImp(curClass, sel);</span><br><span class="line">        <span class="keyword">if</span> (slowpath(imp == forward_imp)) &#123;</span><br><span class="line">            <span class="comment">// Found a forward:: entry in a superclass.</span></span><br><span class="line">            <span class="comment">// Stop searching, but don't cache yet; call method</span></span><br><span class="line">            <span class="comment">// resolver for this class first.</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (fastpath(imp)) &#123;</span><br><span class="line">            <span class="comment">// Found the method in a superclass. Cache it in this class.</span></span><br><span class="line">            <span class="keyword">goto</span> done;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// No implementation found. Try method resolver once.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (slowpath(behavior &amp; LOOKUP_RESOLVER)) &#123;</span><br><span class="line">        behavior ^= LOOKUP_RESOLVER;</span><br><span class="line">        <span class="keyword">return</span> resolveMethod_locked(inst, sel, cls, behavior);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> done:</span><br><span class="line">    <span class="keyword">if</span> (fastpath((behavior &amp; LOOKUP_NOCACHE) == <span class="number">0</span>)) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> CONFIG_USE_PREOPT_CACHES</span></span><br><span class="line">        <span class="keyword">while</span> (cls-&gt;cache.isConstantOptimizedCache(<span class="comment">/* strict */</span><span class="literal">true</span>)) &#123;</span><br><span class="line">            cls = cls-&gt;cache.preoptFallbackClass();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        log_and_fill_cache(cls, imp, sel, inst, curClass);</span><br><span class="line">    &#125;</span><br><span class="line"> done_unlock:</span><br><span class="line">    runtimeLock.unlock();</span><br><span class="line">    <span class="keyword">if</span> (slowpath((behavior &amp; LOOKUP_NIL) &amp;&amp; imp == forward_imp)) &#123;</span><br><span class="line">        <span class="keyword">return</span> nil;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> imp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Class</span><br><span class="line">realizeAndInitializeIfNeeded_locked(id inst, Class cls, <span class="keyword">bool</span> initialize)</span><br><span class="line">&#123;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line">    <span class="keyword">if</span> (slowpath(!cls-&gt;isRealized())) &#123;</span><br><span class="line">        cls = realizeClassMaybeSwiftAndLeaveLocked(cls, runtimeLock);</span><br><span class="line">        <span class="comment">// runtimeLock may have been dropped but is now locked again</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (slowpath(initialize &amp;&amp; !cls-&gt;isInitialized())) &#123;</span><br><span class="line">        cls = initializeAndLeaveLocked(cls, inst, runtimeLock);</span><br><span class="line">        <span class="comment">// runtimeLock may have been dropped but is now locked again</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// If sel == initialize, class_initialize will send +initialize and</span></span><br><span class="line">        <span class="comment">// then the messenger will send +initialize again after this</span></span><br><span class="line">        <span class="comment">// procedure finishes. Of course, if this is not being called</span></span><br><span class="line">        <span class="comment">// from the messenger then it won't happen. 2778172</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cls;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> Class</span><br><span class="line">realizeClassMaybeSwiftAndLeaveLocked(Class cls, <span class="keyword">mutex_t</span>&amp; lock)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> realizeClassMaybeSwiftMaybeRelock(cls, lock, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> Class</span><br><span class="line">realizeClassMaybeSwiftMaybeRelock(Class cls, <span class="keyword">mutex_t</span>&amp; lock, <span class="keyword">bool</span> leaveLocked)</span><br><span class="line">&#123;</span><br><span class="line">    lock.assertLocked();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!cls-&gt;isSwiftStable_ButAllowLegacyForNow()) &#123;</span><br><span class="line">        <span class="comment">// Non-Swift class. Realize it now with the lock still held.</span></span><br><span class="line">        <span class="comment">// fixme wrong in the future for objc subclasses of swift classes</span></span><br><span class="line">        realizeClassWithoutSwift(cls, nil);</span><br><span class="line">        <span class="keyword">if</span> (!leaveLocked) lock.unlock();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Swift class. We need to drop locks and call the Swift</span></span><br><span class="line">        <span class="comment">// runtime to initialize it.</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">        cls = realizeSwiftClass(cls);</span><br><span class="line">        ASSERT(cls-&gt;isRealized());    <span class="comment">// callback must have provoked realization</span></span><br><span class="line">        <span class="keyword">if</span> (leaveLocked) lock.lock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cls;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥æ¸…æ™°çš„çœ‹åˆ°lookUpImpOrForwardä¸­ä¹Ÿä¼šè°ƒç”¨åˆ°realizeClassWithoutSwiftï¼Œå¯¹ç±»è¿›è¡ŒåŠ è½½ã€‚</p>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>æ‡’åŠ è½½ç±»æƒ…å†µ  ç±»åŠ è½½å»¶è¿Ÿåˆ°ç¬¬ä¸€æ¬¡æ¶ˆæ¯å‘é€ã€‚<br> lookUpImOrForward<br> realizeClassMaybeSwiftMaybeRelock<br> relizeClassWithoutSwift<br> methodizeClass</p>
<p>éæ‡’è®°è½½ç±»è°ƒç”¨äº†+loadæ–¹æ³•ï¼Œç±»å°±ä¼šæå‰åŠ è½½ã€‚<br> getObjc2NonlazyClassList<br> readClass<br> realizeClassWithoutSwift<br> methodizeClass</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yujiusheng.com/2021/05/12/iOS%E5%BA%95%E5%B1%82%EF%BC%9Acache_t/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="ä¸ªäººæŠ€æœ¯åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jasonçš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/12/iOS%E5%BA%95%E5%B1%82%EF%BC%9Acache_t/" class="post-title-link" itemprop="url">iOSåº•å±‚ï¼šcache_t</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-05-12 13:55:04 / ä¿®æ”¹æ—¶é—´ï¼š17:03:51" itemprop="dateCreated datePublished" datetime="2021-05-12T13:55:04+08:00">2021-05-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>å‰æ–‡æˆ‘ä»¬æ¢ç´¢äº†iOSç±»çš„åº•å±‚åŸç†ï¼Œç®€å•äº†è§£äº†å››ä¸ªé‡è¦çš„å±æ€§ã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦æ¢ç´¢ç¬¬ä¸‰ä¸ªå±æ€§<code>cache_t</code>ï¼Œå¯¹äºè¿™ä¸ªå±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å­¦ä¹ åˆ°è‹¹æœå¯¹äºç¼“å­˜çš„è®¾è®¡å’Œç†è§£ã€‚</p>
<h3 id="æ¢ç´¢cache-t"><a href="#æ¢ç´¢cache-t" class="headerlink" title="æ¢ç´¢cache_t"></a>æ¢ç´¢<code>cache_t</code></h3><p>ä»æ•°æ®ç»“æ„å¼€å§‹</p>
<h4 id="cache-tçš„åŸºæœ¬ç»“æ„"><a href="#cache-tçš„åŸºæœ¬ç»“æ„" class="headerlink" title="cache_tçš„åŸºæœ¬ç»“æ„"></a><code>cache_t</code>çš„åŸºæœ¬ç»“æ„</h4><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹æºç ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cache_t</span> &#123;</span></span><br><span class="line"><span class="comment">//çœç•¥ä»£ç </span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// The following four fields are public for objcdt's use only.</span></span><br><span class="line">    <span class="comment">// objcdt reaches into fields while the process is suspended</span></span><br><span class="line">    <span class="comment">// hence doesn't care for locks and pesky little details like this</span></span><br><span class="line">    <span class="comment">// and can safely use these.</span></span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="title">capacity</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function">struct <span class="keyword">bucket_t</span> *<span class="title">buckets</span><span class="params">()</span> <span class="keyword">const</span></span>;<span class="comment">//é‡ç‚¹</span></span><br><span class="line">    <span class="function">Class <span class="title">cls</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> CONFIG_USE_PREOPT_CACHES</span></span><br><span class="line">    <span class="function"><span class="keyword">const</span> <span class="keyword">preopt_cache_t</span> *<span class="title">preopt_cache</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">mask_t</span> <span class="title">occupied</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">initializeToEmpty</span><span class="params">()</span></span>;</span><br><span class="line"> <span class="comment">//çœç•¥ä»£ç </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‘ç°æœ‰ä¸€ä¸ª<code>buckets()</code>æˆå‘˜ï¼Œå®ƒæ˜¯ä¸€ä¸ªç»“æ„ä½“<code>bucket_t</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bucket_t</span> &#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// IMP-first is better for arm64e ptrauth and no worse for arm64.</span></span><br><span class="line">    <span class="comment">// SEL-first is better for armv7* and i386 and x86_64.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __arm64__</span></span><br><span class="line">    explicit_atomic&lt;<span class="keyword">uintptr_t</span>&gt; _imp;</span><br><span class="line">    explicit_atomic&lt;SEL&gt; _sel;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    explicit_atomic&lt;SEL&gt; _sel;</span><br><span class="line">    explicit_atomic&lt;<span class="keyword">uintptr_t</span>&gt; _imp;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// Compute the ptrauth signing modifier from &amp;_imp, newSel, and cls.</span></span><br><span class="line">    <span class="function"><span class="keyword">uintptr_t</span> <span class="title">modifierForSEL</span><span class="params">(<span class="keyword">bucket_t</span> *base, SEL newSel, Class cls)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">uintptr_t</span>)base ^ (<span class="keyword">uintptr_t</span>)newSel ^ (<span class="keyword">uintptr_t</span>)cls;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Sign newImp, with &amp;_imp, newSel, and cls as modifiers.</span></span><br><span class="line">    <span class="function"><span class="keyword">uintptr_t</span> <span class="title">encodeImp</span><span class="params">(UNUSED_WITHOUT_PTRAUTH <span class="keyword">bucket_t</span> *base, IMP newImp, UNUSED_WITHOUT_PTRAUTH SEL newSel, Class cls)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!newImp) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> CACHE_IMP_ENCODING == CACHE_IMP_ENCODING_PTRAUTH</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">uintptr_t</span>)</span><br><span class="line">            ptrauth_auth_and_resign(newImp,</span><br><span class="line">                                    ptrauth_key_function_pointer, <span class="number">0</span>,</span><br><span class="line">                                    ptrauth_key_process_dependent_code,</span><br><span class="line">                                    modifierForSEL(base, newSel, cls));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> CACHE_IMP_ENCODING == CACHE_IMP_ENCODING_ISA_XOR</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">uintptr_t</span>)newImp ^ (<span class="keyword">uintptr_t</span>)cls;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> CACHE_IMP_ENCODING == CACHE_IMP_ENCODING_NONE</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">uintptr_t</span>)newImp;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">error</span> Unknown method cache IMP encoding.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">size_t</span> <span class="title">offsetOfSel</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> offsetof(<span class="keyword">bucket_t</span>, _sel); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> SEL <span class="title">sel</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> _sel.load(memory_order_relaxed); &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> CACHE_IMP_ENCODING == CACHE_IMP_ENCODING_ISA_XOR</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAYBE_UNUSED_ISA</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAYBE_UNUSED_ISA __attribute__((unused))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> IMP <span class="title">rawImp</span><span class="params">(MAYBE_UNUSED_ISA objc_class *cls)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">uintptr_t</span> imp = _imp.load(memory_order_relaxed);</span><br><span class="line">        <span class="keyword">if</span> (!imp) <span class="keyword">return</span> nil;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> CACHE_IMP_ENCODING == CACHE_IMP_ENCODING_PTRAUTH</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> CACHE_IMP_ENCODING == CACHE_IMP_ENCODING_ISA_XOR</span></span><br><span class="line">        imp ^= (<span class="keyword">uintptr_t</span>)cls;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> CACHE_IMP_ENCODING == CACHE_IMP_ENCODING_NONE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">error</span> Unknown method cache IMP encoding.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="keyword">return</span> (IMP)imp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> IMP <span class="title">imp</span><span class="params">(UNUSED_WITHOUT_PTRAUTH <span class="keyword">bucket_t</span> *base, Class cls)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">uintptr_t</span> imp = _imp.load(memory_order_relaxed);</span><br><span class="line">        <span class="keyword">if</span> (!imp) <span class="keyword">return</span> nil;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> CACHE_IMP_ENCODING == CACHE_IMP_ENCODING_PTRAUTH</span></span><br><span class="line">        SEL sel = _sel.load(memory_order_relaxed);</span><br><span class="line">        <span class="keyword">return</span> (IMP)</span><br><span class="line">            ptrauth_auth_and_resign((<span class="keyword">const</span> <span class="keyword">void</span> *)imp,</span><br><span class="line">                                    ptrauth_key_process_dependent_code,</span><br><span class="line">                                    modifierForSEL(base, sel, cls),</span><br><span class="line">                                    ptrauth_key_function_pointer, <span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> CACHE_IMP_ENCODING == CACHE_IMP_ENCODING_ISA_XOR</span></span><br><span class="line">        <span class="keyword">return</span> (IMP)(imp ^ (<span class="keyword">uintptr_t</span>)cls);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> CACHE_IMP_ENCODING == CACHE_IMP_ENCODING_NONE</span></span><br><span class="line">        <span class="keyword">return</span> (IMP)imp;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">error</span> Unknown method cache IMP encoding.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;Atomicity, IMPEncoding&gt;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set</span><span class="params">(<span class="keyword">bucket_t</span> *base, SEL newSel, IMP newImp, Class cls)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä»æºç å®šä¹‰ä¸­ä¸éš¾çœ‹å‡ºï¼Œ<code>bucket_t</code> å…¶å®ç¼“å­˜çš„æ˜¯æ–¹æ³•å®ç° <code>IMP</code>ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªæ³¨æ„ç‚¹ï¼Œå°±æ˜¯ <code>IMP-first</code> å’Œ <code>SEL-first</code>ã€‚</p>
<blockquote>
<p>IMP-first is better for arm64e ptrauth and no worse for arm64.</p>
</blockquote>
<ul>
<li>IMP-first å¯¹ arm64e çš„æ•ˆæœæ›´å¥½ï¼Œå¯¹ arm64 ä¸ä¼šæœ‰åçš„å½±å“ã€‚</li>
</ul>
<blockquote>
<p>SEL-first is better for armv7* and i386 and x86_64.</p>
</blockquote>
<ul>
<li>SEL-first é€‚ç”¨äº armv7 * å’Œ i386 å’Œ x86_64ã€‚</li>
</ul>
<p>é€šè¿‡ä¸Šé¢çš„æºç ï¼Œæˆ‘ä»¬å¤§è‡´äº†è§£äº† bucket_t ç±»å‹çš„ç»“æ„ï¼Œé‚£ä¹ˆç°åœ¨é—®é¢˜æ¥äº†ï¼Œç±»ä¸­çš„ cache æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™ä»¥ä»€ä¹ˆæ ·çš„æ–¹å¼æ¥è¿›è¡Œç¼“å­˜çš„å‘¢ï¼Ÿæˆ‘ä»¬ä½¿ç”¨LLDBæŸ¥çœ‹ä¸€ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">lldb) x pClass</span><br><span class="line"><span class="number">0x100008220</span>: f8 <span class="number">81</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">40</span> <span class="number">71</span> <span class="number">35</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  ........@q5.....</span><br><span class="line"><span class="number">0x100008230</span>: <span class="number">10</span> d4 <span class="number">22</span> <span class="number">01</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">03</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">24</span> <span class="number">80</span> <span class="number">01</span> <span class="number">00</span>  ..<span class="string">".........$...</span></span><br><span class="line"><span class="string">(lldb) p (cache_t *)0x100008230 //0x100008220 + 16å­—èŠ‚ï¼ˆisa 8å­—èŠ‚ + superclass 8å­—èŠ‚ï¼‰</span></span><br><span class="line"><span class="string">(cache_t *) $2 = 0x0000000100008230</span></span><br><span class="line"><span class="string">(lldb) p *$2</span></span><br><span class="line"><span class="string">(cache_t) $3 = &#123;</span></span><br><span class="line"><span class="string">  _bucketsAndMaybeMask = &#123;</span></span><br><span class="line"><span class="string">    std::__1::atomic&lt;unsigned long&gt; = &#123;</span></span><br><span class="line"><span class="string">      Value = 4314027024</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">   = &#123;</span></span><br><span class="line"><span class="string">     = &#123;</span></span><br><span class="line"><span class="string">      _maybeMask = &#123;</span></span><br><span class="line"><span class="string">        std::__1::atomic&lt;unsigned int&gt; = &#123;</span></span><br><span class="line"><span class="string">          Value = 3</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      _flags = 32804</span></span><br><span class="line"><span class="string">      _occupied = 1</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    _originalPreoptCache = &#123;</span></span><br><span class="line"><span class="string">      std::__1::atomic&lt;preopt_cache_t *&gt; = &#123;</span></span><br><span class="line"><span class="string">        Value = 0x0001802400000003</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">(lldb) p $3.buckets()</span></span><br><span class="line"><span class="string">(bucket_t *) $4 = 0x000000010122d410</span></span><br><span class="line"><span class="string">(lldb) p *$4</span></span><br><span class="line"><span class="string">(bucket_t) $5 = &#123;</span></span><br><span class="line"><span class="string">  _sel = &#123;</span></span><br><span class="line"><span class="string">    std::__1::atomic&lt;objc_selector *&gt; = "</span><span class="string">" &#123;</span></span><br><span class="line"><span class="string">      Value = "</span><span class="string">"</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  _imp = &#123;</span></span><br><span class="line"><span class="string">    std::__1::atomic&lt;unsigned long&gt; = &#123;</span></span><br><span class="line"><span class="string">      Value = 3365936</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>_occupied</code> åº”è¯¥æ˜¯è¡¨ç¤ºå½“å‰å·²ç»å ç”¨äº†å¤šå°‘ç¼“å­˜ï¼ˆæ¯è°ƒç”¨ä¸€ä¸ªå®ä¾‹æ–¹æ³•ä¼š+1ï¼‰ã€‚ä¸‹é¢éªŒè¯ä¸€ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        Person *p &#x3D; [[Person alloc] init];</span><br><span class="line">      	Class pClass &#x3D; object_getClass(p);</span><br><span class="line">        [p sayHello];</span><br><span class="line">        [p sayOk];&#x2F;&#x2F;æ–­ç‚¹æ‰“åœ¨è¿™</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">(lldb) x pClass</span><br><span class="line"><span class="number">0x100008240</span>: <span class="number">18</span> <span class="number">82</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">40</span> <span class="number">71</span> <span class="number">35</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  ........@q5.....</span><br><span class="line"><span class="number">0x100008250</span>: <span class="number">00</span> dc <span class="number">74</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">03</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">24</span> <span class="number">80</span> <span class="number">02</span> <span class="number">00</span>  ..t.........$...</span><br><span class="line">(lldb) p (<span class="keyword">cache_t</span> *)<span class="number">0x100008250</span></span><br><span class="line">(<span class="keyword">cache_t</span> *) $<span class="number">1</span> = <span class="number">0x0000000100008250</span></span><br><span class="line">(lldb) p *$<span class="number">1</span></span><br><span class="line">(<span class="keyword">cache_t</span>) $<span class="number">2</span> = &#123;</span><br><span class="line">  _bucketsAndMaybeMask = &#123;</span><br><span class="line">    <span class="built_in">std</span>::__1::atomic&lt;<span class="keyword">unsigned</span> <span class="keyword">long</span>&gt; = &#123;</span><br><span class="line">      Value = <span class="number">4302625792</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">   = &#123;</span><br><span class="line">     = &#123;</span><br><span class="line">      _maybeMask = &#123;</span><br><span class="line">        <span class="built_in">std</span>::__1::atomic&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt; = &#123;</span><br><span class="line">          Value = <span class="number">3</span><span class="comment">//æ³¨æ„</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      _flags = <span class="number">32804</span></span><br><span class="line">      _occupied = <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">    _originalPreoptCache = &#123;</span><br><span class="line">      <span class="built_in">std</span>::__1::atomic&lt;<span class="keyword">preopt_cache_t</span> *&gt; = &#123;</span><br><span class="line">        Value = <span class="number">0x0002802400000003</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°<code>_occupied = 2</code>éªŒè¯äº†æˆ‘ä»¬çš„çŒœæƒ³ï¼Œæˆ‘ä»¬ç»§ç»­èµ°æ–­ç‚¹å‘ç°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        Person *p &#x3D; [[Person alloc] init];</span><br><span class="line">      	Class pClass &#x3D; object_getClass(p);</span><br><span class="line">        [p sayHello];</span><br><span class="line">        [p sayOk];</span><br><span class="line">        &#x2F;&#x2F;æ–­ç‚¹åœ¨æœ€åä¸€æ­¥</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(lldb) p *$1</span><br><span class="line">(cache_t) $3 &#x3D; &#123;</span><br><span class="line">  _bucketsAndMaybeMask &#x3D; &#123;</span><br><span class="line">    std::__1::atomic&lt;unsigned long&gt; &#x3D; &#123;</span><br><span class="line">      Value &#x3D; 4305857472</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">   &#x3D; &#123;</span><br><span class="line">     &#x3D; &#123;</span><br><span class="line">      _maybeMask &#x3D; &#123;</span><br><span class="line">        std::__1::atomic&lt;unsigned int&gt; &#x3D; &#123;</span><br><span class="line">          Value &#x3D; 7&#x2F;&#x2F;æ³¨æ„</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      _flags &#x3D; 32804</span><br><span class="line">      _occupied &#x3D; 1</span><br><span class="line">    &#125;</span><br><span class="line">    _originalPreoptCache &#x3D; &#123;</span><br><span class="line">      std::__1::atomic&lt;preopt_cache_t *&gt; &#x3D; &#123;</span><br><span class="line">        Value &#x3D; 0x0001802400000007</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°<code>_occupied=1</code>,<code>_maybeMask</code>çš„<code>Value=7</code>(ä¸Šä¸€æ­¥=3)ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆ</p>
<p>å¦‚æœè¯»è€…äº†è§£å¹¶æŒæ¡æ•£åˆ—è¡¨è¿™ç§æ•°æ®ç»“æ„çš„è¯ï¼Œç›¸ä¿¡å·²ç»çœ‹å‡ºç«¯å€ªäº†ã€‚æ˜¯çš„ï¼Œè¿™é‡Œå…¶å®å°±æ˜¯ç”¨åˆ°äº† <strong>å¼€æ”¾å¯»å€æ³•</strong> æ¥è§£å†³æ•£åˆ—å†²çªï¼ˆå“ˆå¸Œå†²çªï¼‰ã€‚</p>
<blockquote>
<p>å…³äºå“ˆå¸Œå†²çªï¼Œå¯ä»¥å€ŸåŠ©é¸½ç¬¼ç†è®ºï¼Œå³æŠŠ 11 åªé¸½å­æ”¾è¿› 10 ä¸ªæŠ½å±‰é‡Œé¢ï¼Œè‚¯å®šä¼šæœ‰ä¸€ä¸ªæŠ½å±‰é‡Œé¢æœ‰ 2 åªé¸½å­ã€‚æ˜¯ä¸æ˜¯ç†è§£èµ·æ¥å¾ˆç®€å•? </p>
</blockquote>
<p>é€šè¿‡ä¸Šé¢çš„æµ‹è¯•ï¼Œæˆ‘ä»¬æ˜ç¡®äº†æ–¹æ³•ç¼“å­˜ä½¿ç”¨çš„æ˜¯å“ˆå¸Œè¡¨å­˜å‚¨ï¼Œå¹¶ä¸”ä¸ºäº†è§£å†³æ— æ³•é¿å…çš„å“ˆå¸Œå†²çªä½¿ç”¨çš„æ˜¯å¼€æ”¾å¯»å€æ³•ï¼Œè€Œå¼€æ”¾å¯»å€æ³•å¿…ç„¶è¦åœ¨åˆé€‚çš„æ—¶æœºè¿›è¡Œæ‰©å®¹ï¼Œè¿™ä¸ªæ—¶æœºè‚¯å®šä¸æ˜¯ä¼šåœ¨æ•°æ®å·²ç»è£…æ»¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥è¿›æºç æ¢ç´¢ä¸€ä¸‹ï¼Œæˆ‘ä»¬å¿«é€Ÿå®šä½åˆ° <code>cache_t</code> çš„æºç å¤„:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cache_t::insert</span><span class="params">(SEL sel, IMP imp, id receiver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line">    <span class="comment">///çœç•¥ä»£ç </span></span><br><span class="line">    ASSERT(sel != <span class="number">0</span> &amp;&amp; cls()-&gt;isInitialized());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use the cache as-is if until we exceed our expected fill ratio.</span></span><br><span class="line">    <span class="keyword">mask_t</span> newOccupied = occupied() + <span class="number">1</span>;</span><br><span class="line">  	<span class="comment">///å–å½“å‰å ç”¨çš„ç©ºé—´å¤§å°</span></span><br><span class="line">    <span class="keyword">unsigned</span> oldCapacity = capacity(), capacity = oldCapacity;</span><br><span class="line">    <span class="keyword">if</span> (slowpath(isConstantEmptyCache())) &#123;</span><br><span class="line">        <span class="comment">// Cache is read-only. Replace it. </span></span><br><span class="line">        <span class="keyword">if</span> (!capacity) capacity = INIT_CACHE_SIZE;</span><br><span class="line">        reallocate(oldCapacity, capacity, <span class="comment">/* freeOld */</span><span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (fastpath(newOccupied + CACHE_END_MARKER &lt;= cache_fill_ratio(capacity))) &#123;</span><br><span class="line">        <span class="comment">// Cache is less than 3/4 or 7/8 full. Use it as-is.</span></span><br><span class="line">    &#125;</span><br><span class="line">#<span class="keyword">if</span> CACHE_ALLOW_FULL_UTILIZATION</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (capacity &lt;= FULL_UTILIZATION_CACHE_SIZE &amp;&amp; newOccupied + CACHE_END_MARKER &lt;= capacity) &#123;</span><br><span class="line">        <span class="comment">// Allow 100% cache utilization for small buckets. Use it as-is.</span></span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        capacity = capacity ? capacity * <span class="number">2</span> : INIT_CACHE_SIZE;</span><br><span class="line">        <span class="keyword">if</span> (capacity &gt; MAX_CACHE_SIZE) &#123;</span><br><span class="line">            capacity = MAX_CACHE_SIZE;</span><br><span class="line">        &#125;</span><br><span class="line">      	<span class="comment">///åˆ†é…ç©ºé—´</span></span><br><span class="line">        reallocate(oldCapacity, capacity, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">///çœç•¥ä»£ç </span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> CACHE_END_MARKER || (__arm64__ &amp;&amp; !__LP64__)</span></span><br><span class="line">    <span class="comment">// When we have a cache end marker it fills a bucket slot, so having a</span></span><br><span class="line">    <span class="comment">// initial cache size of 2 buckets would not be efficient when one of the</span></span><br><span class="line">    <span class="comment">// slots is always filled with the end marker. So start with a cache size</span></span><br><span class="line">    <span class="comment">// 4 buckets.</span></span><br><span class="line">    INIT_CACHE_SIZE_LOG2 = <span class="number">2</span>,</span><br><span class="line">#<span class="keyword">else</span></span><br><span class="line">    <span class="comment">// Allow an initial bucket size of 2 buckets, since a large number of</span></span><br><span class="line">    <span class="comment">// classes, especially metaclasses, have very few imps, and we support</span></span><br><span class="line">    <span class="comment">// the ability to fill 100% of the cache before resizing.</span></span><br><span class="line">    INIT_CACHE_SIZE_LOG2 = <span class="number">1</span>,</span><br><span class="line">#endif</span><br><span class="line">    INIT_CACHE_SIZE      = (<span class="number">1</span> &lt;&lt; INIT_CACHE_SIZE_LOG2),</span><br></pre></td></tr></table></figure>

<p>çœ‹ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºï¼Œæ¢å‡ºçš„åˆå§‹å¤§å°ä¸º4ï¼ˆmetaclassesè¿™ç§æœ‰å¾ˆå°‘impsä¸º2ï¼‰ï¼Œæœ€åè°ƒç”¨<code>reallocate</code>å‡½æ•°</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cache_t::reallocate</span><span class="params">(<span class="keyword">mask_t</span> oldCapacity, <span class="keyword">mask_t</span> newCapacity, <span class="keyword">bool</span> freeOld)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">bucket_t</span> *oldBuckets = buckets();</span><br><span class="line">    <span class="keyword">bucket_t</span> *newBuckets = allocateBuckets(newCapacity);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Cache's old contents are not propagated. </span></span><br><span class="line">    <span class="comment">// This is thought to save cache memory at the cost of extra cache fills.</span></span><br><span class="line">    <span class="comment">// fixme re-measure this</span></span><br><span class="line"></span><br><span class="line">    ASSERT(newCapacity &gt; <span class="number">0</span>);</span><br><span class="line">    ASSERT((<span class="keyword">uintptr_t</span>)(<span class="keyword">mask_t</span>)(newCapacity<span class="number">-1</span>) == newCapacity<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    setBucketsAndMask(newBuckets, newCapacity - <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (freeOld) &#123;</span><br><span class="line">        collect_free(oldBuckets, oldCapacity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> CACHE_MASK_STORAGE == CACHE_MASK_STORAGE_OUTLINED</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cache_t::setBucketsAndMask</span><span class="params">(struct <span class="keyword">bucket_t</span> *newBuckets, <span class="keyword">mask_t</span> newMask)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// objc_msgSend uses mask and buckets with no locks.</span></span><br><span class="line">    <span class="comment">// It is safe for objc_msgSend to see new buckets but old mask.</span></span><br><span class="line">    <span class="comment">// (It will get a cache miss but not overrun the buckets' bounds).</span></span><br><span class="line">    <span class="comment">// It is unsafe for objc_msgSend to see old buckets and new mask.</span></span><br><span class="line">    <span class="comment">// Therefore we write new buckets, wait a lot, then write new mask.</span></span><br><span class="line">    <span class="comment">// objc_msgSend reads mask first, then buckets.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __arm__</span></span><br><span class="line">    <span class="comment">// ensure other threads see buckets contents before buckets pointer</span></span><br><span class="line">    mega_barrier();</span><br><span class="line"></span><br><span class="line">    _bucketsAndMaybeMask.store((<span class="keyword">uintptr_t</span>)newBuckets, memory_order_relaxed);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ensure other threads see new buckets before new mask</span></span><br><span class="line">    mega_barrier();</span><br><span class="line"></span><br><span class="line">    _maybeMask.store(newMask, memory_order_relaxed);</span><br><span class="line">    _occupied = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> __x86_64__ || i386</span></span><br><span class="line">    <span class="comment">// ensure other threads see buckets contents before buckets pointer</span></span><br><span class="line">    _bucketsAndMaybeMask.store((<span class="keyword">uintptr_t</span>)newBuckets, memory_order_release);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ensure other threads see new buckets before new mask</span></span><br><span class="line">    _maybeMask.store(newMask, memory_order_release);</span><br><span class="line">    _occupied = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">#error Don't know how to do setBucketsAndMask on this architecture.</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°_bucketsAndMaybeMaské‡Œçš„<code>newBuckets</code>ä¸º<code>newCapacity - 1</code>ï¼Œæˆ‘ä»¬çœ‹<code>capacity()</code>æ–¹æ³•ä¹Ÿèƒ½éªŒè¯è¿™ä¸€ç‚¹</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="title">cache_t::capacity</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mask() ? mask()+<span class="number">1</span> : <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç»§ç»­æ¢ç´¢cache-t"><a href="#ç»§ç»­æ¢ç´¢cache-t" class="headerlink" title="ç»§ç»­æ¢ç´¢cache_t"></a>ç»§ç»­æ¢ç´¢<code>cache_t</code></h3><p>é€šè¿‡å‰é¢çš„æ¢ç´¢ï¼Œæˆ‘ä»¬çŸ¥é“äº† <code>cache_t</code> å®è´¨ä¸Šæ˜¯ç¼“å­˜äº†æˆ‘ä»¬ç±»çš„å®ä¾‹æ–¹æ³•ï¼Œé‚£ä¹ˆå¯¹äºç±»æ–¹æ³•æ¥è¯´ï¼Œè‡ªç„¶å°±æ˜¯ç¼“å­˜åœ¨äº†å…ƒç±»ä¸Šäº†ã€‚è¿™ä¸€ç‚¹æˆ‘ç›¸ä¿¡è¯»è€…åº”è¯¥éƒ½èƒ½ç†è§£ã€‚</p>
<h3 id="æ–¹æ³•ç¼“å­˜ç­–ç•¥"><a href="#æ–¹æ³•ç¼“å­˜ç­–ç•¥" class="headerlink" title="æ–¹æ³•ç¼“å­˜ç­–ç•¥"></a>æ–¹æ³•ç¼“å­˜ç­–ç•¥</h3><p>ç›´è§‚çš„æ„Ÿå—å°±æ˜¯ä¼šåœ¨insertçš„æ—¶å€™ç¼“å­˜ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹<code>insert</code>æ–¹æ³•</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cache_t::insert</span><span class="params">(SEL sel, IMP imp, id receiver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    runtimeLock.assertLocked();<span class="comment">//åŠ é”</span></span><br><span class="line">    <span class="comment">// Never cache before +initialize is done</span></span><br><span class="line">    <span class="keyword">if</span> (slowpath(!cls()-&gt;isInitialized())) &#123;<span class="comment">//initializeè°ƒç”¨ä¹‹åæ‰ä¼šç¼“å­˜</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isConstantOptimizedCache()) &#123;<span class="comment">//å†…è”å‡½æ•° return false æ‰€ä»¥ifé‡Œä¸ä¼šæ‰§è¡Œ</span></span><br><span class="line">        _objc_fatal(<span class="string">"cache_t::insert() called with a preoptimized cache for %s"</span>,</span><br><span class="line">                    cls()-&gt;nameForLogging());</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DEBUG_TASK_THREADS</span></span><br><span class="line">    <span class="keyword">return</span> _collecting_in_critical();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> CONFIG_USE_CACHE_LOCK</span></span><br><span class="line">    <span class="function"><span class="keyword">mutex_locker_t</span> <span class="title">lock</span><span class="params">(cacheUpdateLock)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    ASSERT(sel != <span class="number">0</span> &amp;&amp; cls()-&gt;isInitialized());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use the cache as-is if until we exceed our expected fill ratio.</span></span><br><span class="line">    <span class="keyword">mask_t</span> newOccupied = occupied() + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> oldCapacity = capacity(), capacity = oldCapacity;</span><br><span class="line">    <span class="keyword">if</span> (slowpath(isConstantEmptyCache())) &#123;</span><br><span class="line">        <span class="comment">// Cache is read-only. Replace it.</span></span><br><span class="line">        <span class="keyword">if</span> (!capacity) capacity = INIT_CACHE_SIZE;</span><br><span class="line">        reallocate(oldCapacity, capacity, <span class="comment">/* freeOld */</span><span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (fastpath(newOccupied + CACHE_END_MARKER &lt;= cache_fill_ratio(capacity))) &#123;</span><br><span class="line">        <span class="comment">// Cache is less than 3/4 or 7/8 full. Use it as-is.</span></span><br><span class="line">    &#125;</span><br><span class="line">#<span class="keyword">if</span> CACHE_ALLOW_FULL_UTILIZATION</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (capacity &lt;= FULL_UTILIZATION_CACHE_SIZE &amp;&amp; newOccupied + CACHE_END_MARKER &lt;= capacity) &#123;</span><br><span class="line">        <span class="comment">// Allow 100% cache utilization for small buckets. Use it as-is.</span></span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        capacity = capacity ? capacity * <span class="number">2</span> : INIT_CACHE_SIZE;</span><br><span class="line">        <span class="keyword">if</span> (capacity &gt; MAX_CACHE_SIZE) &#123;</span><br><span class="line">            capacity = MAX_CACHE_SIZE;</span><br><span class="line">        &#125;</span><br><span class="line">        reallocate(oldCapacity, capacity, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bucket_t</span> *b = buckets();</span><br><span class="line">    <span class="keyword">mask_t</span> m = capacity - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">mask_t</span> <span class="built_in">begin</span> = cache_hash(sel, m);</span><br><span class="line">    <span class="keyword">mask_t</span> i = <span class="built_in">begin</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Scan for the first unused slot and insert there.</span></span><br><span class="line">    <span class="comment">// There is guaranteed to be an empty slot.</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (fastpath(b[i].sel() == <span class="number">0</span>)) &#123;</span><br><span class="line">            incrementOccupied();</span><br><span class="line">            b[i].<span class="built_in">set</span>&lt;Atomic, Encoded&gt;(b, sel, imp, cls());</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (b[i].sel() == sel) &#123;</span><br><span class="line">            <span class="comment">// The entry was added to the cache by some other thread</span></span><br><span class="line">            <span class="comment">// before we grabbed the cacheUpdateLock.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (fastpath((i = cache_next(i, m)) != <span class="built_in">begin</span>));</span><br><span class="line"></span><br><span class="line">    bad_cache(receiver, (SEL)sel);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// !DEBUG_TASK_THREADS</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ–¹æ³•ç¼“å­˜æ˜¯å¦æœ‰åº"><a href="#æ–¹æ³•ç¼“å­˜æ˜¯å¦æœ‰åº" class="headerlink" title="æ–¹æ³•ç¼“å­˜æ˜¯å¦æœ‰åº"></a>æ–¹æ³•ç¼“å­˜æ˜¯å¦æœ‰åº</h3><p>æ–¹æ³•ç¼“å­˜æ˜¯æ— åºçš„ï¼Œè¿™æ˜¯å› ä¸ºè®¡ç®—ç¼“å­˜ä¸‹æ ‡æ˜¯ä¸€ä¸ªå“ˆå¸Œç®—æ³•:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">static inline mask_t cache_hash(cache_key_t key, mask_t mask) </span><br><span class="line">&#123;</span><br><span class="line">    return (mask_t)(key &amp; mask);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ <code>cache_hash</code> ä¹‹åè®¡ç®—å‡ºæ¥çš„ä¸‹æ ‡å¹¶ä¸æ˜¯æœ‰åºçš„ï¼Œä¸‹æ ‡å€¼å–å†³äº <code>key</code> å’Œ <code>mask</code> çš„å€¼ã€‚</p>
<h3 id="bucket-ä¸-mask-capacity-sel-imp-çš„å…³ç³»"><a href="#bucket-ä¸-mask-capacity-sel-imp-çš„å…³ç³»" class="headerlink" title="bucket ä¸ mask, capacity, sel, imp çš„å…³ç³»"></a>bucket ä¸ mask, capacity, sel, imp çš„å…³ç³»</h3><p>ä¸€ä¸ªç±»æœ‰ä¸€ä¸ªå±æ€§ <code>cache_t</code>ï¼Œè€Œä¸€ä¸ª <code>cache_t</code> çš„ <code>buckets</code> ä¼šæœ‰å¤šä¸ª <code>bucket</code>ã€‚ä¸€ä¸ª <code>bucket</code> å­˜å‚¨çš„æ˜¯ <code>imp</code> å’Œ <code>cache_key_t</code> ã€‚</p>
<p><code>mask</code> çš„å€¼å¯¹äº <code>bucket</code> æ¥è¯´ï¼Œä¸»è¦æ˜¯ç”¨æ¥åœ¨ç¼“å­˜æŸ¥æ‰¾æ—¶çš„å“ˆå¸Œç®—æ³•ã€‚<br>è€Œ <code>capacity</code> åˆ™å¯ä»¥è·å–åˆ° <code>cache_t</code> ä¸­ <code>bucket</code> çš„æ•°é‡ã€‚</p>
<p><code>sel</code> åœ¨ç¼“å­˜çš„æ—¶å€™æ˜¯è¢«å¼ºè½¬æˆäº† <code>cache_key_t</code> çš„å½¢å¼ï¼Œæ›´æ–¹ä¾¿æŸ¥è¯¢ä½¿ç”¨ã€‚<br><code>imp</code> åˆ™æ˜¯å‡½æ•°æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯æ–¹æ³•çš„å…·ä½“å®ç°ï¼Œç¼“å­˜çš„ä¸»è¦ç›®çš„å°±æ˜¯é€šè¿‡ä¸€ç³»åˆ—ç­–ç•¥è®©ç¼–è¯‘å™¨æ›´å¿«çš„æ‰§è¡Œæ¶ˆæ¯å‘é€çš„é€»è¾‘ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul>
<li><code>OC</code> ä¸­å®ä¾‹æ–¹æ³•ç¼“å­˜åœ¨ç±»ä¸Šé¢ï¼Œç±»æ–¹æ³•ç¼“å­˜åœ¨å…ƒç±»ä¸Šé¢ã€‚</li>
<li><code>cache_t</code> ç¼“å­˜ä¼šæå‰è¿›è¡Œæ‰©å®¹é˜²æ­¢æº¢å‡ºã€‚</li>
<li>æ–¹æ³•ç¼“å­˜æ˜¯ä¸ºäº†æœ€å¤§åŒ–çš„æé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚</li>
<li>è‹¹æœåœ¨æ–¹æ³•ç¼“å­˜è¿™é‡Œç”¨çš„æ˜¯<code>å¼€æ”¾å¯»å€æ³•</code>æ¥è§£å†³å“ˆå¸Œå†²çªã€‚</li>
<li>é€šè¿‡ <code>cache_t</code> æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥å»¶ä¼¸å»æ¢ç©¶ <code>objc_msgSend</code>ï¼Œå› ä¸ºæŸ¥æ‰¾æ–¹æ³•ç¼“å­˜æ˜¯å±äº <code>objc_msgSend</code> æŸ¥æ‰¾æ–¹æ³•å®ç°çš„å¿«é€Ÿæµç¨‹ã€‚</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="ä¸Šä¸€é¡µ"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Jason</p>
  <div class="site-description" itemprop="description">ä¸ªäººæŠ€æœ¯åšå®¢</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">50</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">æ ‡ç­¾</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jason</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> å¼ºåŠ›é©±åŠ¨
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
