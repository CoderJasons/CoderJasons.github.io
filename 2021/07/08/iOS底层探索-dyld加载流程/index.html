<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yujiusheng.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="本文我们主要探索应用程序的加载流程，也就是main方法之前，链接器都做了什么。了解这些对我们项目的启动优化有很大帮助。 编译过程和库编译的过程我们知道库是一种可执行文件,从源代码到可执行文件工经历了下面几个步骤：  源文件：主要就是我们写的代码，.h、.m、.cpp等文件。 预编译：主要处理哪些源代码文件中以#开始的预编译指令，比如#include、#define、删除所有的注释&#x2F;&#x2F;和&#x2F;* *&#x2F;、">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS底层探索 - dyld加载流程">
<meta property="og:url" content="http://yujiusheng.com/2021/07/08/iOS%E5%BA%95%E5%B1%82%E6%8E%A2%E7%B4%A2-dyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B/index.html">
<meta property="og:site_name" content="Jason的博客">
<meta property="og:description" content="本文我们主要探索应用程序的加载流程，也就是main方法之前，链接器都做了什么。了解这些对我们项目的启动优化有很大帮助。 编译过程和库编译的过程我们知道库是一种可执行文件,从源代码到可执行文件工经历了下面几个步骤：  源文件：主要就是我们写的代码，.h、.m、.cpp等文件。 预编译：主要处理哪些源代码文件中以#开始的预编译指令，比如#include、#define、删除所有的注释&#x2F;&#x2F;和&#x2F;* *&#x2F;、">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/073f41507a9245fca094630f0fceb1e3~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e8aecf047e2548d9b1940488215457e1~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8bfcb961c63f48f781b22bf363917866~tplv-k3u1fbpfcp-watermark.image">
<meta property="article:published_time" content="2021-07-08T13:00:24.000Z">
<meta property="article:modified_time" content="2021-07-10T16:43:08.399Z">
<meta property="article:author" content="Jason">
<meta property="article:tag" content="iOS底层">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/073f41507a9245fca094630f0fceb1e3~tplv-k3u1fbpfcp-watermark.image">

<link rel="canonical" href="http://yujiusheng.com/2021/07/08/iOS%E5%BA%95%E5%B1%82%E6%8E%A2%E7%B4%A2-dyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>iOS底层探索 - dyld加载流程 | Jason的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Jason的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yujiusheng.com/2021/07/08/iOS%E5%BA%95%E5%B1%82%E6%8E%A2%E7%B4%A2-dyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jason">
      <meta itemprop="description" content="个人技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jason的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          iOS底层探索 - dyld加载流程
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-08 21:00:24" itemprop="dateCreated datePublished" datetime="2021-07-08T21:00:24+08:00">2021-07-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-11 00:43:08" itemprop="dateModified" datetime="2021-07-11T00:43:08+08:00">2021-07-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>本文我们主要探索应用程序的加载流程，也就是<code>main</code>方法之前，链接器都做了什么。了解这些对我们项目的<code>启动优化</code>有很大帮助。</p>
<h3 id="编译过程和库"><a href="#编译过程和库" class="headerlink" title="编译过程和库"></a>编译过程和库</h3><h4 id="编译的过程"><a href="#编译的过程" class="headerlink" title="编译的过程"></a>编译的过程</h4><p>我们知道库是一种<code>可执行文件</code>,从源代码到可执行文件工经历了下面几个步骤：</p>
<ul>
<li><code>源文件</code>：主要就是我们写的代码，.h、.m、.cpp等文件。</li>
<li><code>预编译</code>：主要处理哪些源代码文件中以<code>#</code>开始的预编译指令，比如<code>#include</code>、<code>#define</code>、删除所有的注释<code>//</code>和<code>/* */</code>、添加行号和文件名标识、保留所有的<code>#pragma</code>编译期指令、产生<code>.i</code>文件。</li>
<li><code>编译</code>：将<code>预处理</code>完的文件进行<code>词法分析</code>、<code>语义分析</code>及优化后输出汇编代码文件即<code>.s</code>文件。</li>
<li><code>汇编</code>：将<code>汇编代码</code>转变成机器可以执行的指令即<code>.o</code>文件。</li>
<li><code>链接</code>：对.o文件中引用其他库的地方进行引用，生成最后的可执行文件</li>
</ul>
<h4 id="动态库和静态库"><a href="#动态库和静态库" class="headerlink" title="动态库和静态库"></a>动态库和静态库</h4><p>我们项目中经常会使用到<code>动态库</code>和<code>静态库</code>,它们的区别是：</p>
<ul>
<li>静态库：在链接阶段会将汇编生成的目标文件和引用的库一起链接打包到可执行文件中。即静态库在<code>链接</code>阶段就被载入了。<ul>
<li>优点：编译完成之后的目标程序没有<code>外部依赖</code>,可以直接运行。</li>
<li>缺点：静态库可以会有多份，会导致<code>目标程序</code>体积增加，对内存、性能、速度消耗较大。</li>
</ul>
</li>
<li>动态库：程序编译并不会链接到目标代码中，在程序可执行文件里面会保留对动态库的引用，在程序<code>运行时</code>才被载入，苹果大部分官方的库都是<code>动态库</code>。<ul>
<li>优点：<ol>
<li>可以减少<code>App</code>包体积大小：因为不需要拷贝到<code>目标程序</code>中，所以不会影响<code>目标程序</code>的体积.</li>
<li>共享内存，节约资源：同一份库可以被多个程序使用。</li>
<li>可以更新动态库，而目标程序不需要重新编译：这是因为动态库<code>运行时</code>才载入，可以随时对库进行替换，而·不需要重新编译代码。</li>
</ol>
</li>
<li>缺点：由于是<code>运行时</code>载入会带来一部分性能损失，使用动态库使得程序依赖于外部环境，如果环境缺少了动态库程序就无法运行。</li>
</ul>
</li>
</ul>
<h3 id="dyld是什么"><a href="#dyld是什么" class="headerlink" title="dyld是什么"></a>dyld是什么</h3><p><code>dyld</code>是<code>动态链接器</code>,目前最新的版本是<code>dyld3</code>,我们首先看一下<code>dyld</code>的版本演变。在<code>dyld</code>之前，<code>NeXT</code>使用的是<code>静态二进制</code>数据。</p>
<h4 id="dyld版本演变"><a href="#dyld版本演变" class="headerlink" title="dyld版本演变"></a><code>dyld</code>版本演变</h4><ul>
<li><code>dyld1.0</code>(1996-2004)<ul>
<li>包含在<code>NeXTStep 3.3</code>中</li>
<li>历史早于标准化<code>POSIX dlopen()</code>的调用</li>
<li><code>macOS 10</code>之前编写第三方包装器用来以支持标准<code>Unix</code>软件，但是这些包装器并不能完美的支持相同的语义，在边界情况不能正常工作。</li>
<li>在大多数使用<code>C++</code>动态库的系统之前编写的。</li>
<li>在<code>mac OS 10.0</code>增加了<code>预绑定</code>。使用<code>预绑定</code>技术为系统中所有的<code>dylib</code>和我们的程序找到<code>固定地址</code>,<code>动态加载器</code>将会加载这些地址的所有内容。</li>
</ul>
</li>
<li><code>dyld2.0</code>(2004-2007)<ul>
<li>包含在<code>macOS Tiger</code>中</li>
<li>相比<code>1.0</code>版本是完全重写(Complete rewrite)的。</li>
<li>支持了<code>C++</code>初始化语义，扩展了<code>mach-o</code>格式。</li>
<li>有完整的本地(native)<code>dlopen</code>和<code>dlsym</code>的实现。</li>
<li><code>2.0</code>版本设计的目标是<code>提高速度</code>，仅进行有限的及安全性检查。</li>
<li>提高了安全性。</li>
<li>减少<code>预编译</code>的工作量(时长)</li>
</ul>
</li>
<li><code>dyld2.x</code>(2007-2017)<ul>
<li>增加了更多的基础架构和平台，比如<code>x86</code>、<code>x86_64</code>、<code>arm</code>、<code>arm64</code>、<code>iOS</code>、<code>tvOS</code>、<code>watchOS</code>。</li>
<li>增强了安全性。增加<code>代码签名</code>和<code>ASLR</code>(地址空间配置随机加载)，增加了<code>mach-o</code>头文件中的项目<code>边界检查</code>功能它可以避免恶意二进制数据的加入。</li>
<li>增强了性能：用<code>共享缓存</code>代替了<code>预绑定</code>。<code>共享缓存</code>是一个包含大部分<code>系统dylib</code>的单文件(Single file)，可以节省大量内存，它实际是<code>预链接</code>库。</li>
</ul>
</li>
<li><code>dyld3</code>（2017-至今）<ul>
<li>完全改变<code>动态链接器</code>的概念</li>
<li>默认适用于大部分<code>Apple OS</code>系统应用。</li>
<li>完全替代了<code>dyld2.x</code>。</li>
<li>提高了性能，尽量提高启动速度和运行速度。</li>
<li>提高安全性：将大多数<code>dyld</code>移出进程，允许部分<code>dyld</code>驻留在进程之中，驻留部分尽可能小，从而减少受攻击的面积。</li>
<li>可测试性和可靠性</li>
</ul>
</li>
</ul>
<h4 id="dyld-2和dyld-3加载过程的区别"><a href="#dyld-2和dyld-3加载过程的区别" class="headerlink" title="dyld 2和dyld 3加载过程的区别"></a><code>dyld 2</code>和<code>dyld 3</code>加载过程的区别</h4><ul>
<li><p><code>dyld 2</code>的加载过程</p>
<ol>
<li><code>Parse mach-o headers</code>:分析<code>mach-o</code>文件，通过分析<code>mach-o</code>文件弄清楚需要那些库，这些库可能需要其他库，所以会进行递归分析，直到获得所有<code>dylib</code>的完整图。一般普通<code>iOS</code>程序需要3-600个<code>dylib</code>，数据庞大，需要进行大量的处理。</li>
<li><code>Map mach-o files</code>:映射所有<code>mach-o</code>文件，将它们放入地址空间</li>
<li><code>Perform symbol lookups</code>：执行符号查找，例如程序使用了<code>printf</code>函数，将会查找<code>printf</code>是否在库系统中，然后找到它的地址，将它复制到你的程序中的函数指针。</li>
<li><code>Bind and rebase</code>:绑定和基址重置，复制<code>3</code>步的指针，由于使用随机地址，所有指针必须使用基址。</li>
<li><code>Run initializers</code>:运行初始化器，接下来准备执行<code>main</code>函数。</li>
</ol>
<p>流程图如下图，其中红色表示影响性能和安全性的步骤：</p>
</li>
</ul>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/073f41507a9245fca094630f0fceb1e3~tplv-k3u1fbpfcp-watermark.image" alt="dyld2process"></p>
<ul>
<li><p><code>dyld3</code>加载过程</p>
<p><code>dyld3</code>包括三个部分：</p>
<ul>
<li><p><code>An out of process MachO parser/compiler</code>：进程外<code>mach-o</code>分析器和编译器。</p>
<ol>
<li><code>Resolves all search paths, @rpaths, environment variables</code>:解析所有搜索路径、<code>rpaths</code>、环境变量。</li>
<li><code>Parses the mach-o binaries</code>:分析<code>mach-o</code>二进制数据</li>
<li><code>Perform symbol lookups</code>：执行符号查找，例如程序使用了<code>printf</code>函数，将会查找<code>printf</code>是否在库系统中，然后找到它的地址，将它复制到你的程序中的函数指针。</li>
<li><code>Creates a launch closure with results</code>：创建收尾处理</li>
</ol>
</li>
<li><p><code>An in-process engine that runs launch</code>：进程内引擎执行启动收尾处理，进驻在内存中。</p>
<ol start="5">
<li><code>Validates launch closure</code>：检查启动收尾处理是否正确。</li>
<li><code>Maps in all dylibs</code>：映射到所有的<code>dylib</code>中</li>
<li><code>Applies fixups</code>：应用修正</li>
<li><code>Run initializers</code>:运行初始化器，接下来准备执行<code>main</code>函数。</li>
</ol>
</li>
<li><p><code>A launch closure caching service</code>：启动收尾缓存服务。大部分程序启动会使用缓存但始终不需要调用进程外<code>mach-o</code>分析器和编译器，启动收尾比<code>mach-o</code>更简单，启动收尾文件是内存映射文件，不需要用复杂的方法进行分析从而提高速度。</p>
<p>流程图(来源WWDC ppt)如下：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e8aecf047e2548d9b1940488215457e1~tplv-k3u1fbpfcp-watermark.image" alt="dyld3"></p>
</li>
</ul>
</li>
</ul>
<p>注：本小节内容来源于<a href="https://developer.apple.com/videos/play/wwdc2017/413" target="_blank" rel="noopener">WWDC2017 App Startup Time: Past, Present, and Future</a>感兴趣的童鞋可以查看视频。</p>
<h3 id="dyld加载流程分析"><a href="#dyld加载流程分析" class="headerlink" title="dyld加载流程分析"></a>dyld加载流程分析</h3><p>通过上一小节我们其实对<code>dyld</code>的加载有一个初步的了解了，本小节主要通过看源码来探索一下加载流程。本小节需要的源码有：</p>
<ul>
<li><code>dyld</code></li>
<li><code>libobjc</code></li>
<li><code>libSystem</code></li>
<li><code>libdispatch</code></li>
</ul>
<p>源码可直接去<a href="https://opensource.apple.com/tarballs/" target="_blank" rel="noopener">苹果<code>Source Browser</code></a>下载</p>
<h4 id="dyldstart探索"><a href="#dyldstart探索" class="headerlink" title="dyldstart探索"></a><code>dyld</code>start探索</h4><ul>
<li><p>通过<code>main</code>函数</p>
<p>因为我们程序的入口是<code>main</code>函数，<code>dyld</code>是在<code>main</code>之前执行的，我们很容易想到在<code>main</code>函数打一个断点，然后查看调用堆栈信息来查看<code>dyld</code>的具体调用方法：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(lldb) bt</span><br><span class="line">* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1</span><br><span class="line">  * frame #<span class="number">0</span>: <span class="number">0x000000010000339b</span> DyldTest`main(argc=<span class="number">3</span>, argv=<span class="number">0x00007ffeefbff500</span>) at main.m:<span class="number">13</span>:<span class="number">5</span></span><br><span class="line">    frame #<span class="number">1</span>: <span class="number">0x00007fff6e7d3cc9</span> libdyld.dylib`start + <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>通过这个方式我们看到了<code>start</code>,但是通过打符号断点并没有找到<code>start</code>方法，所以这种方式无效。</p>
</li>
<li><p>通过<code>load</code>方法</p>
<p>根据我们的经验，我们知道<code>load</code>方法是在<code>main</code>函数之前执行的，我们通过<code>load</code>方法能不能找到<code>dyld</code>的入口呢，心动不如行动，我们试一下，在<code>ViewController</code>类加入<code>load</code>方法，打上断点：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(lldb) bt</span><br><span class="line">* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1</span><br><span class="line">  * frame #<span class="number">0</span>: <span class="number">0x00000001000032d7</span> DyldTest`+[ViewController load](self=ViewController, _cmd=<span class="string">"load"</span>) at ViewController.m:<span class="number">19</span>:<span class="number">5</span></span><br><span class="line">    frame #<span class="number">1</span>: <span class="number">0x00007fff6d61e560</span> libobjc.A.dylib`load_images + <span class="number">1529</span></span><br><span class="line">    frame #<span class="number">2</span>: <span class="number">0x000000010001626c</span> dyld`dyld::notifySingle(dyld_image_states, ImageLoader <span class="keyword">const</span>*, ImageLoader::InitializerTimingList*) + <span class="number">418</span></span><br><span class="line">    frame #<span class="number">3</span>: <span class="number">0x0000000100029fe9</span> dyld`ImageLoader::recursiveInitialization(ImageLoader::LinkContext <span class="keyword">const</span>&amp;, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">char</span> <span class="keyword">const</span>*, ImageLoader::InitializerTimingList&amp;, ImageLoader::UninitedUpwards&amp;) + <span class="number">475</span></span><br><span class="line">    frame #<span class="number">4</span>: <span class="number">0x00000001000280b4</span> dyld`ImageLoader::processInitializers(ImageLoader::LinkContext <span class="keyword">const</span>&amp;, <span class="keyword">unsigned</span> <span class="keyword">int</span>, ImageLoader::InitializerTimingList&amp;, ImageLoader::UninitedUpwards&amp;) + <span class="number">188</span></span><br><span class="line">    frame #<span class="number">5</span>: <span class="number">0x0000000100028154</span> dyld`ImageLoader::runInitializers(ImageLoader::LinkContext <span class="keyword">const</span>&amp;, ImageLoader::InitializerTimingList&amp;) + <span class="number">82</span></span><br><span class="line">    frame #<span class="number">6</span>: <span class="number">0x00000001000166a8</span> dyld`dyld::initializeMainExecutable() + <span class="number">199</span></span><br><span class="line">    frame #<span class="number">7</span>: <span class="number">0x000000010001bbba</span> dyld`dyld::_main(macho_header <span class="keyword">const</span>*, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">int</span>, <span class="keyword">char</span> <span class="keyword">const</span>**, <span class="keyword">char</span> <span class="keyword">const</span>**, <span class="keyword">char</span> <span class="keyword">const</span>**, <span class="keyword">unsigned</span> <span class="keyword">long</span>*) + <span class="number">6667</span></span><br><span class="line">    frame #<span class="number">8</span>: <span class="number">0x0000000100015227</span> dyld`dyldbootstrap::start(dyld3::MachOLoaded <span class="keyword">const</span>*, <span class="keyword">int</span>, <span class="keyword">char</span> <span class="keyword">const</span>**, dyld3::MachOLoaded <span class="keyword">const</span>*, <span class="keyword">unsigned</span> <span class="keyword">long</span>*) + <span class="number">453</span></span><br><span class="line">    frame #<span class="number">9</span>: <span class="number">0x0000000100015025</span> dyld`_dyld_start + <span class="number">37</span></span><br></pre></td></tr></table></figure>

<p>通过这个堆栈我们看到了<code>_dyld_start</code>就是<code>dyld</code>开始的函数，我们依次探讨堆栈里的方法。</p>
</li>
</ul>
<h4 id="dyld-start"><a href="#dyld-start" class="headerlink" title="_dyld_start"></a>_dyld_start</h4><p>我们首先在<code>dyld</code>源码中搜索<code>_dyld_start</code>,发现是一段汇编代码</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8bfcb961c63f48f781b22bf363917866~tplv-k3u1fbpfcp-watermark.image" alt="dyld_start汇编"></p>
<p>通过注释我们可以看到，调用的是<code>dyldbootstrap</code>的<code>start</code>函数。</p>
<h4 id="dyldbootstrap-start"><a href="#dyldbootstrap-start" class="headerlink" title="dyldbootstrap::start"></a>dyldbootstrap::start</h4><p>我们在源码中搜索<code>dyldbootstrap</code>找到<code>命名空间</code>，继续查找<code>start</code>函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  This is code to bootstrap dyld.  This work in normally done for a program by dyld and crt.</span></span><br><span class="line"><span class="comment">//  In dyld we have to do this manually.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">uintptr_t</span> <span class="title">start</span><span class="params">(<span class="keyword">const</span> dyld3::MachOLoaded* appsMachHeader, <span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[],</span></span></span><br><span class="line"><span class="function"><span class="params">				<span class="keyword">const</span> dyld3::MachOLoaded* dyldsMachHeader, <span class="keyword">uintptr_t</span>* startGlue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">///省略代码</span></span><br><span class="line">	<span class="comment">// now that we are done bootstrapping dyld, call dyld's main</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> appsSlide = appsMachHeader-&gt;getSlide();</span><br><span class="line">	<span class="keyword">return</span> dyld::_main((macho_header*)appsMachHeader, appsSlide, argc, argv, envp, apple, startGlue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数关键是最后一行，调用了<code>dyld::_main</code>。</p>
<h4 id="dyld-main"><a href="#dyld-main" class="headerlink" title="dyld::_main"></a><code>dyld::_main</code></h4><p>这个方法很长(900+行)，可以从返回值倒退看这个方法都做了什么。方法太长我们省略大部分代码(因为返回值和<code>mainExecutable</code>相关，所以截取的代码基本都和<code>mainExecutable</code>相关)：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uintptr_t</span></span><br><span class="line">_main(<span class="keyword">const</span> macho_header* mainExecutableMH, <span class="keyword">uintptr_t</span> mainExecutableSlide, </span><br><span class="line">		<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[], <span class="keyword">const</span> <span class="keyword">char</span>* envp[], <span class="keyword">const</span> <span class="keyword">char</span>* apple[], </span><br><span class="line">		<span class="keyword">uintptr_t</span>* startGlue)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">///省略代码</span></span><br><span class="line">  <span class="comment">// Grab the cdHash of the main executable from the environment</span></span><br><span class="line">  <span class="comment">// 创建主程序cdHash的空间</span></span><br><span class="line">	<span class="keyword">uint8_t</span> mainExecutableCDHashBuffer[<span class="number">20</span>];</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">uint8_t</span>* mainExecutableCDHash = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">if</span> ( <span class="keyword">const</span> <span class="keyword">char</span>* mainExeCdHashStr = _simple_getenv(apple, <span class="string">"executable_cdhash"</span>) ) &#123;</span><br><span class="line">		<span class="keyword">unsigned</span> bufferLenUsed;</span><br><span class="line">		<span class="keyword">if</span> ( hexStringToBytes(mainExeCdHashStr, mainExecutableCDHashBuffer, <span class="keyword">sizeof</span>(mainExecutableCDHashBuffer), bufferLenUsed) )</span><br><span class="line">			mainExecutableCDHash = mainExecutableCDHashBuffer;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/////配置信息，获取主程序的mach-o header、silder（ASLR的偏移值）</span></span><br><span class="line">	getHostInfo(mainExecutableMH, mainExecutableSlide);</span><br><span class="line">  <span class="comment">///通过silder+ASLR可以找到信息</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> result = <span class="number">0</span>;</span><br><span class="line">	sMainExecutableMachHeader = mainExecutableMH;</span><br><span class="line">	sMainExecutableSlide = mainExecutableSlide;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">///省略代码</span></span><br><span class="line">  <span class="comment">//设置上下文，将这里所有的变量放到了gLinkContext中了，保存起来</span></span><br><span class="line">  setContext(mainExecutableMH, argc, argv, envp, apple);</span><br><span class="line">  <span class="comment">//配置进程是否受限，envp是环境变量</span></span><br><span class="line">  configureProcessRestrictions(mainExecutableMH, envp);</span><br><span class="line">      configureProcessRestrictions(mainExecutableMH, envp);</span><br><span class="line">	<span class="comment">///检测是否强制dyld3</span></span><br><span class="line">	<span class="comment">// Check if we should force dyld3.  Note we have to do this outside of the regular env parsing due to AMFI</span></span><br><span class="line">	<span class="keyword">if</span> ( dyld3::internalInstall() ) &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">const</span> <span class="keyword">char</span>* useClosures = _simple_getenv(envp, <span class="string">"DYLD_USE_CLOSURES"</span>)) &#123;</span><br><span class="line">			<span class="keyword">if</span> ( <span class="built_in">strcmp</span>(useClosures, <span class="string">"0"</span>) == <span class="number">0</span> ) &#123;</span><br><span class="line">				sClosureMode = ClosureMode::Off;</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(useClosures, <span class="string">"1"</span>) == <span class="number">0</span> ) &#123;</span><br><span class="line">	#<span class="keyword">if</span> !__i386__ <span class="comment">// don't support dyld3 for 32-bit macOS</span></span><br><span class="line">				sClosureMode = ClosureMode::On;</span><br><span class="line">				sClosureKind = ClosureKind::full;</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(useClosures, <span class="string">"2"</span>) == <span class="number">0</span> ) &#123;</span><br><span class="line">				sClosureMode = ClosureMode::On;</span><br><span class="line">				sClosureKind = ClosureKind::minimal;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				dyld::warn(<span class="string">"unknown option to DYLD_USE_CLOSURES.  Valid options are: 0 and 1\n"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">if</span> TARGET_OS_OSX</span></span><br><span class="line">    <span class="comment">///受限制的进程，环境变量可能会变化，需要重新设置</span></span><br><span class="line">    <span class="keyword">if</span> ( !gLinkContext.allowEnvVarsPrint &amp;&amp; !gLinkContext.allowEnvVarsPath &amp;&amp; !gLinkContext.allowEnvVarsSharedCache ) &#123;</span><br><span class="line">		pruneEnvironmentVariables(envp, &amp;apple);</span><br><span class="line">		<span class="comment">// set again because envp and apple may have changed or moved</span></span><br><span class="line">		setContext(mainExecutableMH, argc, argv, envp, apple);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">#endif</span><br><span class="line">	&#123;</span><br><span class="line">    <span class="comment">///检查环境变量</span></span><br><span class="line">		checkEnvironmentVariables(envp);</span><br><span class="line">    <span class="comment">///default value for DYLD_FALLBACK_FRAMEWORK_PATH, if not set in environment</span></span><br><span class="line">    <span class="comment">///如果没有环境变量 设置默认值</span></span><br><span class="line">		defaultUninitializedFallbackPaths(envp);</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">// load shared cache 加载共享缓存</span></span><br><span class="line">	checkSharedRegionDisable((dyld3::MachOLoaded*)mainExecutableMH, mainExecutableSlide)</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">if</span> !TARGET_OS_SIMULATOR</span></span><br><span class="line">  <span class="comment">///是否有启动闭包 dyld3有闭包</span></span><br><span class="line">	<span class="keyword">if</span> ( sClosureMode == ClosureMode::Off ) &#123;</span><br><span class="line">		<span class="keyword">if</span> ( gLinkContext.verboseWarnings )</span><br><span class="line">			dyld::<span class="built_in">log</span>(<span class="string">"dyld: not using closures\n"</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">///dyld3有闭包</span></span><br><span class="line">    <span class="comment">///设置加载启动模式</span></span><br><span class="line">		sLaunchModeUsed = DYLD_LAUNCH_MODE_USING_CLOSURE;</span><br><span class="line">    <span class="comment">///配置闭包</span></span><br><span class="line">		<span class="keyword">const</span> dyld3::closure::LaunchClosure* mainClosure = <span class="literal">nullptr</span>;</span><br><span class="line">		dyld3::closure::LoadedFileInfo mainFileInfo;</span><br><span class="line">		mainFileInfo.fileContent = mainExecutableMH;</span><br><span class="line">		mainFileInfo.path = sExecPath;</span><br><span class="line">    <span class="comment">// check for closure in cache first</span></span><br><span class="line">    <span class="comment">// 判断缓存中是否已经有闭包</span></span><br><span class="line">		<span class="keyword">if</span> ( sSharedCacheLoadInfo.loadAddress != <span class="literal">nullptr</span> ) &#123;</span><br><span class="line">			mainClosure = sSharedCacheLoadInfo.loadAddress-&gt;findClosure(sExecPath);</span><br><span class="line">			<span class="keyword">if</span> ( gLinkContext.verboseWarnings &amp;&amp; (mainClosure != <span class="literal">nullptr</span>) )</span><br><span class="line">				dyld::<span class="built_in">log</span>(<span class="string">"dyld: found closure %p (size=%lu) in dyld shared cache\n"</span>, mainClosure, mainClosure-&gt;<span class="built_in">size</span>());</span><br><span class="line">			<span class="keyword">if</span> ( mainClosure != <span class="literal">nullptr</span> )</span><br><span class="line">				sLaunchModeUsed |= DYLD_LAUNCH_MODE_CLOSURE_FROM_OS;</span><br><span class="line">		&#125;</span><br><span class="line">    <span class="comment">///如果闭包已失效</span></span><br><span class="line">    <span class="keyword">if</span> ( (mainClosure != <span class="literal">nullptr</span>) &amp;&amp; !closureValid(mainClosure, mainFileInfo, mainExecutableCDHash, <span class="literal">true</span>, envp) ) &#123;</span><br><span class="line">			mainClosure = <span class="literal">nullptr</span>;</span><br><span class="line">			sLaunchModeUsed &amp;= ~DYLD_LAUNCH_MODE_CLOSURE_FROM_OS;</span><br><span class="line">		&#125;</span><br><span class="line">    <span class="comment">///没有闭包创建一个</span></span><br><span class="line">    <span class="keyword">if</span> ( (mainClosure == <span class="literal">nullptr</span>) &amp;&amp; allowClosureRebuilds ) &#123;</span><br><span class="line">			<span class="comment">// if forcing closures, and no closure in cache, or it is invalid, check for cached closure</span></span><br><span class="line">			<span class="keyword">if</span> ( !sForceInvalidSharedCacheClosureFormat )</span><br><span class="line">				mainClosure = findCachedLaunchClosure(mainExecutableCDHash, mainFileInfo, envp, bootToken);</span><br><span class="line">			<span class="keyword">if</span> ( mainClosure == <span class="literal">nullptr</span> ) &#123;</span><br><span class="line">				<span class="comment">// if  no cached closure found, build new one</span></span><br><span class="line">				mainClosure = buildLaunchClosure(mainExecutableCDHash, mainFileInfo, envp, bootToken);</span><br><span class="line">				<span class="keyword">if</span> ( mainClosure != <span class="literal">nullptr</span> )</span><br><span class="line">					sLaunchModeUsed |= DYLD_LAUNCH_MODE_BUILT_CLOSURE_AT_LAUNCH;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// try using launch closure 使用启动闭包</span></span><br><span class="line">		<span class="keyword">if</span> ( mainClosure != <span class="literal">nullptr</span> ) &#123;</span><br><span class="line">			CRSetCrashLogMessage(<span class="string">"dyld3: launch started"</span>);</span><br><span class="line">			<span class="keyword">if</span> ( mainClosure-&gt;topImage()-&gt;fixupsNotEncoded() )</span><br><span class="line">				sLaunchModeUsed |= DYLD_LAUNCH_MODE_MINIMAL_CLOSURE;</span><br><span class="line">      <span class="keyword">bool</span> closureOutOfDate;</span><br><span class="line">			<span class="keyword">bool</span> recoverable;</span><br><span class="line">      <span class="comment">///启动闭包</span></span><br><span class="line">			<span class="keyword">bool</span> launched = launchWithClosure(mainClosure, sSharedCacheLoadInfo.loadAddress, (dyld3::MachOLoaded*)mainExecutableMH,</span><br><span class="line">											  mainExecutableSlide, argc, argv, envp, apple, diag, &amp;result, startGlue, &amp;closureOutOfDate, &amp;recoverable);</span><br><span class="line">      <span class="comment">/// 如果启动失败</span></span><br><span class="line">      <span class="keyword">if</span> ( !launched &amp;&amp; closureOutOfDate &amp;&amp; allowClosureRebuilds ) &#123;</span><br><span class="line">				<span class="comment">// closure is out of date, build new one</span></span><br><span class="line">				mainClosure = buildLaunchClosure(mainExecutableCDHash, mainFileInfo, envp, bootToken);</span><br><span class="line">        <span class="comment">///重新启动</span></span><br><span class="line">        launched = launchWithClosure(mainClosure, sSharedCacheLoadInfo.loadAddress, (dyld3::MachOLoaded*)mainExecutableMH,</span><br><span class="line">												 mainExecutableSlide, argc, argv, envp, apple, diag, &amp;result, startGlue, &amp;closureOutOfDate, &amp;recoverable);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">///启动成功 返回main函数</span></span><br><span class="line">      <span class="keyword">if</span> ( launched ) &#123;</span><br><span class="line">				gLinkContext.startedInitializingMainExecutable = <span class="literal">true</span>;</span><br><span class="line">				<span class="keyword">if</span> (sSkipMain)</span><br><span class="line">					result = (<span class="keyword">uintptr_t</span>)&amp;fake_main;</span><br><span class="line">				<span class="keyword">return</span> result;</span><br><span class="line">			&#125;</span><br><span class="line">      <span class="comment">///不是dyld3的省略代码</span></span><br><span class="line">    &#125;</span><br><span class="line">   <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">   <span class="comment">///省略代码</span></span><br><span class="line">   <span class="comment">// load any inserted libraries插入动态库</span></span><br><span class="line">		<span class="keyword">if</span>	( sEnv.DYLD_INSERT_LIBRARIES != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span>* lib = sEnv.DYLD_INSERT_LIBRARIES; *lib != <span class="literal">NULL</span>; ++lib) </span><br><span class="line">				loadInsertedDylib(*lib);</span><br><span class="line">		&#125;</span><br><span class="line">   <span class="comment">///弱引用绑定主程序</span></span><br><span class="line">   sMainExecutable-&gt;weakBind(gLinkContext);</span><br><span class="line">    <span class="comment">// run all initializers</span></span><br><span class="line">    <span class="comment">// 运行所有initializers</span></span><br><span class="line">		initializeMainExecutable(); </span><br><span class="line">    <span class="comment">// notify any montoring proccesses that this process is about to enter main()</span></span><br><span class="line">    <span class="comment">/// 通知可以进入main函数了</span></span><br><span class="line">		notifyMonitoringDyldMain();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>大体流程就是：</p>
<ul>
<li>配置环境变量</li>
<li>检查共享缓存是否开启，以及共享缓存是否映射到共享区域</li>
<li>主程序初始化即<code>instantiateFromLoadedImage</code></li>
<li>插入动态库</li>
<li>link主程序</li>
<li>link动态库</li>
<li>弱符号绑定</li>
<li>执行初始化方法</li>
<li>主程序入口</li>
</ul>
<h4 id="dyld-initializeMainExecutable"><a href="#dyld-initializeMainExecutable" class="headerlink" title="dyld::initializeMainExecutable"></a>dyld::initializeMainExecutable</h4><p>主要是循环遍历执行<code>runInitializers</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initializeMainExecutable</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// record that we've reached this step</span></span><br><span class="line">	gLinkContext.startedInitializingMainExecutable = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// run initialzers for any inserted dylibs</span></span><br><span class="line">	ImageLoader::InitializerTimingList initializerTimes[allImagesCount()];</span><br><span class="line">	initializerTimes[<span class="number">0</span>].count = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">size_t</span> rootCount = sImageRoots.<span class="built_in">size</span>();</span><br><span class="line">	<span class="keyword">if</span> ( rootCount &gt; <span class="number">1</span> ) &#123;</span><br><span class="line">    <span class="comment">///遍历 执行</span></span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">size_t</span> i=<span class="number">1</span>; i &lt; rootCount; ++i) &#123;</span><br><span class="line">			sImageRoots[i]-&gt;runInitializers(gLinkContext, initializerTimes[<span class="number">0</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// run initializers for main executable and everything it brings up </span></span><br><span class="line">	sMainExecutable-&gt;runInitializers(gLinkContext, initializerTimes[<span class="number">0</span>]);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// register cxa_atexit() handler to run static terminators in all loaded images when this process exits</span></span><br><span class="line">	<span class="keyword">if</span> ( gLibSystemHelpers != <span class="literal">NULL</span> ) </span><br><span class="line">		(*gLibSystemHelpers-&gt;cxa_atexit)(&amp;runAllStaticTerminators, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// dump info if requested</span></span><br><span class="line">	<span class="keyword">if</span> ( sEnv.DYLD_PRINT_STATISTICS )</span><br><span class="line">		ImageLoader::printStatistics((<span class="keyword">unsigned</span> <span class="keyword">int</span>)allImagesCount(), initializerTimes[<span class="number">0</span>]);</span><br><span class="line">	<span class="keyword">if</span> ( sEnv.DYLD_PRINT_STATISTICS_DETAILS )</span><br><span class="line">		ImageLoaderMachO::printStatisticsDetails((<span class="keyword">unsigned</span> <span class="keyword">int</span>)allImagesCount(), initializerTimes[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ImageLoader-runInitializers"><a href="#ImageLoader-runInitializers" class="headerlink" title="ImageLoader::runInitializers"></a>ImageLoader::runInitializers</h4><p>核心代码是调用<code>processInitializers</code>方法</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ImageLoader::runInitializers</span><span class="params">(<span class="keyword">const</span> LinkContext&amp; context, InitializerTimingList&amp; timingInfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint64_t</span> t1 = mach_absolute_time();</span><br><span class="line">	<span class="keyword">mach_port_t</span> thisThread = mach_thread_self();</span><br><span class="line">	ImageLoader::UninitedUpwards up;</span><br><span class="line">	up.count = <span class="number">1</span>;</span><br><span class="line">	up.imagesAndPaths[<span class="number">0</span>] = &#123; <span class="keyword">this</span>, <span class="keyword">this</span>-&gt;getPath() &#125;;</span><br><span class="line">  <span class="comment">///调用</span></span><br><span class="line">	processInitializers(context, thisThread, timingInfo, up);</span><br><span class="line">	context.notifyBatch(dyld_image_state_initialized, <span class="literal">false</span>);</span><br><span class="line">	mach_port_deallocate(mach_task_self(), thisThread);</span><br><span class="line">	<span class="keyword">uint64_t</span> t2 = mach_absolute_time();</span><br><span class="line">	fgTotalInitTime += (t2 - t1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ImageLoader-processInitializers"><a href="#ImageLoader-processInitializers" class="headerlink" title="ImageLoader::processInitializers"></a>ImageLoader::processInitializers</h4><p>对镜像列表调用<code>recursiveInitialization</code>函数进行递归实例化</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ImageLoader::processInitializers</span><span class="params">(<span class="keyword">const</span> LinkContext&amp; context, <span class="keyword">mach_port_t</span> thisThread,</span></span></span><br><span class="line"><span class="function"><span class="params">									 InitializerTimingList&amp; timingInfo, ImageLoader::UninitedUpwards&amp; images)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint32_t</span> maxImageCount = context.imageCount()+<span class="number">2</span>;</span><br><span class="line">	ImageLoader::UninitedUpwards upsBuffer[maxImageCount];</span><br><span class="line">	ImageLoader::UninitedUpwards&amp; ups = upsBuffer[<span class="number">0</span>];</span><br><span class="line">	ups.count = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// Calling recursive init on all images in images list, building a new list of</span></span><br><span class="line">	<span class="comment">// uninitialized upward dependencies.</span></span><br><span class="line">  <span class="comment">// 递归实例化</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">uintptr_t</span> i=<span class="number">0</span>; i &lt; images.count; ++i) &#123;</span><br><span class="line">		images.imagesAndPaths[i].first-&gt;recursiveInitialization(context, thisThread, images.imagesAndPaths[i].second, timingInfo, ups);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// If any upward dependencies remain, init them.</span></span><br><span class="line">	<span class="keyword">if</span> ( ups.count &gt; <span class="number">0</span> )</span><br><span class="line">		processInitializers(context, thisThread, timingInfo, ups);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ImageLoader-recursiveInitialization"><a href="#ImageLoader-recursiveInitialization" class="headerlink" title="ImageLoader::recursiveInitialization"></a>ImageLoader::recursiveInitialization</h4><p>主要是加载完镜像后通知出去</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ImageLoader::recursiveInitialization</span><span class="params">(<span class="keyword">const</span> LinkContext&amp; context, <span class="keyword">mach_port_t</span> this_thread, <span class="keyword">const</span> <span class="keyword">char</span>* pathToInitialize,</span></span></span><br><span class="line"><span class="function"><span class="params">										  InitializerTimingList&amp; timingInfo, UninitedUpwards&amp; uninitUps)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">///递归锁</span></span><br><span class="line">	<span class="function">recursive_lock <span class="title">lock_info</span><span class="params">(this_thread)</span></span>;</span><br><span class="line">	recursiveSpinLock(lock_info);</span><br><span class="line">	<span class="keyword">if</span> ( fState &lt; dyld_image_state_dependents_initialized<span class="number">-1</span> ) &#123;</span><br><span class="line">		<span class="keyword">uint8_t</span> oldState = fState;</span><br><span class="line">		<span class="comment">// break cycles 结束递归</span></span><br><span class="line">		fState = dyld_image_state_dependents_initialized<span class="number">-1</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// initialize lower level libraries first</span></span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>; i &lt; libraryCount(); ++i) &#123;</span><br><span class="line">				ImageLoader* dependentImage = libImage(i);</span><br><span class="line">				<span class="keyword">if</span> ( dependentImage != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">					<span class="comment">// don't try to initialize stuff "above" me yet</span></span><br><span class="line">					<span class="keyword">if</span> ( libIsUpward(i) ) &#123;</span><br><span class="line">						uninitUps.imagesAndPaths[uninitUps.count] = &#123; dependentImage, libPath(i) &#125;;</span><br><span class="line">						uninitUps.count++;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span> <span class="keyword">if</span> ( dependentImage-&gt;fDepth &gt;= fDepth ) &#123;</span><br><span class="line">						dependentImage-&gt;recursiveInitialization(context, this_thread, libPath(i), timingInfo, uninitUps);</span><br><span class="line">					&#125;</span><br><span class="line">                &#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// record termination order</span></span><br><span class="line">			<span class="keyword">if</span> ( <span class="keyword">this</span>-&gt;needsTermination() )</span><br><span class="line">				context.terminationRecorder(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// let objc know we are about to initialize this image</span></span><br><span class="line">      <span class="comment">// 让objc知道我们要初始化此镜像</span></span><br><span class="line">			<span class="keyword">uint64_t</span> t1 = mach_absolute_time();</span><br><span class="line">			fState = dyld_image_state_dependents_initialized;</span><br><span class="line">			oldState = fState;</span><br><span class="line">			context.notifySingle(dyld_image_state_dependents_initialized, <span class="keyword">this</span>, &amp;timingInfo);</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// initialize this image</span></span><br><span class="line">      <span class="comment">/// 初始化镜像</span></span><br><span class="line">			<span class="keyword">bool</span> hasInitializers = <span class="keyword">this</span>-&gt;doInitialization(context);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// let anyone know we finished initializing this image</span></span><br><span class="line">      <span class="comment">/// 让任何人都知道我们完成了这个镜像的初始化</span></span><br><span class="line">			fState = dyld_image_state_initialized;</span><br><span class="line">			oldState = fState;</span><br><span class="line">			context.notifySingle(dyld_image_state_initialized, <span class="keyword">this</span>, <span class="literal">NULL</span>);</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> ( hasInitializers ) &#123;</span><br><span class="line">				<span class="keyword">uint64_t</span> t2 = mach_absolute_time();</span><br><span class="line">				timingInfo.addTime(<span class="keyword">this</span>-&gt;getShortName(), t2-t1);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (<span class="keyword">const</span> <span class="keyword">char</span>* msg) &#123;</span><br><span class="line">			<span class="comment">// this image is not initialized</span></span><br><span class="line">			fState = oldState;</span><br><span class="line">			recursiveSpinUnLock();</span><br><span class="line">			<span class="keyword">throw</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	recursiveSpinUnLock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="dyld-notifySingle"><a href="#dyld-notifySingle" class="headerlink" title="dyld::notifySingle"></a>dyld::notifySingle</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">notifySingle</span><span class="params">(dyld_image_states state, <span class="keyword">const</span> ImageLoader* <span class="built_in">image</span>, ImageLoader::InitializerTimingList* timingInfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//dyld::log("notifySingle(state=%d, image=%s)\n", state, image-&gt;getPath());</span></span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;dyld_image_state_change_handler&gt;* handlers = stateToHandlers(state, sSingleHandlers);</span><br><span class="line">	<span class="keyword">if</span> ( handlers != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">		dyld_image_info info;</span><br><span class="line">		info.imageLoadAddress	= <span class="built_in">image</span>-&gt;machHeader();</span><br><span class="line">		info.imageFilePath		= <span class="built_in">image</span>-&gt;getRealPath();</span><br><span class="line">		info.imageFileModDate	= <span class="built_in">image</span>-&gt;lastModified();</span><br><span class="line">		<span class="keyword">for</span> (<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;dyld_image_state_change_handler&gt;::iterator it = handlers-&gt;<span class="built_in">begin</span>(); it != handlers-&gt;<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">char</span>* result = (*it)(state, <span class="number">1</span>, &amp;info);</span><br><span class="line">			<span class="keyword">if</span> ( (result != <span class="literal">NULL</span>) &amp;&amp; (state == dyld_image_state_mapped) ) &#123;</span><br><span class="line">				<span class="comment">//fprintf(stderr, "  image rejected by handler=%p\n", *it);</span></span><br><span class="line">				<span class="comment">// make copy of thrown string so that later catch clauses can free it</span></span><br><span class="line">				<span class="keyword">const</span> <span class="keyword">char</span>* str = strdup(result);</span><br><span class="line">				<span class="keyword">throw</span> str;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ( state == dyld_image_state_mapped ) &#123;</span><br><span class="line">		<span class="comment">// &lt;rdar://problem/7008875&gt; Save load addr + UUID for images from outside the shared cache</span></span><br><span class="line">		<span class="comment">// &lt;rdar://problem/50432671&gt; Include UUIDs for shared cache dylibs in all image info when using private mapped shared caches</span></span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">image</span>-&gt;inSharedCache()</span><br><span class="line">			|| (gLinkContext.sharedRegionMode == ImageLoader::kUsePrivateSharedRegion)) &#123;</span><br><span class="line">			dyld_uuid_info info;</span><br><span class="line">			<span class="keyword">if</span> ( <span class="built_in">image</span>-&gt;getUUID(info.imageUUID) ) &#123;</span><br><span class="line">				info.imageLoadAddress = <span class="built_in">image</span>-&gt;machHeader();</span><br><span class="line">				addNonSharedCacheImageUUID(info);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ( (state == dyld_image_state_dependents_initialized) &amp;&amp; (sNotifyObjCInit != <span class="literal">NULL</span>) &amp;&amp; <span class="built_in">image</span>-&gt;notifyObjC() ) &#123;</span><br><span class="line">		<span class="keyword">uint64_t</span> t0 = mach_absolute_time();</span><br><span class="line">		<span class="function">dyld3::ScopedTimer <span class="title">timer</span><span class="params">(DBG_DYLD_TIMING_OBJC_INIT, (<span class="keyword">uint64_t</span>)<span class="built_in">image</span>-&gt;machHeader(), <span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="comment">///重点操作</span></span><br><span class="line">		(*sNotifyObjCInit)(<span class="built_in">image</span>-&gt;getRealPath(), <span class="built_in">image</span>-&gt;machHeader());</span><br><span class="line">		<span class="keyword">uint64_t</span> t1 = mach_absolute_time();</span><br><span class="line">		<span class="keyword">uint64_t</span> t2 = mach_absolute_time();</span><br><span class="line">		<span class="keyword">uint64_t</span> timeInObjC = t1-t0;</span><br><span class="line">		<span class="keyword">uint64_t</span> emptyTime = (t2-t1)*<span class="number">100</span>;</span><br><span class="line">		<span class="keyword">if</span> ( (timeInObjC &gt; emptyTime) &amp;&amp; (timingInfo != <span class="literal">NULL</span>) ) &#123;</span><br><span class="line">			timingInfo-&gt;addTime(<span class="built_in">image</span>-&gt;getShortName(), timeInObjC);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// mach message csdlc about dynamically unloaded images</span></span><br><span class="line">	<span class="keyword">if</span> ( <span class="built_in">image</span>-&gt;addFuncNotified() &amp;&amp; (state == dyld_image_state_terminated) ) &#123;</span><br><span class="line">		notifyKernel(*<span class="built_in">image</span>, <span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">mach_header</span>* <span class="title">loadAddress</span>[] = &#123;</span> <span class="built_in">image</span>-&gt;machHeader() &#125;;</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">char</span>* loadPath[] = &#123; <span class="built_in">image</span>-&gt;getPath() &#125;;</span><br><span class="line">		notifyMonitoringDyld(<span class="literal">true</span>, <span class="number">1</span>, loadAddress, loadPath);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其重点是<code>(*sNotifyObjCInit)(image-&gt;getRealPath(), image-&gt;machHeader());</code>，我们全局搜索<code>sNotifyObjCInit</code>并没有实现，但是有赋值操作：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">registerObjCNotifiers</span><span class="params">(_dyld_objc_notify_mapped mapped, _dyld_objc_notify_init init, _dyld_objc_notify_unmapped unmapped)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// record functions to call</span></span><br><span class="line">	sNotifyObjCMapped	= mapped;</span><br><span class="line">  <span class="comment">///赋值操作</span></span><br><span class="line">	sNotifyObjCInit		= init;</span><br><span class="line">	sNotifyObjCUnmapped = unmapped;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// call 'mapped' function with all images mapped so far</span></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		notifyBatchPartial(dyld_image_state_bound, <span class="literal">true</span>, <span class="literal">NULL</span>, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (<span class="keyword">const</span> <span class="keyword">char</span>* msg) &#123;</span><br><span class="line">		<span class="comment">// ignore request to abort during registration</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// &lt;rdar://problem/32209809&gt; call 'init' function on all images already init'ed (below libSystem)</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;ImageLoader*&gt;::iterator it=sAllImages.<span class="built_in">begin</span>(); it != sAllImages.<span class="built_in">end</span>(); it++) &#123;</span><br><span class="line">		ImageLoader* <span class="built_in">image</span> = *it;</span><br><span class="line">		<span class="keyword">if</span> ( (<span class="built_in">image</span>-&gt;getState() == dyld_image_state_initialized) &amp;&amp; <span class="built_in">image</span>-&gt;notifyObjC() ) &#123;</span><br><span class="line">			<span class="function">dyld3::ScopedTimer <span class="title">timer</span><span class="params">(DBG_DYLD_TIMING_OBJC_INIT, (<span class="keyword">uint64_t</span>)<span class="built_in">image</span>-&gt;machHeader(), <span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">			(*sNotifyObjCInit)(<span class="built_in">image</span>-&gt;getRealPath(), <span class="built_in">image</span>-&gt;machHeader());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>registerObjCNotifiers</code>是在<code>_dyld_objc_notify_register</code>调用，而<code>_dyld_objc_notify_register</code>函数是在<code>libobjc</code>源码<code>_objc_init</code>代用的，所以<code>sNotifyObjCInit</code>的<code>赋值</code>的就是<code>objc</code>中的<code>load_images</code>，而<code>load_images</code>会调用所有的<code>+load</code>方法。所以综上所述，<code>notifySingle</code>是一个<code>回调函数</code>,所以我们继续看<code>load_images</code>方法</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _objc_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">bool</span> initialized = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (initialized) <span class="keyword">return</span>;</span><br><span class="line">    initialized = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// fixme defer initialization until an objc-using image is found?</span></span><br><span class="line">    environ_init();</span><br><span class="line">    tls_init();</span><br><span class="line">    static_init();</span><br><span class="line">    runtime_init();</span><br><span class="line">    exception_init();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __OBJC2__</span></span><br><span class="line">    <span class="keyword">cache_t</span>::init();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    _imp_implementationWithBlock_init();</span><br><span class="line"></span><br><span class="line">    _dyld_objc_notify_register(&amp;map_images, load_images, unmap_image);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __OBJC2__</span></span><br><span class="line">    didCallDyldNotifyRegister = <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="load-images"><a href="#load-images" class="headerlink" title="load_images"></a>load_images</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">load_images(<span class="keyword">const</span> <span class="keyword">char</span> *path __unused, <span class="keyword">const</span> struct mach_header *mh)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!didInitialAttachCategories &amp;&amp; didCallDyldNotifyRegister) &#123;</span><br><span class="line">        didInitialAttachCategories = <span class="literal">true</span>;</span><br><span class="line">        loadAllCategories();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return without taking locks if there are no +load methods here.</span></span><br><span class="line">    <span class="keyword">if</span> (!hasLoadMethods((<span class="keyword">const</span> headerType *)mh)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">recursive_mutex_locker_t</span> <span class="title">lock</span><span class="params">(loadMethodLock)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Discover load methods</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">mutex_locker_t</span> <span class="title">lock2</span><span class="params">(runtimeLock)</span></span>;</span><br><span class="line">        prepare_load_methods((<span class="keyword">const</span> headerType *)mh);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Call +load methods (without runtimeLock - re-entrant)</span></span><br><span class="line"> 		<span class="comment">// 调用了load方法</span></span><br><span class="line">    call_load_methods();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方法比较简单，主要调用了<code>call_load_methods</code>方法</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">call_load_methods</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">bool</span> loading = NO;</span><br><span class="line">    <span class="keyword">bool</span> more_categories;</span><br><span class="line"></span><br><span class="line">    loadMethodLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Re-entrant calls do nothing; the outermost call will finish the job.</span></span><br><span class="line">    <span class="keyword">if</span> (loading) <span class="keyword">return</span>;</span><br><span class="line">    loading = YES;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> *pool = objc_autoreleasePoolPush();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// 1. Repeatedly call class +loads until there aren't any more</span></span><br><span class="line">        <span class="keyword">while</span> (loadable_classes_used &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            call_class_loads();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. Call category +loads ONCE</span></span><br><span class="line">        more_categories = call_category_loads();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. Run more +loads if there are classes OR more untried categories</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (loadable_classes_used &gt; <span class="number">0</span>  ||  more_categories);</span><br><span class="line"></span><br><span class="line">    objc_autoreleasePoolPop(pool);</span><br><span class="line"></span><br><span class="line">    loading = NO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>call_load_methods</code>方法的核心就是循环调用<code>load</code>方法。</p>
<p>###总结</p>
<p>load的源码链为：<code>_dyld_start</code> –&gt; <code>dyldbootstrap::start</code> –&gt; <code>dyld::_main</code> –&gt; <code>dyld::initializeMainExecutable</code> –&gt; <code>ImageLoader::runInitializers</code> –&gt; <code>ImageLoader::processInitializers</code> –&gt; <code>ImageLoader::recursiveInitialization</code> –&gt; <code>dyld::notifySingle</code>(是一个回调处理) –&gt; <code>sNotifyObjCInit</code> –&gt; <code>load_images(libobjc.A.dylib)</code></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/iOS%E5%BA%95%E5%B1%82/" rel="tag"># iOS底层</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/07/04/iOS%E5%BA%95%E5%B1%82%E6%8E%A2%E7%B4%A2-%E6%B6%88%E6%81%AF%E8%BD%AC%E5%8F%91/" rel="prev" title="iOS底层探索 - 消息转发">
      <i class="fa fa-chevron-left"></i> iOS底层探索 - 消息转发
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/07/15/iOS%E5%BA%95%E5%B1%82%E6%8E%A2%E7%B4%A2-%E7%B1%BB%E7%9A%84%E5%8A%A0%E8%BD%BD-%E4%B8%8A/" rel="next" title="iOS底层探索-类的加载（上）">
      iOS底层探索-类的加载（上） <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#编译过程和库"><span class="nav-number">1.</span> <span class="nav-text">编译过程和库</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#编译的过程"><span class="nav-number">1.1.</span> <span class="nav-text">编译的过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#动态库和静态库"><span class="nav-number">1.2.</span> <span class="nav-text">动态库和静态库</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dyld是什么"><span class="nav-number">2.</span> <span class="nav-text">dyld是什么</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#dyld版本演变"><span class="nav-number">2.1.</span> <span class="nav-text">dyld版本演变</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dyld-2和dyld-3加载过程的区别"><span class="nav-number">2.2.</span> <span class="nav-text">dyld 2和dyld 3加载过程的区别</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dyld加载流程分析"><span class="nav-number">3.</span> <span class="nav-text">dyld加载流程分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#dyldstart探索"><span class="nav-number">3.1.</span> <span class="nav-text">dyldstart探索</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dyld-start"><span class="nav-number">3.2.</span> <span class="nav-text">_dyld_start</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dyldbootstrap-start"><span class="nav-number">3.3.</span> <span class="nav-text">dyldbootstrap::start</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dyld-main"><span class="nav-number">3.4.</span> <span class="nav-text">dyld::_main</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dyld-initializeMainExecutable"><span class="nav-number">3.5.</span> <span class="nav-text">dyld::initializeMainExecutable</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ImageLoader-runInitializers"><span class="nav-number">3.6.</span> <span class="nav-text">ImageLoader::runInitializers</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ImageLoader-processInitializers"><span class="nav-number">3.7.</span> <span class="nav-text">ImageLoader::processInitializers</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ImageLoader-recursiveInitialization"><span class="nav-number">3.8.</span> <span class="nav-text">ImageLoader::recursiveInitialization</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dyld-notifySingle"><span class="nav-number">3.9.</span> <span class="nav-text">dyld::notifySingle</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#load-images"><span class="nav-number">3.10.</span> <span class="nav-text">load_images</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Jason</p>
  <div class="site-description" itemprop="description">个人技术博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">47</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jason</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
